var JSON;if(!JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());"use strict";(function($jsRoot){function emptyFunction(){}function __$A__(iterable){if(!iterable){return[]}if(iterable.toArray){return iterable.toArray()}var length=iterable.length||0,results=new Array(length);while(length--){results[length]=iterable[length]}return results}var Class={createCore:function(){var parent=null,properties=__$A__(arguments);if(Object.isFunction(properties[0])){parent=properties.shift()}function klass(){this.initialize.apply(this,arguments)}Object.extend(klass,Class.Methods);klass.superclass=parent;klass.subclasses=[];if(parent){var subclass=function(){};subclass.prototype=parent.prototype;klass.prototype=new subclass;parent.subclasses.push(klass)}for(var i=0;i<properties.length;i++){klass.addMethods(properties[i])}if(!klass.prototype.initialize){klass.prototype.initialize=emptyFunction}klass.prototype.constructor=klass;return klass},create:function(){var result=Class.createCore.apply(this,arguments);return result},free:function(obj){if(obj.finalize){obj.finalize()}obj=null}};Class.Methods={addMethods:function(source){if(!source){return this}var ancestor=this.superclass&&this.superclass.prototype;var properties=Object.keys(source);if(!Object.keys({toString:true}).length){properties.push("toString","valueOf")}var doNothing=function(){};for(var i=0,length=properties.length;i<length;i++){var property=properties[i];var value=source[property];var isFunction=Object.isFunction(value);if(ancestor&&isFunction&&FunctionUtils.argumentNames(value).first()=="$super"){var method=value;value=(function(m){return function(){return(ancestor[m]||doNothing).apply(this,arguments)}})(property).wrap(method);value.valueOf=method.valueOf.bind(method);value.toString=method.toString.bind(method)}this.prototype[property]=value}return this}};Object.extend=function(destination,source,ignoreUnsetValue,ignoreEmptyString){for(var property in source){var value=source[property];if(ignoreUnsetValue&&((value===undefined)||(value===null))){continue}if(ignoreEmptyString&&(value==="")){continue}destination[property]=value}return destination};Object.extendEx=function(destination,source,options){var ops=options||{};for(var property in source){var value=source[property];if(ops.ignoreUnsetValue&&((value===undefined)||(value===null))){continue}if(ops.ignoreEmptyString&&(value==="")){continue}var oldValue=destination[property];if(options.preserveExisted&&oldValue){continue}var oldProto=oldValue&&oldValue.constructor&&oldValue.constructor.prototype;var newProto=value&&value.constructor&&value.constructor.prototype;if(oldValue&&typeof(oldValue)==="object"&&oldProto===newProto){Object.extend(oldValue,value)}else{destination[property]=value}}return destination};Object._extendSupportMethods=function(destination,methods){return Object.extendEx(destination,methods,{ignoreUnsetValue:true,preserveExisted:true})};Object.getCascadeFieldValue=function(fieldName,root){var result;var cascadeNames;if(fieldName.length&&fieldName.splice){cascadeNames=fieldName}else{cascadeNames=fieldName.split(".")}if(!root){var root=this}for(var i=0,l=cascadeNames.length;i<l;++i){result=root[cascadeNames[i]];if(!result){break}else{root=result}}return result};Object.setCascadeFieldValue=function(fieldName,value,root,forceCreateEssentialObjs){var cascadeNames;if(fieldName.length&&fieldName.splice){cascadeNames=fieldName}else{cascadeNames=fieldName.split(".")}var parent=root;for(var i=0,l=cascadeNames.length;i<l;++i){var name=cascadeNames[i];if(i===l-1){parent[name]=value;return value}else{var obj=parent[name];if(!obj&&forceCreateEssentialObjs){obj={};parent[name]=obj}if(!obj){return false}else{parent=obj}}}};Object._inherit=function(proto){if(proto===null){proto={}}var t=typeof(proto);if(!(DataType.isFunctionType(t)||DataType.isObjectType(t))){throw TypeError()}function f(){}f.prototype=proto;return new f()};if(!Object.create){Object.create=Object._inherit}Object.copyValues=function(dest,src,propNames){if(!propNames){return Object.extend(dest,source)}else{for(var i=0,l=propNames.length;i<l;++i){var prop=propNames[i];var value=src[prop];if(value!==undefined){dest[prop]=value}}return dest}};Object._extendSupportMethods(Object,{keys:function(object){var keys=[];for(var property in object){keys.push(property)}return keys},isFunction:function(object){return typeof object=="function"},isUndefined:function(object){return typeof object=="undefined"}});var FunctionUtils={argumentNames:function(f){var names=((f.toString().match(/^[\s\(]*function[^(]*\(([^\)]*)\)/)||[])[1]||"").replace(/\s+/g,"").split(",");return names.length==1&&!names[0]?[]:names},};Object._extendSupportMethods(Function.prototype,{argumentNames:function(){var names=this.toString().match(/^[\s\(]*function[^(]*\(([^\)]*)\)/)[1].replace(/\s+/g,"").split(",");return names.length==1&&!names[0]?[]:names},wrap:function(wrapper){var __method=this;return function(){return wrapper.apply(this,[__method.bind(this)].concat(__$A__(arguments)))}},methodize:function(){if(this._methodized){return this._methodized}var __method=this;return this._methodized=function(){var a=Array.prototype.slice.call(arguments);a.unshift(this);return __method.apply(null,a)}},bind:function(){if(arguments.length<2&&Object.isUndefined(arguments[0])){return this}var __method=this,args=__$A__(arguments),object=args.shift();return function(){return __method.apply(object,args.concat(__$A__(arguments)))}},delay:function(){var __method=this,args=__$A__(arguments),timeout=args.shift();return window.setTimeout(function(){return __method.apply(__method,args)},timeout)},defer:function(){var __method=this,args=__$A__(arguments),timeout=args.shift();return window.setTimeout(function(){return __method.apply(__method,args)},10)}});Object._extendSupportMethods(Array.prototype,{first:function(){return this[0]},last:function(){return this[this.length-1]},clear:function(){this.length=0;return this},without:function(){var values=__$A__(arguments);return this.select(function(value){return !values.include(value)})},removeAt:function(index){this.splice(index,1)},remove:function(item){var index=this.indexOf(item);if(index>=0){return this.removeAt(index)}},forEach:function(func,scope){var i,len;for(i=0,len=this.length;i<len;++i){if(i in this){func.call(scope,this[i],i,this)}}}});if(!Array.prototype.indexOf){Array.prototype.indexOf=function(item,i){i||(i=0);var length=this.length;if(i<0){i=length+i}for(;i<length;i++){if(this[i]===item){return i}}return -1}}if(!Array.prototype.lastIndexOf){Array.prototype.lastIndexOf=function(item,i){i=isNaN(i)?this.length:(i<0?this.length+i:i)+1;var n=this.slice(0,i).reverse().indexOf(item);return(n<0)?n:i-n-1}}Object._extendSupportMethods(String.prototype,{gsub:function gsub(pattern,replacement){var result="",source=this,match;while(source.length>0){if(match=source.match(pattern)){result+=source.slice(0,match.index);result+=replacement;source=source.slice(match.index+match[0].length)}else{result+=source,source=""}}return result},sub:function(pattern,replacement,count){count=Object.isUndefined(count)?1:count;return this.gsub(pattern,function(match){if(--count<0){return match[0]}return replacement(match)})},scan:function(pattern,iterator){this.gsub(pattern,iterator);return String(this)},truncate:function(length,truncation){length=length||30;truncation=Object.isUndefined(truncation)?"...":truncation;return this.length>length?this.slice(0,length-truncation.length)+truncation:String(this)},strip:function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")},stripTags:function(){return this.replace(/<\/?[^>]+>/gi,"")},stripScripts:function(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")},extractScripts:function(){var matchAll=new RegExp(Prototype.ScriptFragment,"img");var matchOne=new RegExp(Prototype.ScriptFragment,"im");return(this.match(matchAll)||[]).map(function(scriptTag){return(scriptTag.match(matchOne)||["",""])[1]})},evalScripts:function(){return this.extractScripts().map(function(script){return eval(script)})},escapeHTML:function escapeHTML(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />")},unescapeHTML:function(){return this.replace(/\<br \/\>/g,"\n").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},toQueryParams:function(separator){var match=this.strip().match(/([^?#]*)(#.*)?$/);if(!match){return{}}return match[1].split(separator||"&").inject({},function(hash,pair){if((pair=pair.split("="))[0]){var key=decodeURIComponent(pair.shift());var value=pair.length>1?pair.join("="):pair[0];if(value!=undefined){value=decodeURIComponent(value)}if(key in hash){if(!Object.isArray(hash[key])){hash[key]=[hash[key]]}hash[key].push(value)}else{hash[key]=value}}return hash})},toArray:function(){return this.split("")},succ:function(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)},times:function(count){return count<1?"":new Array(count+1).join(this)},camelize:function(){var parts=this.split("-"),len=parts.length;if(len==1){return parts[0]}var camelized=this.charAt(0)=="-"?parts[0].charAt(0).toUpperCase()+parts[0].substring(1):parts[0];for(var i=1;i<len;i++){camelized+=parts[i].charAt(0).toUpperCase()+parts[i].substring(1)}return camelized},capitalize:function(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()},capitalizeFirst:function(){return this.charAt(0).toUpperCase()+this.substring(1)},underscore:function(){return this.gsub(/::/,"/").gsub(/([A-Z]+)([A-Z][a-z])/,"#{1}_#{2}").gsub(/([a-z\d])([A-Z])/,"#{1}_#{2}").gsub(/-/,"_").toLowerCase()},dasherize:function(){return this.gsub(/_/,"-")},inspect:function(useDoubleQuotes){var escapedString=this.gsub(/[\x00-\x1f\\]/,function(match){var character=String.specialChar[match[0]];return character?character:"\\u00"+match[0].charCodeAt().toPaddedString(2,16)});if(useDoubleQuotes){return'"'+escapedString.replace(/"/g,'\\"')+'"'}return"'"+escapedString.replace(/'/g,"\\'")+"'"},toJSON:function(){return this.inspect(true)},unfilterJSON:function(filter){return this.sub(filter||Prototype.JSONFilter,"#{1}")},isJSON:function(){var str=this;if(str.blank()){return false}str=this.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,"");return(/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/).test(str)},evalJSON:function(sanitize){var json=this.unfilterJSON();try{if(!sanitize||json.isJSON()){return eval("("+json+")")}}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())},include:function(pattern){return this.indexOf(pattern)>-1},startsWith:function(pattern){return this.indexOf(pattern)===0},endsWith:function(pattern){var d=this.length-pattern.length;return d>=0&&this.lastIndexOf(pattern)===d},empty:function(){return this==""},blank:function(){return/^\s*$/.test(this)},interpolate:function(object,pattern){return new Template(this,pattern).evaluate(object)}});Object._extendSupportMethods(String.prototype,{upperFirst:function(){return this.charAt(0).toUpperCase()+this.substring(1)},format:function(){var formatted=this;for(var i=0;i<arguments.length;i++){var regexp=new RegExp("\\{"+i+"\\}","gi");formatted=formatted.replace(regexp,arguments[i])}return formatted},trim:function(){return this.replace(/^\s*|\s*$/g,"")},ltrim:function(){return this.replace(/^\s+/,"")},rtrim:function(){return this.replace(/\s+$/,"")},trimLeft:function(){return this.ltrim()},trimRight:function(){return this.rtrim()},pad:function(length,padString,rightPad){var p=padString||" ";var a=[];for(var i=0,l=length-this.length;i<l;++i){a.push(p)}var str=this;if(rightPad){return str+a.join("")}else{return a.join("")+str}},lpad:function(length,padString){return this.pad(length,padString,false)},rpad:function(length,padString){return this.pad(length,padString,true)},reverse:function(){var length=this.length;var a=[];for(var i=length-1;i>=0;--i){a.push(this.charAt(i))}return a.join("")},toCharArray:function(){var a=[];for(var i=0,l=this.length;i<l;++i){a.push(this.charAt(i))}return a},hyphenize:function(hyphen){if(!hyphen){hyphen="-"}var len=this.length;var a=[];for(var i=0;i<len;++i){var c=this.charAt(i);if((i!==0)&&(c>="A")&&(c<="Z")){a.push(hyphen+c.toLowerCase())}else{a.push(c)}}return a.join("")}});var StringUtils={STRUE:"$TRUE",SFALSE:"$FALSE",SUNDEFINED:"$UNDEFINED",SNULL:"$NULL",SNAN:"$NAN",SPOSITIVE:"+",SNEGATIVE:"-",SDATEPREFIX:"@",isAllDigitalChar:function(str){for(var i=0,l=str.length;i<l;++i){var c=str.charAt(i);var isDigital=(c>="0")&&(c<="9");if((!isDigital)&&(c!=".")){return false}}return true},serializeValue:function(value,unchangeTypes){var utypes=unchangeTypes||[];var vtype=DataType.getType(value);if(utypes.indexOf(vtype)>=0){return value.toString()}if(value===null){return StringUtils.SNULL}else{if(typeof(value)=="undefined"){return StringUtils.SUNDEFINED}else{if(value!=value){return StringUtils.SNAN}else{switch(vtype){case"boolean":return value?StringUtils.STRUE:StringUtils.SFALSE;break;case"number":var sign=(value>=0)?StringUtils.SPOSITIVE:"";return sign+value;break;case DataType.DATE:return StringUtils.SDATEPREFIX+value.toString();default:return value.toString()}}}}},deserializeValue:function(str,preferedType){if(typeof(str)!=="string"){return str}switch(str){case StringUtils.STRUE:return true;break;case StringUtils.SFALSE:return false;break;case StringUtils.SNULL:return null;break;case StringUtils.SUNDEFINED:return undefined;break;case StringUtils.SNAN:return NaN;break;default:if(preferedType){switch(preferedType){case DataType.FLOAT:return parseFloat(str);break;case DataType.INT:return parseInt(str);break;case"number":return parseFloat(str);break;case"boolean":return !!str;break;default:return str}}else{var firstChar=str.charAt(0);switch(firstChar){case StringUtils.SPOSITIVE:case StringUtils.SNEGATIVE:var s=str.substring(1);if(StringUtils.isAllDigitalChar(s)){return parseFloat(str)}else{return str}break;case StringUtils.SDATEPREFIX:var s=str.substr(1);return new Date(s);default:return str}}}}};Object.extend(Date.prototype,{copyFrom:function(src){this.setFullYear(src.getFullYear(),src.getMonth(),src.getDate());this.setTime(src.getTime())}});if(!Math.sqr){Math.sqr=function(x){return x*x}}if(!Math.sign){Math.sign=function(x){return(x>0)?1:(x<0)?-1:0}}if(!$jsRoot.Node){$jsRoot.Node={}}if(!$jsRoot.Node.ELEMENT_NODE){Object.extend($jsRoot.Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12})}Class.PropertyScope={DEFAULT:3,PUBLISHED:3,PUBLIC:2,PRIVATE:1};Class.PropList=function(){this.props=[]};Class.PropList.prototype={addProperty:function(propName,options){if(!options){options={}}var propInfo;propInfo=this.getPropInfo(propName);if(!propInfo){propInfo={};this.props.push(propInfo)}propInfo=Object.extend(propInfo,options);if(propInfo.serializable===undefined){propInfo.serializable=true}propInfo.name=propName;return propInfo},removeProperty:function(propName){var index=this.indexOf(propName);if(index>=0){this.props.splice(index,1)}},removePropAt:function(index){if(index>=0){var prop=this.props[index];if(prop){this.props.splice(index,1)}}},getLength:function(){return this.props.length},indexOf:function(propName){for(var i=0,l=this.props.length;i<l;++i){if(this.props[i].name===propName){return i}}return -1},getPropInfoAt:function(index){if(index>=0){return this.props[index]}else{return null}},getPropInfo:function(propName){var result;var index=this.indexOf(propName);var result=this.getPropInfoAt(index);return result},hasProperty:function(propName){return(this.indexOf(propName)>=0)},clear:function(){this.props.clear()},clone:function(){var result=new Class.PropList();result.props=this.props.slice();return result},appendList:function(propList){for(var i=0,l=propList.props.length;i<l;++i){this.props.push(propList.props[i])}}};Class.PropList.prototype.constructor=Class.PropList;Class.EventHandlerList=function(){this.handlers=[];this._$flag_="KekuleEventList"};Class.EventHandlerList.prototype={add:function(handler,thisArg){if(!thisArg){thisArg=null}this.handlers.push({thisArg:thisArg,handler:handler})},remove:function(handler,thisArg){var indexes=this.indexesOf(handler,thisArg);if(indexes.length>0){for(var i=indexes.length-1;i>=0;--i){this.removeAt(indexes[i])}}},removeAt:function(index){for(var i=index,l=this.handlers.length;i<l;++i){this.handlers[i]=this.handlers[i+1]}this.handlers.length=this.handlers.length-1},clear:function(){this.handlers=[]},getHandlerInfo:function(index){return this.handlers[index]},indexOf:function(handler,thisArg){for(var i=0,l=this.handlers.length;i<l;++i){if(this.handlers[i].handler==handler){if((thisArg!==undefined)&&(this.handlers[i].thisArg===thisArg)){return i}else{if(thisArg===undefined){return i}}}}return -1},indexesOf:function(handler,thisArg){var result=[];for(var i=0,l=this.handlers.length;i<l;++i){if(this.handlers[i].handler==handler){if((thisArg!==undefined)&&(this.handlers[i].thisArg===thisArg)){result.push(i)}else{if(thisArg===undefined){result.push(i)}}}}return result},getLength:function(){return this.handlers.length}};Class.EventHandlerList.constructor=Class.EventHandlerList;var DataType={UNKNOWN:null,VARIANT:null,PRIMARY:"primary",UNDEFINED:"undefined",BOOL:"boolean",BOOLEAN:"boolean",NUMBER:"number",INT:"int",INTEGER:"int",FLOAT:"float",STRING:"string",ARRAY:"array",FUNCTION:"function",DATE:"date",HASH:"object",OBJECT:"object",OBJECTEX:"objectex",CLASS:"class",isSimpleType:function(typeName){return(typeName==DataType.STRING)||(typeName==DataType.NUMBER)||(typeName==DataType.INT)||(typeName==DataType.FLOAT)||(typeName==DataType.BOOL)||(typeName==DataType.UNDEFINED)||(typeName==DataType.PRIMARY)},isComplexType:function(typeName){return !(DataType.isSimpleType(typeName)||DataType.isFunctionType(typeName))},isFunctionType:function(typeName){return typeName==DataType.FUNCTION},isObjectType:function(typeName){return typeName==DataType.OBJECT},isDateType:function(typeName){return typeName==DataType.DATE},isObjectExType:function(typeName){var result=DataType.isComplexType(typeName)&&(!DataType.isObjectType(typeName))&&(!DataType.isDateType(typeName));if(result){var classObj=ClassEx.findClass(typeName);result=classObj&&ClassEx.isOrIsDescendantOf(classObj,ObjectEx)}return result},getType:function(value){var stype=typeof(value);switch(stype){case"undefined":return DataType.UNDEFINED;case"function":return DataType.FUNCTION;case"boolean":return DataType.BOOL;case"string":return DataType.STRING;case"number":if(Math.floor(value)==value){return DataType.INT}else{return DataType.FLOAT}case"object":if(this.isDateValue(value)){return DataType.DATE}else{if(DataType.isArrayValue(value)){return DataType.ARRAY}else{if(ClassEx.isClass(value)){return DataType.CLASS}else{if(DataType.isObjectExValue(value)&&value.getClassName){return value.getClassName()}else{return DataType.OBJECT}}}}default:return stype}},isSimpleValue:function(value){return DataType.isSimpleType(typeof(value))},isUndefinedValue:function(value){return typeof(value)=="undefined"},isNullValue:function(value){return(value===null)},isFunctionValue:function(value){return typeof(value)=="function"},isObjectValue:function(value){if(value){return(typeof(value)=="object")&&(!DataType.isArrayValue(value))&&(!DataType.isDateValue(value))}else{return false}},isDateValue:function(value){if(value){return((typeof(value)=="object")&&(value.getFullYear!==undefined))}return false},isArrayValue:function(value){if(value){return((typeof(value)=="object")&&(value.length!==undefined))}else{return false}},isObjectExValue:function(value){return(value instanceof ObjectEx)},createInstance:function(typeName){switch(typeName){case DataType.UNDEFINED:return undefined;case DataType.DATE:return new Date();case DataType.ARRAY:return new Array();case DataType.OBJECT:return new Object();case DataType.FUNCTION:return new Function();default:var classInstance=ClassEx.findClass(typeName.capitalizeFirst());return new classInstance()}}};var ClassEx={isClass:function(classObj){if(!classObj){return false}return(classObj.superclass&&classObj.subclasses)},findClass:function(className,root){return Object.getCascadeFieldValue(className,root||$jsRoot)},getClassName:function(aClass){return aClass.prototype.CLASS_NAME},getPrototype:function(aClass){return aClass.prototype},getSuperClass:function(aClass){return aClass.superclass||aClass.constructor.superclass},getSuperClassPrototype:function(aClass){if(aClass.superclass){return aClass.superclass.prototype}else{return null}},_getCommonSuperClass2:function(class1,class2){var result=class1;while(result&&(!ClassEx.isOrIsDescendantOf(class2,result))){result=ClassEx.getSuperClass(result)}return result},getCommonSuperClass:function(objects){if(!objects||!objects.length){return null}var result=objects[0].getClass?objects[0].getClass():null;if(!result){return null}for(var i=1,l=objects.length;i<l;++i){var classObj=objects[i].getClass?objects[i].getClass():null;if(!classObj){return null}result=ClassEx._getCommonSuperClass2(result,classObj)}return result},isDescendantOf:function(aClass,superClass){var ancestor=ClassEx.getSuperClass(aClass);while(ancestor&&(ancestor!==superClass)){ancestor=ClassEx.getSuperClass(ancestor)}return !!ancestor},isOrIsDescendantOf:function(aClass,superClass){return(aClass===superClass)||ClassEx.isDescendantOf(aClass,superClass)},isOrIsDescendantOfClasses:function(aClass,superClasses){for(var i=0,l=superClasses.length;i<l;++i){if(ClassEx.isOrIsDescendantOf(aClass,superClasses[i])){return true}}return false},_ensurePropertySystem:function(aClass){var proto=ClassEx.getPrototype(aClass);if(!proto){return}if(!proto.hasOwnProperty("properties")){var parent=ClassEx.getSuperClass(aClass);if(parent){ClassEx._ensurePropertySystem(parent)}ClassEx._createPropertyList(aClass);if(proto.hasOwnProperty("initProperties")){proto.initProperties.apply(proto)}}},_createPropertyList:function(aClass){if(!ClassEx.getPrototype(aClass).hasOwnProperty("properties")){ClassEx.getPrototype(aClass).properties=new Class.PropList()}},getOwnPropList:function(aClass){var proto=ClassEx.getPrototype(aClass);if(proto){proto._initPropertySystem();return proto.properties}else{return null}},getAllPropList:function(aClass){var result;var s=ClassEx.getSuperClassPrototype(aClass);if(s){result=s.getAllPropList().clone();result.appendList(ClassEx.getOwnPropList(aClass))}else{result=ClassEx.getOwnPropList(aClass)}return result},getPropListOfScopes:function(aClass,scopes){var findOwnList=function(aClass,scopes){var list=ClassEx.getOwnPropList(aClass).clone();if(list){for(var i=list.getLength()-1;i>=0;--i){var propInfo=list.getPropInfoAt(i);var propScope=propInfo.scope||Class.PropertyScope.DEFAULT;if(scopes.indexOf(propScope)<0){list.removePropAt(i)}}}return list};var result;var s=ClassEx.getSuperClass(aClass);if(s){result=ClassEx.getPropListOfScopes(s,scopes).clone();result.appendList(findOwnList(aClass,scopes))}else{result=findOwnList(aClass,scopes)}return result},defineProp:function(aClass,propName,options){ClassEx._ensurePropertySystem(aClass);return ClassEx.getPrototype(aClass).defineProp(propName,options)},defineProps:function(aClass,propDefItems){ClassEx._ensurePropertySystem(aClass);var proto=ClassEx.getPrototype(aClass);for(var i=0,l=propDefItems.length;i<l;++i){var item=propDefItems[i];var propName=item.name;var options=item;proto.defineProp(propName,options)}},getPropInfo:function(aClass,propName){return ClassEx.getPrototype(aClass).getPropInfo(propName)},defineEvent:function(aClass,eventName){return ClassEx.getPrototype(aClass).defineEvent(eventName)},getUnusedMethodName:function(aClass,baseName,fromIndex){var start=fromIndex||0;var i=start;var p=ClassEx.getPrototype(aClass);var name=baseName+Number(i).toString();while(p[name]){++i;name=baseName+Number(i).toString()}return name},extendMethod:function(aClass,methodName,method){var proto=ClassEx.getPrototype(aClass);var originMethod=proto[methodName];var newName=ClassEx.getUnusedMethodName(aClass,"__$changed$_"+methodName+"__");proto[newName]=originMethod;var value=(function(m){return function(){return proto[m].apply(this,arguments)}})(newName).wrap(method);proto[methodName]=value;value.valueOf=method.valueOf.bind(method);value.toString=method.toString.bind(method)},extend:function(aClass,extension){var proto=ClassEx.getPrototype(aClass);var ancestor=ClassEx.getSuperClassPrototype(aClass);var properties=Object.keys(extension);if(!Object.keys({toString:true}).length){properties.push("toString","valueOf")}for(var i=0,length=properties.length;i<length;i++){var property=properties[i],value=extension[property];if(typeof(value)=="function"){var args=FunctionUtils.argumentNames(value);var first=args.first();if(first=="$origin"){var method=value;var originMethod=proto[property];var newName=ClassEx.getUnusedMethodName(aClass,"__$changed$_"+property+"__");proto[newName]=originMethod;value=(function(m){return function(){return proto[m].apply(this,arguments)}})(newName).wrap(method);value.valueOf=method.valueOf.bind(method);value.toString=method.toString.bind(method);args.shift();first=args.first()}if(first=="$super"){var method=value;value=(function(m){return function(){return ancestor[m].apply(this,arguments)}})(property).wrap(method);value.valueOf=method.valueOf.bind(method);value.toString=method.toString.bind(method)}}proto[property]=value}return aClass}};var ObjectEx=Class.create({CLASS_NAME:"ObjectEx",initialize:function(){this._initPropertySystem();this.initPropValues();this._updateStatus=0;this._childChangeEventSuppressed=false;this._modifiedProps=[];this._finalized=false;this.afterInitialization()},afterInitialization:function(){},finalize:function(){if(!this._finalized){this.doFinalize();this.invokeEvent("finalize",{obj:this});this.setPropStoreFieldValue("eventHandlers",null);this._finalized=true}},doFinalize:function(){},initProperties:function(){this.defineProp("enablePropValueGetEvent",{dataType:DataType.BOOL,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("enablePropValueSetEvent",{dataType:DataType.BOOL,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("bubbleEvent",{dataType:DataType.BOOL,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("suppressChildChangeEventInUpdating",{dataType:DataType.BOOL,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("eventHandlers",{dataType:DataType.HASH,serializable:false,scope:Class.PropertyScope.PRIVATE,getter:function(){var r=this.getPropStoreFieldValue("eventHandlers");if(!r){r={};this.setPropStoreFieldValue("eventHandlers",r)}return r}})},initPropValues:function(){},getHigherLevelObj:function(){return null},saved:function(){},loaded:function(){},_initPropertySystem:function(){if(!this.getPrototype().hasOwnProperty("properties")){var parent=this.getSuperClassPrototype();if(parent){parent._initPropertySystem.apply(parent)}this._createPropertyList();if(this.getPrototype().hasOwnProperty("initProperties")){this.getPrototype().initProperties.apply(this.getPrototype())}}},_createPropertyList:function(){if(!this.getPrototype().hasOwnProperty("properties")){this.getPrototype().properties=new Class.PropList()}},getClass:function(){return this.constructor},getSuperClass:function(){return this.getClass().superclass},getClassName:function(){return this.getPrototype().CLASS_NAME},getSerializationName:function(){return this.getClassName()},getPrototype:function(){if(this.prototype){return this.prototype}else{return this.constructor.prototype}},getSuperClassPrototype:function(){if(this.constructor&&this.constructor.superclass){return this.constructor.superclass.prototype}else{return null}},getOwnPropList:function(){this._initPropertySystem();return this.getPrototype().properties},getAllPropList:function(){var result;var s=this.getSuperClassPrototype();if(s){result=s.getAllPropList().clone();result.appendList(this.getOwnPropList())}else{result=this.getOwnPropList().clone()}return result},getPropListOfScopes:function(scopes){return ClassEx.getPropListOfScopes(this.getClass(),scopes)},getPropInfoHashKey:function(propName){return ObjectEx._PROPINFO_HASHKEY_PREFIX+propName},getDefPropStoreFieldName:function(propName){return ObjectEx._PROP_STOREFIELD_PREFIX+propName},defineProp:function(propName,options){if(!options){options={}}if(options.serializable===undefined){options.serializable=true}if(!options.storeField){options.storeField=this.getDefPropStoreFieldName(propName)}var list=this.getOwnPropList();var prop=list.addProperty(propName,options);if(options.getter!==null){prop.getter=this.createPropGetter(prop,options.getter)}if(options.setter!==null){prop.setter=this.createPropSetter(prop,options.setter)}this[this.getPropInfoHashKey(propName)]=prop;return prop},createPropGetter:function(prop,getter){var propNameBase=prop.name.toString().upperFirst();var getterName="get"+propNameBase;var doGetterName="doGet"+propNameBase;var actualGetter=this[doGetterName];if(!actualGetter){actualGetter=getter||new Function('return this["'+prop.storeField+'"];');this.getPrototype()[doGetterName]=actualGetter}this.getPrototype()[getterName]=function(){var args=Array.prototype.slice.call(arguments);return this[doGetterName].apply(this,args)};return doGetterName},createPropSetter:function(prop,setter){var propName=prop.name.toString();var propNameBase=propName.upperFirst();var setterName="set"+propNameBase;var doSetterName="doSet"+propNameBase;var actualSetter=this[doSetterName];if(!this[doSetterName]){actualSetter=setter||new Function("value",'this["'+prop.storeField+'"] = value;');this.getPrototype()[doSetterName]=actualSetter}this.getPrototype()[setterName]=function(){var args=Array.prototype.slice.call(arguments);var value=args[0];this[doSetterName].apply(this,args);this.notifyPropSet(propName,value);return this};return doSetterName},hasProperty:function(propName){return(this.getPropInfo(propName)!=null)},getPropInfo:function(propName){var pname=propName||"";var hashKey=this.getPropInfoHashKey(pname)||"";var result=this[hashKey];if(!result){result=this.getOwnPropList().getPropInfo(pname);if(!result){var parent=this.getSuperClassPrototype();if(parent&&parent.getPropInfo){result=parent.getPropInfo(pname)}else{result=null}}}return result},getPropertyDataType:function(propName){var info=this.getPropInfo(propName);return info?info.dataType:null},isPropertySerializable:function(propName){var info=this.getPropInfo(propName);var s=info.serializable;return(s===undefined)||(!!s)},getPropStoreFieldValue:function(propName){var info=this.getPropInfo(propName);if(info.storeField){return this[info.storeField]}else{return undefined}},getPropValue:function(propName){var result;var info=this.getPropInfo(propName);if(info){if(info.getter){var args=Array.prototype.slice.call(arguments);args.shift();result=this[info.getter].apply(this,args)}else{result=this[info.storeField]}return result}else{return null}},setPropStoreFieldValue:function(propName,value){var pname;var info=this.getPropInfo(propName);if(info.storeField){this[info.storeField]=value}},setPropValue:function(propName,value,ignoreReadOnly){var info=this.getPropInfo(propName);if(info){if(info.setter){this[info.setter].apply(this,[value])}else{if(ignoreReadOnly){this[info.storeField]=value}}this.notifyPropSet(propName,value)}return this},setPropValueX:function(){var args=Array.prototype.slice.call(arguments);var propName=args.shift();var info=this.getPropInfo(propName);if(info){if(info.setter){this[info.setter].apply(this,args)}this.notifyPropSet(propName,this.getPropValue(propName))}return this},setPropValues:function(hash,ignoreReadOnly){for(var propName in hash){if(hash.hasOwnProperty(propName)){if(this.hasProperty(propName)){var propValue=hash[propName];this.setPropValue(propName,propValue,ignoreReadOnly)}}}return this},_isPropGetOrSetEvent:function(propName){return(propName=="propValueGet")||(propName=="propValueSet")},notifyPropSet:function(propName,newValue,doNotEvokeObjChange){if(this.isUpdating()){if(this._modifiedProps.indexOf(propName)<0){this._modifiedProps.push(propName)}return}if(this._isPropGetOrSetEvent(propName)||this.isEventPropName(propName)){return}this.doPropChanged(propName,newValue);if(this.getPropStoreFieldValue("enablePropValueSetEvent")){this.invokeEvent("propValueSet",{propName:propName,propValue:newValue})}if(!doNotEvokeObjChange){this.objectChange([propName])}},objectChange:function(modifiedPropNames){this.doObjectChange(modifiedPropNames);this.invokeEvent("change",{changedPropNames:modifiedPropNames})},doObjectChange:function(modifiedPropNames){},doPropChanged:function(propName,newValue){},defineEvent:function(eventName){return;var propName=this.eventNameToPropName(eventName);var result=this.defineProp(propName,{serializable:false,setter:null});return result},eventNameToPropName:function(eventName){return"__event_"+eventName},isEventPropName:function(propName){return((typeof(propName)=="string")&&(propName.indexOf("__event_")>=0))},isEventHandlerList:function(value){return(value&&(typeof(value)=="object")&&(value instanceof Class.EventHandlerList))},getEventHandlerList:function(eventName){var hs=this.getEventHandlers();var result=hs[eventName];if(!result){result=new Class.EventHandlerList();hs[eventName]=result}return result},addEventListener:function(eventName,listener,thisArg){var handlerList=this.getEventHandlerList(eventName);if(this.isEventHandlerList(handlerList)){return handlerList.add(listener,thisArg)}else{return null}},addOnceEventListener:function(eventName,listener,thisArg){var self=this;var wrapper=function(event){self.removeEventListener(eventName,wrapper,thisArg);listener(event)};return this.addEventListener(eventName,wrapper,thisArg)},removeEventListener:function(eventName,listener,thisArg){var handlerList=this.getEventHandlerList(eventName);if(this.isEventHandlerList(handlerList)){return handlerList.remove(listener,thisArg)}},on:function(eventName,listener,thisArg){return this.addEventListener(eventName,listener,thisArg)},once:function(eventName,listener,thisArg){return this.addOnceEventListener(eventName,listener,thisArg)},off:function(eventName,listener,thisArg){return this.removeEventListener(eventName,listener,thisArg)},invokeEvent:function(eventName,event){if(!event){event={}}event.name=eventName;event.target=this;event.stopPropagation=this._eventStopPropagation;this.dispatchEvent(eventName,event)},relayEvent:function(eventName,event){event.currentTarget=this;if(eventName==="change"&&this.getSuppressChildChangeEventInUpdating()&&this.isUpdating()){this._childChangeEventSuppressed=true}else{this.dispatchEvent(eventName,event)}},dispatchEvent:function(eventName,event){var handlerList=this.getEventHandlerList(eventName);if(this.isEventHandlerList(handlerList)){for(var i=0,l=handlerList.getLength();i<l;++i){var handlerInfo=handlerList.getHandlerInfo(i);if(handlerInfo.handler){handlerInfo.handler.apply(handlerInfo.thisArg,[event])}}}else{}var higherObj=this.getHigherLevelObj();if(!event.cancelBubble&&this.getBubbleEvent()&&higherObj){if(higherObj.relayEvent){higherObj.relayEvent(eventName,event)}}},stopEventPropagation:function(event){event.cancelBubble=true},overwriteMethod:function(methodName,newMethod){var self=this;var oldMethod=this[methodName];this[methodName]=function _delegator_(){var args=Array.prototype.slice.call(arguments);args.unshift(oldMethod.bind(self));return newMethod.apply(self,args)};return this},assign:function(srcObj){return srcObj.assignTo(this)},assignTo:function(targetObj){var jsonObj={};this.saveObj(jsonObj,"json");targetObj.loadObj(jsonObj,"json")},clone:function(){var classObj=this.getClass();var result=new classObj();this.assignTo(result);return result},beginUpdate:function(){++this._updateStatus},endUpdate:function(){--this._updateStatus;this.checkUpdateStatus();if(!this.isUpdating()){var modifiedProps=this._modifiedProps||[];this._modifiedProps=[];if(this._childChangeEventSuppressed){modifiedProps.push("[children]")}this.doEndUpdate(modifiedProps);this._childChangeEventSuppressed=false}},doEndUpdate:function(modifiedPropNames){if(modifiedPropNames.length){if(this.getPropStoreFieldValue("enablePropValueSetEvent")){for(var i=0,l=modifiedPropNames.length;i<l;++i){var propName=modifiedPropNames[i];var propValue=this.getPropValue(propName);this.notifyPropSet(propName,propValue,true)}}this.objectChange(modifiedPropNames)}},isUpdating:function(){return this._updateStatus>0},isPropUpdated:function(propName){return(this._modifiedProps.indexOf(propName)>=0)},checkUpdateStatus:function(){if(this._updateStatus<=0){this._updateStatus=0}},copyPropsTo:function(dest){var props=this.getAllPropList();for(var i=0,l=props.getLength();i<l;++i){var propName=props.getPropInfoAt(i).name;if(dest.hasProperty(propName)){var propValue=this.getPropValue(propName);dest.setPropValue(propName,propValue,true)}}}});ObjectEx._PROPINFO_HASHKEY_PREFIX="__$propInfo__";ObjectEx._PROP_STOREFIELD_PREFIX="__$";$jsRoot.Class=Class;$jsRoot.ClassEx=ClassEx;$jsRoot.ObjectEx=ObjectEx;$jsRoot.DataType=DataType;DataType.StringUtils=StringUtils})(this);var JsonUtility={DEF_LOAD_TIMEOUT:20000,FILE_EXT_JSON:".json",FILE_EXT_JSON_JS_WRAPPER:".jsonjs",DEF_SERIALIZE_TO_JSCODE_VARNAME:"__jsonvar__",parse:function(a){return JSON.parse(a)},parseFromJsWrappedCode:function(code,jsVarName){if(!jsVarName){jsVarName=JsonUtility.DEF_SERIALIZE_TO_JSCODE_VARNAME}eval(code);return JsonUtility.parse(eval(jsVarName))},load:function(b,d,a){var c=WebShow.URL.getFileExt(b);if(c.toLowerCase()==JsonUtility.FILE_EXT_JSON_JS_WRAPPER){return JsonUtility.loadJsWrapper(b,d,a)}else{return JsonUtility.loadJson(b,d,a)}},loadJsWrapper:function(url,callback,options){var loptions=options||{};var wrapperVarName=loptions.wrapperVarName||JsonUtility.DEF_SERIALIZE_TO_JSCODE_VARNAME;if(!loptions.timeout){loptions.timeout=JsonUtility.DEF_LOAD_TIMEOUT}var runCallBack=function(jsonObj,isSuccess){if(callback){callback(jsonObj,isSuccess)}};var wrapperCallback=function(src,isSuccess){var jsonObj=null;if(isSuccess){var wrapperVar=eval(wrapperVarName);if(wrapperVar){if(typeof(wrapperVar)=="string"){jsonObj=JsonUtility.parse(wrapperVar)}else{jsonObj=wrapperVar}}runCallBack(jsonObj,true)}else{runCallBack(null,false)}};WebShow.ScriptLoader.load(url,wrapperCallback,loptions)},loadJson:function(c,e,b){loptions=b||{};if(!loptions.timeout){loptions.timeout=JsonUtility.DEF_LOAD_TIMEOUT}loptions.resultType=WebShow.FileLoader.ResultType.TEXT;loptions.extractBody=false;var d=function(h,f,g){if(f){var i=JsonUtility.parse(h);e(i,true)}else{e(null,false)}};var a=new WebShow.XHRLoader();a.load(c,d,loptions)},serializeToStr:function(b,a){if(a&&a.prettyPrint){return JSON.stringify(b,null,a.indentSpaces||2)}else{return JSON.stringify(b)}},serializeToJsCode:function(d,b,e){if(!e){e="'"}if(!b){b=JsonUtility.DEF_SERIALIZE_TO_JSCODE_VARNAME}var a=JsonUtility.serializeToStr(d);var c=new RegExp(e,"g");a=a.replace(c,"\\"+e);return"var "+b+" = "+e+a+e}};var XmlUtility={DEF_INCLUDE_TAG_NAME:"include",DEF_INCLUDE_SRC_ATTRIB:"src",DEF_LOAD_TIMEOUT:20000,DEF_BYPASS_ROOT_ELEM:true,DEF_SERIALIZE_TO_JSCODE_VARNAME:"__xmlStr__",FILE_EXT_XML:".xml",FILE_EXT_XML_JS_WRAPPER:".xmljs",newDocument:function(b,a){if(!b){b=""}if(!a){a=""}if(document.implementation&&document.implementation.createDocument){var f=document.implementation.createDocument(a,b,null);return f}else{var f=new ActiveXObject("MSXML2.DOMDocument");if(b){var d="";var c=b;var e=b.indexOf(":");if(e!=-1){d=b.substring(0,e);c=b.substring(e+1)}var g="<"+(d?(d+":"):"")+c+(a?((d?" xmlns:":" xmlns")+d+'="'+a+'"'):"")+"/>";f.loadXML(g)}return f}},parse:function(d){if(typeof DOMParser!="undefined"){return(new DOMParser()).parseFromString(d,"application/xml")}else{if(typeof ActiveXObject!="undefined"){var c=XmlUtility.newDocument();c.loadXML(d);return c}else{var a="data:text/xml;charset=utf-8,"+encodeURIComponent(d);var b=new XMLHttpRequest();b.open("GET",a,false);b.send(null);return b.responseXML}}},load:function(b,d,a){var c=WebShow.URL.getFileExt(b);if(c.toLowerCase()==XmlUtility.FILE_EXT_XML_JS_WRAPPER){return XmlUtility.loadHelper.loadJsWrapper(b,d,a)}if(!a){a={disableInclude:false}}if(!a.disableInclude){return XmlUtility.loadHelper.loadAndHandleIncludeElement(b,d,a)}else{return XmlUtility.loadHelper.loadSimple(b,d,a.timeout)}},loadHelper:{loadSimple:function(a,h,f){var b=(h!=null);if((f===null)||(f===undefined)){f=XmlUtility.DEF_LOAD_TIMEOUT}if(!(document.implementation&&document.implementation.createDocument)){return XmlUtility.loadHelper.loadSimpleViaDoc(a,h)}else{var d=new XMLHttpRequest();var i=null;if(f){i=setTimeout(function(){j(null,false)},f)}var j=function(k,e){if(i){clearTimeout(i)}if(h){h(k,e)}};if(b){d.onreadystatechange=function(){if(d.readyState==4){var e=d.responseXML;if(e&&e.documentElement){j(e,true)}else{j(null,false)}}}}try{d.open("get",a,b);d.send(null)}catch(c){WebShow.reportError(c);j(null,false)}var g=d.responseXML;if(g&&g.documentElement){return g}else{return null}}},loadSimpleViaDoc:function(c,e){var b="dummy_dummy_dummy_dummy";var d=(e!=null);var a=XmlUtility.newDocument(b);a.async=d;if(d){a.onreadystatechange=function(){if(a.readyState==4){if((!a.documentElement)||(a.documentElement.tag==b)){e(a,false)}else{e(a,true)}}}}a.load(c);return a},loadAndHandleIncludeElement:function(c,f,b){var e;if(b){e=b.timeout}else{e=null}var d=(f==null);if(d){var a=XmlUtility.loadHelper.loadSimple(c,null,e);if(a&&a.documentElement){XmlUtility.loadHelper.handleIncludedXmlInElement(a.documentElement,null,b);return a}else{return null}}else{return XmlUtility.loadHelper.loadSimple(c,function(h,g){if(!g){f(h,false)}else{XmlUtility.loadHelper.handleIncludedXmlInElement(h.documentElement,function(i){f(h,true)},b)}},e)}},loadJsWrapper:function(url,callback,options){options=options||{};var wrapperVarName=options.wrapperVarName||XmlUtility.DEF_SERIALIZE_TO_JSCODE_VARNAME;var loadTimeout=options.timeout;if((loadTimeout===null)||(loadTimeout===undefined)){loadTimeout=XmlUtility.DEF_LOAD_TIMEOUT}var runCallBack=function(xmldoc,isSuccess){if(callback){callback(xmldoc,isSuccess)}};var wrapperCallback=function(src,isSuccess){if(isSuccess){var xmlContent=eval(wrapperVarName);var doc=XmlUtility.parse(xmlContent);runCallBack(doc,true)}else{runCallBack(null,false)}};options.timeout=loadTimeout;WebShow.ScriptLoader.load(url,wrapperCallback,options)},getIncludeElements:function(b,c){var a=[];if(!c){c=XmlUtility.DEF_INCLUDE_TAG_NAME}return b.getElementsByTagName(c)},handleIncludedXmlInElement:function(b,n,p){if(!p){p={}}var j=p.includeTagName||XmlUtility.DEF_INCLUDE_TAG_NAME;var o=p.srcAttribName||XmlUtility.DEF_INCLUDE_SRC_ATTRIB;var a=(p.bypassRootElem!=null)?p.bypassRootElem:XmlUtility.DEF_BYPASS_ROOT_ELEM;var k=(n==null);var m=XmlUtility.getXmlDocUrl(b.ownerDocument);var h=XmlUtility.loadHelper.getIncludeElements(b,j);if(!o){var d=null}var e=null;var l=0;var c=h.length;if(c<=0){if(n){n(0)}return null}var f;for(var g=h.length-1;g>=0;--g){e=h[g];d=e.getAttribute(o);if(d){d=WebShow.URL.mergePath(d,m);if(k){f=XmlUtility.loadHelper.loadSimple(d);if(f){XmlUtility.loadHelper.insertIncludedSection(f,e,a)}}else{XmlUtility.loadHelper.loadSimple(d,(function(r,q,i){if(i&&q){f=q;XmlUtility.loadHelper.insertIncludedSection(f,r,a)}l++;if(l==c){n(l)}}).bind(this,e))}}}return b},insertIncludedSection:function(j,h,a){var c=[];if(a){var d=j.documentElement.firstChild;while(d){if(d.nodeType==Node.ELEMENT_NODE){c.push(d)}d=d.nextSibling}}else{c.push(j.documentElement)}var f;var b=h.ownerDocument;var e=b.documentElement;for(var k=0,g=c.length;k<g;++k){var f=c[k];if(b.importNode){f=b.importNode(f,true)}h.parentNode.insertBefore(f,h)}h.parentNode.removeChild(h);return b}},serializeNode:function(b,a){if(a&&a.prettyPrint){return XmlUtility.serializeNodePretty(b)}if(typeof XMLSerializer!="undefined"){return(new XMLSerializer()).serializeToString(b)}else{if(b.xml){return b.xml}else{throw"XML.serialize is not supported or can't serialize "+b}}},serializeNodePretty:function(a){try{return XML((new XMLSerializer()).serializeToString(a)).toXMLString()}catch(b){return XmlUtility.serializeNode(a)}},serializeNodeToJsCode:function(d,a,c){if(!c){c="'"}if(!a){a=XmlUtility.DEF_SERIALIZE_TO_JSCODE_VARNAME}var e=XmlUtility.serializeNode(d);var b=new RegExp(c,"g");e=e.replace(b,"\\"+c);return"var "+a+" = "+c+e+c+";"},parseFromJsWrappedCode:function(code,jsVarName){eval(code);var xmlText=eval(jsVarName);return XmlUtility.parse(xmlText)},getXmlDocUrl:function(a){return a.url||a.documentURI||a.URL||a.location}};var ObjSerializer=Class.create({CLASS_NAME:"ObjSerializer",serializeValue:function(a){return a},deserializeValue:function(b,a){return b},propNameToStorageName:function(a){return a},storageNameToPropName:function(a){return a},getObjCustomSaveMethod:function(a){return(a.doSaveObj)},getObjCustomLoadMethod:function(a){return(a.doLoadObj)},getObjCustomPropSaveMethod:function(a){return(a.doSaveProp)},getObjCustomPropLoadMethod:function(a){return(a.doLoadProp)},isUndefined:function(a){return DataType.isUndefinedValue(a)},isNull:function(a){return(a===null)},isNaN:function(a){return a!=a},isFunction:function(a){return DataType.isFunctionValue(a)},isArray:function(a){return DataType.isArrayValue(a)},isDate:function(a){return DataType.isDateValue(a)},isObject:function(a){return DataType.isObjectValue(a)},isObjectEx:function(a){return DataType.isObjectExValue(a)},isSimpleType:function(b){var a=typeof(b);return(a=="string")||(a=="number")||(a=="boolean")||(a=="undefined")||(this.isNull(b))},isComplexType:function(a){return(!this.isSimpleType(a))},createChildStorageNode:function(c,b,a){},appendArrayItemStorageNode:function(b,c,a){},getNameForArrayItemStorageNode:function(a){var b=this.getDefaultArrayItemStorageName();return b},getChildStorageNode:function(a,b){},getAllArrayItemStorageNodes:function(a){},getAllStoredStorageNames:function(a){},setStorageNodeExplicitType:function(a,b){},getStorageNodeExplicitType:function(a){},getStorageNodeName:function(a){},isComplexStorageNode:function(a){},isComplexArrayItemStorageNode:function(a){},isSimpleStorageNode:function(a){},getValueExplicitType:function(a){if(a instanceof ObjectEx){return a.getClassName()}else{if(this.isObject(a)){return DataType.OBJECT}else{if(this.isArray(a)){return DataType.ARRAY}else{if(this.isDate(a)){return DataType.DATE}else{return(typeof a)}}}}},getDefaultArrayItemStorageName:function(){return"item"},getDefaultDateStorageName:function(){return"date"},save:function save(d,c,b){if(typeof(d)=="object"){var e=this.getObjCustomSaveMethod(d);if(e){return e(d,c,this)}}var a=this.doSave(d,c,b||{});if(a&&this.isFunction(d.saved)){d.saved()}return a},doSave:function(c,b,a){if(typeof(c)=="object"){if(c instanceof ObjectEx){this.doSaveObjectEx(c,b,a)}else{if(this.isArray(c)){this.doSaveArray(c,b)}else{if(this.isDate(c)){this.doSaveDate(c,b)}else{this.doSaveSimpleObject(c,b)}}}}this.setStorageNodeExplicitType(b,this.getValueExplicitType(c));return c},doSaveSimpleObject:function(d,b){for(var e in d){if(!d.hasOwnProperty(e)){continue}var a=d[e];var c;if(this.isComplexType(a)){c=this.getValueExplicitType(a)}this.doSaveFieldValue(d,e,a,b,c)}},doSaveArray:function(b,e){for(var c=0,a=b.length;c<a;++c){var d=b[c];var g=this.getNameForArrayItemStorageNode(d);if(this.isComplexType(d)){var f=this.appendArrayItemStorageNode(e,this.propNameToStorageName(g),this.isArray(d));this.setStorageNodeExplicitType(f,this.getValueExplicitType(d));this.save(d,f)}else{this.doAppendArrayItemSimpleValue(this.serializeValue(d),typeof(d),e)}}},doSaveDate:function(c,b){var a=c.toUTCString();this.doSaveSimpleValue(c,this.propNameToStorageName(this.getDefaultDateStorageName()),this.serializeValue(a),DataType.DATE,b)},doSaveObjectEx:function(f,b,m){var j=f.getAllPropList();var h=m.propFilter;for(var g=0,c=j.getLength();g<c;++g){var a=j.getPropInfoAt(g);var d=h?h(a,f):true;if(!d){continue}var e=this.getObjCustomPropSaveMethod(f);var k=false;if(e){k=e(f,a,b,this)}if(!!k){continue}if(a.serializable){this.doSaveObjectExProp(f,a,b,m)}}},doSaveObjectExProp:function(e,h,c,a){var b=h.name;var g=h.dataType;var f=e.getPropValue(b);if(a.saveDefaultValues||(f!==h.defaultValue)){var d;if(f instanceof ObjectEx){if(f.getClassName()!=g){d=f.getClassName()}}else{if(this.isComplexType(f)){d=this.getValueExplicitType(f);if(d==g){d=undefined}}}this.doSaveFieldValue(e,b,f,c,d)}},doSaveFieldValue:function(d,e,b,a,c){if(typeof(b)!="function"){if(this.isComplexType(b)){subNode=this.createChildStorageNode(a,this.propNameToStorageName(e),this.isArray(b));if(c){this.setStorageNodeExplicitType(subNode,c)}this.save(b,subNode)}else{this.doSaveSimpleValue(d,this.propNameToStorageName(e),this.serializeValue(b),this.getValueExplicitType(b),a)}}},doSaveSimpleValue:function(d,a,c,e,b){},doAppendArrayItemSimpleValue:function(b,c,a){},load:function(c,b){if(!c){var e=this.getStorageNodeExplicitType(b);if(e){c=DataType.createInstance(e)}else{if(this.doLoadUntypedNode){return this.doLoadUntypedNode(b)}else{return null}}}if(typeof(c)==="object"){var d=this.getObjCustomLoadMethod(c);if(d){return d(c,b,this)}}var a=this.doLoad(c,b);if(a&&this.isFunction(c.loaded)){c.loaded()}return a},doLoad:function(c,a){var b=this.getStorageNodeExplicitType(a);if(typeof(c)=="object"){if(c instanceof ObjectEx){c=this.doLoadObjectEx(c,a)}else{if(this.isArray(c)){c=this.doLoadArray(c,a)}else{if(this.isDate(c)){c=this.doLoadDate(c,a)}else{c=this.doLoadSimpleObject(c,a)}}}}return c},doLoadArray:function(j,a){var g=this.getAllArrayItemStorageNodes(a);for(var f=0,c=g.length;f<c;++f){var b=g[f];if(this.isComplexArrayItemStorageNode(b)){var e;var d=this.getStorageNodeExplicitType(b)||this.getStorageNodeName(b);if(d){e=DataType.createInstance(d);this.load(e,b)}else{e={};this.load(e,b)}j.push(e)}else{var h=this.deserializeValue(this.doGetArrayItemSimpleStorageValue(b));j.push(h)}}return j},doLoadDate:function(e,d){var a=this.propNameToStorageName(this.getDefaultDateStorageName());var b=this.doLoadSimpleValue(e,a,DataType.DATE,d);if(b){var c=new Date(b);e.copyFrom(c);return e}else{return undefined}},doLoadSimpleObject:function(d,a){var b=this.getAllStoredStorageNames(a);for(var e=0,c=b.length;e<c;++e){var k=b[e];var j=this.storageNameToPropName(k);var f=this.getChildStorageNode(a,k);if(f){var m;var h=this.getStorageNodeExplicitType(f);if(h){m=DataType.createInstance(h)}else{m={}}this.load(m,f);d[j]=m}else{var g=this.doLoadSimpleValue(d,k,null,a);d[j]=g}}return d},doLoadObjectEx:function(f,e){var d=f.getAllPropList();for(var c=0,a=d.getLength();c<a;++c){var h=d.getPropInfoAt(c);if(!h.serializable){continue}var g=this.getObjCustomPropLoadMethod(f);var b=false;if(g){b=g(f,h,e,this)}if(!!b){continue}this.doLoadObjectExProp(f,h,e)}return f},doLoadObjectExProp:function(c,f,b){var a=f.name;var e=f.dataType;var d=this.doLoadFieldValue(c,a,b,e);if((d!==null)&&(d!==undefined)){c.setPropValue(a,d,true)}},doLoadFieldValue:function(f,h,c,b){var a;var e=false;if(DataType.isComplexType(b)){var g=this.getChildStorageNode(c,this.propNameToStorageName(h));if(g){var d=this.getStorageNodeExplicitType(g);if(d&&(d!=b)){a=DataType.createInstance(d)}else{a=DataType.createInstance(b)}this.load(a,g);e=true}}if(DataType.isSimpleType(b)||(!e)){a=this.doLoadSimpleValue(f,this.propNameToStorageName(h),b,c)}return a},doLoadSimpleValue:function(d,a,e,c){var b=this.doLoadSimpleStorageValue(a,c);return this.deserializeValue(b,e)},doLoadSimpleStorageValue:function(a,b){},doGetArrayItemSimpleStorageValue:function(a){}});var JsonObjSerializer=Class.create(ObjSerializer,{CLASS_NAME:"JsonObjSerializer",TYPE_TAG_NAME:"__type__",createChildStorageNode:function(d,c,b){var a=b?[]:{};d[c]=a;return a},appendArrayItemStorageNode:function(c,d,b){var a=b?[]:{};c.push(a);return a},getChildStorageNode:function(b,c){var a=b[c];if(this.isSimpleType(a)){a=null}return a},getAllArrayItemStorageNodes:function(b){var a=Array.prototype.slice.call(b);return a},getAllStoredStorageNames:function(c){var a=[];for(var b in c){if(c.hasOwnProperty(b)){if(b!=this.TYPE_TAG_NAME){a.push(b)}}}return a},isComplexStorageNode:function(a){return this.isComplexType(a)},isComplexArrayItemStorageNode:function(a){return this.isComplexStorageNode(a)},isSimpleStorageNode:function(a){return this.isSimpleType(a)},setStorageNodeExplicitType:function(a,b){if(!this.isArray(a)){a[this.TYPE_TAG_NAME]=b}},getStorageNodeExplicitType:function(b){var a=b[this.TYPE_TAG_NAME]||null;if((!a)&&this.isArray(b)){return DataType.ARRAY}else{return a}},doSaveSimpleValue:function(d,a,c,e,b){b[a]=c},doAppendArrayItemSimpleValue:function(b,c,a){return a.push(b)},doLoadSimpleStorageValue:function(a,b){return b[a]},doLoadUntypedNode:function(a){return a},doGetArrayItemSimpleStorageValue:function(a){return a}});var XmlObjSerializer=Class.create(ObjSerializer,{CLASS_NAME:"XmlObjSerializer",TYPE_TAG_NAME:"dataType",getLocalName:function(a){return a.localName||a.baseName||a.nodeName},getElemTextValue:function(d){var a="";for(var c=0,b=d.childNodes.length;c<b;++c){if(d.childNodes[c].nodeType==Node.TEXT_NODE){a+=d.childNodes[c].nodeValue}}return a},serializeValue:function(a){return DataType.StringUtils.serializeValue(a)},deserializeValue:function(b,a){return DataType.StringUtils.deserializeValue(b,a)},createChildStorageNode:function(d,c,b){var a=d.ownerDocument.createElement(c);d.appendChild(a);return a},appendArrayItemStorageNode:function(b,c,a){return this.createChildStorageNode(b,c,a)},getAllArrayItemStorageNodes:function(b){var a=[];for(var d=0,c=b.childNodes.length;d<c;++d){var e=b.childNodes[d];if(e.nodeType==Node.ELEMENT_NODE){a.push(e)}}return a},getAllStoredStorageNames:function(f){var a=[];for(var c=0,b=f.childNodes.length;c<b;++c){var d=f.childNodes[c];if(d.nodeType==Node.ELEMENT_NODE){if(this.getLocalName(d)!=this.TYPE_TAG_NAME){a.push(this.getLocalName(d))}}}for(var c=0,b=f.attributes.length;c<b;++c){var e=f.attributes[c];if(this.getLocalName(e)!=this.TYPE_TAG_NAME){a.push(this.getLocalName(e))}}return a},getChildStorageNode:function(b,f){var a=null;for(var d=0,c=b.childNodes.length;d<c;++d){var e=b.childNodes[d];if(e.nodeType==Node.ELEMENT_NODE){if(this.getLocalName(e)==f){a=e}}}return a},isComplexStorageNode:function(a){return a.nodeType==Node.ELEMENT_NODE},isComplexArrayItemStorageNode:function(a){return this.isComplexStorageNode(a)&&(a.attributes.length)&&(!this.getElemTextValue(a).trim())},isSimpleStorageNode:function(a){return a.nodeType==Node.ATTRIBUTE_NODE},setStorageNodeExplicitType:function(a,b){a.setAttribute(this.TYPE_TAG_NAME,b)},getStorageNodeExplicitType:function(a){return a.getAttribute(this.TYPE_TAG_NAME)||null},getStorageNodeName:function(b){var a=b.tagName;if(a==this.getDefaultArrayItemStorageName()){return null}else{return a}},doSaveSimpleObject:function($super,b,a){$super(b,a)},doSaveArray:function($super,a,b){$super(a,b)},doSaveSimpleValue:function(d,a,c,e,b){b.setAttribute(a,c)},doAppendArrayItemSimpleValue:function(c,e,a){var b=this.appendArrayItemStorageNode(a,this.propNameToStorageName(this.getDefaultArrayItemStorageName()),false);var d=b.ownerDocument.createTextNode(c);b.appendChild(d)},doLoadSimpleStorageValue:function(a,b){return b.getAttribute(a)},doGetArrayItemSimpleStorageValue:function(a){return this.getElemTextValue(a)}});var ObjSerializerFactory={_serializerClasses:{},_defaultName:null,registerSerializer:function(a,c,b){var d=(typeof(c)=="string")?ClassEx.findClass(c):c;ObjSerializerFactory._serializerClasses[a]=d;if(b){ObjSerializerFactory._defaultName=a}},getSerializer:function(a){var b=a||ObjSerializerFactory._defaultName;if(b){var c=ObjSerializerFactory._serializerClasses[b];return c?new c():null}else{return null}}};(function(){ObjSerializerFactory.registerSerializer("json",JsonObjSerializer,true);ObjSerializerFactory.registerSerializer("xml",XmlObjSerializer)})();ClassEx.extend(ObjectEx,{saveObj:function(c,a,b){if(!a){serializer=ObjSerializerFactory.getSerializer()}else{if(typeof(a)=="string"){serializer=ObjSerializerFactory.getSerializer(a)}else{serializer=a}}return serializer.save(this,c,b)},loadObj:function(b,a){if(!a){serializer=ObjSerializerFactory.getSerializer()}else{if(typeof(a)=="string"){serializer=ObjSerializerFactory.getSerializer(a)}else{serializer=a}}return serializer.load(this,b)}});Object.extend(ClassEx,{saveObj:function(c,d,a,b){if(!a){serializer=ObjSerializerFactory.getSerializer()}else{if(typeof(a)=="string"){serializer=ObjSerializerFactory.getSerializer(a)}else{serializer=a}}return serializer.save(c,d,b)},loadObj:function(c,b,a){if(!a){serializer=ObjSerializerFactory.getSerializer()}else{if(typeof(a)=="string"){serializer=ObjSerializerFactory.getSerializer(a)}else{serializer=a}}return serializer.load(c,b)}});Object.extend(DataType,{valueToJson:function(c,b){if(DataType.isSimpleValue(c)){return JSON.stringify(c)}else{var a=DataType.isArrayValue(c)?[]:{};ClassEx.saveObj(c,a,"json",b);return JSON.stringify(a)}},jsonToValue:function(a){var b=JSON.parse(a);if(!b||DataType.isSimpleValue(b)){return b}else{return ClassEx.loadObj(null,b,"json")}}});var Kekule={LIBNAME:"Kekule.js",LIBNAME_CORE:"Kekule",VERSION:"0.6.0",LOADED:false,_afterLoadProcedures:[],PROP_AUTO_TITLE:true};Kekule._loaded=function(){Kekule.LOADED=true;var b=Kekule._afterLoadProcedures;while(b.length){var a=b.shift();if(a){a()}}};Kekule._isLoaded=function(){return Kekule.LOADED};Kekule._registerAfterLoadProc=function(a){if(a){Kekule._afterLoadProcedures.push(a)}};Kekule.$jsRoot=this;Kekule.scriptSrcInfo=Kekule.$jsRoot["__$kekule_load_info__"];if(Kekule.scriptSrcInfo&&Kekule.scriptSrcInfo.language){Kekule.language=Kekule.scriptSrcInfo.language}if(!Kekule.scriptSrcInfo&&Kekule.$jsRoot.document){Kekule.scriptSrcInfo=(function(){var g=/^(.*\/?)kekule\..*\.js(\?.*)?$/;var f=document.getElementsByTagName("script");var h;for(var d=f.length-1;d>=0;--d){var e=f[d];if(e.src){var b=e.src.match(g);if(b){var c=b[2];if(c){c=c.substr(1)}var a={src:e.src,path:b[1],paramStr:c,useMinFile:true};return a}}}return null})()}Kekule.getScriptPath=function(){return Kekule.scriptSrcInfo.path};if(Kekule.$jsRoot&&Kekule.$jsRoot.addEventListener&&Kekule.$jsRoot.postMessage){Kekule.$jsRoot.addEventListener("message",function(a){if(a.data==="kekule-sys-info-query"){Kekule.$jsRoot.postMessage({msg:"kekule-sys-info-result",libName:Kekule.LIBNAME,version:Kekule.VERSION},"*")}},false)}"use strict";(function(){if(false&&Kekule.PROP_AUTO_TITLE){var d=ClassEx.getPrototype(ObjectEx).defineProp;var b="TITLE_";var c="DES_";var a=function(f,m){if(!m.title&&!m.description){var h=this.getClassName();if(h.startsWith("Kekule.")){h=h.substr(7)}var e=b;var k=c;var g=e+f;var i=k+f;var j=Kekule.Localization.findValue("OBJDEF_TEXTS."+h+"."+g);var l=Kekule.Localization.findValue("OBJDEF_TEXTS."+h+"."+i);m.title=j;m.description=l}return d.apply(this,[f,m])};ClassEx.getPrototype(ObjectEx).defineProp=a}Kekule.ExceptionLevel={ERROR:-1,WARNING:-2,NOTE:-3,LOG:-4};Kekule.throwException=function(h,f){if(Kekule.exceptionHandler){return Kekule.exceptionHandler.throwException(h,f)}else{var g=Kekule.ExceptionLevel;if((!f)||(f===g.ERROR)){if(typeof(h)==="string"){h=new Kekule.Exception(h)}throw h}else{if(typeof(console)!=="undefined"){if(typeof(h)!=="string"){h=h.message}var i=(f===g.WARNING)?console.warn:(f===g.NOTE)?console.info:console.log;if(i){i(h)}else{console.log(h)}}}}};Kekule.getExceptionMsg=function(f){if(typeof(f)==="string"){return f}else{if(typeof(f)==="object"){return f.message}else{return""}}};Kekule.raise=Kekule.throwException;Kekule.error=function(f){return Kekule.raise(f,Kekule.ExceptionLevel.ERROR)};Kekule.chemError=function(f){if(typeof(f)=="string"){f=new Kekule.ChemError(f)}return Kekule.error(f)};Kekule.warn=function(f){return Kekule.raise(f,Kekule.ExceptionLevel.WARNING)};Kekule.notify=function(f){return Kekule.raise(f,Kekule.ExceptionLevel.NOTE)};Kekule.log=function(f){return Kekule.raise(f,Kekule.ExceptionLevel.LOG)};Kekule.hasLocalRes=function(){return !!Kekule.LOCAL_RES};Kekule.HashEx=Class.create({CLASS_NAME:"Kekule.HashEx",PROP_NAME_PREFIX:"__$key$__",initialize:function(){this._map={}},finalize:function(){this._map=null},keyToPropName:function(e){return this.PROP_NAME_PREFIX+e},has:function(e){return this._map.hasOwnProperty(this.keyToPropName(e))},set:function(e,f){this._map[this.keyToPropName(e)]=f;return this},get:function(f,e){var g=this.keyToPropName(f);if(this._map.hasOwnProperty(g)){return this._map[g]}else{return e}},remove:function(e){var f=this.keyToPropName(e);if(this._map.hasOwnProperty(f)){delete this._map[f]}return this},clear:function(){this._map={}}});Kekule.MapEx=Class.create({CLASS_NAME:"Kekule.MapEx",initialize:function(e){this.isWeak=!e;if(!Kekule.MapEx._inited){Kekule.MapEx._init()}if((!Kekule.MapEx._implementation)||(!this.isWeak)){this.keys=[];this.values=[]}else{this._implementation=new Kekule.MapEx._implementation()}},finalize:function($super){if(!this._implementation){this.keys=null;this.values=null}},set:function(f,g){if(this._implementation){this._implementation.set(f,g)}else{var e=this.keys.indexOf(f);if(e>=0){this.values[e]=g}else{this.keys.push(f);this.values.push(g)}}return this},get:function(g,e){if(this._implementation){return this._implementation.get(g,e)}else{var f=this.keys.indexOf(g);if(f>=0){return this.values[f]}else{return e}}},has:function(f){if(this._implementation){return this._implementation.has(f)}else{var e=this.keys.indexOf(f);return e>=0}},remove:function(f){if(this._implementation){return this._implementation["delete"](f)}else{var e=this.keys.indexOf(f);if(e>=0){this.keys.splice(e,1);this.values.splice(e,1)}}return this},clear:function(){if(!this._implementation){this.keys=[];this.values=[]}else{Kekule.error(Kekule.$L("ErrorMsg.CANNOT_CLEAR_WEAKMAP"))}return this},getKeys:function(){if(!this._implementation){return[].concat(this.keys)}else{Kekule.error(Kekule.$L("ErrorMsg.CANNOT_GET_KEY_LIST_IN_WEAKMAP"));return[]}},getValues:function(){if(!this._implementation){return this.values}else{Kekule.error(Kekule.$L("ErrorMsg.CANNOT_GET_VALUE_LIST_IN_WEAKMAP"));return[]}}});Kekule.MapEx._init=function(){if(Kekule.$jsRoot.WeakMap){Kekule.MapEx._implementation=Kekule.$jsRoot.WeakMap}else{Kekule.MapEx._implementation=null}Kekule.MapEx._inited=true};Kekule.MapEx._inited=false;Kekule.TwoTupleMapEx=Class.create({CLASS_NAME:"Kekule.TwoTupleMapEx",initialize:function(e){this.nonWeak=e;this.map=new Kekule.MapEx(e)},finalize:function(){this.map.finalize()},getSecondLevelMap:function(f,g){var e=this.map.get(f);if((!e)&&g){e=new Kekule.MapEx(this.nonWeak);this.map.set(f,e)}return e},set:function(f,e,g){var h=this.getSecondLevelMap(f,true);h.set(e,g);return this},get:function(g,f,e){var h=this.getSecondLevelMap(g,false);if(h){return h.get(f,e)}else{return e}},has:function(f,e){var g=this.getSecondLevelMap(f,false);if(g){return g.has(e)}else{return false}},remove:function(f,e){var g=this.getSecondLevelMap(f,false);if(g){return g.remove(e)}},clear:function(){this.map.clear()}});Kekule.CoordMode={UNKNOWN:0,COORD2D:2,COORD3D:3};Kekule.ClassDefineUtils={CommonSizeMethods:{getSizeOfMode:function(f,e){if(f===Kekule.CoordMode.COORD3D){return this.getSize3D(e)}else{return this.getSize2D(e)}},setSizeOfMode:function(f,e){if(e===Kekule.CoordMode.COORD3D){return this.setSize3D(f)}else{return this.setSize2D(f)}},getBoxOfMode:function(f,e){if(f===Kekule.CoordMode.COORD3D){return this.getBox3D(e)}else{return this.getBox2D(e)}}},Size2DMethods:{fetchSize2D:function(){var e=this.getPropStoreFieldValue("size2D");if(!e){e={};this.setPropStoreFieldValue("size2D",e)}return e},notifySize2DChanged:function(e){this.notifyPropSet("size2D",e)},hasSize2D:function(f){var g=this.getPropStoreFieldValue("size2D");var e=(g)&&((typeof(g.x)!="undefined")||(typeof(g.y)!="undefined"));if((!e)&&f){e=this.hasSize3D?this.hasSize3D():false}return e},getBox2D:function(e){var h=this.getCoord2D(e)||{x:0,y:0};var f=this.getSize2D(e);if(f&&(f.x||f.y)){var i={x:f.x,y:-f.y};var g=Kekule.CoordUtils.add(h,i);return{x1:h.x,y1:h.y,x2:g.x,y2:g.y}}else{return{x1:h.x,y1:h.y,x2:h.x,y2:h.y}}},get2DSizeX:function(e){var f=this.getSize2D(e);return f?f.x||0:0},set2DSizeX:function(e){var f=fetchSize2D();if(f.x!=e){f.x=e;notifySize2DChanged(f)}},get2DSizeY:function(e){var f=this.getSize2D(e);return f?f.y||0:0},set2DSizeY:function(f){var e=fetchSize2D();if(e.y!=f){e.y=f;notifySize2DChanged(e)}}},Size3DMethods:{fetchSize3D:function(){var e=this.getPropStoreFieldValue("size3D");if(!e){e={};this.setPropStoreFieldValue("size3D",e)}return e},notifySize3DChanged:function(e){this.notifyPropSet("size3D",e)},hasSize3D:function(f){var g=this.getPropStoreFieldValue("size3D");var e=(g)&&((typeof(g.x)!=="undefined")||(typeof(g.y)!=="undefined")||(typeof(g.z)!=="undefined"));if((!e)&&f){e=this.hasSize2D?this.hasSize2D():false}return e},getBox3D:function(e){var h=this.getCoord3D(e);var f=this.getSize3D(e);if(h&&f){var g=Kekule.CoordUtils.add(h,f);return{x1:h.x,y1:h.y,z1:h.z,x2:g.x,y2:g.y,z2:g.z}}},get3DSizeX:function(e){var f=this.getSize3D(e);return f?f.x||0:0},set3DSizeX:function(e){var f=fetchSize3D();if(f.x!=e){f.x=e;notifySize3DChanged(f)}},get3DSizeY:function(e){var f=this.getSize3D(e);return f?f.y||0:0},set3DSizeY:function(f){var e=fetchSize3D();if(e.y!=f){e.y=f;notifySize3DChanged(e)}},get3DSizeZ:function(e){var f=this.getSize3D(e);return f?f.z||0:0},set3DSizeZ:function(e){var f=fetchSize3D();if(f.z!=e){f.z=e;notifySize3DChanged(f)}}},addStandardSizeSupport:function(f,e){ClassEx.extend(f,Kekule.ClassDefineUtils.CommonSizeMethods);if((!e)||(e.indexOf("size2D")>=0)){ClassEx.defineProp(f,"size2D",{dataType:DataType.HASH,getter:function(h,i){var j=this.getPropStoreFieldValue("size2D");if((!j)&&h){if(this.hasSize3D()){j=this.getSize3D()}}if((!j)&&i){j={x:0,y:0};this.setPropStoreFieldValue("size2D",j)}var g=j?{x:j.x,y:j.y}:undefined;return g},setter:function(g){var h=this.fetchSize2D();if(g.x!==undefined){h.x=g.x}if(g.y!==undefined){h.y=g.y}this.notifySize2DChanged(h)}});ClassEx.extend(f,Kekule.ClassDefineUtils.Size2DMethods)}if((!e)||(e.indexOf("size3D")>=0)){ClassEx.defineProp(f,"size3D",{dataType:DataType.HASH,getter:function(h,i){var j=this.getPropStoreFieldValue("size3D");if((!j)&&h){if(this.hasSize2D()){j=this.getSize2D();j.z=0}}if((!j)&&i){j={x:0,y:0,z:0};this.setPropStoreFieldValue("size3D",j)}var g=j?{x:j.x,y:j.y,z:j.z}:undefined;return g},setter:function(g){var h=this.fetchSize3D();if(g.x!==undefined){h.x=g.x}if(g.y!==undefined){h.y=g.y}if(g.z!==undefined){h.z=g.z}this.notifySize3DChanged(h)}});ClassEx.extend(f,Kekule.ClassDefineUtils.Size3DMethods)}},CommonCoordMethods:{getCoordOfMode:function(f,e){if(f===Kekule.CoordMode.COORD3D){return this.getCoord3D(e)}else{return this.getCoord2D(e)}},setCoordOfMode:function(f,e){if(e===Kekule.CoordMode.COORD3D){return this.setCoord3D(f)}else{return this.setCoord2D(f)}},getAbsCoordOfMode:function(f,e){if(f===Kekule.CoordMode.COORD3D){return this.getAbsCoord3D(e)}else{return this.getAbsCoord2D(e)}},setAbsCoordOfMode:function(f,e){if(e===Kekule.CoordMode.COORD3D){return this.setAbsCoord3D(f)}else{return this.setAbsCoord2D(f)}}},Coord2DMethods:{fetchCoord2D:function(){var e=this.getPropStoreFieldValue("coord2D");if(!e){e={};this.setPropStoreFieldValue("coord2D",e)}return e},notifyCoord2DChanged:function(e){this.notifyPropSet("coord2D",e)},hasCoord2D:function(f){var g=this.getPropStoreFieldValue("coord2D");var e=(g)&&((typeof(g.x)!="undefined")||(typeof(g.y)!="undefined"));if((!e)&&f){e=this.hasCoord3D?this.hasCoord3D():false}return e},get2DX:function(e){var f=this.getCoord2D(e);return f?f.x||0:0},set2DX:function(e){var f=fetchCoord2D();if(f.x!=e){f.x=e;notifyCoord2DChanged(f)}},get2DY:function(e){var f=this.getCoord2D(e);return f?f.y||0:0},set2DY:function(f){var e=fetchCoord2D();if(e.y!=f){e.y=f;notifyCoord2DChanged(e)}}},Coord3DMethods:{fetchCoord3D:function(){var e=this.getPropStoreFieldValue("coord3D");if(!e){e={};this.setPropStoreFieldValue("coord3D",e)}return e},notifyCoord3DChanged:function(e){this.notifyPropSet("coord3D",e)},hasCoord3D:function(f){var g=this.getPropStoreFieldValue("coord3D");var e=(g)&&((typeof(g.x)!="undefined")||(typeof(g.y)!="undefined")||(typeof(g.z)!="undefined"));if((!e)&&f){e=this.hasCoord2D?this.hasCoord2D():false}return e},get3DX:function(e){var f=this.getCoord3D(e);return f?f.x||0:0},set3DX:function(e){var f=fetchCoord3D();if(f.x!=e){f.x=e;notifyCoord3DChanged(f)}},get3DY:function(e){var f=this.getCoord3D(e);return f?f.y||0:0},set3DY:function(f){var e=fetchCoord3D();if(e.y!=f){e.y=f;notifyCoord3DChanged(e)}},get3DZ:function(e){var f=this.getCoord3D(e);return f?f.z||0:0},set3DZ:function(e){var f=fetchCoord3D();if(f.z!=e){f.z=e;notifyCoord3DChanged(f)}}},addStandardCoordSupport:function(f,e){ClassEx.extend(f,Kekule.ClassDefineUtils.CommonCoordMethods);if((!e)||(e.indexOf("coord2D")>=0)){ClassEx.defineProp(f,"coord2D",{dataType:DataType.HASH,getter:function(h,i){var j=this.getPropStoreFieldValue("coord2D");if((!j)&&h){if(this.hasCoord3D()){j=this.getCoord3D()}}if((!j)&&i){j={x:0,y:0};this.setPropStoreFieldValue("coord2D",j)}var g=j?{x:j.x,y:j.y}:undefined;return g},setter:function(g){var h=this.fetchCoord2D();if(g.x!==undefined){h.x=g.x}if(g.y!==undefined){h.y=g.y}this.notifyCoord2DChanged(h)}});ClassEx.extend(f,Kekule.ClassDefineUtils.Coord2DMethods)}if((!e)||(e.indexOf("coord3D")>=0)){ClassEx.defineProp(f,"coord3D",{dataType:DataType.HASH,getter:function(h,i){var j=this.getPropStoreFieldValue("coord3D");if((!j)&&h){if(this.hasCoord2D()){j=this.getCoord2D();j.z=0}}if((!j)&&i){j={x:0,y:0,z:0};this.setPropStoreFieldValue("coord3D",j)}var g=j?{x:j.x,y:j.y,z:j.z}:undefined;return g},setter:function(g){var h=this.fetchCoord3D();if(g.x!==undefined){h.x=g.x}if(g.y!==undefined){h.y=g.y}if(g.z!==undefined){h.z=g.z}this.notifyCoord3DChanged(h)}});ClassEx.extend(f,Kekule.ClassDefineUtils.Coord3DMethods)}if((!e)||(e.indexOf("absCoord2D")>=0)){ClassEx.defineProp(f,"absCoord2D",{dataType:DataType.HASH,serializable:false,getter:function(h){var j=this.getCoord2D(h)||{};var i=this.getParent?this.getParent():null;var g;if(i&&i.getAbsCoord2D){return Kekule.CoordUtils.add(j,i.getAbsCoord2D(h)||{})}else{return Object.extend({},j)}},setter:function(g){var h=g;if(this.getParent&&this.getParent()&&this.getParent().getAbsCoord2D){h=Kekule.CoordUtils.substract(g,this.getParent().getAbsCoord2D())}this.setCoord2D(h)}})}if((!e)||(e.indexOf("absCoord3D")>=0)){ClassEx.defineProp(f,"absCoord3D",{dataType:DataType.HASH,serializable:false,getter:function(g){var i=this.getCoord3D(g)||{};var h=this.getParent?this.getParent():null;if(h&&h.getAbsCoord3D){return Kekule.CoordUtils.add(i,h.getAbsCoord3D(g)||{})}else{return Object.extend({},i)}},setter:function(g){var h=g;if(this.getParent&&this.getParent()){h=Kekule.CoordUtils.substract(g,this.getParent().getAbsCoord3D())}this.setCoord3D(h)}})}},ExtraObjMapMethods:{getExtraProp:function(g,e){var f=this.getExtraObjMap().get(g);if(f){return e?f[e]:f}else{return undefined}},setExtraProp:function(g,e,h){var f=this.getExtraProp(g);if(f){f[e]=h}else{var f={};f[e]=h;this.getExtraObjMap().set(g,f)}},removeExtraProp:function(g,e){if(e){var f=this.getExtraProp(g);f[e]=undefined;delete f[e]}else{this.getExtraObjMap().remove(g)}}},addExtraObjMapSupport:function(f){var e="extraObjMap";ClassEx.defineProp(f,e,{dataType:"Kekule.MapEx",serializable:false,getter:function(){var g=this.getPropStoreFieldValue(e);if(!g){g=new Kekule.MapEx(true);this.setPropStoreFieldValue(e,g)}return g}});ClassEx.extend(f,Kekule.ClassDefineUtils.ExtraObjMapMethods)},ExtraTwoTupleObjMapMethods:{getExtraProp2:function(h,g,e){var f=this.getExtraTwoTupleObjMap().get(h,g);if(f){return e?f[e]:f}else{return undefined}},setExtraProp2:function(i,g,e,h){var f=this.getExtraProp2(i,g);if(f){f[e]=h}else{var f={};f[e]=h;this.getExtraTwoTupleObjMap().set(i,g,f)}},removeExtraProp2:function(h,g,e){if(e){var f=this.getExtraProp2(h,g);f[e]=undefined;delete f[e]}else{this.getExtraTwoTupleObjMap().remove(h,g)}}},addExtraTwoTupleObjMapSupport:function(f){var e="extraTwoTupleObjMap";ClassEx.defineProp(f,e,{dataType:"Kekule.TwoTupleMapEx",serializable:false,getter:function(){var g=this.getPropStoreFieldValue(e);if(!g){g=new Kekule.TwoTupleMapEx(true);this.setPropStoreFieldValue(e,g)}return g}});ClassEx.extend(f,Kekule.ClassDefineUtils.ExtraTwoTupleObjMapMethods)}};Kekule.ObjPropSettingManager={_items:new Kekule.MapEx(true),register:function(e,f){Kekule.ObjPropSettingManager._items.set(e,f)},unregister:function(e){Kekule.ObjPropSettingManager._items.remove(e)},getSetting:function(e){return Kekule.ObjPropSettingManager._items.get(e)}};ClassEx.defineProp(ObjectEx,"predefinedSetting",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLIC,setter:function(k){var n=Kekule.StrUtils.splitTokens(k||"",",");if(n.length){for(var g=0,f=n.length;g<f;++g){var j=this.getClass();var m=n[g];var o=null;var e="";while(j&&!o){var h=ClassEx.getClassName(j);var e=h+"."+m;var o=Kekule.ObjPropSettingManager.getSetting(e);j=ClassEx.getSuperClass(j)}if(!o){o=Kekule.ObjPropSettingManager.getSetting(m)}if(o){this.setPropValues(o)}}this.setPropStoreFieldValue("predefinedSetting",e)}}});Kekule.ChemObjInteractMode={DEFAULT:0,HIDDEN:-1};Kekule.ChemObject=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemObject",initialize:function($super,e){$super();if(e){this.setId(e)}this.setBubbleEvent(true)},doFinalize:function($super){this.removeSelf();$super()},initProperties:function(){this.defineProp("id",{dataType:DataType.STRING});this.defineProp("interactMode",{dataType:DataType.INT});this.defineProp("info",{dataType:DataType.HASH,getter:function(f){var e=this.getPropStoreFieldValue("info");if((!e)&&f){e={};this.setPropStoreFieldValue("info",e)}return e}});this.defineProp("scalarAttribs",{dataType:DataType.ARRAY,setter:null});this.defineProp("parent",{dataType:"Kekule.ChemObject",serializable:false,scope:Class.PropertyScope.PUBLIC,setter:function(f){var e=this.getParent();if(e===f){return}if(e&&e._removeChildObj){e._removeChildObj(this)}this.setPropStoreFieldValue("parent",f);if(f&&f._appendChildObj){f._appendChildObj(this)}this.parentChanged(f)}});this.defineProp("owner",{dataType:"Kekule.ChemSpace",serializable:false,scope:Class.PropertyScope.PUBLIC,setter:function(f){var e=this.getOwner();if(e===f){return}if(e){e._removeOwnedObj(this)}this.setPropStoreFieldValue("owner",f);if(f){f._appendOwnedObj(this)}this.ownerChanged(f)}});this.defineProp("srcInfo",{dataType:DataType.OBJECT,serializable:false,scope:Class.PropertyScope.PUBLISHED,getter:function(){var e=this.getPropStoreFieldValue("srcInfo");if(!e){e={};this.setPropStoreFieldValue("srcInfo",e)}return e}})},getHigherLevelObj:function(){return this.getParent()||this.getOwner()},getAutoIdPrefix:function(){return"o"},isSelectable:function(){return this.getInteractMode()!==Kekule.ChemObjInteractMode.HIDDEN},getNearestSelectableObject:function(){return this.isSelectable()?this:this.getParent()?this.getParent().getNearestSelectableObject():null},removeSelf:function(){this.setParent(null);this.setOwner(null)},notifyScalarAttribsChange:function(){this.notifyPropSet("scalarAttribs",this.getPropStoreFieldValue("scalarAttribs"))},notifyInfoChange:function(){this.notifyPropSet("info",this.getPropStoreFieldValue("info"))},ownerChanged:function(f){for(var g=0,e=this.getScalarAttribCount();g<e;++g){this.getScalarAttribAt(g).setOwner(f)}},parentChanged:function(e){},isChildOf:function(f){var e=this.getParent();while(e&&(e!==f)){e=e.getParent?e.getParent():null}return(!!e)},getNextSibling:function(){var e=this.getParent();if(e&&e.getNextSiblingOfChild){return e.getNextSiblingOfChild(this)}else{return null}},getChildCount:function(){return 0},getChildAt:function(e){return null},indexOfChild:function(e){return -1},isEmpty:function(){return false},clearIds:function(){this.setId(null);for(var f=0,e=this.getChildCount();f<e;++f){var g=this.getChildAt(f);if(g.clearIds){g.clearIds()}}},assignTo:function($super,g,f){var e=$super(g);if(!f&&g.clearIds){g.clearIds()}return e},assign:function(f,e){return f.assignTo(this,e)},clone:function(f){var g=this.getClass();var e=new g();this.assignTo(e,f);return e},getScalarAttribCount:function(){var e=this.getScalarAttribs();return e?e.length:0},getScalarAttribAt:function(f){var e=this.getScalarAttribs();return e?e[f]:null},appendScalarAttrib:function(e){if(!this.getScalarAttribs()){this.setPropStoreFieldValue("scalarAttribs",[])}var f=Kekule.ArrayUtils.pushUniqueEx(this.getScalarAttribs(),e);if(f.isPushed){e.setParent(this);this.notifyScalarAttribsChange()}return f.index},removeScalarAttribAt:function(e){if(!this.getScalarAttribs()){return null}else{var f=Kekule.ArrayUtils.removeAt(this.getScalarAttribs(),e);if(f){f.setParent(null);this.notifyScalarAttribsChange()}return f}},removeScalarAttrib:function(e){if(!this.getScalarAttribs()){return null}else{var f=Kekule.ArrayUtils.remove(this.getScalarAttribs(),e);if(f){f.setParent(null);this.notifyScalarAttribsChange()}return f}},getInfoKeys:function(){return this.getInfo()?Kekule.ObjUtils.getOwnedFieldNames(this.getInfo()):[]},getInfoValue:function(e){return this.getInfo()?this.getInfo()[e]:null},setInfoValue:function(e,f){this.doGetInfo(true)[e]=f;this.notifyInfoChange()}});Kekule.Scalar=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Scalar",initialize:function($super,h,e,g,f){$super(h);if(e){this.setName(e)}if(typeof(g)!=="undefined"){this.setValue(g)}if(f){this.setUnit(f)}},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING});this.defineProp("value",{dataType:DataType.PRIMARY});this.defineProp("errorValue",{dataType:DataType.PRIMARY});this.defineProp("unit",{dataType:DataType.STRING});this.defineProp("title",{dataType:DataType.STRING})}});Kekule.ChemObjList=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemObjList",initialize:function($super,f,e){$super(f);this.setPropStoreFieldValue("itemBaseClass",e)},initProperties:function(){this.defineProp("itemBaseClass",{dataType:DataType.CLASS,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("items",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(f){var e=this.getPropStoreFieldValue("items");if((!e)&&f){e=[];this.setPropStoreFieldValue("items",e)}return e}})},loaded:function($super){this.ownerChanged(this.getOwner());this.parentChanged(this.getParent())},ownerChanged:function($super,e){this.changeAllItemsOwner();$super(e)},parentChanged:function($super,e){this.changeAllItemsParent();$super(e)},isEmpty:function(){return result&&(this.getItemCount()<=0)},checkItemType:function(f){var g=this.getItemBaseClass();var e=g?f instanceof g:true;if(!e){Kekule.raise(Kekule.$L("ErrorMsg.LIST_ITEM_CLASS_MISMATCH"))}return e},notifyItemsChange:function(){this.notifyPropSet("items",this.getPropStoreFieldValue("items"))},getItemOwner:function(){return this.getOwner()},changeAllItemsOwner:function(){var g=this.getItems();if(g){var e=this.getItemOwner();for(var h=0,f=g.length;h<f;++h){var j=g[h];if(j&&j.setOwner){j.setOwner(e)}}}},getItemParent:function(){return this.getParent()||this},changeAllItemsParent:function(){var f=this.getItems();if(f){var h=this.getItemParent();for(var g=0,e=f.length;g<e;++g){var j=f[g];if(j&&j.setParent){j.setParent(h)}}}},getItemCount:function(){var e=this.getPropStoreFieldValue("items");return e?e.length:0},getItemAt:function(f){var e=this.getPropStoreFieldValue("items");return e?e[f]:null},indexOf:function(f){var e=this.getPropStoreFieldValue("items");return e?e.indexOf(f):-1},getNextSiblingOfChild:function(f){var e=this.indexOf(f);return(e>=0)?this.getItemAt(e+1):null},append:function(f){this.checkItemType(f);if(f){var e=Kekule.ArrayUtils.pushUniqueEx(this.doGetItems(true),f);if(e.isPushed){this.notifyItemsChange();if(f.setOwner){f.setOwner(this.getItemOwner())}if(f.setParent){f.setParent(this.getItemParent())}}return e.index}else{return -1}},insert:function(g,e){this.checkItemType(g);if(g){var f=Kekule.ArrayUtils.insertUniqueEx(this.doGetItems(true),g,e);if(f.isInserted){this.notifyItemsChange();if(g.setOwner){g.setOwner(this.getItemOwner())}if(g.setParent){g.setParent(this.getItemParent())}}return f.index}else{return -1}},insertBefore:function(g,e){if(!e){return this.append(g)}else{var f=this.indexOf(e);return(f>=0)?this.insert(g,f):this.append(g)}},removeAt:function(e){if(this.getItems()){var f=Kekule.ArrayUtils.removeAt(this.getItems(),e);if(f){if(f.setOwner){f.setOwner(null)}if(f.setParent){f.setParent(null)}this.notifyItemsChange()}return f}},remove:function(f){if(this.getItems()){var e=Kekule.ArrayUtils.remove(this.getItems(),f);if(e){if(e.setOwner){e.setOwner(null)}if(e.setParent){e.setParent(null)}this.notifyItemsChange()}return e}},removeChild:function(e){return this.remove(e)},toArray:function(){return this.getItems()},getContainerBox:function(k,g){var e;var m=this.toArray();for(var h=0,f=m.length;h<f;++h){var n=m[h];var j=n.getContainerBox?n.getContainerBox(k,g):null;if(j){if(!e){e=Object.extend({},j)}else{e=Kekule.BoxUtils.getContainerBox(e,j)}}}return e}});Kekule.ChemSpaceElement=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemSpaceElement",initialize:function($super,f){$super(f);var e=new Kekule.ChemObjList(null,Kekule.ChemObject);e.setParent(this);e.addEventListener("change",function(){this.objectChange(["children"])},this);this.setPropStoreFieldValue("children",e)},initProperties:function(){this.defineProp("children",{dataType:"Kekule.ChemObjList",scope:Class.PropertyScope.PUBLIC,setter:function(f){var e=this.getChildren();if(e){e.finalize()}if(f){f.setParent(this);f.setOwner(this.getOwner())}this.setPropStoreFieldValue("children",f)}})},ownerChanged:function($super,e){this.getChildren().setOwner(e)},_removeChildObj:function(f){var e=this.indexOfChild(f);if(e>=0){this.removeChildAt(e)}},getChildCount:function(){return this.getChildren().getItemCount()},getChildAt:function(e){return this.getChildren().getItemAt(e)},indexOfChild:function(e){return this.getChildren().indexOf(e)},getNextSiblingOfChild:function(e){return this.getChildren().getNextSiblingOfChild(e)},appendChild:function(e){return this.getChildren().append(e)},insertChild:function(f,e){return this.getChildren().insert(f,e)},insertBefore:function(f,e){return this.getChildren().insertBefore(f,e)},removeChildAt:function(e){return this.getChildren().removeChildAt(e)},removeChild:function(e){return this.getChildren().removeChild(e)}});Kekule.ChemSpace=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemSpace",initialize:function($super,f){$super(f);this._autoIdMap={};this.setPropStoreFieldValue("enableAutoId",true);this.setPropStoreFieldValue("ownedObjs",[]);var e=new Kekule.ChemSpaceElement();this.setPropStoreFieldValue("root",e);e.setParent(this);e.setOwner(this)},initProperties:function(){this.defineProp("ownedObjs",{dataType:DataType.ARRAY,serializable:false,setter:null,scope:Class.PropertyScope.PUBLIC});this.defineProp("root",{dataType:"Kekule.ChemSpaceElement",setter:null});this.defineProp("enableAutoId",{dataType:DataType.BOOL});this.defineProp("objScreenLengthRatio",{dataType:DataType.FLOAT,serializable:false,scope:Class.PropertyScope.PRIVATE});this.defineProp("screenSize",{dataType:DataType.HASH,getter:function(){var e=this.getPropStoreFieldValue("screenSize")||{};return{x:e.x,y:e.y}},setter:function(e){var f=this.getPropStoreFieldValue("screenSize");if(!f){f={};this.setPropStoreFieldValue("screenSize",f)}f.x=e.x;f.y=e.y}})},loaded:function($super){$super();var e=this.getRoot();if(e){e.setParent(this);e.setOwner(this)}},notifyOwnedObjsChange:function(){this.notifyPropSet("ownedObjs",this.getPropStoreFieldValue("ownedObjs"))},getChildren:function(){return this.getRoot().getChildren().toArray()},getChildCount:function(){return this.getRoot().getChildCount()},getChildAt:function(e){return this.getRoot().getChildAt(e)},indexOfChild:function(e){return this.getRoot().indexOfChild(e)},getNextSiblingOfChild:function(e){return this.getRoot().getNextSiblingOfChild(e)},appendChild:function(e){return this.getRoot().appendChild(e)},insertChild:function(f,e){return this.getRoot().insertChild(f,e)},insertBefore:function(f,e){return this.getRoot().insertBefore(f,e)},removeChildAt:function(e){return this.getRoot().removeChildAt(e)},removeChild:function(e){return this.getRoot().removeChild(e)},getObjById:function(h){for(var f=0,e=this.getOwnedObjCount();f<e;++f){var g=this.getOwnedObjAt(f);if(g.getId){if(g.getId()==h){return g}}}return null},getAutoId:function(h,f){var g;if(h){g=h.getAutoIdPrefix?h.getAutoIdPrefix():"o"}else{g="o"}var g=h.getAutoIdPrefix?h.getAutoIdPrefix():"o";var e;if(Kekule.ObjUtils.notUnset(f)){e=f}else{e=this._autoIdMap[g]||0;++e}var e=this._getAutoIdIndex(g,e);this._autoIdMap[g]=e;return g+Number(e).toString()},_getAutoIdIndex:function(g,f){var j=f||0;var e=j;var h=g+Number(e).toString();while(this.getObjById(h)){++e;h=g+Number(e).toString()}return e},assignAutoIdToObj:function(e){if(e.setId){var f=this.getAutoId(e);e.setId(f)}},getOwnedObjCount:function(){return this.getOwnedObjs().length},getOwnedObjAt:function(e){return this.getOwnedObjs()[e]},indexOfOwnedObj:function(e){return this.getOwnedObjs().indexOf(e)},_appendOwnedObj:function(e){if(this.indexOfOwnedObj(e)>=0){return}else{if(this.getEnableAutoId()){if(e.getId&&!e.getId()){this.assignAutoIdToObj(e)}}this.getOwnedObjs().push(e);this.notifyOwnedObjsChange()}},_removeOwnedObjAt:function(e){var f=this.getOwnedObjAt(e);if(f){this.getOwnedObjs().splice(e,1);this.notifyOwnedObjsChange()}},_removeOwnedObj:function(f){var e=this.getOwnedObjs().indexOf(f);if(e>=0){this._removeOwnedObjAt(e)}}});Kekule.ClassDefineUtils.addStandardSizeSupport(Kekule.ChemSpace);Kekule.ChemDocument=Class.create(Kekule.ChemSpace,{CLASS_NAME:"Kekule.ChemDocument",initProperties:function(){}})})();Kekule.ExceptionHandler=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ExceptionHandler",initProperties:function(){this.defineEvent("exceptionThrown")},notifyExceptionThrown:function(b,a){var c={exception:b,level:a};this.invokeEvent("exceptionThrown",c);return c},throwException:function(d,b){var c=Kekule.ExceptionLevel;if(!b){b=c.ERROR}var g=this.notifyExceptionThrown(d,b||c.ERROR);if(!g.stop){if((!b)||(b===c.ERROR)){var a=d;if(typeof(d)==="string"){a=new Kekule.Exception(d)}throw a}else{if(typeof(console)!=="undefined"){if(typeof(d)!=="string"){d=d.message}var f=(b===c.WARNING)?"warn":(b===c.NOTE)?"info":"log";if(f){console[f](d)}else{console.log(d)}}}}},raise:function(b,a){return this.throwException(b,a||Kekule.ExceptionLevel.ERROR)}});Kekule.ExceptionHandler.getInstance=function(){if(!this.instance){this.instance=new Kekule.ExceptionHandler()}return this.instance};Kekule.exceptionHandler=Kekule.ExceptionHandler.getInstance();Kekule.Exception=function(b,a){this.message=b;this.name=a};Kekule.Exception.prototype=new Error();Kekule.Exception.prototype.constructor=Kekule.Exception;Object.extend(Kekule.Exception.prototype,{getMessage:function(){return this.message}});Kekule.Error=function(b,a){this.message=b;this.name=a};Kekule.Error.prototype=Kekule.Exception.prototype;Kekule.Error.prototype.constructor=Kekule.Error;Kekule.ChemError=function(b,a){this.message=b;this.name=a};Kekule.ChemError.prototype=Kekule.Error.prototype;Kekule.ChemError.prototype.constructor=Kekule.ChemError;if(typeof(console)=="undefined"){console={log:function(){},warn:function(){},info:function(){},error:function(){}}}Kekule.oneOf=function(){var b=arguments;var d=Kekule.ObjUtils.notUnset;for(var c=0,a=b.length;c<a;++c){if(d(b[c])){return b[c]}}return null};Kekule.ClassUtils={getShortClassName:function(a){var b=a.indexOf(".");if(b>=0){return a.substring(b+1)}else{return a}},getLastClassName:function(a){var b=a.lastIndexOf(".");return(b>=0)?a.substring(b+1):a},makeSingleton:function(a){return Object.extend(a,{_instance:null,getInstance:function(k,j,i,h,g,f,e,d,c,b){if(!a._instance){a._instance=new a(k,j,i,h,g,f,e,d,c,b)}return a._instance}})}};Kekule.NumUtils={isInteger:function(a){return(typeof(a)==="number")&&(parseInt(a,10)===parseFloat(a))},toDecimals:function(a,e){if(Kekule.NumUtils.isInteger(a)){return a.toString()}var g=Math.pow(10,e);var h=Math.round(a*g);h=h/g;var b=parseInt(h);var d=h-b;var c=d.toString();if(c.length>e+2){c=c.substr(2,e);return b.toString()+"."+c}else{return h.toString()}},isFloatEqual:function(b,c,a){if(Kekule.ObjUtils.isUnset(a)){a=1e-100}return Math.abs(b-c)<=a}};Kekule.ObjUtils={getPrototypeOf:function(a){return Object.getPrototypeOf?Object.getPrototypeOf(a):(a.prototype||a.__proto__)},getOwnedFieldNames:function(c,b){var a=[];for(var d in c){if(c.hasOwnProperty(d)&&(b||typeof(c[d])!="function")){a.push(d)}}return a},replacePropName:function(c,b,a){if(c[b]!==undefined){if(c.hasOwnProperty(b)){c[a]=c[b];delete c[b]}else{Kekule.raise(Kekule.$L("ErrorMsg.NON_OWN_PROPERTY_CANNOT_BE_REPLACED"))}}return c},isUnset:function(a){return(a===null)||(typeof(a)=="undefined")},notUnset:function(a){return(a!==null)&&(typeof(a)!=="undefined")},equal:function(c,a,b){for(var d in c){if(b&&(b.indexOf(d)>=0)){continue}if(c[d]!==a[d]){return false}}return true},match:function(a,c){for(var b in c){if(c.hasOwnProperty(b)){if(a[b]!==c[b]){return false}}}return true},isInstanceOf:function(d,c){if(!DataType.isArrayValue(c)){return(d instanceof c)}else{for(var b=0,a=c.length;b<a;++b){if(d instanceof c[b]){return true}}return false}},getLeafFieldCascadeNames:function(c,b){var d=function(i,g,h,e){for(var j in h){if(h.hasOwnProperty(j)&&(e||typeof(h[j])!="function")){var f=h[j];if(typeof(f)==="object"){d(i,g+j+".",f,e)}else{i.push(g+j)}}}};var a=[];d(a,"",c,b);return a}};Kekule.ArrayUtils={isArray:function(a){if(a){return((typeof(a)=="object")&&(a.length!==undefined))}else{return false}},toArray:function(a){if(Kekule.ArrayUtils.isArray(a)){return a}else{return[a]}},clone:function(a){return a.slice(0)},pushUnique:function(c,b){var a=Kekule.ArrayUtils.pushUniqueEx(c,b);return a?a.index:null},pushUniqueEx:function(f,e){if(DataType.isArrayValue(e)){var d;for(var c=0,a=e.length;c<a;++c){if(Kekule.ObjUtils.isUnset(d)){d=Kekule.ArrayUtils.pushUniqueEx(f,e[c])}else{Kekule.ArrayUtils.pushUniqueEx(f,e[c])}}return d}else{if(!e){return{index:-1,isPushed:false}}var b=f.indexOf(e);if(b<0){return{index:f.push(e),isPushed:true}}else{return{index:b,isPushed:false}}}},insertUnique:function(c,b,a){return Kekule.ArrayUtils.insertUniqueEx(c,b,a).index},insertUniqueEx:function(d,c,a){if(!c){return{index:-1,isInserted:false}}if(Kekule.ObjUtils.isUnset(a)||(a<0)){a=d.length}var b=d.indexOf(c);if(b<0){d.splice(a,0,c);return{index:a,isInserted:true}}else{if(b!=a){d.splice(b,1);d.splice(a,0,c);return{index:a,isInserted:false}}}},removeAt:function(c,a){var b=c[a];if(typeof(b)!="undefined"){c.splice(a,1);return b}else{return null}},remove:function(c,b){var a=c.indexOf(b);if(a>=0){return Kekule.ArrayUtils.removeAt(c,a)}else{return null}},changeIndex:function(c,d,a){if((d>=0)&&(d<=c.length)){var b=c[d];c.splice(d,1);c.splice(a,0,b);return b}else{return null}},changeItemIndex:function(d,c,b){var a=d.indexOf(c);return Kekule.ArrayUtils.changeIndex(d,a,b)},toUnique:function(f){var c=[];for(var g=0,d=f.length;g<d;++g){var h=f[g];if(c.indexOf(h)<0){c.push(h)}}return c},getUniqueElemCount:function(d){var c=Kekule.ArrayUtils.toUnique(d);return c.length},reverse:function(d){var b=[];for(var e=0,c=d.length;e<c;++e){if(Kekule.ObjUtils.notUnset(d[e])){b[c-e-1]=d[e]}}return b},randomize:function(d){var a=[];var c=d.slice(0);while(c.length>1){var b=Math.round(Math.random()*(c.length-1));a.push(c.splice(b,1)[0])}a.push(c[0]);return a},exclude:function(f,g){var a=[];var e=Kekule.ArrayUtils.toArray(g);for(var c=0,b=f.length;c<b;++c){var d=f[c];if(e.indexOf(d)<0){a.push(d)}}return a},intersect:function(d,b){var a=[];for(var e=0,c=d.length;e<c;++e){if(b.indexOf(d[e])>=0){a.push(d[e])}}return a},compare:function(d,a,g){if(!g){g=function(j,i){return(j>i)?1:(j<i)?-1:0}}var c=Math.min(d.length,a.length);for(var h=0;h<c;++h){var e=d[h];var b=a[h];var f=g(e,b);if(f!==0){return f}}if(d.length>c){return 1}else{if(a.length>c){return -1}else{return 0}}},compareNestedArray:function(c,b,a){var d=Math.min(c.length,b.length);if(!a){a=function(m,l){return m-l}}for(var e=0;e<d;++e){var k=0;var g=c[e];var f=b[e];var j=DataType.isArrayValue(g);var h=DataType.isArrayValue(f);if(j&&h){k=Kekule.ArrayUtils.compareNestedArray(g,f,a)}else{if(j){k=1}else{if(h){k=-1}else{k=a(g,f)}}}if(k!=0){return k}}if(c.length>d){return 1}else{if(b.length>d){return -1}else{return 0}}},group:function(e,a){if(!a){a=function(k,i){return(k<i)?-1:(k>i)?1:0}}var g=Kekule.ArrayUtils.clone(e);g.sort(a);var j=[];var b;for(var d=0,c=g.length;d<c;++d){var h=g[d];if(b&&a(h,b)===0){var f=j.length?j[j.length-1]:null;if(!Kekule.ArrayUtils.isArray(f)){j.pop();f=[b];j.push(f)}f.push(h)}else{j.push(h)}b=h}return j},getMedian:function(b){var d=[].concat(b);var c=d.length;if(c===0){return null}if(c<=1){return d[0]}else{d.sort(function(f,e){return f-e});return(c%2)?d[(c+1)>>1]:(d[c>>1]+d[(c>>1)+1])/2}},sortHashArray:function(g,c){var d="!";var e=[];for(var f=0,b=c.length;f<b;++f){var a={};var h=c[f]||"";if(h.startsWith(d)){a.field=h.substr(1);a.desc=true}else{a.field=h;a.desc=false}e.push(a)}var j=function(r,p){var k=0;for(var n=0,m=e.length;n<m;++n){var o=e[n].field;var s=r[o]||"";var q=p[o]||"";k=(s>q)?1:(s<q)?-1:0;if(e[n].desc){k=-k}if(k!==0){break}}return k};g.sort(j);return g}};Kekule.StrUtils={STR_TRUES:["true","yes","t","y"],STR_FALSES:["false","no","f","n"],trim:function(a){return a.replace(/^\s*|\s*$/g,"")},normalizeSpace:function(a){return a.replace(/^\s*|\s(?=\s)|\s*$/g,"")},convertToStr:function(a){return""+a},convertToType:function(a,b){if(typeof(a)!="string"){return a}switch(b){case DataType.FLOAT:case DataType.NUMBER:return parseFloat(a);break;case DataType.INT:return parseInt(a);break;case DataType.BOOL:return Kekule.StrUtils.strToBool(a);break;default:return a}},boolToStr:function(a){if(a){return Kekule.StrUtils.STR_TRUES[0]}else{return Kekule.StrUtils.STR_FALSES[0]}},strToBool:function(d){var b=d.toLowerCase();for(var c=0,a=Kekule.StrUtils.STR_FALSES.length;c<a;++c){if(b==Kekule.StrUtils.STR_FALSES[c]){return false}}return !!d},removeAroundPair:function(c,b,a){if(c.startsWith(b)&&c.endsWith(a)){return c.substring(b.length,c.length-b.length-a.length+1)}else{return c}},unquote:function(c){var b=Kekule.StrUtils.removeAroundPair;var a=c;a=b(a,"'","'");a=b(a,'"','"');return a},splitTokens:function(c,b){if(!c){return[]}if(DataType.isArrayValue(c)){return c}else{var a=b?new RegExp(b,"g"):/\s+/g;return c.replace(a," ").split(" ")}},hasToken:function(d,a,c){var b=Kekule.StrUtils.splitTokens(d,c);return(b.indexOf(a)>=0)},addTokens:function(g,e,d){var c=Kekule.StrUtils.splitTokens(g,d);var f=Kekule.StrUtils.splitTokens(e,d);for(var b=0,a=f.length;b<a;++b){if(c.indexOf(f[b])<0){c.push(f[b])}}return c.join(d||" ")},removeTokens:function(h,g,f){var e=Kekule.StrUtils.splitTokens(h,f);var d=Kekule.StrUtils.splitTokens(g,f);for(var c=0,a=d.length;c<a;++c){var b=e.indexOf(d[c]);if(b>=0){e.splice(b,1)}}return e.join(f||" ")},toggleTokens:function(g,h,d){var f=Kekule.StrUtils.splitTokens(g,d);var a=Kekule.StrUtils.splitTokens(h,d);var j=[];for(var c=0,b=a.length;c<b;++c){var e=f.indexOf(a[c]);if(e>=0){f.splice(e,1)}else{j.push(a[c])}}f=f.concat(j);return f.join(d||" ")},getLineCount:function(c,b){if(!b){b="\n"}var a=c.split(b);return a.length},getMaxLineCharCount:function(g,f){if(!f){f="\n"}var d=g.split(f);var a=0;for(var e=0,c=d.length;e<c;++e){var b=d[e];a=Math.max(b.length,a)}return a}};Kekule.RoleMapUtils={KEY_ITEM:"item",KEY_ROLE:"role",NON_EXPLICIT_ROLE:null,createMap:function(b,c){var a={};c=c||Kekule.RoleMapUtils.NON_EXPLICIT_ROLE;a[Kekule.RoleMapUtils.KEY_ITEM]=b;a[Kekule.RoleMapUtils.KEY_ROLE]=c;return a},getItem:function(a){return a[Kekule.RoleMapUtils.KEY_ITEM]},setItem:function(b,a){b[Kekule.RoleMapUtils.KEY_ITEM]=a},getRole:function(a){return a[Kekule.RoleMapUtils.KEY_ROLE]},setRole:function(a,b){a[Kekule.RoleMapUtils.KEY_ROLE]=b}};Kekule.FactoryUtils={MATCH_EXACTLY:0,MATCH_BY_CLASS:1,DEF_ITEM_STORE_FIELD_NAME:"_items",createSimpleFactory:function(b){var c=Kekule.FactoryUtils;var a={_items:new Kekule.MapEx(true),_matchMethod:b||Kekule.FactoryUtils.MATCH_EXACTLY,register:function(d,e){a._items.set(d,e)},unregister:function(d){a._items.remove(d)},getClass:function(d){if(a._matchMethod===c.MATCH_EXACTLY){return a._items.get(d)}else{if(a._matchMethod===c.MATCH_BY_CLASS){var f=a._items.get(d);if(!f){var e=ClassEx.getSuperClass(d);if(e){f=a.getClass(e)}}return f}}},getInstance:function(m,n,l,j,i,h,g,f,e,d){var k=a.getClass(m);if(k){return new k(n,l,j,i,h,g,f,e,d)}}};return a}};Kekule.UrlUtils={EXT_DELIMITER:".",PATH_DELIMITER:"/",SEARCH_DELIMITER:"?",SEARCH_PAIR_DELIMITER:"&",KEY_VALUE_DELIMITER:"=",HASH_DELIMITER:"#",extractFileName:function(a){if(!a){return null}var b=a.lastIndexOf(Kekule.UrlUtils.PATH_DELIMITER);if(b>=0){return a.substr(b+1)}else{return a}},extractFileExt:function(a){var c=Kekule.UrlUtils.extractFileName(a);if(c){var b=c.lastIndexOf(Kekule.UrlUtils.EXT_DELIMITER);if(b>=0){return c.substr(b+1)}else{return""}}else{return null}},extractFileCoreName:function(a){var c=Kekule.UrlUtils.extractFileName(a);if(c){var b=c.lastIndexOf(Kekule.UrlUtils.EXT_DELIMITER);if(b>=0){return c.substr(0,b)}else{return""}}else{return null}},extractSearch:function(a){if(!a){return null}var b=a.lastIndexOf(Kekule.UrlUtils.SEARCH_DELIMITER);if(b>=0){return a.substr(b)}else{return null}},analysisSearch:function(b,e){var j=Kekule.UrlUtils.extractSearch(b)||"";j=j.substr(1);var c=j.split(Kekule.UrlUtils.SEARCH_PAIR_DELIMITER);var k=e?{}:[];for(var g=0,d=c.length;g<d;++g){var f=c[g];var h=f.split(Kekule.UrlUtils.KEY_VALUE_DELIMITER);if(h[0]){if(e){k[h[0]]=h[1]}else{k.push({key:h[0],value:h[1]})}}}return k},generateSearchString:function(h){var b=Kekule.UrlUtils;var g=[];var e=Kekule.ObjUtils.getOwnedFieldNames(h);for(var d=0,a=e.length;d<a;++d){var c=e[d];var f=h[c];if(Kekule.ObjUtils.notUnset(f)){var f=encodeURIComponent(""+f);g.push(c+b.KEY_VALUE_DELIMITER+f)}}return g.join(b.SEARCH_PAIR_DELIMITER)},generateUrl:function(d,f,e){var c=Kekule.UrlUtils;var b=d;if(f){var a=c.generateSearchString(f);b+=c.SEARCH_DELIMITER+a}if(e){b+=c.HASH_DELIMITER+e}return b}};Kekule.MatrixUtils={create:function(n,q,h){var s=false;var p=false;var o=Kekule.ObjUtils;if(o.notUnset(h)){s=true;if(Kekule.ArrayUtils.isArray(h)){p=true}}var g=0;var b=new Array(n);for(var f=0,c=b.length;f<c;++f){var a=new Array(q);if(s){for(var e=0,d=a.length;e<d;++e){if(p&&o.notUnset(h[g])){a[e]=h[g];++g}else{a[e]=h}}}b[f]=a}return b},createIdentity:function(b){var a=Kekule.MatrixUtils.create(b,b,0);for(var c=0;c<b-1;++c){a[c][c]=1}return a},getRowCount:function(a){return a.length},getColCount:function(a){return(Kekule.MatrixUtils.getRowCount(a)>0)?a[0].length:0},getValue:function(a,c,b){return a[c-1][b-1]||0},setValue:function(a,d,b,c){a[d-1][b-1]=c},transpose:function(b){var h=Kekule.MatrixUtils;var c=h.getColCount(b);var g=h.getRowCount(b);var a=h.create(c,g);for(var e=1;e<=c;++e){var f=a[e-1];for(var d=1;d<=g;++d){f[d-1]=h.getValue(b,d,e)}}return a},minus:function(g){var e=Kekule.MatrixUtils;var f=e.getRowCount(g);var h=e.getColCount(g);var k=this.create(f,h);for(var d=0;d<f;++d){var a=k[d];var b=g[d];for(var c=0;c<h;++c){a[c]=-(b[c]||0)}}},add:function(e,c){var h=Kekule.MatrixUtils;var b=h.getRowCount(e);var g=h.getColCount(e);var a=this.create(b,g);for(var f=1;f<=b;++f){for(var d=1;d<=g;++d){h.setValue(a,f,d,h.getValue(e,f,d)+h.getValue(c,f,d))}}return a},substract:function(b,a){var c=Kekule.MatrixUtils;return c.add(b,c.minus(a))},multiply:function(l,h){var e=Kekule.MatrixUtils;var f=e.getRowCount(l);var g=e.getColCount(h);var m=e.create(f,g);for(var c=1;c<=f;++c){for(var b=1;b<=g;++b){var d=0;for(var a=1;a<=f;++a){d+=e.getValue(l,c,a)*e.getValue(h,a,b)}e.setValue(m,c,b,d)}}return m}};Kekule.CoordUtils={create:function(b,d,c){var a={x:b,y:d};if(c||(c===0)){a.z=c}return a},is3D:function(a){return(a.z||(a.z===0))},isEqual:function(c,b){var a=(c.x===b.x)&&(c.y===b.y);var d=Kekule.ObjUtils;if(a&&(d.notUnset(c.z)||d.notUnset(b.z))){a=(c.z===b.z)}return a},isZero:function(c,b){var a=Kekule.ObjUtils.notUnset(b)?b:0;return(Math.abs(c.x||0)<=a)&&(Math.abs(c.y||0)<=a)&&(Math.abs(c.z||0)<=a)},add:function(c,b){var a={};if(!(Kekule.ObjUtils.isUnset(c.x)&&(Kekule.ObjUtils.isUnset(b.x)))){a.x=(c.x||0)+(b.x||0)}if(!(Kekule.ObjUtils.isUnset(c.y)&&(Kekule.ObjUtils.isUnset(b.y)))){a.y=(c.y||0)+(b.y||0)}if(!(Kekule.ObjUtils.isUnset(c.z)&&(Kekule.ObjUtils.isUnset(b.z)))){a.z=(c.z||0)+(b.z||0)}return a},substract:function(c,b){var a={};if(!(Kekule.ObjUtils.isUnset(c.x)&&(Kekule.ObjUtils.isUnset(b.x)))){a.x=(c.x||0)-(b.x||0)}if(!(Kekule.ObjUtils.isUnset(c.y)&&(Kekule.ObjUtils.isUnset(b.y)))){a.y=(c.y||0)-(b.y||0)}if(!(Kekule.ObjUtils.isUnset(c.z)&&(Kekule.ObjUtils.isUnset(b.z)))){a.z=(c.z||0)-(b.z||0)}return a},multiply:function(c,b){var a={};if(!Kekule.ObjUtils.isUnset(c.x)){a.x=c.x*b}if(!Kekule.ObjUtils.isUnset(c.y)){a.y=c.y*b}if(!Kekule.ObjUtils.isUnset(c.z)){a.z=c.z*b}return a},divide:function(b,a){return Kekule.CoordUtils.multiply(b,1/a)},standardize:function(b){var a=Math.sqrt(Math.sqr(b.x||0)+Math.sqr(b.y||0)+Math.sqr(b.z||0));return Kekule.CoordUtils.divide(b,a)},toArray:function(b){var a=[];a.push(b.x,b.y);if(Kekule.CoordUtils.is3D(b)){a.push(b.z)}},transform2D:function(d,c){var b=Kekule.CoordUtils.calcTransform2DMatrix(c);var a=Kekule.CoordUtils.transform2DByMatrix(d,b);return a},inverseTransform2D:function(d,c){var b=Kekule.CoordUtils.calcInverseTransform2DMatrix(c);var a=Kekule.CoordUtils.transform2DByMatrix(d,b);return a},transform2DByMatrix:function(d,b){var c=Kekule.MatrixUtils;var a=c.create(3,1,[d.x||0,d.y||0,1]);a=c.multiply(b,a);return{x:a[0][0],y:a[1][0]}},calcTransform2DMatrix:function(c,d){var i=Kekule.MatrixUtils;var j=c||{};var p=j.center;if(p){var q=i.create(3,3,[1,0,-(p.x||0),0,1,-(p.y||0),0,0,1]);var h=i.create(3,3,[1,0,(p.x||0),0,1,(p.y||0),0,0,1])}if(j.rotateAngle){var r=j.rotateAngle;var o=Math.cos(r);var f=Math.sin(r);var b=i.create(3,3,[o,-f,0,f,o,0,0,0,1])}var t=j.scale;var n=j.scaleX;var m=j.scaleY;var l=t||1;if(t||n||m){var e=i.create(3,3);i.setValue(e,1,1,n||l);i.setValue(e,2,2,m||l);i.setValue(e,3,3,1)}var u=j.translateX;var s=j.translateY;if(u||s){var k=i.create(3,3);i.setValue(k,1,1,1);i.setValue(k,2,2,1);i.setValue(k,3,3,1);i.setValue(k,1,3,(u||0));i.setValue(k,2,3,(s||0))}var g=i.create(3,3,[1,0,0,0,1,0,0,0,1]);if(!d){if(q){g=i.multiply(q,g)}if(b){g=i.multiply(b,g)}if(e){g=i.multiply(e,g)}if(k){g=i.multiply(k,g)}if(h){g=i.multiply(h,g)}}else{if(q){g=i.multiply(q,g)}if(k){g=i.multiply(k,g)}if(e){g=i.multiply(e,g)}if(b){g=i.multiply(b,g)}if(h){g=i.multiply(h,g)}}return g},calcInverseTransform2DMatrix:function(a){var b=Object.create(a);if(a.center){b.center={x:a.center.x,y:a.center.y}}if(b.scale){b.scale=1/b.scale}if(b.scaleX){b.scaleX=1/b.scaleX}if(b.scaleY){b.scaleY=1/b.scaleY}if(b.translateX){b.translateX=-b.translateX}if(b.translateY){b.translateY=-b.translateY}if(b.rotateAngle){b.rotateAngle=-b.rotateAngle}return Kekule.CoordUtils.calcTransform2DMatrix(b,true)},transform3D:function(c,b){var a=Kekule.CoordUtils.calcTransform3DMatrix(b);return Kekule.CoordUtils.transform3DByMatrix(c,a)},transform3DByMatrix:function(d,b){var c=Kekule.MatrixUtils;var a=c.create(4,1,[d.x||0,d.y||0,d.z||0,1]);a=c.multiply(b,a);return{x:a[0][0],y:a[1][0],z:a[2][0]}},_calcRotateXYZ3DMatrixCore:function(b){var m=Kekule.MatrixUtils;var o=m.create(4,4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);var q=[];if(b.rotateAngle&&b.rotateAxisVector){var n=Kekule.CoordUtils.standardize(b.rotateAxisVector);q.push({vector:[n.x,n.y,n.z],angle:-b.rotateAngle})}else{var f=b.rotateX;var e=b.rotateY;var d=b.rotateZ;if(f){q.push({vector:[1,0,0],angle:-f})}if(e){q.push({vector:[0,1,0],angle:-e})}if(d){q.push({vector:[0,0,1],angle:-d})}}for(var u=0,r=q.length;u<r;++u){var a=m.create(4,4);var w=q[u].angle;var g=q[u].vector;var x=Math.cos(w);var c=Math.sin(w);var p;for(var u=1;u<=4;++u){for(var t=1;t<=4;++t){if((u<4)&&(t<4)){for(var s=1;s<=3;++s){if((s!==u)&&(s!==t)){break}}var h=g[u-1]*g[t-1];p=(u<t)?h*(1-x)-Math.pow(-1,u+t)*g[s-1]*c:(u>t)?h*(1-x)+Math.pow(-1,u+t)*g[s-1]*c:h+(1-h)*x}else{if(u===t){p=1}else{p=0}}m.setValue(a,u,t,p)}}o=m.multiply(a,o)}return o},calcRotate3DMatrix:function(d){var g=Kekule.MatrixUtils;var f=Object.extend({},d||{});var e;if(f.rotateMatrix){e=f.rotateMatrix}else{var a=f.center;if(a){var b=g.create(4,4,[1,0,0,-(a.x||0),0,1,0,-(a.y||0),0,0,1,-(a.z||0),0,0,0,1]);var c=g.create(4,4,[1,0,0,(a.x||0),0,1,0,(a.y||0),0,0,1,(a.z||0),0,0,0,1])}var e=Kekule.CoordUtils._calcRotateXYZ3DMatrixCore(d);if(b){e=g.multiply(b,e)}if(c){e=g.multiply(c,e)}}return e},calcTransform3DMatrix:function(b){var g=Kekule.MatrixUtils;var h=b||{};var o=h.center;if(o){var p=g.create(4,4,[1,0,0,-(o.x||0),0,1,0,-(o.y||0),0,0,1,-(o.z||0),0,0,0,1]);var e=g.create(4,4,[1,0,0,(o.x||0),0,1,0,(o.y||0),0,0,1,(o.z||0),0,0,0,1])}var f=["rotateX","rotateY","rotateZ","rotateAngle","rotateAxisVector","rotateMatrix"];var k=Object.copyValues({},h,f);var a=Kekule.CoordUtils.calcRotate3DMatrix(k);var r=h.scale;var n=h.scaleX;var m=h.scaleY;var l=h.scaleZ;if(r||n||m||l){var j=r||1;var c=g.create(4,4);g.setValue(c,1,1,n||j);g.setValue(c,2,2,m||j);g.setValue(c,3,3,l||j);g.setValue(c,4,4,1)}var t=h.translateX;var s=h.translateY;var q=h.translateZ;if(t||s||q){var i=g.create(4,4);g.setValue(i,1,1,1);g.setValue(i,2,2,1);g.setValue(i,3,3,1);g.setValue(i,4,4,1);g.setValue(i,1,4,t||0);g.setValue(i,2,4,s||0);g.setValue(i,3,4,q||0)}var d=g.create(4,4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);if(p){d=g.multiply(p,d)}if(a){d=g.multiply(a,d)}if(c){d=g.multiply(c,d)}if(i){d=g.multiply(i,d)}if(e){d=g.multiply(e,d)}return d},calcInverseTransform3DMatrix:function(a){var b=Object.create(a);if(a.center){b.center={x:a.center.x,y:a.center.y,z:a.center.z}}if(b.scale){b.scale=1/b.scale}if(b.scaleX){b.scaleX=1/b.scaleX}if(b.scaleY){b.scaleY=1/b.scaleY}if(b.scaleZ){b.scaleZ=1/b.scaleZ}if(b.translateX){b.translateX=-b.translateX}if(b.translateY){b.translateY=-b.translateY}if(b.translateZ){b.translateZ=-b.translateZ}if(b.rotateAngle){b.rotateAngle=-b.rotateAngle}if(b.rotateX){b.rotateX=-b.rotateX}if(b.rotateX){b.rotateY=-b.rotateY}if(b.rotateZ){b.rotateZ=-b.rotateZ}return Kekule.CoordUtils.calcTransform3DMatrix(b,true)},calcCoordGroup2DTransformParams:function(e,c,l,k){var m=Kekule.CoordUtils;var d=m.getDistance(e,c);var i=m.substract(c,e);var g=Math.atan2(i.y,i.x);var f=m.getDistance(l,k);var b=m.substract(k,l);var h=Math.atan2(b.y,b.x);var a=m.substract(l,e);var j={translateX:a.x,translateY:a.y,scale:f/d,rotateAngle:h-g,center:e};return j},getDistance:function(c,b){if(!b){b={x:0,y:0,z:0}}var a=Math.sqr(b.x-c.x)+Math.sqr(b.y-c.y);if(Kekule.ObjUtils.notUnset(c.z)&&Kekule.ObjUtils.notUnset(b.z)){a+=Math.sqr(b.z-c.z)}return Math.sqrt(a)},getCenter:function(d){var c=d.length;if(c<=0){return null}var b=Object.extend(d[0]);for(var a=1;a<c;++a){b=Kekule.CoordUtils.add(b,d[a])}return Kekule.CoordUtils.divide(b,c)},insideRect:function(c,a,b){return((c.x-a.x)*(c.x-b.x)<=0)&&((c.y-a.y)*(c.y-b.y)<=0)},isInsideBox:function(e,d){var c=d;var a=(Math.sign(e.x-c.x1)*Math.sign(e.x-c.x2)<=0)&&(Math.sign(e.y-c.y1)*Math.sign(e.y-c.y2)<=0);if(Kekule.ObjUtils.notUnset(e.z)){a=a&&(Math.sign(e.z-c.z1)*Math.sign(e.z-c.z2)<=0)}return a},getContainerBox:function(d){var f={};var a={};var b=d.length;if(b>0){f=Object.extend({},d[0]);a=Object.extend({},d[0])}else{return null}for(var c=1;c<b;++c){var e=d[c];f.x=Math.min(f.x,e.x);f.y=Math.min(f.y,e.y);a.x=Math.max(a.x,e.x);a.y=Math.max(a.y,e.y);if(Kekule.ObjUtils.notUnset(f.z)){f.z=Math.min(f.z,e.z);a.z=Math.max(a.z,e.z)}}return Kekule.BoxUtils.createBox(f,a)}};Kekule.GeometryUtils={getVectorScalarProduct:function(c,b){var a=(c.x||0)*(b.x||0)+(c.y||0)*(b.y||0)+(c.z||0)*(b.z||0);return a},getVectorCrossProduct:function(c,b){var a={x:(c.y||0)*(b.z||0)-(c.z||0)*(b.y||0),y:(c.z||0)*(b.x||0)-(c.x||0)*(b.z||0),z:(c.x||0)*(b.y||0)-(c.y||0)*(b.x||0)};return a},getVectorIncludedAngle:function(e,d){var c=Kekule.CoordUtils;var h=Kekule.GeometryUtils.getVectorCrossProduct(e,d);var g={x:0,y:0,z:0};var b=(c.getDistance(e,g)*c.getDistance(d,g));var f=c.getDistance(h,g)/b;var a=Math.asin(f);return a},getDihedralAngleOfVectors:function(j,i,g){var m=Kekule.CoordUtils;var b=Kekule.GeometryUtils;var k=b.getVectorCrossProduct(j,i);var a=b.getVectorCrossProduct(i,g);var e=m.getDistance(i)/100000;if(m.isZero(k,e)||m.isZero(a,e)){return -1}var c=m.standardize(i);var f=b.getVectorScalarProduct(b.getVectorCrossProduct(k,a),c);var h=b.getVectorScalarProduct(k,a);var l=Math.atan2(f,h);if(l<0){l+=Math.PI*2}return l},getDihedralAngleOfPoints:function(e,d,b,a){var c=Kekule.CoordUtils;var h=c.substract(d,e);var g=c.substract(b,d);var f=c.substract(a,b);return Kekule.GeometryUtils.getDihedralAngleOfVectors(h,g,f)}};Kekule.BoxUtils={createBox:function(g,f){var a={};var c=g.x||0;var e=g.y||0;var b=f.x||0;var d=f.y||0;(c<=b)?(a.x1=c,a.x2=b):(a.x1=b,a.x2=c);(e<=d)?(a.y1=e,a.y2=d):(a.y1=d,a.y2=e);if(Kekule.ObjUtils.notUnset(g.z)&&Kekule.ObjUtils.notUnset(f.z)){(g.z<=f.z)?(a.z1=g.z,a.z2=f.z):(a.z1=f.z,a.z2=g.z)}return a},convertToRect:function(c){var a=Kekule.BoxUtils.normalize(c);return Kekule.RectUtils.createRect(a.x1,a.y1,a.x2-a.x1,a.y2-a.y1)},normalize:function(b){var a={x1:Math.min(b.x1,b.x2),y1:Math.min(b.y1,b.y2),x2:Math.max(b.x1,b.x2),y2:Math.max(b.y1,b.y2)};if(Kekule.ObjUtils.notUnset(b.z1)&&Kekule.ObjUtils.notUnset(b.z2)){a.z1=Math.min(b.z1,b.z2);a.z2=Math.max(b.z1,b.z2)}return a},shiftBox:function(d,c,b,a){var j=c||0;var h=b||0;var g=a||0;var f={x:d.x1+j,y:d.y1+h};var e={x:d.x2+j,y:d.y2+h};if(Kekule.ObjUtils.notUnset(d.z1)&&Kekule.ObjUtils.notUnset(d.z2)){f.z=d.z1+g;e.z=d.z2+g}var i=Kekule.BoxUtils.createBox(f,e);return i},inflateBox:function(c,e,d,b){if(Kekule.ObjUtils.isUnset(d)){d=e}if(Kekule.ObjUtils.isUnset(b)){b=e}var a=Kekule.BoxUtils.normalize(c);var a={x1:a.x1-e,y1:a.y1-d,x2:a.x2+e,y2:a.y2+d};if(Kekule.ObjUtils.notUnset(a.z1)&&Kekule.ObjUtils.notUnset(a.z2)){a.z1=a.z1-b;a.z2=a.z2+b}return a},getContainerBox:function(d,b){if(!d){return Object.extend({},b)}else{if(!b){return Object.extend({},d)}}var e=Kekule.BoxUtils.normalize(d);var c=Kekule.BoxUtils.normalize(b);var a={x1:Math.min(e.x1,c.x1),y1:Math.min(e.y1,c.y1),x2:Math.max(e.x2,c.x2),y2:Math.max(e.y2,c.y2)};if(Kekule.ObjUtils.notUnset(e.z1)&&Kekule.ObjUtils.notUnset(e.z2)&&Kekule.ObjUtils.notUnset(c.z1)&&Kekule.ObjUtils.notUnset(c.z2)){a.z1=Math.min(e.z1,c.z1);a.z2=Math.max(e.z2,c.z2)}return a},getIntersection:function(c,a){var d=Kekule.BoxUtils.normalize(c);var b=Kekule.BoxUtils.normalize(a);var e={x1:Math.max(d.x1,b.x1),y1:Math.max(d.y1,b.y1),x2:Math.min(d.x2,b.x2),y2:Math.max(d.y2,b.y2)};if((e.x1>=e.x2)||(e.y1>=e.y2)){return null}if(Kekule.ObjUtils.notUnset(d.z1)&&Kekule.ObjUtils.notUnset(d.z2)&&Kekule.ObjUtils.notUnset(b.z1)&&Kekule.ObjUtils.notUnset(b.z2)){e.z1=Math.max(d.z1,b.z1);e.z2=Math.min(d.z2,b.z2);if(e.z1>=e.z2){return null}}return e},hasIntersection:function(b,a){return !!Kekule.BoxUtils.getIntersection(b,a)},isEqual:function(b,a){return(Math.min(b.x1,b.x2)===Math.min(a.x1,a.x2))&&(Math.max(b.x1,b.x2)===Math.max(a.x1,a.x2))&&(Math.min(b.y1,b.y2)===Math.min(a.y1,a.y2))&&(Math.max(b.y1,b.y2)===Math.max(a.y1,a.y2))},isInside:function(a,c){var d=a;var b=c;return(Math.min(d.x1,d.x2)>=Math.min(b.x1,b.x2))&&(Math.max(d.x1,d.x2)<=Math.max(b.x1,b.x2))&&(Math.min(d.y1,d.y2)>=Math.min(b.y1,b.y2))&&(Math.max(d.y1,d.y2)<=Math.max(b.y1,b.y2))},getCenterCoord:function(b){var a={x:(b.x1||0+b.x2||0)/2,y:(b.y1||0+b.y2||0)/2};if(Kekule.ObjUtils.notUnset(b.z1)||Kekule.ObjUtils.notUnset(b.z2)){a.z=(b.z1||0+b.z2||0)/2}return a},getMinMaxCoords:function(d){var c=Kekule.BoxUtils.normalize(d);var a={min:{x:c.x1,y:c.y1},max:{x:c.x2,y:c.y2}};if(Kekule.ObjUtils.notUnset(c.z1)){a.min.z=c.z1;a.max.z=c.z2}return a},getCornerCoords:function(c){var a=Kekule.BoxUtils.normalize(c);if(Kekule.ObjUtils.isUnset(a.z1)){return[{x:a.x1,y:a.y1},{x:a.x1,y:a.y2},{x:a.x2,y:a.y1},{x:a.x2,y:a.y2}]}else{return[{x:a.x1,y:a.y1,z:a.z1},{x:a.x1,y:a.y2,z:a.z1},{x:a.x2,y:a.y1,z:a.z1},{x:a.x2,y:a.y2,z:a.z1},{x:a.x1,y:a.y1,z:a.z2},{x:a.x1,y:a.y2,z:a.z2},{x:a.x2,y:a.y1,z:a.z2},{x:a.x2,y:a.y2,z:a.z2}]}},transform2D:function(e,b){var f=Kekule.BoxUtils.getCornerCoords(e);var d=[];for(var c=0,a=f.length;c<a;++c){d.push(Kekule.CoordUtils.transform2D(f[c],b))}return Kekule.CoordUtils.getContainerBox(d)},transform3D:function(e,b){var f=Kekule.BoxUtils.getCornerCoords(e);var d=[];for(var c=0,a=f.length;c<a;++c){d.push(Kekule.CoordUtils.transform3D(f[c],b))}return Kekule.CoordUtils.getContainerBox(d)}};Kekule.RectUtils={createRect:function(e,d,c,b){var a={left:e,top:d,width:c,height:b};return a},isZero:function(a){return(a.width===0)&&(a.height===0)},convertToBox:function(b){var c=Kekule.CoordUtils.create(b.left,b.top);var a=Kekule.CoordUtils.create(b.left+b.width,b.top+b.height);return Kekule.BoxUtils.createBox(c,a)},inflateRect:function(d,c,b){if(Kekule.ObjUtils.isUnset(b)){b=c}var a=Kekule.RectUtils.createRect(d.left,d.top,d.width+c,d.height+b);return a},shiftRect:function(f,d,b){var e=d||0;var c=b||0;var a=Kekule.RectUtils.createRect(f.left+e,f.top+c,f.width,f.height);return a},getContainerRect:function(d,b){var e=Kekule.RectUtils.convertToBox(d);var c=Kekule.RectUtils.convertToBox(b);var a=Kekule.BoxUtils.getContainerBox(e,c);return Kekule.BoxUtils.convertToRect(a)},getIntersection:function(d,b){var e=Kekule.RectUtils.convertToBox(d);var c=Kekule.RectUtils.convertToBox(b);var a=Kekule.BoxUtils.getIntersection(e,c);return a?Kekule.BoxUtils.convertToRect(a):null},hasIntersection:function(b,a){return !!Kekule.RectUtils.getIntersection(b,a)}};Kekule.ZoomUtils={PREDEFINED_ZOOM_RATIOS:[0.1,0.3,0.5,0.66,0.8,0.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5,7,10,15,20],getNextZoomInRatio:function(b,e){if(!e){e=1}var c=Kekule.ZoomUtils.PREDEFINED_ZOOM_RATIOS;var a=c.length;if(b<c[a-1]){for(var d=0;d<a;++d){if(c[d]>b){return c[Math.min(d+e,a)-1]}}}return b},getNextZoomOutRatio:function(b,e){if(!e){e=1}var c=Kekule.ZoomUtils.PREDEFINED_ZOOM_RATIOS;var a=c.length;if(b>c[0]){for(var d=a-1;d>=0;--d){if(c[d]<b){return c[Math.max(d-e+1,0)]}}}return b}};