Kekule.ChemWidget={};Kekule.ChemWidget.AbstractWidget=Kekule.Widget.BaseWidget;Kekule.ChemWidget.ComponentWidgetNames={newDoc:"newDoc",loadFile:"loadFile",loadData:"loadData",saveFile:"saveFile",zoomIn:"zoomIn",zoomOut:"zoomOut",rotateRight:"rotateRight",rotateLeft:"rotateLeft",rotateX:"rotateX",rotateY:"rotateY",rotateZ:"rotateZ",reset:"reset",molDisplayType:"molDisplayType",molHideHydrogens:"molHideHydrogens",openEditor:"openEditor",config:"config",objInspector:"objInspector",undo:"undo",redo:"redo",copy:"copy",cut:"cut",paste:"paste",cloneSelection:"cloneSelection",erase:"erase",manipulate:"manipulate",molBond:"bond",molAtom:"atom",molCharge:"charge",textBlock:"textBlock",molRing:"ring",glyph:"glyph",fontName:"fontName",fontSize:"fontSize",color:"color",textDirection:"textDirection",textAlign:"textAlign"};Kekule.ChemWidget.HtmlClassNames={PREFIX:"K-Chem-",INNER_TOOLBAR:"K-Chem-InnerToolbar"};(function(){var e=Class.PropertyScope;var b=Kekule.ChemWidget;var a=Kekule.Widget.HtmlClassNames;var d=Kekule.ChemWidget.HtmlClassNames;var c=Kekule.ChemWidgetTexts;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{DIALOG_LOADDATA:"K-Chem-Dialog-LoadData",DIALOG_LOADDATA_FORMATBOX:"K-Chem-Dialog-LoadData-FormatBox",DIALOG_LOADDATA_SRCEDITOR:"K-Chem-Dialog-LoadData-SrcEditor",DIALOG_LOADDATA_BTN_LOADFROMFILE:"K-Chem-Dialog-LoadData-Btn-LoadFromFile"});Kekule.ChemWidget.LoadDataDialog=Class.create(Kekule.Widget.Dialog,{CLASS_NAME:"Kekule.ChemWidget.LoadDataDialog",_sBtnLoadFromFile:c.CAPTION_LOADDATA_FROM_FILE,initialize:function($super,f,g,h){this._openFileAction=new Kekule.ActionFileOpen();this._openFileAction.update();this._openFileAction.addEventListener("open",this.reactFileLoad,this);$super(f,g||c.CAPTION_LOADDATA,h||[Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL])},finalize:function($super){this._openFileAction.finalize();$super()},initProperties:function(){this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:false,setter:null})},initPropValues:function($super){$super()},doGetWidgetClassName:function($super){return $super()+" "+d.DIALOG_LOADDATA},doCreateClientContents:function($super,l){$super();var k=this.getDocument();var h=k.createElement("div");h.innerHTML=c.CAPTION_DATA_FORMAT;l.appendChild(h);h=k.createElement("div");l.appendChild(h);var f=new Kekule.Widget.SelectBox(this);f.addClassName(d.DIALOG_LOADDATA_FORMATBOX);f.appendToElem(h);this._formatSelector=f;var j=this.getAvailableReaderInfos();var g=this.getFormatSelectorItems(j);f.setItems(g);var h=k.createElement("div");h.innerHTML=c.CAPTION_DATA_SRC;l.appendChild(h);h=k.createElement("div");l.appendChild(h);var i=new Kekule.Widget.TextEditor(this);i.setWrap("off");i.setToolbarPos(Kekule.Widget.Position.BOTTOM);i.addClassName(d.DIALOG_LOADDATA_SRCEDITOR);i.appendToElem(h);this._dataEditor=i},getAvailableReaderInfos:function(){return Kekule.IO.ChemDataReaderManager.getAvailableReaderInfos()},getFormatSelectorItems:function(f){var u=[];var r=[];for(var p=0,m=f.length;p<m;++p){var h=f[p];Kekule.ArrayUtils.pushUnique(r,h.formatId)}for(var p=0,m=r.length;p<m;++p){var g=Kekule.IO.DataFormatsManager.getFormatInfo(r[p]);if(g){var q=Kekule.ArrayUtils.clone(Kekule.ArrayUtils.toArray(g.fileExts));for(var o=0,n=q.length;o<n;++o){q[o]="*."+q[o]}var t=q.join(", ");var s=g.title;if(t){s+=" ("+t+")"}u.push({value:g.mimeType,text:s,title:g.mimeType,data:g})}}u.sort(function(j,i){return(j.text<i.text)?-1:(j.text>i.text)?1:0});return u},doSetButtons:function($super,h){var g=h||[];if(g.indexOf(this._sBtnLoadFromFile)<0){g.unshift(this._sBtnLoadFromFile)}$super(g);var f=this.getDialogButton(this._sBtnLoadFromFile);f.setAction(this._openFileAction);f.linkStyleResource(Kekule.Widget.StyleResourceNames.BUTTON_LOAD_FILE);f.addClassName(d.DIALOG_LOADDATA_BTN_LOADFROMFILE);f.setEnabled(this._openFileAction.getEnabled())},reactFileLoad:function(j){var i=j.files;if(i&&i.length){var h=i[0];var f=this;var g=null;try{Kekule.IO.loadFileData(h,function(l,k){if(k){f.setPropStoreFieldValue("chemObj",l);g=Kekule.Widget.DialogButtons.OK}f.close(g)})}catch(j){Kekule.raise(j,Kekule.ExceptionLevel.ERROR)}}},open:function($super,h,f,g){this.setPropStoreFieldValue("chemObj",null);return $super(h,f,g)},close:function($super,f){if(!this.getChemObj()){if(this.isPositiveResult(f)){var g=this._dataEditor.getValue();var i=this._formatSelector.getValue();try{var j=Kekule.IO.loadTypedData(g,i);if(j){this.setPropStoreFieldValue("chemObj",j)}else{Kekule.error(Kekule.ErrorMsg.LOAD_CHEMDATA_FAILED)}}catch(h){Kekule.raise(h,Kekule.ExceptionLevel.ERROR)}}}return $super(f)}})})();(function(){var b=Kekule.DomUtils;var d=Kekule.HtmlElementUtils;var c=Kekule.ChemWidgetTexts;var a=Kekule.Widget.HtmlClassNames;var e=Kekule.ChemWidget.HtmlClassNames;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{PERIODIC_TABLE:"K-Chem-Periodic-Table",PERIODIC_TABLE_MINI:"K-Chem-Periodic-Table-Mini",PERIODIC_TABLE_LEGEND:"K-Chem-Periodic-Table-Legend",PERIODIC_TABLE_LEGEND_CONTENT:"K-Chem-Periodic-Table-Legend-Content",PERIODIC_TABLE_LEGEND_COLORS:"K-Chem-Periodic-Table-Legend-Colors",PERIODIC_TABLE_LEGEND_COLOR:"K-Chem-Periodic-Table-Legend-Color",PERIODIC_TABLE_MAINTABLE:"K-Chem-Periodic-Table-MainTable",PERIODIC_TABLE_EXTRATABLE:"K-Chem-Periodic-Table-ExtraTable",PERIODIC_TABLE_ELEM_CELL:"K-Chem-Periodic-Table-Elem-Cell",PERIODIC_TABLE_ELEM_STUBSCELL:"K-Chem-Periodic-Table-Elem-StubsCell",PERIODIC_TABLE_ELEM_CELL_CONTENT:"K-Chem-Periodic-Table-Elem-Cell-Content",PERIODIC_TABLE_LEGEND_ELEM_CELL_CONTENT:"K-Chem-Periodic-Table-Elem-Cell-Content",PERIODIC_TABLE_HEAD_CELL:"K-Chem-Periodic-Table-Head-Cell",PERIODIC_TABLE_HEAD_CELL_CONTENT:"K-Chem-Periodic-Table-Head-Cell-Content",PERIODIC_TABLE_HEAD_CELL_GROUP:"K-Chem-Periodic-Table-Head-Cell-Group",PERIODIC_TABLE_HEAD_CELL_PERIOD:"K-Chem-Periodic-Table-Head-Cell-Period",ELEM_SYMBOL:"K-Chem-Elem-Symbol",ELEM_SYMBOL_STUBS:"K-Chem-Elem-Symbol-Stubs",ELEM_NAME:"K-Chem-Elem-Name",ATOMIC_NUM:"K-Chem-Atomic-Num",ATOMIC_WEIGHT:"K-Chem-Atomic-Weight"});Kekule.ChemWidget.PeriodicTable=Class.create(Kekule.ChemWidget.AbstractWidget,{CLASS_NAME:"Kekule.ChemWidget.PeriodicTable",BINDABLE_TAG_NAMES:["span","div"],ELEM_DATA_FIELD:"__$elemData__",MAX_GROUP:18,MAX_PERIOD:7,LA_SERIES:["La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu"],AC_SERIES:["Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr"],initialize:function($super,f,g){this.setPropStoreFieldValue("displayedComponents",g||this.getDefaultDisplayedComponents());this._elemCells=[];this._selectedElemCells=[];$super(f);this.setEnableSelect(true);this.setEnableMultiSelect(true)},initProperties:function(){this.defineProp("displayedComponents",{dataType:DataType.ARRAY,getter:function(){return this.getPropStoreFieldValue("displayedComponents")||this.getDefaultDisplayedComponents()}});this.defineProp("startingAtomNum",{dataType:DataType.INT});this.defineProp("endingAtomNum",{dataType:DataType.INT});this.defineProp("useMiniMode",{dataType:DataType.BOOL,setter:function(f){this.setPropStoreFieldValue("useMiniMode",f);if(f){this.addClassName(e.PERIODIC_TABLE_MINI)}else{this.removeClassName(e.PERIODIC_TABLE_MINI)}}});this.defineProp("enableSelect",{dataType:DataType.BOOL,getter:function(){return this.getPropStoreFieldValue("enableSelect")||this.getEnableMultiSelect()}});this.defineProp("enableMultiSelect",{dataType:DataType.BOOL});this.defineProp("selected",{dataType:DataType.HASH,serializable:false,setter:null,getter:function(){return this.getSelection()?this.getSelection()[0]:null}});this.defineProp("selection",{dataType:DataType.ARRAY,serializable:false,setter:null,getter:function(){var f=[];var h=this._selectedElemCells||[];for(var j=0,g=h.length;j<g;++j){var k=h[j][this.ELEM_DATA_FIELD];if(k){f.push(k)}}return f}});this.defineProp("selectedSymbol",{dataType:DataType.STRING,getter:function(){return this.getSelectedSymbols()[0]},setter:function(f){this.setSelectedSymbols([f])}});this.defineProp("selectedSymbols",{dataType:DataType.ARRAY,getter:function(){var j=this.getSelection();if(j){var f=[];for(var h=0,g=j.length;h<g;++h){f.push(j[h].symbol)}return f}return[]},setter:function(f){this.selectSymbols(f)}})},doGetWidgetClassName:function($super){return $super()+" "+e.PERIODIC_TABLE},doCreateRootElement:function(g){var f=g.createElement("div");return f},doCreateSubElements:function($super,h,f){$super(h,f);var g=this.createMainTable(h,f);return[g]},doObjectChange:function(f){var g=["displayedComponents","startingAtomNum","endingAtomNum"];if(Kekule.ArrayUtils.intersect(f,g).length){this.recreateMainTable()}},getDefaultDisplayedComponents:function(){return["symbol","name","atomicNumber","groupHead","legend"]},getShowElemSymbol:function(){var f=this.getDisplayedComponents();return f.indexOf("symbol")>=0},getShowElemName:function(){var f=this.getDisplayedComponents();return f.indexOf("name")>=0},getShowAtomicNum:function(){var f=this.getDisplayedComponents();return f.indexOf("atomicNumber")>=0},getShowAtomicWeight:function(){var f=this.getDisplayedComponents();return f.indexOf("atomicWeight")>=0},getShowGroupHead:function(){var f=this.getDisplayedComponents();return f.indexOf("groupHead")>=0},getShowPeriodHead:function(){var f=this.getDisplayedComponents();return f.indexOf("periodHead")>=0},getShowLegend:function(){var f=this.getDisplayedComponents();return f.indexOf("legend")>=0},recreateMainTable:function(){this.deselectAll();var f=this.getElement();b.clearChildContent(f);this.createMainTable(f.ownerDocument,f)},createMainTable:function(M,z){var F=Kekule.chemicalElementsData;var h=[];this._elemCells=[];var s=[];var v=[];var x=M.createElement("table");for(var o=0;o<=this.MAX_PERIOD;++o){var k=M.createElement("tr");var p=[];for(var j=0;j<=this.MAX_GROUP;++j){var t=M.createElement("td");k.appendChild(t);p.push(t)}x.appendChild(k);h.push(p)}var f=M.createElement("table");for(var o=0;o<2;++o){var k=M.createElement("tr");var p=[];for(var j=0;j<this.LA_SERIES.length;++j){var t=M.createElement("td");k.appendChild(t);p.push(t)}f.appendChild(k);s.push(p)}var K=this.getStartingAtomNum()||0;var g=this.getEndingAtomNum()||300000;for(var D=0,B=F.length;D<B;++D){var H=F[D];var r=H.atomicNumber;if(r<K||r>g){continue}var C=H.symbol;var E=H.period;var q=H.group;var m=H.chemicalSerie.replace(/\s/g,"");Kekule.ArrayUtils.pushUnique(v,H.chemicalSerie);var t;var w=this.LA_SERIES.indexOf(C);var u=this.AC_SERIES.indexOf(C);if(w>=0){t=s[0][w]}else{if(u>=0){t=s[1][u]}else{if(E&&q){t=h[E][q]}}}if(t){t.className=e.PERIODIC_TABLE_ELEM_CELL;t.appendChild(this.createElemCellContent(M,H,m.upperFirst()));t[this.ELEM_DATA_FIELD]=H;this._elemCells.push(t)}if((w===0)||(u===0)){t=h[E][q];t.className=e.PERIODIC_TABLE_ELEM_STUBSCELL;t.appendChild(this.createElemCellStubsContent(M,H,m.upperFirst()))}}if(this.getShowGroupHead()){var n=["IA","IIA","IIIB","IVB","VB","VIB","VIIB","","VIII","","IB","IIB","IIIA","IVA","VA","VIA","VIIA","VIIIA"];for(var j=1;j<=this.MAX_GROUP;++j){var o=(j===1)||(j===18)?0:(j===2)||(j>=13)?1:3;var t=h[o][j];t.className=e.PERIODIC_TABLE_HEAD_CELL+" "+e.PERIODIC_TABLE_HEAD_CELL_GROUP;t.appendChild(this.createHeadContent(M,n[j-1]))}}if(this.getShowPeriodHead()){for(var o=1;o<=this.MAX_PERIOD;++o){var t=h[o][0];t.className=e.PERIODIC_TABLE_HEAD_CELL+" "+e.PERIODIC_TABLE_HEAD_CELL_PERIOD;t.appendChild(this.createHeadContent(M,o))}}z.appendChild(x);if(this.getShowLegend()){var L=M.createElement("a");L.href="javascript:void(0)";L.className=e.PERIODIC_TABLE_LEGEND+" "+a.CORNER_ALL;b.setElementText(L,c.LEGEND_CAPTION);var y=M.createElement("div");y.className=e.PERIODIC_TABLE_LEGEND_CONTENT+" "+a.CORNER_ALL;var A={symbol:c.LEGEND_ELEM_SYMBOL,atomicNumber:c.LEGEND_ATOMIC_NUM,naturalMass:c.LEGEND_ATOMIC_WEIGHT,name:c.LEGEND_ELEM_NAME};var I=this.createElemCellContent(M,A,e.PERIODIC_TABLE_LEGEND_ELEM_CELL_CONTENT);y.appendChild(I);var J=M.createElement("div");J.className=e.PERIODIC_TABLE_LEGEND_COLORS;for(var D=0,B=v.length;D<B;++D){var G=M.createElement("div");G.className=e.PERIODIC_TABLE_LEGEND_COLOR+" "+v[D].replace(/\s/g,"");b.setElementText(G,v[D]);J.appendChild(G)}y.appendChild(J);L.appendChild(y);z.appendChild(L)}z.appendChild(f);return x},createElemCellContent:function(k,h,l){var f=k.createElement("div");var j=e.PERIODIC_TABLE_ELEM_CELL_CONTENT;if(l){j+=" "+l}f.className=j;if(this.getShowAtomicNum()){f.appendChild(this.createElemContentComponent(k,h.atomicNumber,e.ATOMIC_NUM))}if(this.getShowAtomicWeight()){var i=h.naturalMass;if(i){var g=(typeof(i)==="number")?i.toFixed(3):i;f.appendChild(this.createElemContentComponent(k,g,e.ATOMIC_WEIGHT))}else{f.appendChild(this.createElemContentComponent(k,"\u00a0",e.ATOMIC_WEIGHT))}}if(this.getShowElemSymbol()){f.appendChild(this.createElemContentComponent(k,h.symbol,e.ELEM_SYMBOL))}if(this.getShowElemName()){f.appendChild(this.createElemContentComponent(k,h.name,e.ELEM_NAME))}return f},createElemCellStubsContent:function(j,g,l){var f=j.createElement("div");f.className=e.PERIODIC_TABLE_ELEM_CELL_CONTENT+" "+(l||"");var k,i,h;h=g.chemicalSerie;if(g.symbol==="La"){k="57-71";i="La-Lu"}else{k="89-103";i="Ac-Lr"}if(this.getShowAtomicNum()){f.appendChild(this.createElemContentComponent(j,k,e.ATOMIC_NUM))}if(this.getShowElemSymbol()){f.appendChild(this.createElemContentComponent(j,i,e.ELEM_SYMBOL_STUBS,true))}if(this.getShowElemName()){f.appendChild(this.createElemContentComponent(j,h,e.ELEM_NAME))}return f},createElemContentComponent:function(i,h,f,k){var g=i.createElement("span");g.className=f;if(k){var j=i.createElement("span");g.appendChild(j)}b.setElementText(j||g,h);return g},createHeadContent:function(g,h,i){var f=g.createElement("div");f.className=e.PERIODIC_TABLE_HEAD_CELL_CONTENT+" "+(i||"");b.setElementText(f,h);return f},_getAtomCellElem:function(g){var f=b.getNearestAncestorByTagName(g,"td",true);if(f&&(this._elemCells.indexOf(f)>=0)){return f}else{return null}},_getCellElemOfSymbol:function(m){var h=this._elemCells;for(var j=0,g=h.length;j<g;++j){var f=h[j];var k=f[this.ELEM_DATA_FIELD];if(k.symbol===m){return f}}return null},isCellSelected:function(f){return this._selectedElemCells.indexOf(f)>=0},selectCell:function(f){if(f){d.addClass(f,a.STATE_SELECTED);Kekule.ArrayUtils.pushUnique(this._selectedElemCells,f);this.invokeEvent("select",{elemData:f[this.ELEM_DATA_FIELD]})}},deselectCell:function(f){if(f){d.removeClass(f,a.STATE_SELECTED);Kekule.ArrayUtils.remove(this._selectedElemCells,f);this.invokeEvent("deselect",{elemData:f[this.ELEM_DATA_FIELD]})}},toggleCell:function(f){if(this.isCellSelected(f)){this.deselectCell(f)}else{this.selectCell(f)}},deselectAll:function(){var f=this._selectedElemCells;for(var g=f.length-1;g>=0;--g){this.deselectCell(f[g])}return this},selectSymbols:function(h){this.deselectAll();var k=Kekule.ArrayUtils.toArray(h);for(var j=0,g=k.length;j<g;++j){var f=this._getCellElemOfSymbol(k[j]);if(f){this.selectCell(f)}}return this},react_click:function($super,h){if(this.getEnableSelect()){var g=h.getTarget();var f=this._getAtomCellElem(g);if(f){if(!this.getEnableMultiSelect()){this.deselectAll();this.selectCell(f)}else{this.toggleCell(f)}return true}}$super(h)}})})();(function(){var g=Class.PropertyScope;var d=Kekule.DomUtils;var c=Kekule.ZoomUtils;var b=Kekule.ChemWidget;var e=Kekule.ChemWidgetTexts;var a=Kekule.Widget.HtmlClassNames;var f=Kekule.ChemWidget.HtmlClassNames;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{DISPLAYER_DRAWCONTEXT_PARENT:"K-Chem-Displayer-DrawContext-Parent",ACTION_MOL_DISPLAY_TYPE:"K-Chem-MolDisplayType",ACTION_MOL_DISPLAY_SKELETAL:"K-Chem-MolDisplaySkeletal",ACTION_MOL_DISPLAY_CONDENSED:"K-Chem-MolDisplayCondensed",ACTION_MOL_DISPLAY_WIRE:"K-Chem-MolDisplayWire",ACTION_MOL_DISPLAY_BALLSTICK:"K-Chem-MolDisplayBallStick",ACTION_MOL_DISPLAY_STICKS:"K-Chem-MolDisplaySticks",ACTION_MOL_DISPLAY_SPACEFILL:"K-Chem-MolDisplaySpaceFill",ACTION_MOL_HIDE_HYDROGENS:"K-Chem-MolHideHydrogens",ACTION_ZOOMIN:"K-Chem-ZoomIn",ACTION_ZOOMOUT:"K-Chem-ZoomOut",ACTION_RESET:"K-Chem-Reset",ACTION_RESET_ZOOM:"K-Chem-ResetZoom",ACTION_LOADFILE:"K-Chem-LoadFile",ACTION_LOADDATA:"K-Chem-LoadData",ACTION_SAVEFILE:"K-Chem-SaveFile",ACTION_CONFIG:"K-Chem-Config",DIALOG_CHOOSE_FILE_FORAMT:"K-Chem-Dialog-Choose-File-Format",DIALOG_CHOOSE_FILE_FORAMT_FORMATBOX:"K-Chem-Dialog-Choose-File-Format-FormatBox",DIALOG_CHOOSE_FILE_FORAMT_PREVIEWER:"K-Chem-Dialog-Choose-File-Format-Previewer"});Kekule.ChemWidget.ChemObjDisplayerConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.ChemWidget.ChemObjDisplayerConfigs",initProperties:function(){this.addConfigProp("ioConfigs","Kekule.ChemWidget.ChemObjDisplayerIOConfigs")},initPropValues:function($super){$super();this.setPropStoreFieldValue("ioConfigs",new Kekule.ChemWidget.ChemObjDisplayerIOConfigs())}});Kekule.ChemWidget.ChemObjDisplayerIOConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.ChemWidget.ChemObjDisplayerIOConfigs",initProperties:function(){this.addBoolConfigProp("canonicalizeBeforeSave",true)}});Kekule.ChemWidget.ChemObjDisplayer=Class.create(Kekule.ChemWidget.AbstractWidget,{CLASS_NAME:"Kekule.ChemWidget.ChemObjDisplayer",initialize:function($super,h,k,i,j){this.setPropStoreFieldValue("renderType",i||Kekule.Render.RendererType.R2D);$super(h);if(k){this.setChemObj(k)}this.setEnableLoadNewFile(true);this.setPropStoreFieldValue("displayerConfigs",j||this.createDefaultConfigs());this._paintFlag=0},doFinalize:function($super){this.setChemObj(null);this.getPainter().finalize();var h=this.getPropStoreFieldValue("drawBridge");var i=this.getPropStoreFieldValue("drawContext");if(i&&h){h.releaseContext(i)}if(h.finalize){h.finalize()}this.setPropStoreFieldValue("drawBridge",null);this.setPropStoreFieldValue("drawContext",null);$super()},initProperties:function(){this.defineProp("displayerConfigs",{dataType:"Kekule.ChemWidget.ChemObjDisplayerConfigs",serializable:false,scope:g.PUBLIC});this.defineProp("enableLoadNewFile",{dataType:DataType.BOOL,serializable:false});this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:false,scope:g.PUBLIC,setter:function(i){var h=this.getPropStoreFieldValue("chemObj");if(i!==h){this.setPropStoreFieldValue("chemObj",i);this.chemObjChanged(i,h)}}});this.defineProp("chemObjLoaded",{dataType:DataType.BOOL,serializable:false,scope:g.PUBLIC,setter:null,getter:function(){return this.getChemObj()&&this.getPropStoreFieldValue("chemObjLoaded")}});this.defineProp("renderType",{dataType:DataType.INT,serializable:false,setter:null,scope:g.PUBLIC});this.defineProp("renderConfigs",{dataType:DataType.OBJECT,serializable:false,scope:g.PUBLIC,getter:function(){var h=this.getPropStoreFieldValue("renderConfigs");if(!h){h=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.Render.Render3DConfigs.getInstance():Kekule.Render.Render2DConfigs.getInstance()}return h}});this.defineProp("drawOptions",{dataType:DataType.HASH,serializable:false,scope:g.PUBLIC,getter:function(){var h=this.getPropStoreFieldValue("drawOptions");if(!h){h={};this.setPropStoreFieldValue("drawOptions",h)}return h}});this.defineProp("zoom",{dataType:DataType.FLOAT,serializable:false,getter:function(){var h=this.getDrawOptions()||{};return h.zoom},setter:function(h){this.zoomTo(h);return this}});this.defineProp("autofit",{dataType:DataType.BOOL,serializable:false,getter:function(){var h=this.getDrawOptions()||{};return h.autofit},setter:function(h){var i=this.getDrawOptions()||{};i.autofit=h;return this.setDrawOptions(i)}});this.defineProp("moleculeDisplayType",{dataType:DataType.INT,serializable:false,getter:function(){var h=this.getDrawOptions()||{};return h.moleculeDisplayType},setter:function(h){this.getDrawOptions().moleculeDisplayType=h;this.drawOptionChanged();return this}});this.defineProp("allowCoordBorrow",{dataType:DataType.BOOL,serializable:false,scope:g.PUBLIC,getter:function(){return Kekule.oneOf(this.getDrawOptions().allowCoordBorrow,this.getRenderConfigs().getGeneralConfigs().getAllowCoordBorrow())}});this.defineProp("autoSize",{dataType:DataType.BOOL,serializable:false,setter:function(h){if(h!=this.getAutoSize()){this.setPropStoreFieldValue("autoSize",h);if(h&&this.allowAutoSize()){this.drawOptionChanged()}}}});this.defineProp("padding",{dataType:DataType.INT,serializable:false,setter:function(h){if(h!=this.getPadding()){this.setPropStoreFieldValue("padding",h);this.getDrawOptions().autofitContextPadding=h;this.drawOptionChanged()}}});this.defineProp("baseCoordOffset",{dataType:DataType.Hash,serializable:false,setter:function(h){this.setPropStoreFieldValue("baseCoordOffset",h);if(this.getChemObjLoaded()){this.repaint()}}});this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:false,scope:g.PRIVATE,setter:null,getter:function(){var h=this.getPropStoreFieldValue("drawBridge");if(!h){h=this.createDrawBridge();this.setPropStoreFieldValue("drawBridge",h)}return h}});this.defineProp("drawContext",{dataType:DataType.OBJECT,serializable:false,scope:g.PRIVATE,setter:null,getter:function(){var h=this.getPropStoreFieldValue("drawContext");if(!h){var k=this.getDrawBridge();if(k){var i=this.getDrawContextParentElem();if(!i){return null}else{var j=Kekule.HtmlElementUtils.getElemOffsetDimension(i);h=k.createContext(i,j.width,j.height);this.setPropStoreFieldValue("drawContext",h)}}}return h}});this.defineProp("painter",{dataType:"Kekule.Render.ChemObjPainter",serializable:false,scope:g.PRIVATE,setter:null,getter:function(){var h=this.getPropStoreFieldValue("painter");if(!h){h=this.createNewPainter()}return h}});this.defineProp("rootRenderer",{dataType:"Kekule.Render.AbstractRenderer",serializable:false,scope:g.PRIVATE,setter:null,getter:function(){var h=this.getPainter();return h?h.getRenderer():null}})},createDefaultConfigs:function(){return new Kekule.ChemWidget.ChemObjDisplayerConfigs()},doWidgetShowStateChanged:function($super,h){$super(h);if(h){this.setChemObj(this.getChemObj())}},getCoordMode:function(){return(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D},loadPredefinedResDataToProp:function(i,h,k){if(i==="chemObj"){if(k){try{var l=Kekule.IO.loadTypedData(h.data,h.resType,h.resUri);this.setChemObj(l)}catch(j){this.reportException(j)}}else{this.reportException(Kekule.ErrorMsg.CANNOT_LOAD_RES_OF_URI+h.resUri||"")}}},reportException:function(i,h){Kekule.raise(i,h||Kekule.ExceptionLevel.ERROR)},createDrawBridge:function(){var i=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.Render.DrawBridge3DMananger:Kekule.Render.DrawBridge2DMananger;var h=i.getPreferredBridgeInstance();if(!h){Kekule.error(Kekule.ErrorMsg.DRAW_BRIDGE_NOT_SUPPORTED)}return h},getDrawContextParentElem:function(){var h=this._drawContextParentElem;if(!h){h=this.getDocument().createElement("div");this._drawContextParentElem=h;Kekule.HtmlElementUtils.addClass(h,a.DYN_CREATED);Kekule.HtmlElementUtils.addClass(h,f.DISPLAYER_DRAWCONTEXT_PARENT);h.style.width="100%";h.style.height="100%";var i=this.getElement();var j=Kekule.DomUtils.getFirstChildElem(i);if(j){i.insertBefore(h,j)}else{i.appendChild(h)}}return h},allowAutoSize:function(){return this.getRenderType()===Kekule.Render.RendererType.R2D},canModifyPartialGraphic:function(i){var h=this.getDrawBridge();return h.canModifyGraphic?h.canModifyGraphic(i||this.getDrawContext()):false},doInsertedToDom:function(){this.doResize()},doResize:function(){this.refitDrawContext(this.isPainting())},refitDrawContext:function(i){if(this.getDrawBridge()&&this.getDrawContext()){var h=Kekule.HtmlElementUtils.getElemClientDimension(this.getDrawContextParentElem());var j=this.changeContextDimension(h);if(!i&&j){this.repaint()}}},changeContextDimension:function(h){if(this.getDrawBridge()&&this.getDrawContext()){this.getDrawBridge().setContextDimension(this.getDrawContext(),h.width,h.height);return true}else{return false}},clearContext:function(){var i=this.getPropStoreFieldValue("drawContext");if(i){var h=this.getPropStoreFieldValue("painter");if(h){h.clear(i)}this.getDrawBridge().clearContext(i)}},createNewPainter:function(j){var i=this.getPropStoreFieldValue("painter");if(i){i.finalize()}var h=new Kekule.Render.ChemObjPainter(this.getRenderType(),j,this.getDrawBridge());this.setPropStoreFieldValue("painter",h);return h},chemObjChanged:function(i,h){this.doLoad(i)},load:function(h){this.setChemObj(h)},doLoad:function(j){this.refitDrawContext(true);this.setPropStoreFieldValue("chemObjLoaded",false);try{if(j){var h=this.createNewPainter(j);h.setRenderConfigs(this.getRenderConfigs());this.repaint();this.setPropStoreFieldValue("chemObjLoaded",true)}else{this.clearContext()}this.invokeEvent("load",{obj:j})}catch(i){this.clearContext();this.reportException(i)}finally{this.doLoadEnd(this.getChemObj())}},doLoadEnd:function(h){},loadFromData:function(h,k,j){try{var l=Kekule.IO.loadTypedData(h,k,j);if(l){this.setChemObj(l)}else{Kekule.error(Kekule.ErrorMsg.LOAD_CHEMDATA_FAILED)}return l}catch(i){this.reportException(i)}},loadFromFile:function(i){var h=this;try{Kekule.IO.loadFileData(i,function(l,k){if(k){h.setChemObj(l)}})}catch(j){this.reportException(j)}},saveData:function(m,h,k){var k=k||this.getChemObj();this.prepareSaveData(k);var j=Kekule.IO.ChemDataWriterManager.getWriterByFormat(m,null,k);if(j){var l=this.getDisplayerConfigs().getIoConfigs().getCanonicalizeBeforeSave();if(l&&k.canonicalize){var k=k.clone?k.clone(true):k;k.canonicalize()}if(!h){var n=Kekule.IO.DataFormatsManager.getFormatInfo(m);h=n.dataType}var i=j.writeData(k,h,m);return i}else{Kekule.error(Kekule.ErrorMsg.NO_SUITABLE_WRITER_FOR_FORMAT);return null}},prepareSaveData:function(h){},getDrawClientDimension:function(){var h=Kekule.HtmlElementUtils.getElemClientDimension(this.getCoreElement());return h},setDrawDimension:function(i,h){this.setDimension(i,h)},calcDrawBaseCoord:function(r){var o;var i=this.getDrawContext();var p=this.getPainter();var j;if((!this._isContinuousRepainting)&&this.getAutoSize()&&this.allowAutoSize()){var n=this.getPadding()||0;var l=p.estimateScreenBox(i,o,r,this.getAllowCoordBorrow());var h=l.x2-l.x1+n*2;var q=l.y2-l.y1+n*2;this.getDrawBridge().setContextDimension(i,h,q);this.setDrawDimension(h,q);j={width:h,height:q};o={x:h/2,y:q/2}}else{o=r?r.baseCoord:null;if(!o){var m=this.getDrawClientDimension();o={x:m.width/2,y:m.height/2};var k=this.getBaseCoordOffset();if(k){o=Kekule.CoordUtils.add(o,k)}}}o=this.getDrawBridge().transformScreenCoordToContext(i,o);return{baseCoord:o,newWidgetDimension:j}},getActualDrawOptions:function(){return this.getDrawOptions()},calcDrawParams:function(j){var i=this.getActualDrawOptions();if(j){i=Object.extend(i,j)}var h=this.calcDrawBaseCoord(i);return{drawOptions:i,baseCoord:h.baseCoord,newWidgetDimension:h.newWidgetDimension}},repaint:function(k){this.beginPaint();try{this.clearContext();if(!this.getChemObj()){return}var h=this.getPainter();var i=this.calcDrawParams();var j=this.getDrawContext();this._lastBaseCoord=i.baseCoord;h.draw(j,i.baseCoord,i.drawOptions)}finally{this.endPaint()}},beginPaint:function(){++this._paintFlag},endPaint:function(){if(this._paintFlag>0){--this._paintFlag}},isPainting:function(){return this._paintFlag>0},drawOptionChanged:function(){this.repaint()},geometryOptionChanged:function(){var h=this.getPainter();var i=this.getDrawOptions();if(h.supportGeometryOptionChange()){h.changeGeometryOptions(this.getDrawContext(),i.baseCoord||this._lastBaseCoord,i)}else{this.drawOptionChanged()}},beginContinuousRepainting:function(){this._isContinuousRepainting=true},endContinuousRepainting:function(){if(this._isContinuousRepainting){this._isContinuousRepainting=false;this.repaint()}},resetDisplay:function(){var h=this.getDrawOptions();h.zoom=1;h.rotateX=0;h.rotateY=0;h.rotateZ=0;h.rotateAngle=0;h.rotateAxisVector=null;h.rotateMatrix=null;this.setBaseCoordOffset(null);this.geometryOptionChanged();return this},getCurrZoom:function(){return this.getDrawOptions().zoom||1},zoomTo:function(i,h){this.getDrawOptions().zoom=i;if(!h){this.geometryOptionChanged()}return this},zoomIn:function(i){var j=this.getCurrZoom();var h=c.getNextZoomInRatio(j,i||1);return this.zoomTo(h)},zoomOut:function(i){var j=this.getCurrZoom();var h=c.getNextZoomOutRatio(j,i||1);return this.zoomTo(h)},resetZoom:function(){return this.zoomTo(1)},getCurrMoleculeDisplayType:function(){var h=this.getDrawOptions().moleculeDisplayType;if(!h){h=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.Render.Molecule3DDisplayType.DEFAULT:Kekule.Render.Molecule2DDisplayType.DEFAULT}return h},setHideHydrogens:function(h){this.getDrawOptions().hideHydrogens=h;this.drawOptionChanged();return this},exportToDataUrl:function(h,i){return this.getDrawBridge().exportToDataUrl(this.getDrawContext(),h,i)},createConfigurator:function($super){var h=$super();h.addEventListener("configChange",function(i){this.repaint()},this);return h}});Kekule.ChemWidget.ChemObjDisplayer.Settings=Class.create(Kekule.Widget.BaseWidget.Settings,{CLASS_NAME:"Kekule.ChemWidget.ChemObjDisplayer.Settings",initialize:function($super,h){$super(h)},initProperties:function(){this.defineDelegatedProps(["enableLoadNewFile"])},getDisplayer:function(){return this.getWidget()}});Kekule.ChemWidget.ChemObjDisplayer.Configurator=Class.create(Kekule.Widget.Configurator,{CLASS_NAME:"Kekule.ChemWidget.ChemObjDisplayer.Configurator",TAB_BTN_DATA_FIELD:"__$data__",initialize:function($super,h){$super(h)},initPropValues:function($super){$super();this.setLayout(Kekule.Widget.Layout.HORIZONTAL)},getCategoryInfos:function($super){var v=$super();var u=this.getDisplayer();var o=[u.getDisplayerConfigs(),u.getRenderConfigs()];for(var p=0,n=o.length;p<n;++p){var h=o[p];var t=h.getPropListOfScopes([Class.PropertyScope.PUBLISHED]);for(var r=0,m=t.getLength();r<m;++r){var s=t.getPropInfoAt(r);var q=h.getPropValue(s.name);if(q){v.push({obj:q,name:s.name,title:s.title,description:s.description})}}}return v},getDisplayer:function(){return this.getWidget()}});Kekule.ChemWidget.ActionDisplayerLoadFile=Class.create(Kekule.ActionFileOpen,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerLoadFile",HTML_CLASSNAME:f.ACTION_LOADFILE,initialize:function($super,h){$super();this.setDisplayer(h);this.setText(e.CAPTION_LOADFILE);this.setHint(e.HINT_LOADFILE)},initProperties:function(){this.defineProp("displayer",{dataType:"Kekule.ChemWidget.ChemObjDisplayer",serializable:false})},doUpdate:function($super){$super();var h=this.getDisplayer();this.setEnabled(this.getEnabled()&&h&&h.getEnabled()&&h.getEnableLoadNewFile())},doFileOpened:function(i){if(i&&i.length){var h=i[0];this.getDisplayer().loadFromFile(h)}}});Kekule.ChemWidget.ActionOnDisplayer=Class.create(Kekule.Action,{CLASS_NAME:"Kekule.ChemWidget.ActionOnDisplayer",initialize:function($super,i,h,j){$super();this.setDisplayer(i);this.setText(h);this.setHint(j)},initProperties:function(){this.defineProp("displayer",{dataType:"Kekule.ChemWidget.ChemObjDisplayer",serializable:false})},doUpdate:function(){var h=this.getDisplayer();this.setEnabled(h&&h.getChemObj()&&h.getChemObjLoaded()&&h.getEnabled())}});Kekule.ChemWidget.ActionDisplayerLoadData=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerLoadData",HTML_CLASSNAME:f.ACTION_LOADDATA,initialize:function($super,h){$super(h,e.CAPTION_LOADDATA,e.HINT_LOADDATA)},finalize:function($super){$super()},initProperties:function(){this.defineProp("dataDialog",{dataType:"Kekule.ChemWidget.LoadDataDialog",serializable:false,setter:null,getter:function(){var h=this.getPropStoreFieldValue("dataDialog");if(!h){h=this.createDataDialog();this.setPropStoreFieldValue("dataDialog",h)}return h}})},createDataDialog:function(){var h=this.getDisplayer().getDocument();return new Kekule.ChemWidget.LoadDataDialog(h)},doUpdate:function($super){$super();var h=this.getDisplayer();this.setEnabled(h&&h.getEnabled()&&h.getEnableLoadNewFile())},doExecute:function(k){var h=this;var j=this.getDataDialog();var i=j._formatSelector;j.openModal(function(l){if(j.isPositiveResult(l)){var m=h.getDisplayer();m.load(j.getChemObj())}},k)}});Kekule.ChemWidget.ActionDisplayerSaveFile=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerSaveFile",HTML_CLASSNAME:f.ACTION_SAVEFILE,initialize:function($super,h){$super(h,e.CAPTION_SAVEFILE,e.HINT_SAVEFILE);this._saveAction=new Kekule.ActionFileSave()},finalize:function($super){this._saveAction.finalize();$super()},initProperties:function(){this.defineProp("formatDialog",{dataType:"Kekule.Widget.Dialog",serializable:false,setter:null,getter:function(){var h=this.getPropStoreFieldValue("formatDialog");if(!h){h=this.createFormatDialog();this.setPropStoreFieldValue("formatDialog",h)}return h}});this.defineProp("lastFormat",{dataType:DataType.STRING,serializable:false});this.defineProp("currSaveData",{dataType:DataType.VARIANT,serializable:false})},getChemObjSrcInfo:function(i){var h=this.getDisplayer();return h.getChemObjSrcInfo?h.getChemObjSrcInfo(i):i.getSrcInfo?i.getSrcInfo():null},getChemObjSrcFormat:function(i){var h=this.getChemObjSrcInfo(i);return h?h.format:null},createFormatDialog:function(){var l=this.getDisplayer().getDocument();var h=new Kekule.Widget.Dialog(l,e.CAPTION_CHOOSEFILEFORMAT,[Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL]);h.addClassName(f.DIALOG_CHOOSE_FILE_FORAMT);var k=l.createElement("div");k.innerHTML=e.CAPTION_SELECT_FORMAT;h.getClientElem().appendChild(k);k=l.createElement("div");h.getClientElem().appendChild(k);var j=new Kekule.Widget.SelectBox(h);j.addClassName(f.DIALOG_CHOOSE_FILE_FORAMT_FORMATBOX);j.appendToElem(k);j.addEventListener("valueChange",this.reactFormatSelectorChange,this);h._formatSelector=j;var k=l.createElement("div");k.innerHTML=e.CAPTION_PREVIEW_FILE_CONTENT;h.getClientElem().appendChild(k);k=l.createElement("div");h.getClientElem().appendChild(k);var i=new Kekule.Widget.TextEditor(h);i.setReadOnly(true);i.setWrap("off");i.setToolbarPos(Kekule.Widget.Position.BOTTOM);i.addClassName(f.DIALOG_CHOOSE_FILE_FORAMT_PREVIEWER);i.appendToElem(k);h._previewTextArea=i;return h},getAvailableWriterInfos:function(h){if(!h){return[]}else{return Kekule.IO.ChemDataWriterManager.getAvailableWriterInfos(null,h)}},getFormatSelectorItems:function(x,u){var A=[];var v=[];var r=this.getChemObjSrcInfo(x);var y=(r)?r.format:null;for(var s=0,n=u.length;s<n;++s){var m=u[s];Kekule.ArrayUtils.pushUnique(v,m.formatId)}for(var s=0,n=v.length;s<n;++s){var h=Kekule.IO.DataFormatsManager.getFormatInfo(v[s]);if(h){var t=Kekule.ArrayUtils.clone(Kekule.ArrayUtils.toArray(h.fileExts));for(var q=0,o=t.length;q<o;++q){t[q]="*."+t[q]}var z=t.join(", ");var w=h.title;if(z){w+=" ("+z+")"}var p=y?(v[s]===y):this.getLastFormat()?(this.getLastFormat()===v[s]):s===0;A.push({value:h.id,text:w,title:h.mimeType,data:h,selected:p})}}A.sort(function(j,i){return(j.text<i.text)?-1:(j.text>i.text)?1:0});return A},reactFormatSelectorChange:function(){var h=this.getFormatDialog()._formatSelector.getValue();this.updatePreview(h,this.getFormatDialog())},updatePreview:function(k,n){var j=n._previewTextArea;j.setValue("");if(k){var m=Kekule.IO.DataFormatsManager.getFormatInfo(k);var i=this.getTargetObj();var l=this.getChemObjSrcInfo(i);if(l&&l.format===k){j.setValue(l.data)}else{var h=this.getDisplayer().saveData(k,m.dataType,i);j.setValue(h);this.setCurrSaveData(h)}}},getTargetObj:function(h){return this.getDisplayer().getChemObj()},doUpdate:function($super){$super();var h=this.getDisplayer();this.setEnabled(h&&h.getEnabled()&&h.getChemObj()&&this._saveAction.getEnabled())},doExecute:function(m){var i=this;var k=this.getFormatDialog();var n=this.getDisplayer().getChemObj();var j=k._formatSelector;var h=this.getAvailableWriterInfos(n);var l=this.getFormatSelectorItems(n,h);j.setItems(l);this.reactFormatSelectorChange();k.openModal(function(p){if(p===Kekule.Widget.DialogButtons.OK){var r=i.getCurrSaveData();i._saveAction.setData(r);var s=k._formatSelector.getValue();i.setLastFormat(s);var o=Kekule.IO.DataFormatsManager.getFileExts(s);var q=o[0]||o;var t=e.S_DEF_SAVE_FILENAME+"."+q;i._saveAction.setFileName(t);i._saveAction.execute(m)}},m)}});Kekule.ChemWidget.ActionDisplayerReset=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerReset",HTML_CLASSNAME:f.ACTION_RESET,initialize:function($super,h){$super(h,e.CAPTION_RESETVIEW,e.HINT_RESETVIEW)},doExecute:function(){this.getDisplayer().resetDisplay()}});Kekule.ChemWidget.ActionDisplayerZoomIn=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerZoomIn",HTML_CLASSNAME:f.ACTION_ZOOMIN,initialize:function($super,h){$super(h,e.CAPTION_ZOOMIN,e.HINT_ZOOMIN)},doExecute:function(){this.getDisplayer().zoomIn()}});Kekule.ChemWidget.ActionDisplayerZoomOut=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerZoomOut",HTML_CLASSNAME:f.ACTION_ZOOMOUT,initialize:function($super,h){$super(h,e.CAPTION_ZOOMOUT,e.HINT_ZOOMOUT)},doExecute:function(){this.getDisplayer().zoomOut()}});Kekule.ChemWidget.ActionDisplayerResetZoom=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerResetZoom",HTML_CLASSNAME:f.ACTION_RESETZOOM,initialize:function($super,h){$super(h,e.CAPTION_RESETZOOM,e.HINT_RESETZOOM)},doExecute:function(){this.getDisplayer().resetZoom()}});Kekule.ChemWidget.ActionDisplayerHideHydrogens=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerHideHydrogens",HTML_CLASSNAME:f.ACTION_MOL_HIDE_HYDROGENS,initialize:function($super,h){$super(h,e.CAPTION_HIDEHYDROGENS,e.HINT_HIDEHYDROGENS)},doUpdate:function($super){$super();var i=this.getDisplayer();var h=i&&(i.getRenderType()===Kekule.Render.RendererType.R3D);this.setDisplayed(this.getDisplayed()&&h).setEnabled(this.getEnabled()&&h)},doExecute:function(){var h=!this.getChecked();this.setChecked(h);this.getDisplayer().setHideHydrogens(h)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase",initialize:function($super,i,h,k,j){$super(i,h,k);this._displayType=j},doExecute:function(){this.getDisplayer().setMoleculeDisplayType(this._displayType)},getMolDisplayType:function(){return this._displayType}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase2D=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase2D",doUpdate:function($super){$super();var i=this.getDisplayer();var h=i&&(i.getRenderType()===Kekule.Render.RendererType.R2D);this.setDisplayed(this.getDisplayed()&&h).setEnabled(this.getEnabled()&&h)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase3D=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase3D",doUpdate:function($super){$super();var i=this.getDisplayer();var h=i&&(i.getRenderType()===Kekule.Render.RendererType.R3D);this.setDisplayed(this.getDisplayed()&&h).setEnabled(this.getEnabled()&&h)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSkeletal=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase2D,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSkeletal",HTML_CLASSNAME:f.ACTION_MOL_DISPLAY_SKELETAL,initialize:function($super,h){$super(h,e.CAPTION_SKELETAL,e.HINT_SKELETAL,Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSkeletal.TYPE)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSkeletal.TYPE=Kekule.Render.Molecule2DDisplayType.SKELETAL;Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeCondensed=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase2D,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeCondensed",HTML_CLASSNAME:f.ACTION_MOL_DISPLAY_CONDENSED,initialize:function($super,h){$super(h,e.CAPTION_CONDENSED,e.HINT_CONDENSED,Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeCondensed.TYPE)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeCondensed.TYPE=Kekule.Render.Molecule2DDisplayType.CONDENSED;Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeWire=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeWire",HTML_CLASSNAME:f.ACTION_MOL_DISPLAY_WIRE,initialize:function($super,h){$super(h,e.CAPTION_WIRE,e.HINT_WIRE,Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeWire.TYPE)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeWire.TYPE=Kekule.Render.Molecule3DDisplayType.WIRE;Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSticks=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSticks",HTML_CLASSNAME:f.ACTION_MOL_DISPLAY_STICKS,initialize:function($super,h){$super(h,e.CAPTION_STICKS,e.HINT_STICKS,Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSticks.TYPE)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSticks.TYPE=Kekule.Render.Molecule3DDisplayType.STICKS;Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBallStick=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBallStick",HTML_CLASSNAME:f.ACTION_MOL_DISPLAY_BALLSTICK,initialize:function($super,h){$super(h,e.CAPTION_BALLSTICK,e.HINT_BALLSTICK,Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBallStick.TYPE)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBallStick.TYPE=Kekule.Render.Molecule3DDisplayType.BALL_STICK;Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSpaceFill=Class.create(Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSpaceFill",HTML_CLASSNAME:f.ACTION_MOL_DISPLAY_SPACEFILL,initialize:function($super,h){$super(h,e.CAPTION_SPACEFILL,e.HINT_SPACEFILL,Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSpaceFill.TYPE)}});Kekule.ChemWidget.ActionDisplayerChangeMolDisplayTypeSpaceFill.TYPE=Kekule.Render.Molecule3DDisplayType.SPACE_FILL})();(function(){var a=Kekule.ChemWidget.HtmlClassNames;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{CHEM_STRUCT_TREE_VIEW:"K-Chem-Struct-TreeView",CHEM_STRUCT_TREE_VIEW_ITEM_TITLE:"K-Chem-Struct-TreeView-ItemTitle",CHEM_STRUCT_TREE_VIEW_ITEM_TYPE:"K-Chem-Struct-TreeView-ItemType"});Kekule.ChemWidget.StructureTreeView=Class.create(Kekule.Widget.TreeView,{CLASS_NAME:"Kekule.ChemWidget.StructureTreeView",initialize:function($super,b,c){$super(b);this.setPropStoreFieldValue("objMap",new Kekule.MapEx(true));this.setEnableLiveUpdate(true);this.setEnableMultiSelected(true);this.setRootObj(c)},initProperties:function(){this.defineProp("rootObj",{dataType:"Kekule.ChemObject",serializable:false,setter:function(c){var b=this.getPropStoreFieldValue("rootObj");this.setPropStoreFieldValue("rootObj",c);this.rootObjChanged(c,b)}});this.defineProp("enableLiveUpdate",{dataType:DataType.BOOL});this.defineProp("objMap",{dataType:"Kekule.MapEx",setter:null,serializable:false})},doGetWidgetClassName:function($super){return $super()+" "+a.CHEM_STRUCT_TREE_VIEW},rootObjChanged:function(c,b){this.clearChildItems();this.getObjMap().clear();if(b){this._uninstallRootEventHandler(b)}if(c){this._fillTree(c);this._installRootEventHandler(c)}},_installRootEventHandler:function(b){b.addEventListener("change",this.reactChemObjChange,this)},_uninstallRootEventHandler:function(b){b.removeEventListener("change",this.reactChemObjChange,this)},reactChemObjChange:function(d){if(this.getEnableLiveUpdate()){var c=d.target;var b=this.getObjMap().get(c);if(b){this._updateTreeItem(b,c)}}},_fillTree:function(b){if(b){this.clearChildItems();this._updateTreeItem(this.appendChildItem(),b)}},_updateTreeItem:function(g,k){var j=this._getChemObjDisplayTitle(k);var e={text:j,obj:k};this.setItemData(g,e);this.getObjMap().set(k,g);var b=this.getChildItemCount(g);var d=k.getChildCount();for(var f=0;f<d;++f){var c=k.getChildAt(f);if(!c.isSelectable()){continue}var h;if(f<b){h=this.getChildItemAt(g,f)}else{h=this.appendChildItem(g)}this._updateTreeItem(h,c)}if(b>d){for(var f=b-1;f>=d;--f){this.removeChildItemAt(g,f)}}},_getChemObjDisplayTitle:function(h){var b="";var g=h.getId();if(g){b+='<span class="'+a.CHEM_STRUCT_TREE_VIEW_ITEM_TITLE+'">'+g+"</span>"}var f=h.getClassName();var e=f.split(".");var d=e.length?e[e.length-1]:f;var c='<span class="'+a.CHEM_STRUCT_TREE_VIEW_ITEM_TYPE+'">('+d+")</span>";return b+c},selectChemObjs:function(d){var c=[];for(var e=0,b=d.length;e<b;++e){var g=d[e];var f=this.getObjMap().get(g);if(f){c.push(f)}}this.select(c);return this},getSelectedChemObjs:function(){var b=[];var d=this.getSelection();if(d&&d.length){for(var e=0,c=d.length;e<c;++e){var f=this.getItemData(d[e]);if(f&&f.obj){b.push(f.obj)}}}return b}})})();(function(){var a=Kekule.oneOf;Kekule.ChemWidget.AbstractUIMarker=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemWidget.AbstractUIMarker",initialize:function($super){$super();this.setVisible(true)},initProperties:function(){this.defineProp("drawStyles",{dataType:DataType.OBJECT});this.defineProp("visible",{dataType:DataType.BOOL})}});Kekule.ChemWidget.MetaShapeUIMarker=Class.create(Kekule.ChemWidget.AbstractUIMarker,{CLASS_NAME:"Kekule.ChemWidget.MetaShapeUIMarker",initialize:function($super,b){$super();if(b){this.setShapeInfo(b)}},initProperties:function(){this.defineProp("shapeInfo",{dataType:DataType.OBJECT});this.defineProp("shapeType",{dataType:DataType.INT,serializable:false,setter:null,getter:function(){var b=this.getShapeInfo();return b?b.shapeType:null}})}});Kekule.ChemWidget.UiMarkerCollection=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemWidget.UiMarkerCollection",initProperties:function(){this.defineProp("markers",{dataType:DataType.ARRAY,getter:function(){var b=this.getPropStoreFieldValue("markers");if(!b){b=[];this.setPropStoreFieldValue("markers",b)}return b},setter:null})},getMarkerCount:function(){return this.getMarkers().length},getMarkerAt:function(b){return this.getMarkers()[b]},addMarker:function(b){return this.getMarkers().push(b)},indexOfMarker:function(b){return this.getMarkers().indexOf(b)},removeMarker:function(b){var d=this.getMarkers();var c=d.indexOf(b);if(c>=0){d.splice(c,1)}},clearMarkers:function(){this.setPropStoreFieldValue("markers",[])}});Kekule.ChemWidget.UiMarkersRenderer=Class.create(Kekule.Render.Base2DRenderer,{CLASS_NAME:"Kekule.ChemWidget.UiMarkersRenderer",DRAW_ELEM_FIELD:"__$drawElem__",initialize:function($super,b,c){$super(b,c);this._drawGroup=null},initProperties:function(){this.defineProp("dummy",{dataType:DataType.OBJECT,serializable:false})},getObjDrawElem:function(b,c){return this.getExtraProp2(b,c,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(b,d,c){this.setExtraProp2(b,d,this.DRAW_ELEM_FIELD,c)},doEstimateRenderBox:function(d,e,c,b){return null},doDraw:function($super,c,d,b){$super(c,d,b);var f=this.getChemObj();var e=this.createDrawGroup(c);this.setObjDrawElem(c,f,e);if(f.getMarkerCount()>0){this.doDrawMarkers(c,e,f.getMarkers(),b)}return e},doUpdate:function($super,d,g,b){if(this.canModifyGraphic(d)){var e=false;var c=Kekule.Render.ObjectUpdateType;switch(b){case c.ADD:e=this.doAddNew(d,g);break;case c.MODIFY:e=this.doModify(d,g);break;case c.REMOVE:var f=this._extractObjsOfUpdateObjDetails(g);e=this.doRemove(d,f);break;default:return $super(d,g,b)}return e}else{return $super(d,updatedObjs,b)}},doAddNew:function(b,c){if(this.canRemoveElem()){return this.doModify(b,c)}else{return false}},doModify:function(b,g){if(this.canRemoveElem()){var e=this._extractObjsOfUpdateObjDetails(g);this.remove(b,e);var f=this.getChemObj();var c=this.getObjDrawElem(f);var d=this.getDrawParams();if(e.indexOf(f)>=0){this.draw(b,d.baseCoord,d.options)}else{this.doDrawMarkers(b,c,e,d.options)}}else{return false}},doRemove:function(b,d){if(this.canRemoveElem()){var c=this.getObjDrawElem(d);if(c){var e=this.getObjDrawElem(this.getChemObj());this.doRemoveFromGroup(c,e);this.doRemoveElem(b,c);this.setObjDrawElem(d,null)}}else{return false}},doDrawMarkers:function(f,g,h,d){for(var e=0,c=h.length;e<c;++e){var b=h[e];if(b.getVisible()){this.doDrawMarker(f,g,b,d)}}},doDrawMarker:function(b,h,f,k){var j=f.getShapeInfo();if(!j){return null}var c=Object.create(k);c=Object.extend(f.getDrawStyles()||{});if(c.color){if(!c.strokeColor){c.strokeColor=c.color}if(!c.fillColor){c.fillColor=c.color}}var m;if(Kekule.ArrayUtils.isArray(j)){if(j.length>1){m=this.createDrawGroup(b);for(var e=0,d=j.length;e<d;++e){var g=j[e];this.doDrawShape(b,m,g,c)}}else{if(j.length===1){m=this.doDrawShape(b,null,j[0],c)}else{return null}}}else{m=this.doDrawShape(b,null,j,c)}if(m){this.setObjDrawElem(b,f,m);if(h){this.addToDrawGroup(m,h)}}return m},doDrawShape:function(b,o,j,q){var f=Kekule.Render.MetaShapeType;var r;if(Kekule.Render.MetaShapeUtils.isCompositeShape(j)){r=this.createDrawGroup(b);for(var g=0,e=j.length;g<e;++g){var d=this.doDrawShape(b,r,j[g],q)}}else{var n=j.coords;switch(j.shapeType){case f.POINT:r=this.drawCircle(b,n[0],1,q);break;case f.CIRCLE:r=this.drawCircle(b,n[0],j.radius,q);break;case f.LINE:var c=q;if(j.width){c=Object.create(q);c.strokeWidth=j.width}r=this.drawLine(b,n[0],n[1],c);break;case f.RECT:r=this.drawRect(b,n[0],n[1],q);break;case f.POLYGON:var k=[];for(var g=0,e=n.length;g<e;++g){var h=(g===0)?"M":"L";k.push(h);var m=[n[g].x,n[g].y];k.push(m)}k.push("L");m=[n[0].x,n[0].y];k.push(m);var p=Kekule.Render.DrawPathUtils.makePath.apply(this,k);r=this.drawPath(b,p,q);break}}if(o){this.addToDrawGroup(r,o)}return r}});Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.ChemWidget.UiMarkersRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemWidget.UiMarkerCollection,Kekule.ChemWidget.UiMarkersRenderer)})();(function(){var b=Class.PropertyScope;var j=Kekule.ZoomUtils;var c=Kekule.ChemWidget.ComponentWidgetNames;var i=Kekule.ChemWidget;var d=Kekule.ChemWidgetTexts;var e=Kekule.Widget.EvokeMode;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{VIEWER:"K-Chem-Viewer",VIEWER2D:"K-Chem-Viewer2D",VIEWER3D:"K-Chem-Viewer3D",VIEWER_CAPTION:"K-Chem-Viewer-Caption",ACTION_ROTATE_LEFT:"K-Chem-RotateLeft",ACTION_ROTATE_RIGHT:"K-Chem-RotateRight",ACTION_ROTATE_X:"K-Chem-RotateX",ACTION_ROTATE_Y:"K-Chem-RotateY",ACTION_ROTATE_Z:"K-Chem-RotateZ",ACTION_VIEWER_EDIT:"K-Chem-Viewer-Edit"});var g=Kekule.Widget.HtmlClassNames;var a=Kekule.ChemWidget.HtmlClassNames;Kekule.ChemWidget.Viewer=Class.create(Kekule.ChemWidget.ChemObjDisplayer,{CLASS_NAME:"Kekule.ChemWidget.Viewer",BINDABLE_TAG_NAMES:["div","span","img"],DEF_TOOLBAR_EVOKE_MODES:[e.EVOKEE_CLICK,e.EVOKEE_MOUSE_ENTER,e.EVOKEE_TOUCH],DEF_TOOLBAR_REVOKE_MODES:[e.EVOKEE_MOUSE_LEAVE,e.EVOKER_TIMEOUT],initialize:function($super,k,n,m,l){this.setPropStoreFieldValue("renderType",m||Kekule.Render.RendererType.R2D);this.setPropStoreFieldValue("enableToolbar",false);this.setPropStoreFieldValue("toolbarEvokeModes",this.DEF_TOOLBAR_EVOKE_MODES);this.setPropStoreFieldValue("toolbarRevokeModes",this.DEF_TOOLBAR_REVOKE_MODES);this.setPropStoreFieldValue("enableDirectInteraction",true);this.setPropStoreFieldValue("enableTouchInteraction",false);this.setPropStoreFieldValue("toolbarPos",Kekule.Widget.Position.AUTO);this.setPropStoreFieldValue("toolbarMarginHorizontal",10);this.setPropStoreFieldValue("toolbarMarginVertical",10);this.setPropStoreFieldValue("showCaption",false);$super(k,n,m,l);this.setPadding(this.getRenderConfigs().getLengthConfigs().getActualLength("autofitContextPadding"));this.setUseCornerDecoration(true);this._isContinuousRepainting=false;this.setModalEdit(true);this.useCornerDecorationChanged();this.doResize();this.addIaController("default",new Kekule.ChemWidget.ViewerBasicInteractionController(this),true)},doFinalize:function($super){var k=this.getToolbar();if(k){k.finalize()}$super()},initProperties:function(){this.defineProp("viewerConfigs",{dataType:"Kekule.ChemWidget.ChemObjDisplayerConfigs",serializable:false,getter:function(){return this.getDisplayerConfigs()},setter:function(k){return this.setDisplayerConfigs(k)}});this.defineProp("allowedMolDisplayTypes",{dataType:DataType.ARRAY,scope:b.PUBLIC,setter:function(k){this.setPropStoreFieldValue("allowedMolDisplayTypes",k);this.updateToolbar()}});this.defineProp("enableEdit",{dataType:DataType.BOOL,getter:function(){return this.getPropStoreFieldValue("enableEdit")&&(this.getCoordMode()!==Kekule.CoordMode.COORD3D)}});this.defineProp("modalEdit",{dataType:DataType.BOOL});this.defineProp("toolButtons",{dataType:DataType.HASH,serializable:false,scope:b.PUBLIC,getter:function(){var k=this.getPropStoreFieldValue("toolButtons");if(!k){k=this.getDefaultToolBarButtons();this.setPropStoreFieldValue("toolButtons",k)}return k},setter:function(k){this.setPropStoreFieldValue("toolButtons",k);this.updateToolbar()}});this.defineProp("toolButtonNameMapping",{dataType:DataType.HASH,serializable:false,scope:b.PRIVATE,setter:null,getter:function(){var k=this.getPropStoreFieldValue("toolButtonNameMapping");if(!k){k=this.createDefaultToolButtonNameMapping();this.setPropStoreFieldValue("toolButtonNameMapping",k)}return k}});this.defineProp("toolbar",{dataType:"Kekule.Widget.ButtonGroup",serializable:false,scope:b.PRIVATE,setter:function(n){var l=this.getToolbar();var k=this.getToolbarEvokeHelper();if(n!==l){if(l){l.finalize();var m=this.getToolbarEvokeHelper();if(m){m.finalize()}l=null}if(k){k.finalize()}this.setPropStoreFieldValue("toolbar",n);if(n){this.setPropStoreFieldValue("toolbarEvokeHelper",new Kekule.Widget.DynamicEvokeHelper(this,n,this.getToolbarEvokeModes(),this.getToolbarRevokeModes()))}}}});this.defineProp("enableToolbar",{dataType:DataType.BOOL,setter:function(k){this.setPropStoreFieldValue("enableToolbar",k);this.updateToolbar()}});this.defineProp("toolbarPos",{dataType:DataType.INT,enumSource:Kekule.Widget.Position,setter:function(k){this.setPropStoreFieldValue("toolbarPos",k);this.adjustToolbarPos()}});this.defineProp("toolbarMarginVertical",{dataType:DataType.INT,setter:function(k){this.setPropStoreFieldValue("toolbarMarginVertical",k);this.adjustToolbarPos()}});this.defineProp("toolbarMarginHorizontal",{dataType:DataType.INT,setter:function(k){this.setPropStoreFieldValue("toolbarMarginHorizontal",k);this.adjustToolbarPos()}});this.defineProp("toolbarEvokeHelper",{dataType:"Kekule.Widget.DynamicEvokeHelper",serializable:false,setter:null,scope:b.PRIVATE});this.defineProp("toolbarEvokeModes",{dataType:DataType.ARRAY,scope:b.PUBLIC,setter:function(k){this.setPropStoreFieldValue("toolbarEvokeModes",k||[]);if(this.getToolbarEvokeHelper()){this.getToolbarEvokeHelper().setEvokeModes(k||[])}}});this.defineProp("toolbarRevokeModes",{dataType:DataType.ARRAY,scope:b.PUBLIC,setter:function(k){this.setPropStoreFieldValue("toolbarRevokeModes",k||[]);if(this.getToolbarEvokeHelper()){this.getToolbarEvokeHelper().setRevokeModes(k||[])}}});this.defineProp("toolbarRevokeTimeout",{dataType:DataType.INT,setter:function(k){this.setPropStoreFieldValue("toolbarRevokeTimeout",k);if(this.getToolbarEvokeHelper()){this.getToolbarEvokeHelper().setTimeout(k)}}});this.defineProp("caption",{dataType:DataType.STRING,setter:function(k){this.setPropStoreFieldValue("caption",k);Kekule.DomUtils.setElementText(this.getCaptionElem(),k||"");this.captionChanged()}});this.defineProp("showCaption",{dataType:DataType.BOOL,setter:function(k){this.setPropStoreFieldValue("showCaption",k);this.captionChanged()}});this.defineProp("captionPos",{dataType:DataType.INT,enumSource:Kekule.Widget.Position,setter:function(k){this.setPropStoreFieldValue("captionPos",k);this.captionChanged()}});this.defineProp("autoCaption",{dataType:DataType.BOOL,setter:function(k){this.setPropStoreFieldValue("autoCaption",k);if(k){this.autoDetectCaption()}}});this.defineProp("captionElem",{dataType:DataType.OBJECT,scope:b.PRIVATE,setter:null,getter:function(l){var k=this.getPropStoreFieldValue("captionElem");if(!k&&!l){k=this.doCreateCaptionElem();this.setPropStoreFieldValue("captionElem",k)}return k}});this.defineProp("actions",{dataType:"Kekule.ActionList",serializable:false,scope:b.PUBLIC,setter:null,getter:function(){var k=this.getPropStoreFieldValue("actions");if(!k){k=new Kekule.ActionList();this.setPropStoreFieldValue("actions",k)}return k}});this.defineProp("enableDirectInteraction",{dataType:DataType.BOOL});this.defineProp("enableTouchInteraction",{dataType:DataType.BOOL})},doObjectChange:function($super,k){$super(k);this.updateActions()},doSetElement:function($super,l){var m=l;if(m){var k=m.tagName.toLowerCase();if(k==="img"){m=Kekule.DomUtils.replaceTagName(m,"span")}}return $super(m)},doUnbindElement:function($super,k){if(this._drawContextParentElem&&this._drawContextParentElem.parentNode){this._drawContextParentElem.parentNode.removeChild(this._drawContextParentElem);this._drawContextParentElem=null}return $super(k)},doCreateRootElement:function(l){var k=l.createElement("div");return k},doGetWidgetClassName:function($super){var l=$super()+" "+a.VIEWER;var k=(this.getRenderType()===Kekule.Render.RendererType.R3D)?a.VIEWER3D:a.VIEWER2D;l+=" "+k;return l},doResize:function($super){this.adjustDrawParentDim();this.adjustToolbarPos();$super()},doWidgetShowStateChanged:function(k){if(k){this.updateActions()}},refitDrawContext:function($super,k){$super(k);this.adjustToolbarPos()},doLoadEnd:function(k){this.updateActions();this.autoDetectCaption()},doSetUseCornerDecoration:function($super,k){$super(k);this.useCornerDecorationChanged()},useCornerDecorationChanged:function(){var k=this.getUseCornerDecoration();var l=this.getDrawContextParentElem();if(k){Kekule.HtmlElementUtils.addClass(l,g.CORNER_ALL)}else{Kekule.HtmlElementUtils.removeClass(l,g.CORNER_ALL)}},adjustDrawParentDim:function(){var n=this.getDrawContextParentElem();var l=n.parentNode;var q=this.getCaptionElem(true);var p=Kekule.HtmlElementUtils.getElemClientDimension(l);var m,o;if(q&&this.captionIsShown()&&q.parentNode===l){var k=Kekule.HtmlElementUtils.getElemClientDimension(q);o=Math.max(p.height-k.height,0);m=(this.getCaptionPos()&Kekule.Widget.Position.TOP)?k.height:0}else{m=0;o=p.height}n.style.top=m+"px";n.style.height=o+"px"},getInteractionReceiverElem:function(){return this.getDrawContextParentElem()},setDrawDimension:function($super,n,l){var m=l;if(this.captionIsShown()){var k=Kekule.HtmlElementUtils.getElemClientDimension(this.getCaptionElem());m+=k.height||0}$super(n,m)},doCreateCaptionElem:function(){var k=this.getDocument().createElement("span");k.className=g.DYN_CREATED+"  "+g.SELECTABLE+" "+a.VIEWER_CAPTION;this.getElement().appendChild(k);return k},captionChanged:function(){if(this.captionIsShown()){var l=this.getCaptionElem();var k=l.style;var m=this.getCaptionPos();if(m&Kekule.Widget.Position.TOP){k.top=0;k.bottom="auto"}else{k.bottom=0;k.top="auto"}k.display="block"}else{var l=this.getCaptionElem(true);if(l){l.style.display="none"}}this.doResize()},captionIsShown:function(){return this.getCaption()&&this.getShowCaption()},getComposerDialog:function(){if(!this._composerDialog){this._composerDialog=new Kekule.Editor.ComposerDialog(this.getDocument(),d.CAPTION_EDIT_OBJ,[Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL])}return this._composerDialog},openEditor:function(k){if(this.getEnableEdit()&&this.getChemObj()){var o=this.getComposerDialog();var n=o.getComposer();n.setEnableCreateNewDoc(false);n.setEnableLoadNewFile(false);n.setAllowCreateNewChild(false);var q=this.getChemObj();var m=q.clone();o.setChemObj(m);var l=this;var p=function(r){if(r===Kekule.Widget.DialogButtons.OK&&o.getComposer().isDirty()){q.assign(m);q.setSrcInfo(null);l.setChemObj(q)}};if(this.getModalEdit()){o.openModal(p,k||this)}else{o.openPopup(p,k||this)}}},resetView:function(){return this.resetDisplay()},getCurr2DRotationAngle:function(){return this.getDrawOptions().rotateAngle||0},rotate2DBy:function(l,k){return this.rotate2DTo(this.getCurr2DRotationAngle()+l,k)},rotate2DTo:function(l,k){this.getDrawOptions().rotateAngle=l;if(!k){this.geometryOptionChanged()}return this},getCurr3DRotationInfo:function(){var m={};var k=["rotateMatrix","rotateX","rotateY","rotateZ","rotateAngle"];var p=this.getDrawOptions();for(var o=0,n=k.length;o<n;++o){var q=k[o];m[q]=p[q]||0}m.rotateAxisVector=p.rotateAxisVector||null;return m},setRotate3DMatrix:function(k,l){this.getDrawOptions().rotateMatrix=k;if(!l){this.geometryOptionChanged()}return this},rotate3DBy:function(l,k,r,o){var p=this.getCurr3DRotationInfo();var q=p.rotateMatrix||Kekule.MatrixUtils.createIdentity(4);var n=Kekule.CoordUtils.calcRotate3DMatrix({rotateX:l,rotateY:k,rotateZ:r});var m=Kekule.MatrixUtils.multiply(n,q);this.setRotate3DMatrix(m,o);return this},rotate3DByAxis:function(q,o,m){var n=this.getCurr3DRotationInfo();var p=n.rotateMatrix||Kekule.MatrixUtils.createIdentity(4);var l=Kekule.CoordUtils.calcRotate3DMatrix({rotateAngle:q,rotateAxisVector:o});var k=Kekule.MatrixUtils.multiply(l,p);this.setRotate3DMatrix(k,m);return this},getDefaultToolBarButtons:function(){var k=[c.loadData,c.saveFile,c.molDisplayType,c.molHideHydrogens,c.zoomIn,c.zoomOut];if(this.getRenderType()===Kekule.Render.RendererType.R3D){k=k.concat([c.rotateX,c.rotateY,c.rotateZ])}else{k=k.concat([c.rotateLeft,c.rotateRight])}k.push(c.reset);k.push(c.openEditor);k.push(c.config);return k},createDefaultToolButtonNameMapping:function(){var k={};k[c.loadFile]=i.ActionDisplayerLoadFile;k[c.loadData]=i.ActionDisplayerLoadData;k[c.saveFile]=i.ActionDisplayerSaveFile;k[c.zoomIn]=i.ActionDisplayerZoomIn;k[c.zoomOut]=i.ActionDisplayerZoomOut;k[c.rotateLeft]=i.ActionViewerRotateLeft;k[c.rotateRight]=i.ActionViewerRotateRight;k[c.rotateX]=i.ActionViewerRotateX;k[c.rotateY]=i.ActionViewerRotateY;k[c.rotateZ]=i.ActionViewerRotateZ;k[c.reset]=i.ActionDisplayerReset;k[c.molHideHydrogens]=i.ActionDisplayerHideHydrogens;k[c.openEditor]=i.ActionViewerEdit;k[c.config]=Kekule.Widget.ActionOpenConfigWidget;return k},adjustToolbarPos:function(){var w=this.getToolbar();if(w){var n=Kekule.Widget.Position;var s=Kekule.HtmlElementUtils.getElemBoundingClientRect(this.getDrawContextParentElem());var q=w.getBoundingClientRect();var v=this.getToolbarPos();var k=this.getToolbarMarginHorizontal();var r=this.getToolbarMarginVertical();var l="left",u="top";var m="right",p="bottom";var t=(s.width-q.width)/2;var x=(s.height-q.height)/2;if(v===n.AUTO||!v){var o=((k>0)?k:0)*2+q.width;var y=((r>0)?r:0)*2+q.height;if(o>s.width){v|=n.LEFT;k=0}else{v|=n.RIGHT}if(y>s.height){v|=n.BOTTOM;r=-1}else{v|=n.BOTTOM}}if(v&n.LEFT){l="left";m="right";t=(k>=0)?k:k-q.width}else{if(v&n.RIGHT){l="right";m="left";t=(k>=0)?k:k-q.width}}if(v&n.TOP){u="top";p="bottom";x=(r>=0)?r:r-q.height}else{if(v&n.BOTTOM){u="bottom";p="top";x=(r>=0)?r:r-q.height}}w.removeStyleProperty(m);w.removeStyleProperty(p);w.setStyleProperty(l,t+"px");w.setStyleProperty(u,x+"px")}},updateToolbar:function(){if(this.getEnableToolbar()){this.createToolbar();this.adjustToolbarPos()}else{this.setToolbar(null)}},updateActions:function(){if(this.getActions()){this.getActions().updateAll()}},getToolButtonActionClass:function(k){return this.getToolButtonNameMapping()[k]},createToolbar:function(){this.getActions().clear();var m=new Kekule.Widget.ButtonGroup(this);m.addClassName(g.DYN_CREATED);m.setDisplayed(false);var q=this.getToolButtons();for(var p=0,k=q.length;p<k;++p){var n=q[p];var o=this.createToolButton(n,m)}m.addClassName(a.INNER_TOOLBAR);m.setShowText(false);m.doSetShowGlyph(true);m.appendToElem(this.getDrawContextParentElem());this.setToolbar(m);return m},createToolButton:function(r,q){var s=null;var n=this.beginContinuousRepainting.bind(this);var l=this.endContinuousRepainting.bind(this);var o=[c.rotateX,c.rotateY,c.rotateZ,c.rotateLeft,c.rotateRight];if(r===c.molDisplayType){this.createMolDisplayTypeButton(q)}var p=this.getToolButtonActionClass(r);var k=Kekule.Widget.Button;if(r===c.molHideHydrogens){k=Kekule.Widget.CheckButton}if(p){s=new k(q);var m=new p(this);this.getActions().add(m);s.setAction(m);if(o.indexOf(r)>=0){s.setPeriodicalExecInterval(20);s.setEnablePeriodicalExec(true);s.addEventListener("activate",n);s.addEventListener("deactivate",l)}}return s},createMolDisplayTypeButton:function(s){var u=new Kekule.Widget.CompactButtonSet(s);u.getButtonSet().addClassName(a.INNER_TOOLBAR);u.setShowText(false);var n=new Kekule.ChemWidget.ActionViewerChangeMolDisplayTypeStub(this);u.setAction(n);this.getActions().add(n);var t=this.getDocument();var r=(this.getRenderType()===Kekule.Render.RendererType.R3D)?i.Viewer.molDisplayType3DActionClasses:i.Viewer.molDisplayType2DActionClasses;var q=this.getAllowedMolDisplayTypes();for(var p=0,m=r.length;p<m;++p){var o=r[p].TYPE;if(q&&(q.indexOf(o)<0)&&(o!==this.getCurrMoleculeDisplayType())){continue}var k=new Kekule.Widget.RadioButton(t);n=new r[p](this);this.getActions().add(n);k.setAction(n);u.append(k,o===this.getCurrMoleculeDisplayType())}return u},autoDetectCaption:function(){if(this.getAutoCaption()){var m=this.getChemObj();var l=m&&m.getInfo();var n=m&&m.getSrcInfo();if(l&&n){var k=l.title||l.caption||m.getName()||n.fileName;if(k){this.setCaption(k)}}}}});var h=Kekule.X.Event;Kekule.ChemWidget.ViewerBasicInteractionController=Class.create(Kekule.Widget.InteractionController,{CLASS_NAME:"Kekule.ChemWidget.ViewerBasicInteractionController",initialize:function($super,k){$super(k);this._enableMouseRotate=true;this._transformInfo={isTransforming:false,lastCoord:null,lastZoom:null}},initProperties:function(){this.defineProp("viewer",{dataType:"Kekule.ChemWidget.Viewer",serializable:false,getter:function(){return this.getWidget()},setter:function(k){this.setWidget(k)}})},getViewerRenderType:function(){return this.getViewer().getRenderType()},getEnableInteraction:function(){var l=this.getViewer();var k=!!(l&&l.getEnableDirectInteraction()&&l.getChemObjLoaded());return k},getEnableTouchInteraction:function(){var l=this.getViewer();var k=!!(l&&l.getEnableDirectInteraction()&&l.getEnableTouchInteraction()&&l.getChemObjLoaded());return k},_initTransform:function(){var m=this.getViewer();var k=Math.min(m.getOffsetWidth(),m.getOffsetHeight());var l=this._transformInfo;l.angleRatio=1/k*Math.PI},zoomViewer:function(l){var k=this.getViewer();if(!k||!k.getChemObj()){return}if(l>0){if(k.zoomIn){k.zoomIn(l)}}else{if(l<0){if(k.zoomOut){k.zoomOut(-l)}}}},isEventFromInteractionArea:function(m){var l=m.getTarget();var k=this.getViewer().getInteractionReceiverElem();return(l===k)||Kekule.DomUtils.isDescendantOf(l,k)},needReactEvent:function(k){return this.getEnableInteraction()&&this.isEventFromInteractionArea(k)},react_dblclick:function(k){if(this.needReactEvent(k)){this.getViewer().resetDisplay()}},react_mousewheel:function(k){if(this.needReactEvent(k)){var l=k.wheelDeltaY||k.wheelDelta;if(l){l/=120}this.zoomViewer(l);k.preventDefault();return true}},react_mousedown:function(l){if(!this.needReactEvent(l)){return}if(l.getButton()===h.MouseButton.LEFT){var m=this.getViewer();if(m&&m.getChemObj()){var k=this._transformInfo;k.isTransforming=true;k.lastCoord={x:l.getScreenX(),y:l.getScreenY()};this._initTransform()}}},react_mouseleave:function(k){this._transformInfo.isTransforming=false},react_mouseup:function(k){if(k.getButton()===h.MouseButton.LEFT){this._transformInfo.isTransforming=false}},react_mousemove:function(k){if(!this.needReactEvent(k)){return}if(this.getViewerRenderType()===Kekule.Render.RendererType.R3D){this.rotateByXYDistance(k.getScreenX(),k.getScreenY())}else{this.moveByXYDistance(k.getScreenX(),k.getScreenY())}},moveByXYDistance:function(m,l){var o=this._transformInfo;if(o&&o.isTransforming&&(!o.calculating)){var p=this.getViewer();if(p.getRenderType()===Kekule.Render.RendererType.R3D){return}o.calculating=true;try{var n={x:m,y:l};var q=Kekule.CoordUtils.substract(n,o.lastCoord);var k=p.getBaseCoordOffset()||{};k=Kekule.CoordUtils.add(k,q);p.setBaseCoordOffset(k);o.lastCoord=n}finally{o.calculating=false}}},rotateByXYDistance:function(m,l){var n=this._transformInfo;if(n&&n.isTransforming&&(!n.calculating)){var q=this.getViewer();if(q.getRenderType()!==Kekule.Render.RendererType.R3D){return}n.calculating=true;try{var k={x:m,y:l};var t=Kekule.CoordUtils.substract(k,n.lastCoord);t.y=-t.y;var o=Kekule.CoordUtils.getDistance({x:0,y:0},t);var p=o*n.angleRatio;var s={x:-t.y,y:t.x,z:0};q.rotate3DByAxis(p,s);n.lastCoord=k;n.calculating=false}catch(r){}finally{n.calculating=false}}},react_transformstart:function(l){if(!this.getEnableTouchInteraction()||!this.needReactEvent(l)){return}var m=this.getViewer();if(m){var k=this._transformInfo;k.isTransforming=true;k.lastZoom=m.getCurrZoom();k.lastCoord={x:0,y:0};this._initTransform()}},react_transformend:function(k){if(!this.getEnableTouchInteraction()||!this.needReactEvent(k)){return}this._transformInfo.isTransforming=false},react_transform:function(o){if(!this.getEnableTouchInteraction()||!this.needReactEvent(o)){return}var q=this.getViewer();var n=this._transformInfo;if(q&&n.isTransforming&&(!n.calculating)){try{var m=o.gesture;if(m){var p=o.gesture.scale;q.zoomTo((n.lastZoom||1)*p,true);var l=m.deltaX;var k=m.deltaY;this.rotateByXYDistance(l,k);o.gesture.preventDefault();o.gesture.stopPropagation()}}finally{}}},doTestMouseCursor:function(n,m){var k="";var l=this._transformInfo;if(l.isTransforming){k="move"}return k}});Kekule.ChemWidget.Viewer2D=Class.create(Kekule.ChemWidget.Viewer,{CLASS_NAME:"Kekule.ChemWidget.Viewer2D",initialize:function($super,k,l){$super(k,l,Kekule.Render.RendererType.R2D)}});Kekule.ChemWidget.Viewer3D=Class.create(Kekule.ChemWidget.Viewer,{CLASS_NAME:"Kekule.ChemWidget.Viewer3D",initialize:function($super,k,l){$super(k,l,Kekule.Render.RendererType.R3D)}});var f=Kekule.ObjPropSettingManager;f.register("Kekule.ChemWidget.Viewer.fullFunc",{enableToolbar:true,enableDirectInteraction:true,enableTouchInteraction:true,enableEdit:true,toolButtons:null});f.register("Kekule.ChemWidget.Viewer.basic",{enableToolbar:true,enableDirectInteraction:true,enableTouchInteraction:false,toolButtons:[c.saveFile,c.molDisplayType,c.zoomIn,c.zoomOut]});f.register("Kekule.ChemWidget.Viewer.static",{enableToolbar:false,enableDirectInteraction:false,enableTouchInteraction:false,toolButtons:[]});Kekule.ChemWidget.Viewer.Settings=Class.create(Kekule.ChemWidget.ChemObjDisplayer.Settings,{CLASS_NAME:"Kekule.ChemWidget.Viewer.Settings",initProperties:function(){this.defineDelegatedProps(["enableDirectInteraction","enableTouchInteraction","enableToolbar","toolbarPos","toolbarMarginHorizontal","toolbarMarginVertical","enableEdit","modalEdit"])},getViewer:function(){return this.getWidget()}});Kekule.ChemWidget.ActionOnViewer=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionOnViewer",initialize:function($super,m,k,l){$super(m,k,l)},doUpdate:function(){var k=this.getDisplayer();this.setEnabled(k&&k.getChemObj()&&k.getChemObjLoaded()&&k.getEnabled())},getViewer:function(){var k=this.getDisplayer();return(k instanceof Kekule.ChemWidget.Viewer)?k:null}});Kekule.ChemWidget.ActionViewerRotateBase=Class.create(Kekule.ChemWidget.ActionOnViewer,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateBase",initialize:function($super,m,k,l){$super(m,k,l);this.setDelta(2*Math.PI/180)},initProperties:function(){this.defineProp("delta",{dataType:DataType.FLOAT})}});Kekule.ChemWidget.ActionViewerRotateBase2D=Class.create(Kekule.ChemWidget.ActionViewerRotateBase,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateBase2D",doUpdate:function($super){$super();var l=this.getViewer();var k=l&&(l.getRenderType()===Kekule.Render.RendererType.R2D);this.setDisplayed(this.getDisplayed()&&k).setEnabled(this.getEnabled()&&k)}});Kekule.ChemWidget.ActionViewerRotateBase3D=Class.create(Kekule.ChemWidget.ActionViewerRotateBase,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateBase3D",doUpdate:function($super){$super();var l=this.getViewer();var k=l&&(l.getRenderType()===Kekule.Render.RendererType.R3D);this.setDisplayed(this.getDisplayed()&&k).setEnabled(this.getEnabled()&&k)}});Kekule.ChemWidget.ActionViewerRotateLeft=Class.create(Kekule.ChemWidget.ActionViewerRotateBase2D,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateLeft",HTML_CLASSNAME:a.ACTION_ROTATE_LEFT,initialize:function($super,k){$super(k,d.CAPTION_ROTATELEFT,d.HINT_ROTATELEFT)},doExecute:function(){this.getViewer().rotate2DBy(this.getDelta())}});Kekule.ChemWidget.ActionViewerRotateRight=Class.create(Kekule.ChemWidget.ActionViewerRotateBase2D,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateRight",HTML_CLASSNAME:a.ACTION_ROTATE_RIGHT,initialize:function($super,k){$super(k,d.CAPTION_ROTATERIGHT,d.HINT_ROTATERIGHT)},doExecute:function(){this.getViewer().rotate2DBy(-this.getDelta())}});Kekule.ChemWidget.ActionViewerRotateX=Class.create(Kekule.ChemWidget.ActionViewerRotateBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateX",HTML_CLASSNAME:a.ACTION_ROTATE_X,initialize:function($super,k){$super(k,d.CAPTION_ROTATEX,d.HINT_ROTATEX)},doExecute:function(){this.getViewer().rotate3DBy(-this.getDelta(),0,0)}});Kekule.ChemWidget.ActionViewerRotateY=Class.create(Kekule.ChemWidget.ActionViewerRotateBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateY",HTML_CLASSNAME:a.ACTION_ROTATE_Y,initialize:function($super,k){$super(k,d.CAPTION_ROTATEY,d.HINT_ROTATEY)},doExecute:function(){this.getViewer().rotate3DBy(0,-this.getDelta(),0)}});Kekule.ChemWidget.ActionViewerRotateZ=Class.create(Kekule.ChemWidget.ActionViewerRotateBase3D,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerRotateZ",HTML_CLASSNAME:a.ACTION_ROTATE_Z,initialize:function($super,k){$super(k,d.CAPTION_ROTATEZ,d.HINT_ROTATEZ)},doExecute:function(){this.getViewer().rotate3DBy(0,0,-this.getDelta())}});Kekule.ChemWidget.ActionViewerChangeMolDisplayTypeStub=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerChangeMolDisplayTypeStub",initialize:function($super,k){$super(k,d.CAPTION_MOL_DISPLAY_TYPE,d.HINT_MOL_DISPLAY_TYPE)},doExecute:function(k){}});Kekule.ChemWidget.ActionViewerEdit=Class.create(Kekule.ChemWidget.ActionOnViewer,{CLASS_NAME:"Kekule.ChemWidget.ActionViewerEdit",HTML_CLASSNAME:a.ACTION_VIEWER_EDIT,initialize:function($super,k){$super(k,d.CAPTION_OPENEDITOR,d.HINT_OPENEDITOR)},doUpdate:function($super){$super();var k=this.getViewer();this.setEnabled(this.getEnabled()&&k.getChemObj()&&k.getEnableEdit());this.setDisplayed(k.getEnableEdit())},doExecute:function(k){var l=this.getViewer();l.openEditor(k)}});Kekule.ChemWidget.Viewer.rotate2DActionClasses=[i.ActionViewerRotateLeft,i.ActionViewerRotateRight];Kekule.ChemWidget.Viewer.rotate3DActionClasses=[i.ActionViewerRotateX,i.ActionViewerRotateY,i.ActionViewerRotateZ];Kekule.ChemWidget.Viewer.molDisplayType2DActionClasses=[i.ActionDisplayerChangeMolDisplayTypeSkeletal,i.ActionDisplayerChangeMolDisplayTypeCondensed];Kekule.ChemWidget.Viewer.molDisplayType3DActionClasses=[i.ActionDisplayerChangeMolDisplayTypeWire,i.ActionDisplayerChangeMolDisplayTypeSticks,i.ActionDisplayerChangeMolDisplayTypeBallStick,i.ActionDisplayerChangeMolDisplayTypeSpaceFill]})();(function(){var c=Class.PropertyScope;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{VIEWER_GRID:"K-Chem-Viewer-Grid"});var a=Kekule.Widget.HtmlClassNames;var b=Kekule.ChemWidget.HtmlClassNames;Kekule.ChemWidget.ViewerGrid=Class.create(Kekule.Widget.WidgetGrid,{CLASS_NAME:"Kekule.ChemWidget.ViewerGrid",initialize:function($super,d,f,e){this.setPropStoreFieldValue("renderType",f);this.setPropStoreFieldValue("viewerConfigs",e);$super(d)},initProperties:function(){this._shadowedPropPairs=[];this.defineProp("renderType",{dataType:DataType.INT,serializable:false,setter:null,scope:c.PUBLIC});this.defineProp("chemObjs",{dataType:DataType.ARRAY,serializable:false,setter:null,getter:function(){var d=[];this.each(function(e){d.push(e.getChemObj())});return d}});this.defineViewerShadowProps(["drawOptions","moleculeDisplayType","zoom","autoSize","enableLoadNewFile","viewerConfigs","allowedMolDisplayTypes","enableEdit","modalEdit","toolButtons","enableToolbar","toolbarPos","toolbarMarginVertical","toolbarMarginHorizontal","toolbarEvokeModes","toolbarRevokeModes","toolbarRevokeTimeout","caption","showCaption","autoCaption","captionPos","enableDirectInteraction","enableTouchInteraction"]);this.defineViewerShadowProps(["viewerPredefinedSetting"],["predefinedSetting"]);this.defineProp("actionLoadData",{dataType:"Kekule.ChemWidget.ActionDisplayerLoadData",serializable:false,scope:c.PRIVATE,setter:null,getter:function(){var d=this.getPropStoreFieldValue("actionLoadData");if(!d){d=new Kekule.ChemWidget.ActionDisplayerLoadData();this.setPropStoreFieldValue("actionLoadData",d)}return d}})},defineViewerShadowProps:function(j,f){if(!f){f=[]}for(var g=0,e=j.length;g<e;++g){var h=j[g];var d=f[g]||j[g];this.defineViewerShadowProp(h,d)}},defineViewerShadowProp:function(h,f){if(!f){f=h}var e=Kekule.ChemWidget.Viewer;var g=ClassEx.getPropInfo(e,f);if(g){var d=Object.create(g);d.getter=undefined;d.setter=function(i){this.setPropStoreFieldValue(h,i);this.each(function(j){j.setPropValue(f,i)})};this.defineProp(h,d);this._shadowedPropPairs.push({prop:h,viewerProp:f})}},doGetWidgetClassName:function($super){return $super()+" "+b.VIEWER_GRID},createWidget:function($super){var f=this.getDocument();var e=new Kekule.ChemWidget.LoadDataDialog(f);var d=this;e.openModal(function(g){if(e.isPositiveResult(g)){var i=e.getChemObj();if(i){var h=d.doCreateNewChildWidget(f,i);h.setParent(d)}}},this.getAddingCell())},doCreateNewChildWidget:function(e,f){var d=new Kekule.ChemWidget.Viewer(e,null,this.getRenderType(),this.getViewerConfigs());this.doSetShadowedPropValuesToViewer(d);if(!f){}else{d.setChemObj(f)}return d},doSetShadowedPropValuesToViewer:function(h){for(var e=0,d=this._shadowedPropPairs.length;e<d;++e){var g=this._shadowedPropPairs[e];var f=this.getPropValue(g.prop);h.setPropValue(g.viewerProp,f)}},addChemObj:function(d){this.doCreateNewChildWidget(this.getDocument(),d).setParent(this);return this},removeChemObj:function(e){var d=this;this.each(function(f){if(f.getChemObj()===e){d.removeWidget(f,true)}});return this}});Kekule.ChemWidget.ViewerGrid2D=Class.create(Kekule.ChemWidget.ViewerGrid,{CLASS_NAME:"Kekule.ChemWidget.ViewerGrid2D",initialize:function($super,d,e){$super(d,Kekule.Render.RendererType.R2D,e)}});Kekule.ChemWidget.ViewerGrid3D=Class.create(Kekule.ChemWidget.ViewerGrid,{CLASS_NAME:"Kekule.ChemWidget.ViewerGrid3D",initialize:function($super,d,e){$super(d,Kekule.Render.RendererType.R3D,e)}})})();(function(){var a=Kekule;var b=Kekule.CoordMode;ClassEx.extend(Kekule.ChemObject,{isStandalone:function(){return true},getStandaloneAncestor:function(){var c=this;while(c.isStandalone&&(!c.isStandalone())&&c.getParent&&c.getParent()){c=c.getParent()}return c},getCascadeDeleteObjs:function(){return[]},cascadeRemove:function(d){var c=this.getParent();if(c&&c.notifyBeforeCascadeRemove){c.notifyBeforeCascadeRemove(this)}if(d){this.finalize()}else{this.removeSelf()}if(c&&c.notifyAfterCascadeRemove){c.notifyAfterCascadeRemove(this)}},notifyBeforeCascadeRemove:function(c,d){},notifyAfterCascadeRemove:function(c,d){if((!this.getKeepEmptyEvenOnCascadeRemove())&&this.isEmpty()){this.cascadeRemove(d)}},getAllContainingConnectors:function(){return[]},transformAbsCoordByMatrix:function(g,j,f,m,d,p){if(this.getChildCount&&(m||Kekule.ObjUtils.isUnset(m))){for(var h=0,e=this.getChildCount();h<e;++h){var c=this.getChildAt(h);if(c&&c.transformAbsCoordByMatrix){c.transformAbsCoordByMatrix(j,j,f,m,d,true)}}}var o=(f===Kekule.CoordMode.COORD3D)?Kekule.CoordUtils.transform3DByMatrix:Kekule.CoordUtils.transform2DByMatrix;if(p){if(this.getCoordOfMode&&this.setCoordOfMode){var k=this.getCoordOfMode(f,d);var n=o(k,g);this.setCoordOfMode(n,f)}}else{if(this.getAbsCoordOfMode&&this.setAbsCoordOfMode){var k=this.getAbsCoordOfMode(f,d);var n=o(k,g);this.setAbsCoordOfMode(n,f)}}},scaleSize:function(e,g,k,d){if(this.getSizeOfMode&&this.setSizeOfMode){var m=this.getSizeOfMode(g,d);var j=Kekule.CoordUtils.multiply(m,e);this.setSizeOfMode(j,g)}if(this.getChildCount&&(k||Kekule.ObjUtils.isUnset(k))){for(var h=0,f=this.getChildCount();h<f;++h){var c=this.getChildAt(h);if(c&&c.scaleSize){c.scaleSize(e,g,k,d)}}}}});ClassEx.defineProps(Kekule.ChemObject,[{name:"keepEmptyEvenOnCascadeRemove",dataType:DataType.BOOL,scope:Class.PropertyScope.PUBLIC}]);ClassEx.extend(Kekule.ChemStructureObject,{getCascadeDeleteObjs:function($super){var c=$super();var h=this.getLinkedConnectors?this.getLinkedConnectors():[];for(var g=0,e=h.length;g<e;++g){var d=h[g];if(d.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(c,d);var f=d.getCascadeDeleteObjs();Kekule.ArrayUtils.pushUnique(c,f)}}return c},isStandalone:function(){return false},isCoordDependent:function(){return false},getCoordDependentObjects:function(){return[this]},getCoordDeterminateObjects:function(){return this.getLinkedConnectors()}});ClassEx.extend(Kekule.BaseStructureNode,{getCascadeDeleteObjs:function($super){return $super()},isCoordDependent:function(){return false},move:function(f,e){var d=this.getCoordOfMode(e);var c=Kekule.CoordUtils.add(d,f);this.setCoordOfMode(c,e);return c},move2D:function(c){return this.move(c,b.COORD2D)},move3D:function(c){return this.move(c,b.COORD3D)}});ClassEx.extend(Kekule.BaseStructureConnector,{getCascadeDeleteObjs:function($super){var c=$super();var g=this.getConnectedObjs();for(var e=0,d=g.length;e<d;++e){var f=g[e];if(f instanceof Kekule.BaseStructureNode){if(f.getLinkedConnectors().length<=1){Kekule.ArrayUtils.pushUnique(c,f)}}}return c},isCoordDependent:function(){return true},getCoordDependentObjects:function(){var c=[];var g=this.getConnectedObjs();for(var e=0,d=g.length;e<d;++e){var f=g[e];if(f.isExposed){if(f.isExposed()){c.push(f)}else{c.push(f.getExposedAncestor())}}else{c.push(f)}}return c},move:function(g,e){for(var d=0,c=this.getConnectedObjCount();d<c;++d){var f=this.getConnectedObjAt(d);if(f.move){f.move(g,e)}}},move2D:function(c){return this.move(c,b.COORD2D)},move3D:function(c){return this.move(c,b.COORD3D)},setAbsBaseCoord:function(e,d){var c=this.getAbsBaseCoord();var f=Kekule.CoordUtils.substract(e,c);this.move(f,d)},setAbsBaseCoord2D:function(c){this.setAbsCoordOfMode(c,Kekule.CoordMode.COORD2D)},setAbsBaseCoord3D:function(c){this.setAbsCoordOfMode(c,Kekule.CoordMode.COORD3D)}});ClassEx.extend(Kekule.Glyph.PathGlyphNode,{getCascadeDeleteObjs:function($super){var c=[this.getParent()];return c}});ClassEx.extend(Kekule.Glyph.PathGlyphConnector,{getCascadeDeleteObjs:function($super){var c=[this.getParent()];return c}});ClassEx.extend(Kekule.StructureFragment,{isStandalone:function(){return !this.getCrossConnectors().length},notifyBeforeCascadeRemove:function($super,e,g){var c=this._getObjsNeedToBeCascadeRemoved(e);if(c&&c.length){for(var d=c.length-1;d>=0;--d){var f=c[d];if(g){f.finalize()}else{f.removeSelf()}}}$super(e,g)},getCoordDependentObjects:function(){if(this.isExpanded&&!this.isExpanded()){return[this]}else{if(!this.hasCtab()){return[this]}else{var c=[];var d=this.getNodeCount();for(var e=0;e<d;++e){var f=this.getNodeAt(e);c.push(f)}return c}}},transformAbsCoordByMatrix:function($super,g,j,f,k,d,m){if(k||Kekule.ObjUtils.isUnset(k)){for(var h=0,e=this.getNodeCount();h<e;++h){var c=this.getNodeAt(h);if(c&&c.transformAbsCoordByMatrix){c.transformAbsCoordByMatrix(j,j,f,k,d,true)}}}$super(g,j,f,false,d,m)}});ClassEx.extend(Kekule.Glyph.Base,{isStandalone:function(){return true}});ClassEx.extend(Kekule.Glyph.PathGlyph,{getCoordDependentObjects:function(){var c=[];var d=this.getNodeCount();for(var e=0;e<d;++e){var f=this.getNodeAt(e);c.push(f)}return c},transformAbsCoordByMatrix:function($super,g,j,f,k,d,m){if(k||Kekule.ObjUtils.isUnset(k)){for(var h=0,e=this.getNodeCount();h<e;++h){var c=this.getNodeAt(h);if(c&&c.transformAbsCoordByMatrix){c.transformAbsCoordByMatrix(j,j,f,k,d,true)}}}$super(g,j,f,false,d,m)}})})();(function(){var c=Kekule.HtmlElementUtils;var a=Kekule.Widget.HtmlClassNames;var d=Kekule.ChemWidget.HtmlClassNames;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{EDITOR:"K-Chem-Editor",EDITOR_CLIENT:"K-Chem-Editor-Client",EDITOR_UIEVENT_RECEIVER:"K-Chem-Editor-UiEvent-Receiver",EDITOR2D:"K-Chem-Editor2D",EDITOR3D:"K-Chem-Editor3D"});Kekule.ChemWidget.Editor={};Kekule.Editor=Kekule.ChemWidget.Editor;Kekule.Editor.CoordSys=Kekule.Render.CoordSystem;Kekule.Editor.BoxRegion={OUTSIDE:0,CORNER_TL:1,CORNER_TR:2,CORNER_BL:3,CORNER_BR:4,EDGE_TOP:11,EDGE_LEFT:12,EDGE_BOTTOM:13,EDGE_RIGHT:14,INSIDE:20};Kekule.Editor.BaseEditor=Class.create(Kekule.ChemWidget.ChemObjDisplayer,{CLASS_NAME:"Kekule.Editor.BaseEditor",BINDABLE_TAG_NAMES:["div","span"],initialize:function($super,e,h,g,f){this._objSelectFlag=0;this._objectUpdateFlag=0;this._uiMarkerUpdateFlag=0;this._updatedObjectDetails=[];this._operatingObjs=[];this._operatingRenderers=[];this._initialRenderTransformParams=null;this._objChanged=false;this.setPropStoreFieldValue("enableCreateNewDoc",true);this.setPropStoreFieldValue("enableOperHistory",true);this.setPropStoreFieldValue("enableOperContext",true);this.setPropStoreFieldValue("initOnNewDoc",true);$super(e,h,g);if(!this.getChemObj()&&this.getInitOnNewDoc()&&this.getEnableCreateNewDoc()){this.newDoc()}this.setPropStoreFieldValue("editorConfigs",f||this.createDefaultConfigs())},initProperties:function(){this.defineProp("editorConfigs",{dataType:"Kekule.Editor.BaseEditorConfigs",serializable:false,getter:function(){return this.getDisplayerConfigs()},setter:function(e){return this.setDisplayerConfigs(e)}});this.defineProp("enableCreateNewDoc",{dataType:DataType.BOOL,serializable:false});this.defineProp("initOnNewDoc",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableOperHistory",{dataType:DataType.BOOL,serializable:false});this.defineProp("operHistory",{dataType:"Kekule.OperationHistory",serializable:false,getter:function(){var e=this.getPropStoreFieldValue("operHistory");if(!e){e=new Kekule.OperationHistory();this.setPropStoreFieldValue("operHistory",e);e.addEventListener("push",this.reactOperHistoryPush,this);e.addEventListener("pop",this.reactOperHistoryPop,this);e.addEventListener("undo",this.reactOperHistoryUndo,this);e.addEventListener("redo",this.reactOperHistoryRedo,this);e.addEventListener("clear",this.reactOperHistoryClear,this);e.addEventListener("change",this.reactOperHistoryChange,this)}return e},setter:null});this.defineProp("selection",{dataType:DataType.ARRAY,serializable:false,getter:function(){var e=this.getPropStoreFieldValue("selection");if(!e){e=[];this.setPropStoreFieldValue("selection",e)}return e},setter:function(e){this.setPropStoreFieldValue("selection",e);this.selectionChanged()}});this.defineProp("hotTrackedObjs",{dataType:DataType.ARRAY,serializable:false,setter:function(j){var k=j?Kekule.ArrayUtils.toArray(j):[];if(this.getEditorConfigs()&&this.getEditorConfigs().getInteractionConfigs().getEnableHotTrack()){this.setPropStoreFieldValue("hotTrackedObjs",k);var h;if(k&&k.length){h=[];for(var f=0,e=k.length;f<e;++f){var g=this.getBoundInfoRecorder().getBound(this.getObjContext(),k[f]);if(h){Kekule.ArrayUtils.pushUnique(h,g)}}}if(h){this.changeHotTrackMarkerBounds(h)}else{if(this.getUiHotTrackMarker().getVisible()){this.hideHotTrackMarker()}}}}});this.defineProp("hotTrackedObj",{dataType:DataType.OBJECT,serializable:false,getter:function(){return this.getHotTrackedObjs()&&this.getHotTrackedObjs()[0]},setter:function(e){this.setHotTrackedObjs(e)}});this.defineProp("enableOperContext",{dataType:DataType.BOOL,setter:function(g){this.setPropStoreFieldValue("enableOperContext",!!g);if(!g){var f=this.getPropStoreFieldValue("operContext");var e=this.getPropStoreFieldValue("drawBridge");if(e&&f){e.releaseContext(f)}}}});this.defineProp("uiEventReceiverElem",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("objContextParentElem",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("operContextParentElem",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("uiContextParentElem",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("objContext",{dataType:DataType.OBJECT,serializable:false,setter:null,getter:function(){return this.getDrawContext()}});this.defineProp("operContext",{dataType:DataType.OBJECT,serializable:false,setter:null,getter:function(){if(!this.getEnableOperContext()){return null}else{var e=this.getPropStoreFieldValue("operContext");if(!e){var h=this.getDrawBridge();if(h){var f=this.getOperContextParentElem();if(!f){return null}else{var g=Kekule.HtmlElementUtils.getElemScrollDimension(f);e=h.createContext(f,g.width,g.height);this.setPropStoreFieldValue("operContext",e)}}}return e}}});this.defineProp("uiContext",{dataType:DataType.OBJECT,serializable:false,getter:function(){var e=this.getPropStoreFieldValue("uiContext");if(!e){var h=this.getUiDrawBridge();if(h){var f=this.getUiContextParentElem();if(!f){return null}else{var g=Kekule.HtmlElementUtils.getElemScrollDimension(f);e=h.createContext(f,g.width,g.height);this.setPropStoreFieldValue("uiContext",e)}}}return e}});this.defineProp("objDrawBridge",{dataType:DataType.OBJECT,serializable:false,setter:null,getter:function(){return this.getDrawBridge()}});this.defineProp("uiDrawBridge",{dataType:DataType.OBJECT,serializable:false,setter:null,getter:function(){var e=this.getPropStoreFieldValue("uiDrawBridge");if(!e){e=this.createUiDrawBridge();this.setPropStoreFieldValue("uiDrawBridge",e)}return e}});this.defineProp("uiPainter",{dataType:"Kekule.Render.ChemObjPainter",serializable:false,setter:null,getter:function(){var e=this.getPropStoreFieldValue("uiPainter");if(!e){var f=this.getUiMarkers();e=new Kekule.Render.ChemObjPainter(Kekule.Render.RendererType.R2D,f,this.getUiDrawBridge());this.setPropStoreFieldValue("uiPainter",e);return e}return e}});this.defineProp("uiRenderer",{dataType:"Kekule.Render.AbstractRenderer",serializable:false,setter:null,getter:function(){var f=this.getUiPainter();if(f){var e=f.getRenderer();if(!e){f.prepareRenderer()}return f.getRenderer()||null}else{return null}}});this.defineProp("uiMarkers",{dataType:"Kekule.ChemWidget.UiMarkerCollection",serializable:false,setter:null,getter:function(){var e=this.getPropStoreFieldValue("uiMarkers");if(!e){e=new Kekule.ChemWidget.UiMarkerCollection();this.setPropStoreFieldValue("uiMarkers",e)}return e}});this._defineUiMarkerProp("uiHotTrackMarker");this._defineUiMarkerProp("uiSelectionAreaMarker");this._defineUiMarkerProp("uiSelectingMarker");this.defineProp("uiSelectionAreaContainerBox",{dataType:DataType.Object,serializable:false,scope:Class.PropertyScope.PRIVATE});this.defineProp("objRendererMap",{dataType:"Kekule.MapEx",serializable:false,setter:null,getter:function(){var e=this.getPropStoreFieldValue("objRendererMap");if(!e){e=new Kekule.MapEx(true);this.setPropStoreFieldValue("objRendererMap",e)}return e}});this.defineProp("boundInfoRecorder",{dataType:"Kekule.Render.BoundInfoRecorder",serializable:false,setter:null})},_defineUiMarkerProp:function(e,f){return this.defineProp(e,{dataType:"Kekule.ChemWidget.AbstractUIMarker",serializable:false,getter:function(){var g=this.getPropStoreFieldValue(e);if(!g){g=this.createShapeBasedMarker(e,null,null,false)}return g},setter:function(h){if(!f){f=this.getUiMarkers()}var g=this.getPropValue(e);if(g){f.removeMarker(g);g.finalize()}f.addMarker(h);this.setPropStoreFieldValue(e,h)}})},doFinalize:function($super){var i=this.getPropStoreFieldValue("operHistory");if(i){i.finalize();this.setPropStoreFieldValue("operHistory",null)}var f=this.getPropStoreFieldValue("objDrawBridge");var g=this.getPropStoreFieldValue("operContext");if(f&&g){f.releaseContext(g)}this.setPropStoreFieldValue("operContext",null);var f=this.getPropStoreFieldValue("uiDrawBridge");var g=this.getPropStoreFieldValue("uiContext");if(f&&g){f.releaseContext(g)}this.setPropStoreFieldValue("uiDrawBridge",null);this.setPropStoreFieldValue("uiContext",null);var j=this.getPropStoreFieldValue("boundInfoRecorder");if(j){j.finalize()}this.setPropStoreFieldValue("boundInfoRecorder",null);var e=this.getPropStoreFieldValue("objRendererMap");if(e){e.finalize()}this.setPropStoreFieldValue("objRendererMap",null);$super()},createDefaultConfigs:function(){return new Kekule.Editor.BaseEditorConfigs()},doCreateRootElement:function(f){var e=f.createElement("div");return e},doCreateSubElements:function(g,e){var f=g.createElement("div");f.className=d.EDITOR_CLIENT;e.appendChild(f);this._editClientElem=f;return[f]},getCoreElement:function($super){return this._editClientElem||$super()},getEditClientElem:function(){return this._editClientElem},doGetWidgetClassName:function($super){var f=$super()+" "+d.EDITOR;var e=(this.getRenderType()===Kekule.Render.RendererType.R3D)?d.EDITOR3D:d.EDITOR2D;f+=" "+e;return f},doBindElement:function(e){this.createContextParentElems();this.createUiEventReceiverElem()},changeClientSize:function(g,q,m){this._initialRenderTransformParams=null;var j=this.getCoreElement();var f=j.style;if(!m){m=1}var p=g*m;var o=q*m;if(p){f.width=p+"px"}if(o){f.height=o+"px"}var e=[this.getObjContext(),this.getOperContext(),this.getUiContext()];for(var n=0,k=e.length;n<k;++n){var r=e[n];if(r){this.getDrawBridge().setContextDimension(r,p,o)}}this.repaint()},isDirty:function(){if(this.getEnableOperHistory()){return this.getOperHistory().getCurrIndex()>=0}else{return this._objChanged}},getChemObjSrcInfo:function(e){if(this.isDirty()){return null}else{return e.getSrcInfo?e.getSrcInfo():null}},getActualDrawOptions:function($super){var f=$super();if(this._initialRenderTransformParams){var e=Object.extend({},this._initialRenderTransformParams);e=Object.extend(e,f);return e}else{return f}},repaint:function($super,g){var f=g;var e=$super(f);if(!this._initialRenderTransformParams){this._initialRenderTransformParams=this.getPainter().getActualInitialRenderTransformOptions(this.getObjContext())}this.recalcUiMarkers();return e},newDoc:function(){if(this.getEnableCreateNewDoc()){this.load(this.doCreateNewDocObj())}},doCreateNewDocObj:function(){return new Kekule.Molecule()},getExportableClasses:function(){var e=this.getChemObj();if(!e){return[]}else{return e.getClass?e.getClass():null}},exportObj:function(e){var f=this.getChemObj();if(!e){return f}else{return(f&&(f instanceof e))?f:null}},doLoad:function($super,e){this.deselectAll();this._initialRenderTransformParams=null;this.getObjRendererMap().clear();if(this.getOperHistory()){this.getOperHistory().clear()}$super(e);this._objChanged=false},doLoadEnd:function($super,e){$super();if(!e){this._initialRenderTransformParams=null}},doResize:function($super){this._initialRenderTransformParams=null;$super()},geometryOptionChanged:function($super){var e=this.getDrawOptions().zoom;this.zoomChanged(e);$super()},zoomChanged:function(e){},chemObjChanged:function($super,f,e){$super(f,e);if(f!==e){if(e){this._uninstallChemObjEventListener(e)}if(f){this._installChemObjEventListener(f)}}},_installChemObjEventListener:function(e){e.addEventListener("change",this.reactChemObjChange,this)},_uninstallChemObjEventListener:function(e){e.removeEventListener("change",this.reactChemObjChange,this)},createUiEventReceiverElem:function(){var f=this.getCoreElement();if(f){var e=f.ownerDocument.createElement("div");e.className=d.EDITOR_UIEVENT_RECEIVER;f.appendChild(e);c.addClass(e,a.DYN_CREATED);this.setPropStoreFieldValue("uiEventReceiverElem",e);return e}},createContextParentElems:function(){var e=this.getCoreElement();if(e){var f=e.ownerDocument;this._createContextParentElem(f,e,"objContextParentElem");this._createContextParentElem(f,e,"operContextParentElem");this._createContextParentElem(f,e,"uiContextParentElem")}},_createContextParentElem:function(h,f,g){var e=h.createElement("div");e.style.position="absolute";e.style.width="100%";e.style.height="100%";e.className=g+" "+a.DYN_CREATED;this.setPropStoreFieldValue(g,e);f.appendChild(e);return e},createNewPainter:function($super,f){var e=$super(f);if(e){this.installPainterEventHandlers(e);this.createNewBoundInfoRecorder(this.getPainter())}return e},createNewBoundInfoRecorder:function(g){var e=this.getPropStoreFieldValue("boundInfoRecorder");if(e){e.finalize()}var f=new Kekule.Render.BoundInfoRecorder(g);this.setPropStoreFieldValue("boundInfoRecorder",f)},getDrawContextParentElem:function(){return this.getObjContextParentElem()},createUiDrawBridge:function(){var e=Kekule.Render.DrawBridge2DMananger.getPreferredBridgeInstance();if(!e){Kekule.error(Kekule.ErrorMsg.DRAW_BRIDGE_NOT_SUPPORTED)}return e},changeContextDimension:function($super,f){var e=$super(f);if(e){this._resizeContext(this.getOperContext(),this.getObjDrawBridge(),f.width,f.height);this._resizeContext(this.getUiContext(),this.getUiDrawBridge(),f.width,f.height)}return e},_resizeContext:function(f,h,g,e){if(f&&h){h.setContextDimension(f,g,e)}},_clearSpecContext:function(e,f){if(f&&e){f.clearContext(e)}},clearObjContext:function(){this._clearSpecContext(this.getObjContext(),this.getDrawBridge());if(this.getBoundInfoRecorder()){this.getBoundInfoRecorder().clear(this.getObjContext())}},clearOperContext:function(){this._clearSpecContext(this.getOperContext(),this.getDrawBridge())},clearUiContext:function(){this._clearSpecContext(this.getUiContext(),this.getUiDrawBridge())},clearContext:function(){this.clearObjContext();if(this._operatingRenderers){this.clearOperContext()}},repaintOperContext:function(){if(this._operatingRenderers&&this._operatingObjs){var e={partialDrawObjs:this._operatingObjs};this.repaint(e)}},installPainterEventHandlers:function(e){e.addEventListener("draw",this.reactChemObjDraw,this);e.addEventListener("clear",this.reactChemObjClear,this)},reactChemObjDraw:function(i){var f=i.context;var h=i.obj;if(h&&((f===this.getObjContext())||(f===this.getOperContext()))){var g=i.target;this.getObjRendererMap().set(h,g)}},reactChemObjClear:function(i){var f=i.context;var h=i.obj;if(h&&((f===this.getObjContext())||(f===this.getOperContext()))){var g=i.target;this.getObjRendererMap().remove(h)}},reactChemObjChange:function(g){var f=g.target;var i=g.changedPropNames;var h=["owner","ownedObjs"];i=Kekule.ArrayUtils.exclude(i,h);if(i.length){this.objectChanged(f,i)}},reactOperHistoryPush:function(f){this.invokeEvent("operPush",f)},reactOperHistoryPop:function(f){this.invokeEvent("operPop",f)},reactOperHistoryUndo:function(f){this.invokeEvent("operUndo",f)},reactOperHistoryRedo:function(f){this.invokeEvent("operRedo",f)},reactOperHistoryClear:function(f){this.invokeEvent("operHistoryClear",f)},reactOperHistoryChange:function(f){this.invokeEvent("operChange",f)},beginUpdateObject:function(){--this._objectUpdateFlag},endUpdateObject:function(){++this._objectUpdateFlag;if(!this.isUpdatingObject()){if((this._updatedObjectDetails&&this._updatedObjectDetails.length)){this.objectsChanged(this._updatedObjectDetails);this._updatedObjectDetails=[]}}},isUpdatingObject:function(){return(this._objectUpdateFlag<0)},objectChanged:function(h,f){var g={obj:h,propNames:f};var e=this.objectsChanged(g);this.invokeEvent("editObjChanged",Object.extend({},g));return e},objectsChanged:function(f){var e=DataType.isArrayValue(f)?f:[f];if(this.isUpdatingObject()){Kekule.ArrayUtils.pushUnique(this._updatedObjectDetails,e)}else{this.doObjectsChanged(e)}this._objChanged=true;this.invokeEvent("editObjsChanged",Object.extend({},f))},doObjectsChanged:function(l){var f=Kekule.ArrayUtils.clone(l);var i=Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(f);var k=this._getAdditionalRenderRelatedObjs(i);if(k.length){var h=Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(k);Kekule.ArrayUtils.pushUnique(f,h)}Kekule.ArrayUtils.pushUnique(i,k);var e=this._operatingRenderers;var g=e&&this._isAllObjsRenderedByRenderers(this.getObjContext(),i,e);var j=this.canModifyPartialGraphic();if(j){this.getRootRenderer().modify(this.getObjContext(),f);this.recalcUiMarkers()}else{if(g){this.repaintOperContext()}else{this.repaint()}}},_getAdditionalRenderRelatedObjs:function(k){var e=[];for(var g=0,f=k.length;g<f;++g){var h=k[g];var j=h.getCoordDeterminateObjects?h.getCoordDeterminateObjects():[];Kekule.ArrayUtils.pushUnique(e,j)}return e},_isAllObjsRenderedByRenderers:function(e,o,p){for(var n=0,f=o.length;n<f;++n){var m=o[n];var r=false;for(var h=0,g=p.length;h<g;++h){var q=p[h];if(q.isChemObjRenderedBySelf(e,m)){r=true;break}}if(!r){return false}}return true},prepareOperatingObjs:function(e){if(this._operatingRenderers&&this._operatingRenderers.length){this.endOperatingObjs(true)}if(this.getEnableOperContext()){this._prepareRenderObjsInOperContext(e);this._operatingObjs=e}this.repaint()},endOperatingObjs:function(e){if(this.getEnableOperContext()){this._endRenderObjsInOperContext();this._operatingObjs=null;if(!e){this.repaint()}}},_prepareRenderObjsInOperContext:function(r){var g=[];var e=this.getObjRendererMap();var n=e.getValues();var f=this.getObjContext();for(var q=0,h=r.length;q<h;++q){var p=r[q];for(var o=0,m=n.length;o<m;++o){var s=n[o];if(s.isChemObjRenderedDirectlyBySelf(f,p)){Kekule.ArrayUtils.pushUnique(g,s)}}}if(g.length>0){for(var q=0,h=g.length;q<h;++q){var s=g[q];s.setRedirectContext(this.getOperContext())}this._operatingRenderers=g}else{this._operatingRenderers=null}},_endRenderObjsInOperContext:function(){var f=this._operatingRenderers;if(f&&f.length){for(var g=0,e=f.length;g<e;++g){var h=f[g];h.setRedirectContext(null)}this.clearOperContext()}this._operatingRenderers=null},clearBoundMap:function(){this.getBoundInfoRecorder().clear(this.getObjContext())},findTopmostBoundInfo:function(h,g){if(h&&h.length){var e=null;var f=h.length-1;e=h[f];while((f>=0)&&(g&&(g.indexOf(e.obj)>=0))){--f;e=h[f]}return e}else{return null}},getBoundInfosAtCoord:function(f){var e=this.getBoundInfoRecorder();var j=this.getEditorConfigs().getInteractionConfigs().getObjBoundTrackInflation();var i=this.screenCoordToContext(f);var h=(this.getRenderType()===Kekule.Render.RendererType.R3D)?{x:0,y:0}:null;var g=e.getIntersectionInfos(this.getObjContext(),i,h,j);return g},getTopmostBoundInfoAtCoord:function(e,f){return this.findTopmostBoundInfo(this.getBoundInfosAtCoord(e),f)},getTopmostBasicObjectAtCoord:function(e){var f=this.getTopmostBoundInfoAtCoord(e);return f?f.obj:null},beginUpdateUiMarkers:function(){--this._uiMarkerUpdateFlag},endUpdateUiMarkers:function(){++this._uiMarkerUpdateFlag;if(!this.isUpdatingUiMarkers()){this.repaintUiMarker()}},isUpdatingUiMarkers:function(){return(this._uiMarkerUpdateFlag<0)},recalcUiMarkers:function(){this.beginUpdateUiMarkers();try{this.recalcHotTrackMarker();this.recalcSelectionAreaMarker()}finally{this.endUpdateUiMarkers()}},repaintUiMarker:function(){if(this.isUpdatingUiMarkers()){return}this.clearUiContext();var e=this.calcDrawParams();this.getUiPainter().draw(this.getUiContext(),e.baseCoord,e.drawOptions)},createShapeBasedMarker:function(h,g,i,f){var e=new Kekule.ChemWidget.MetaShapeUIMarker();if(g){e.setShapeInfo(g)}if(i){e.setDrawStyles(i)}this.setPropStoreFieldValue(h,e);this.getUiMarkers().addMarker(e);if(f){this.repaintUiMarker()}return e},modifyShapeBasedMarker:function(f,g,i,h){var e=Kekule.Render.ObjectUpdateType.MODIFY;f.setShapeInfo(g);if(i){f.setDrawStyles(i)}if(h){this.repaintUiMarker()}},hideUiMarker:function(e,f){e.setVisible(false);if(f){this.repaintUiMarker()}},showUiMarker:function(e,f){e.setVisible(true);if(f){this.repaintUiMarker()}},removeUiMarker:function(e){if(e){this.getUiMarkers().removeMarker(e);this.repaintUiMarker()}},clearUiMarkers:function(){this.getUiMarkers().clearMarkers();this.repaintUiMarker()},changeHotTrackMarkerBounds:function(p){var n=Kekule.ArrayUtils.toArray(p);var f=this.getEditorConfigs().getUiMarkerConfigs();var m={color:f.getHotTrackerColor(),opacity:f.getHotTrackerOpacity()};var q=this.getEditorConfigs().getInteractionConfigs().getObjBoundTrackInflation();var e=[];for(var j=0,g=n.length;j<g;++j){var k=n[j];var h=q?Kekule.Render.MetaShapeUtils.inflateShape(k,q):k;if(h){e.push(h)}}var o=this.getUiHotTrackMarker();o.setVisible(true);this.modifyShapeBasedMarker(o,e,m,true);return this},hideHotTrackMarker:function(){var e=this.getUiHotTrackMarker();if(e){this.hideUiMarker(e,true)}return this},showHotTrackMarker:function(){var e=this.getUiHotTrackMarker();if(e){this.showUiMarker(e,true)}return this},hotTrackOnCoord:function(e){if(this.getEditorConfigs().getInteractionConfigs().getEnableHotTrack()){this.setHotTrackedObj(this.getTopmostBasicObjectAtCoord(e))}return this},hotTrackOnObj:function(e){this.setHotTrackedObj(e);return this},hideHotTrack:function(){this.hideHotTrackMarker();return this},addHotTrackedObj:function(f){var e=this.getHotTrackedObjs()||[];Kekule.ArrayUtils.pushUnique(e,f);this.setHotTrackedObjs(e);return this},recalcHotTrackMarker:function(){this.setHotTrackedObjs(this.getHotTrackedObjs())},changeSelectionAreaMarkerBound:function(h){var f=this.getEditorConfigs().getUiMarkerConfigs();var g={strokeColor:f.getSelectionMarkerStrokeColor(),strokeWidth:f.getSelectionMarkerStrokeWidth(),fillColor:f.getSelectionMarkerFillColor(),opacity:f.getSelectionMarkerOpacity()};var e=this.getUiSelectionAreaMarker();e.setVisible(true);this.modifyShapeBasedMarker(e,h,g,true);return this},hideSelectionAreaMarker:function(){var e=this.getUiSelectionAreaMarker();if(e){this.hideUiMarker(e,true)}},showSelectionAreaMarker:function(){var e=this.getUiSelectionAreaMarker();if(e){this.showUiMarker(e,true)}},recalcSelectionAreaMarker:function(n){this.beginUpdateUiMarkers();try{var u=this.getSelection();var s=u.length;if(s<=0){this.hideSelectionAreaMarker()}else{var e=[];var f=null;var v=this.getEditorConfigs().getInteractionConfigs().getSelectionMarkerInflation();for(var q=0;q<s;++q){var p=u[q];var t=this.getBoundInfoRecorder().getBelongedInfos(this.getObjContext(),p);if(t&&t.length){for(var o=0,m=t.length;o<m;++o){var g=t[o];var l=g.boundInfo;if(l){l=Kekule.Render.MetaShapeUtils.inflateShape(l,v);e.push(l);var r=Kekule.Render.MetaShapeUtils.getContainerBox(l);f=f?Kekule.BoxUtils.getContainerBox(f,r):r}}}}this.setUiSelectionAreaContainerBox(f);if(f){var h=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.MetaShapeType.RECT,[{x:f.x1,y:f.y1},{x:f.x2,y:f.y2}]);e.push(h)}else{this.hideSelectionAreaMarker()}if(e.length){this.changeSelectionAreaMarkerBound(e)}}}finally{this.endUpdateUiMarkers()}},startSelectingBoxDrag:function(e,f){this._selectingBoxStartCoord=e;if(!f){this.deselectAll()}},dragSelectingBoxToCoord:function(e){var g=this._selectingBoxStartCoord;var f=e;this.changeSelectingMarkerBox(g,f)},endSelectingBoxDrag:function(e,i){var g=this._selectingBoxStartCoord;this._selectingBoxEndCoord=e;var h=Kekule.BoxUtils.createBox(g,e);var f=this.getEditorConfigs().getInteractionConfigs().getEnablePartialAreaSelecting();if(i){this.toggleSelectingStateOfObjectsInScreenBox(h,f)}else{this.selectObjectsInScreenBox(h,f)}this.hideSelectingMarker()},selectOnCoord:function(g,f){var e=this.getTopmostBasicObjectAtCoord(g);if(e){if(f){this.toggleSelectingState(e)}else{this.select(e)}}},changeSelectingMarkerBound:function(h){var f=this.getEditorConfigs().getUiMarkerConfigs();var g={strokeColor:f.getSelectingMarkerStrokeColor(),strokeWidth:f.getSelectingMarkerStrokeWidth(),strokeDash:f.getSelectingMarkerStrokeDash(),fillColor:f.getSelectingMarkerFillColor(),opacity:f.getSelectingMarkerOpacity()};var e=this.getUiSelectingMarker();e.setVisible(true);this.modifyShapeBasedMarker(e,h,g,true);return this},changeSelectingMarkerBox:function(g,e){var h=this.screenCoordToContext(g);var f=this.screenCoordToContext(e);var i=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.MetaShapeType.RECT,[{x:Math.min(h.x,f.x),y:Math.min(h.y,f.y)},{x:Math.max(h.x,f.x),y:Math.max(h.y,f.y)}]);return this.changeSelectingMarkerBound(i)},hideSelectingMarker:function(){var e=this.getUiSelectingMarker();if(e){this.hideUiMarker(e,true)}},showSelectingMarker:function(){var e=this.getUiSelectingMarker();if(e){this.showUiMarker(e,true)}},getCoordRegionInSelectionMarker:function(m,s){var h=Kekule.Editor.BoxRegion;var t=Kekule.CoordUtils;var n=this.screenCoordToContext(m);var i=this.getUiSelectionAreaMarker();if(i&&i.getVisible()){var k=this.getUiSelectionAreaContainerBox();if(Kekule.ObjUtils.isUnset(s)){s=this.getEditorConfigs().getInteractionConfigs().getSelectionMarkerEdgeInflation()}var g=(s/2)||0;var p=t.substract({x:k.x1,y:k.y1},{x:g,y:g});var o=t.add({x:k.x2,y:k.y2},{x:g,y:g});if((n.x<p.x)||(n.y<p.y)||(n.x>o.x)||(n.y>o.y)){return h.OUTSIDE}var f=t.substract(n,p);var e=t.substract(o,n);var r=f.x;var q=e.x;var l=f.y;var j=e.y;if(l<j){if(r<q){if(l<=s){return(r<=s)?h.CORNER_TL:h.EDGE_TOP}else{if(r<=s){return h.EDGE_LEFT}else{return h.INSIDE}}}else{if(l<=s){return(q<=s)?h.CORNER_TR:h.EDGE_TOP}else{if(q<=s){return h.EDGE_RIGHT}else{return h.INSIDE}}}}else{if(r<q){if(j<=s){return(r<=s)?h.CORNER_BL:h.EDGE_BOTTOM}else{if(r<=s){return h.EDGE_LEFT}else{return h.INSIDE}}}else{if(j<=s){return(q<=s)?h.CORNER_BR:h.EDGE_BOTTOM}else{if(q<=s){return h.EDGE_RIGHT}else{return h.INSIDE}}}}}return h.OUTSIDE},isCoordInSelectionMarkerBound:function(e){return(this.getCoordRegionInSelectionMarker(e)!==Kekule.Editor.BoxRegion.OUTSIDE)},getObjSelectedRenderOptions:function(){return this._selectedRenderOptions},_getObjRenderOptionItemAppendMethod:function(e){return(this.getRenderType()===Kekule.Render.RendererType.R3D)?e.addOverrideRender3DOptionItem:e.addOverrideRenderOptionItem},_getObjRenderOptionItemRemoveMethod:function(e){return(this.getRenderType()===Kekule.Render.RendererType.R3D)?e.removeOverrideRender3DOptionItem:e.removeOverrideRenderOptionItem},_addSelectRenderOptions:function(f){var e=this._getObjRenderOptionItemAppendMethod(f);return e.apply(f,[this.getObjSelectedRenderOptions()])},_removeSelectRenderOptions:function(f){var e=this._getObjRenderOptionItemRemoveMethod(f);return e.apply(f,[this.getObjSelectedRenderOptions()])},beginUpdateSelection:function(){this.beginUpdateObject();--this._objSelectFlag},endUpdateSelection:function(){++this._objSelectFlag;if(this._objSelectFlag>=0){this.selectionChanged()}this.endUpdateObject()},isUpdatingSelection:function(){return(this._objSelectFlag<0)},selectionChanged:function(){if(!this.isUpdatingSelection()){this.notifyPropSet("selection",this.getSelection());this.invokeEvent("selectionChange");return this.doSelectionChanged()}},doSelectionChanged:function(){this.recalcSelectionAreaMarker()},isInSelection:function(e){return this.getSelection().indexOf(e)>=0},addObjToSelection:function(f){var e=this.getSelection();Kekule.ArrayUtils.pushUnique(e,f.getNearestSelectableObject());this._addSelectRenderOptions(f);this.selectionChanged();return this},removeObjFromSelection:function(f){var e=this.getSelection();Kekule.ArrayUtils.remove(e,f);this._removeSelectRenderOptions(f);this.selectionChanged();return this},deselectAll:function(){var e=this.getSelection();return this.removeFromSelection(e)},select:function(e){this.beginUpdateSelection();try{this.deselectAll();this.addToSelection(e)}finally{this.endUpdateSelection()}return this},addToSelection:function(h){if(!h){return}var g=DataType.isArrayValue(h)?h:[h];this.beginUpdateSelection();try{for(var f=0,e=g.length;f<e;++f){this.addObjToSelection(g[f])}}finally{this.endUpdateSelection()}return this},removeFromSelection:function(g){if(!g){return}var f=DataType.isArrayValue(g)?g:[g];this.beginUpdateSelection();try{for(var e=f.length-1;e>=0;--e){this.removeObjFromSelection(f[e])}}finally{this.endUpdateSelection()}return this},toggleSelectingState:function(j){if(!j){return}var h=DataType.isArrayValue(j)?j:[j];this.beginUpdateSelection();try{for(var f=0,e=h.length;f<e;++f){var g=h[f];if(this.isInSelection(g)){this.removeObjFromSelection(g)}else{this.addObjToSelection(g)}}}finally{this.endUpdateSelection()}return this},hasSelection:function(){return !!this.getSelection().length},deleteSelectedObjs:function(){},getObjectsInScreenBox:function(p,g){var m=this.screenBoxToContext(p);var k=[];var f=this.getBoundInfoRecorder().getAllRecordedInfoOfContext(this.getObjContext());var e=g?Kekule.Render.MetaShapeUtils.isIntersectingBox:Kekule.Render.MetaShapeUtils.isInsideBox;for(var j=0,h=f.length;j<h;++j){var n=f[j];var o=n.boundInfo;if(o){if(e(o,m)){k.push(n.obj)}}}return k},selectObjectsInScreenBox:function(e,g){var f=this.getObjectsInScreenBox(e,g);if(f&&f.length){this.select(f)}return f},addObjectsInScreenBoxToSelection:function(e,g){var f=this.getObjectsInScreenBox(e,g);if(f&&f.length){this.addToSelection(f)}return f},removeObjectsInScreenBoxFromSelection:function(e,g){var f=this.getObjectsInScreenBox(e,g);if(f&&f.length){this.removeFromSelection(f)}return f},toggleSelectingStateOfObjectsInScreenBox:function(e,g){var f=this.getObjectsInScreenBox(e,g);if(f&&f.length){this.toggleSelectingState(f)}return f},getObjectsContainerBox:function(w,u){var t=Kekule.ArrayUtils.toArray(w);var g=u||0;var e=[];var f=null;for(var r=0,m=t.length;r<m;++r){var q=t[r];var v=this.getBoundInfoRecorder().getBelongedInfos(this.getObjContext(),q);if(v&&v.length){for(var p=0,o=v.length;p<o;++p){var h=v[p];var n=h.boundInfo;if(n){if(g){n=Kekule.Render.MetaShapeUtils.inflateShape(n,g)}var s=Kekule.Render.MetaShapeUtils.getContainerBox(n);f=f?Kekule.BoxUtils.getContainerBox(f,s):s}}}}return f},getSelectionContainerBox:function(e){return this.getObjectsContainerBox(this.getSelection(),e)},getObjSize:function(e){return this.doGetObjSize(e)},doGetObjSize:function(f){var e=this.getCoordMode();return f.getSizeOfMode?f.getSizeOfMode(e):null},setObjSize:function(f,e){this.doSetObjSize(f,e);this.objectChanged(f)},doSetObjSize:function(f,e){if(f.setSizeOfMode){f.setSizeOfMode(dimension,this.getCoordMode())}},getObjCoord:function(e){return this.doGetObjCoord(e)},doGetObjCoord:function(g){var f=this.getCoordMode();var e=this.getAllowCoordBorrow();return g.getAbsBaseCoord?g.getAbsBaseCoord(f,e):g.getAbsCoordOfMode?g.getAbsCoordOfMode(f,e):g.getCoordOfMode?g.getCoordOfMode(f,e):null},setObjCoord:function(e,f){this.doSetObjCoord(e,f);this.objectChanged(e)},doSetObjCoord:function(f,g){var e=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;if(f.setAbsBaseCoord){f.setAbsBaseCoord(g,e)}else{if(f.setAbsCoordOfMode){f.setAbsCoordOfMode(g,e)}else{if(f.setAbsCoordOfMode){f.setCoordOfMode(g,e)}}}},getObjectContextCoord:function(e){var f=this.getObjCoord(e);return this.objCoordToContext(f)},setObjectContextCoord:function(f,e){var g=this.contextCoordToObj(e);if(g){this.setObjCoord(f,g)}},getObjectScreenCoord:function(e){var f=this.getObjCoord(e);return this.objCoordToScreen(f)},setObjectScreenCoord:function(f,e){var g=this.screenCoordToObj(e);if(g){this.setObjCoord(f,g)}},getCoord:function(g,e){var f=this.getObjCoord(g);return this.translateCoord(f,Kekule.Editor.CoordSys.OBJ,e)},setCoord:function(h,g,e){var f=this.translateCoord(g,e,Kekule.Editor.CoordSys.OBJ);this.setObjCoord(h,f)},translateCoord:function(i,f,g){if(!i){return null}var h=Kekule.Editor.CoordSys;if(f===h.SCREEN){if(g===h.SCREEN){return i}else{if(g===h.CONTEXT){return this.getObjDrawBridge().transformScreenCoordToContext(this.getObjContext(),i)}else{var e=this.getObjDrawBridge().transformScreenCoordToContext(this.getObjContext(),i);return this.getRootRenderer().transformCoordToObj(this.getObjContext(),this.getChemObj(),e)}}}else{if(f===h.CONTEXT){if(g===h.SCREEN){return this.getObjDrawBridge().transformContextCoordToScreen(this.getObjContext(),i)}else{if(g===h.CONTEXT){return i}else{return this.getRootRenderer().transformCoordToObj(this.getObjContext(),this.getChemObj(),i)}}}else{if(g===h.SCREEN){var e=this.getRootRenderer().transformCoordToContext(this.getObjContext(),this.getChemObj(),i);return this.getObjDrawBridge().transformContextCoordToScreen(this.getObjContext(),e)}else{if(g===h.CONTEXT){return this.getRootRenderer().transformCoordToContext(this.getObjContext(),this.getChemObj(),i)}else{return i}}}}},objCoordToContext:function(f){var e=Kekule.Editor.CoordSys;return this.translateCoord(f,e.OBJ,e.CONTEXT)},contextCoordToObj:function(e){var f=Kekule.Editor.CoordSys;return this.translateCoord(e,f.CONTEXT,f.OBJ)},objCoordToScreen:function(f){var e=Kekule.Editor.CoordSys;return this.translateCoord(f,e.OBJ,e.SCREEN)},screenCoordToObj:function(e){var f=Kekule.Editor.CoordSys;return this.translateCoord(e,f.SCREEN,f.OBJ)},screenCoordToContext:function(e){var f=Kekule.Editor.CoordSys;return this.translateCoord(e,f.SCREEN,f.CONTEXT)},contextCoordToScreen:function(e){var f=Kekule.Editor.CoordSys;return this.translateCoord(e,f.CONTEXT,f.SCREEN)},screenBoxToContext:function(e){var g=this.screenCoordToContext({x:e.x1,y:e.y1});var f=this.screenCoordToContext({x:e.x2,y:e.y2});return{x1:g.x,y1:g.y,x2:f.x,y2:f.y}},createDefaultNode:function(i,e,f){var h=this.getEditorConfigs().getStructureConfigs().getDefIsotopeId();var g=new Kekule.Atom();g.setIsotopeId(h);if(f){f.appendNode(g)}this.setCoord(g,i,e);return g},operationDone:function(e){this.doOperationDone(e)},doOperationDone:function(e){},clearOperHistory:function(){var e=this.getOperHistory();if(e){e.clear()}},pushOperation:function(e,g){var f=this.getOperHistory();if(f&&e){f.push(e)}if(g){e.execute()}},popOperation:function(e){var g;var f=this.getOperHistory();if(f){g=f.pop(operation);if(e){g.reverse()}}else{return null}},undo:function(){var f;var e=this.getOperHistory();if(e){this.beginUpdateObject();try{f=e.undo()}finally{this.endUpdateObject();if(f){this.operationDone(f)}}}return f},redo:function(){var f;var e=this.getOperHistory();if(e){this.beginUpdateObject();try{f=e.redo()}finally{this.endUpdateObject();if(f){this.operationDone(f)}}}return f},undoAll:function(){var f;var e=this.getOperHistory();if(e){this.beginUpdateObject();try{f=e.undoAll()}finally{this.endUpdateObject()}}return f},canUndo:function(){var e=this.getOperHistory();return e?e.canUndo():false},canRedo:function(){var e=this.getOperHistory();return e?e.canRedo():false},modifyObjects:function(e,h,o){var n=Kekule.ArrayUtils.toArray(e);try{var f=new Kekule.MacroOperation();for(var m=0,j=n.length;m<j;++m){var k=n[m];var g=new Kekule.ChemObjOperation.Modify(k,h);f.add(g)}f.execute()}finally{if(o&&this.getEnableOperHistory()&&f.getChildCount()){this.pushOperation(f)}}return this},modifyObjectsRenderOptions:function(g,o,n,t){var s=Kekule.ArrayUtils.toArray(g);var f=n?"render3DOptions":"renderOptions";var u=n?"getRender3DOptions":"getRenderOptions";try{var j=new Kekule.MacroOperation();for(var r=0,m=s.length;r<m;++r){var q=s[r];if(q[u]){var h=q[u]();var e=Object.extend({},h);e=Object.extend(e,o);var p={};p[f]=e;var k=new Kekule.ChemObjOperation.Modify(q,p);j.add(k)}}j.execute()}finally{if(t&&this.getEnableOperHistory()&&j.getChildCount()){this.pushOperation(j)}}return this},getClientScrollPosition:function(){var e=this.getEditClientElem().parentNode;return e?{x:e.scrollLeft,y:e.scrollTop}:null},scrollClientTo:function(f,g){var e=this.getEditClientElem().parentNode;if(Kekule.ObjUtils.notUnset(f)){e.scrollTop=f}if(Kekule.ObjUtils.notUnset(g)){e.scrollLeft=g}return this},scrollClientToTop:function(){return this.scrollClientTo(0,null)}});Kekule.Editor.BaseEditor.Settings=Class.create(Kekule.ChemWidget.ChemObjDisplayer.Settings,{CLASS_NAME:"Kekule.Editor.BaseEditor.Settings",initProperties:function(){this.defineProp("enableCreateNewDoc",{dataType:DataType.BOOL,serializable:false,getter:function(){return this.getEditor().getEnableCreateNewDoc()},setter:function(e){this.getEditor().setEnableCreateNewDoc(e)}});this.defineProp("initOnNewDoc",{dataType:DataType.BOOL,serializable:false,getter:function(){return this.getEditor().getInitOnNewDoc()},setter:function(e){this.getEditor().setInitOnNewDoc(e)}});this.defineProp("enableOperHistory",{dataType:DataType.BOOL,serializable:false,getter:function(){return this.getEditor().getEnableOperHistory()},setter:function(e){this.getEditor().setEnableOperHistory(e)}})},getEditor:function(){return this.getDisplayer()}});Kekule.Editor.IaControllerManager={_controllerMap:new Kekule.MapEx(true),register:function(f,e){b._controllerMap.set(f,e)},unregister:function(e){b._controllerMap.remove(e)},getAllControllerClasses:function(){return b._controllerMap.getKeys()},getAvailableControllerClasses:function(f){var e=[];var k=b.getAllControllerClasses();for(var j=0,g=k.length;j<g;++j){var m=k[j];var h=b._controllerMap.get(m);if(!h||ClassEx.isOrIsDescendantOf(f,h)){e.push(m)}}return e}};var b=Kekule.Editor.IaControllerManager;Kekule.Editor.BaseEditorIaController=Class.create(Kekule.Widget.InteractionController,{CLASS_NAME:"Kekule.Editor.BaseEditorIaController",initialize:function($super,e){$super(e)},initProperties:function(){this.defineProp("manuallyHotTrack",{dataType:DataType.BOOL,serializable:false})},getDefId:function(){return Kekule.ClassUtils.getLastClassName(this.getClassName())},getEditor:function(){return this.getWidget()},setEditor:function(e){return this.setWidget(e)},getEditorConfigs:function(){var e=this.getEditor();return e?e.getEditorConfigs():null},handleUiEvent:function($super,i){var g=false;var h=i.getTarget();var f=this.getEditor().getUiEventReceiverElem();if(f){if((h===f)||Kekule.DomUtils.isDescendantOf(h,f)){g=true}}else{g=true}if(g){$super(i)}},canInteractWithObj:function(e){return !!e},zoomEditor:function(e){if(e>0){this.getEditor().zoomIn(e)}else{if(e<0){this.getEditor().zoomOut(-e)}}},react_mousemove:function(g){var h=this._getEventMouseCoord(g);var f=this.getEditor().getTopmostBasicObjectAtCoord(h);if(!this.getManuallyHotTrack()){if(f&&this.canInteractWithObj(f)){this.getEditor().hotTrackOnObj(f)}else{this.getEditor().hotTrackOnObj(null)}}return true},react_mousewheel:function(f){if(f.getCtrlKey()){var g=f.wheelDeltaY||f.wheelDelta;if(g){g/=120}this.zoomEditor(g);f.preventDefault();return true}},_getEventMouseCoord:function($super,h,g){var f=g||this.getWidget().getCoreElement();return $super(h,f)}});Kekule.Editor.BasicEraserIaController=Class.create(Kekule.Editor.BaseEditorIaController,{CLASS_NAME:"Kekule.Editor.BasicEraserIaController",initialize:function($super,e){$super(e);this._isExecuting=false},canInteractWithObj:function(e){return !!e},removeObjs:function(e){if(e&&e.length){var f=this.doGetActualRemovedObjs(e);this.doRemoveObjs(f)}},doRemoveObjs:function(e){},doGetActualRemovedObjs:function(e){return e},removeSelection:function(){var e=this.getEditor();this.removeObjs(e.getSelection());e.deselectAll()},removeOnScreenCoord:function(f){var e=this.getEditor().getTopmostBasicObjectAtCoord(f);if(e){this.removeObjs([e]);return true}else{return false}},startRemove:function(){this._isExecuting=true},endRemove:function(){this._isExecuting=false},isRemoving:function(){return this._isExecuting},react_mousedown:function(f){if(f.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){this.startRemove();var g=this._getEventMouseCoord(f);this.removeOnScreenCoord(g)}else{if(f.getButton()===Kekule.X.Event.MOUSE_BTN_RIGHT){this.endRemove()}}},react_mouseup:function(f){if(f.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){this.endRemove()}},react_mousemove:function($super,f){$super(f);if(this.isRemoving()){var g=this._getEventMouseCoord(f);this.removeOnScreenCoord(g)}return true}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.BasicEraserIaController,Kekule.Editor.BaseEditor);Kekule.Editor.BasicManipulationIaController=Class.create(Kekule.Editor.BaseEditorIaController,{CLASS_NAME:"Kekule.Editor.BasicManipulationIaController",initialize:function($super,e){$super(e);this.setState(Kekule.Editor.BasicManipulationIaController.State.NORMAL);this.setEnableSelect(true);this.setEnableMove(true);this.setEnableResize(true);this.setEnableConstrainedResize(true);this.setEnableRotate(true);this._suppressConstrainedResize=false},initProperties:function(){this.defineProp("enableSelect",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableMove",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableResize",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableRotate",{dataType:DataType.BOOL,serializable:false});this.defineProp("state",{dataType:DataType.INT,serializable:false});this.defineProp("startCoord",{dataType:DataType.HASH,serializable:false});this.defineProp("endCoord",{dataType:DataType.HASH,serializable:false});this.defineProp("startBox",{dataType:DataType.HASH,serializable:false});this.defineProp("endBox",{dataType:DataType.HASH,serializable:false});this.defineProp("rotateCenter",{dataType:DataType.HASH,serializable:false,getter:function(){var e=this.getPropStoreFieldValue("rotateCenter");if(!e){var f=this.getStartBox();e=f?{x:(f.x1+f.x2)/2,y:(f.y1+f.y2)/2}:null}return e}});this.defineProp("resizeStartingRegion",{dataType:DataType.INT,serializable:false});this.defineProp("enableConstrainedResize",{dataType:DataType.BOOL,serializable:false});this.defineProp("rotateStartingRegion",{dataType:DataType.INT,serializable:false});this.defineProp("manipulateOriginObjs",{dataType:DataType.ARRAY,serializable:false});this.defineProp("manipulateObjs",{dataType:DataType.ARRAY,serializable:false,setter:function(e){this.setPropStoreFieldValue("manipulateObjs",e);if(!e){this.getEditor().endOperatingObjs()}else{this.getEditor().prepareOperatingObjs(e)}}});this.defineProp("manipulateObjInfoMap",{dataType:DataType.OBJECT,serializable:false,setter:null,getter:function(){var e=this.getPropStoreFieldValue("manipulateObjInfoMap");if(!e){e=new Kekule.MapEx(true);this.setPropStoreFieldValue("manipulateObjInfoMap",e)}return e}});this.defineProp("manipulateObjCurrInfoMap",{dataType:DataType.OBJECT,serializable:false,setter:null,getter:function(){var e=this.getPropStoreFieldValue("manipulateObjCurrInfoMap");if(!e){e=new Kekule.MapEx(true);this.setPropStoreFieldValue("manipulateObjCurrInfoMap",e)}return e}});this.defineProp("manipulationType",{dataType:DataType.INT,serializable:false});this.defineProp("isManipulatingSelection",{dataType:DataType.BOOL,serializable:false});this.defineProp("moveOperations",{dataType:DataType.ARRAY,serializable:false});this.defineProp("objOperationMap",{dataType:"Kekule.MapEx",serializable:false,getter:function(){var e=this.getPropStoreFieldValue("objOperationMap");if(!e){e=new Kekule.MapEx(true);this.setPropStoreFieldValue("objOperationMap",e)}return e}})},doFinalize:function($super){var e=this.getPropStoreFieldValue("manipulateObjInfoMap");if(e){e.clear()}e=this.getPropStoreFieldValue("objOperationMap");if(e){e.clear()}$super()},isConstrainedResize:function(){return this.getEnableConstrainedResize()&&(!this._suppressConstrainedResize)},getCoordOnSelectionRotationRegion:function(n){var j=Kekule.Editor.BoxRegion;var o=this.getEditor();var p=o.getCoordRegionInSelectionMarker(n);if(p!==j.OUTSIDE){return false}var e=o.getEditorConfigs().getInteractionConfigs().getRotationRegionInflation();var k=o.getUiSelectionAreaContainerBox();if(k&&o.hasSelection()){var m=[j.CORNER_TL,j.CORNER_TR,j.CORNER_BR,j.CORNER_BL];var u=[{x:k.x1,y:k.y1},{x:k.x2,y:k.y1},{x:k.x2,y:k.y2},{x:k.x1,y:k.y2}];var v=false;var t=e;for(var h=0,g=m.length;h<g;++h){var s=m[h];var q=u[h];var f=Kekule.CoordUtils.getDistance(q,n);if(f<=t){v=s;t=f}}return v}else{return false}},createManipulateOperation:function(){var k=[];this.setMoveOperations(k);var n=this.getManipulateObjs();var f=this.getManipulateObjInfoMap();var g=this.getObjOperationMap();g.clear();for(var m=0,h=n.length;m<h;++m){var j=n[m];var o=f.get(j);var e=new Kekule.ChemObjOperation.MoveAndResize(j,null,null,this.getEditor().getCoordMode(),true);e.setAllowCoordBorrow(this.getEditor().getAllowCoordBorrow());e.setOldCoord(o.objCoord);e.setOldDimension(o.dimension);k.push(e)}return k},updateChildMoveOperation:function(g,e,f){var h=this.getMoveOperations()[g];h.setNewCoord(f)},updateChildResizeOperation:function(g,f,e){var h=this.getMoveOperations()[g];h.setNewDimension(e)},getAllObjOperations:function(){var e=this.getMoveOperations();return e},getActiveOperation:function(){var e=this.getAllObjOperations();e=Kekule.ArrayUtils.toUnique(e);if(e.length<=0){return null}else{if(e.length===1){return e[0]}else{var f=new Kekule.MacroOperation(e);return f}}},reverseActiveOperation:function(){return this.getActiveOperation().reverse()},addOperationToEditor:function(){var e=this.getEditor();if(e&&e.getEnableOperHistory()){e.pushOperation(this.getActiveOperation())}},getActualManipulatingObjects:function(j){var e=[];for(var g=0,f=j.length;g<f;++g){var h=j[g];var k=h.getCoordDependentObjects?h.getCoordDependentObjects():[h];Kekule.ArrayUtils.pushUnique(e,k)}return e},prepareManipulating:function(o,p,m,h,r){this.setManipulationType(o);var n=this.getActualManipulatingObjects(p);this.setManipulateOriginObjs(p);this.setManipulateObjs(n);var e=this.getManipulateObjInfoMap();e.clear();this.getManipulateObjCurrInfoMap().clear();var q=this.getEditor();for(var k=0,g=n.length;k<g;++k){var j=n[k];var f=this.createManipulateObjInfo(j,m);e.set(j,f)}this.setStartBox(h);this.setRotateCenter(r);this.createManipulateOperation()},cancelManipulatingObjs:function(){var e=this.getEditor();var f=this.getManipulateObjs();this.reverseActiveOperation();this.notifyCoordChangeOfObjects(this.getManipulateObjs())},_maniplateObjsFrameEnd:function(e){},_addManipultingObjNewInfo:function(h,f){var e=this.getManipulateObjCurrInfoMap();var g=e.get(h)||{};g=Object.extend(g,f);e.set(h,g)},applyManipulatingObjsInfo:function(m){var k=this.getManipulateObjs();var h=this.getManipulateObjCurrInfoMap();for(var f=0,e=k.length;f<e;++f){var j=k[f];var g=h.get(j);this.applySingleManipulatingObjInfo(f,j,g,m)}},applySingleManipulatingObjInfo:function(h,f,e,g){if(e){if(e.screenCoord){this.doMoveManipulatedObj(h,f,e.screenCoord,g)}if(e.size){this.doResizeManipulatedObj(h,f,e.Size)}}},_calcActualRotateAngle:function(e,f){return f},_calcManipulateObjsRotationInfo:function(e,x){var o=Kekule.CoordUtils;var y;var g=false;var j=this.getRotateCenter();var q=this.getStartCoord();var h=this.getEditorConfigs().getInteractionConfigs().getRotationLocationPointDistanceThreshold();if(h){var s=o.getDistance(q,j);if(s<h){y=0;g=true;this.setStartCoord(x)}var w=o.getDistance(x,j);if(w<h){y=0;g=true;return}}if(!g){var f=o.substract(x,j);var r=Math.atan2(f.y,f.x);f=o.substract(q,j);var u=Math.atan2(f.y,f.x);y=r-u;y=this._calcActualRotateAngle(e,y)}var k=Kekule.CoordUtils.calcTransform2DMatrix({center:j,rotateAngle:y});for(var v=0,t=e.length;v<t;++v){var n=e[v];var z=this.getManipulateObjInfoMap().get(n);if(!z.hasNoCoord){var p=z.screenCoord;var m=o.transform2DByMatrix(p,k);this._addManipultingObjNewInfo(n,{screenCoord:m})}if(z.size){}}},rotateManipulatedObjs:function(k){var h=Kekule.Editor.BoxRegion;var j=Kekule.CoordUtils;var g=this.getEditor();var i=this.getManipulateObjs();var f=[];this._calcManipulateObjsRotationInfo(i,k);var e=this.getManipulateObjCurrInfoMap();g.beginUpdateObject();try{this.applyManipulatingObjsInfo(k);this._maniplateObjsFrameEnd(i);this.notifyCoordChangeOfObjects(i)}finally{g.endUpdateObject()}},_calcManipulateObjsResizeInfo:function(f,h,A){var j=Kekule.Editor.BoxRegion;var t=Kekule.CoordUtils;var n=this.getStartBox();var B=t.substract(A,this.getStartCoord());var o;if(h===j.EDGE_TOP){B.x=0;o={x:(n.x1+n.x2)/2,y:n.y2}}else{if(h===j.EDGE_BOTTOM){B.x=0;o={x:(n.x1+n.x2)/2,y:n.y1}}else{if(h===j.EDGE_LEFT){B.y=0;o={x:n.x2,y:(n.y1+n.y2)/2}}else{if(h===j.EDGE_RIGHT){B.y=0;o={x:n.x1,y:(n.y1+n.y2)/2}}else{if(this.isConstrainedResize()){var z=(n.x2-n.x1)/(n.y2-n.y1);var y=B.x/B.y;if(Math.abs(y)>z){B.x=B.y*z*Math.sign(y)}else{B.y=B.x/z*Math.sign(y)}}o=(h===j.CORNER_TL)?{x:n.x2,y:n.y2}:(h===j.CORNER_TR)?{x:n.x1,y:n.y2}:(h===j.CORNER_BL)?{x:n.x2,y:n.y1}:{x:n.x1,y:n.y1}}}}}var q=(h===j.CORNER_TL)||(h===j.CORNER_BL)||(h===j.EDGE_LEFT);var p=(h===j.CORNER_TL)||(h===j.CORNER_TR)||(h===j.EDGE_TOP);var F=1+B.x/(n.x2-n.x1)*(q?-1:1);var E=1+B.y/(n.y2-n.y1)*(p?-1:1);var w={center:o,scaleX:F,scaleY:E};var g=false;var m=g?t.calcTransform3DMatrix(w):t.calcTransform2DMatrix(w);for(var x=0,v=f.length;x<v;++x){var s=f[x];var D=this.getManipulateObjInfoMap().get(s);var k={};if(!D.hasNoCoord){var u=D.screenCoord;var r=g?t.transform3DByMatrix(u,m):t.transform2DByMatrix(u,m);k.screenCoord=r}if(D.size){var e={x:D.size.x*Math.abs(F),y:D.size.y*Math.abs(E)};k.size=e}this._addManipultingObjNewInfo(s,k)}},resizeManipulatedObjs:function(h){var e=this.getEditor();var g=this.getManipulateObjs();this._calcManipulateObjsResizeInfo(g,this.getResizeStartingRegion(),h);e.beginUpdateObject();var f=this.getManipulateObjCurrInfoMap();try{this.applyManipulatingObjsInfo(h);this._maniplateObjsFrameEnd(g);this.notifyCoordChangeOfObjects(g)}finally{e.endUpdateObject()}},_calcActualMovedScreenCoord:function(g,f,e){return e},_calcManipulateObjsMoveInfo:function(n,o){var e=Kekule.CoordUtils;var g=this.getManipulateObjCurrInfoMap();for(var k=0,h=n.length;k<h;++k){var j=n[k];var f=this.getManipulateObjInfoMap().get(j);if(f.hasNoCoord){continue}var m=e.add(o,f.screenCoordOffset);m=this._calcActualMovedScreenCoord(j,f,m);this._addManipultingObjNewInfo(j,{screenCoord:m})}},moveManipulatedObjs:function(j){var i=Kekule.CoordUtils;var f=this.getEditor();var h=this.getManipulateObjs();var e=[];this._calcManipulateObjsMoveInfo(h,j);f.beginUpdateObject();var g=this.getManipulateObjCurrInfoMap();try{this.applyManipulatingObjsInfo(j);this._maniplateObjsFrameEnd(h);this.notifyCoordChangeOfObjects(h)}finally{f.endUpdateObject()}},doMoveManipulatedObj:function(i,h,f,e){var g=this.getEditor();this.updateChildMoveOperation(i,h,g.screenCoordToObj(f));g.setObjectScreenCoord(h,f)},doResizeManipulatedObj:function(g,f,e){this.updateChildResizeOperation(g,f,e);if(f.setSizeOfMode){f.setSizeOfMode(e,this.getEditor().getCoordMode())}},startDirectManipulate:function(i,g,e,j,f){var h=Kekule.ArrayUtils.toArray(g);this.setState(Kekule.Editor.BasicManipulationIaController.State.MANIPULATING);this.setStartCoord(e);this.setIsManipulatingSelection(false);this.prepareManipulating(i||Kekule.Editor.BasicManipulationIaController.ManipulationType.MOVE,h,e,j,f)},stopManipulate:function(){this.setManipulateObjs(null);this.getManipulateObjInfoMap().clear();this.getObjOperationMap().clear()},createManipulateObjInfo:function(h,e){var f=this.getEditor();var g={objCoord:f.getObjCoord(h),screenCoord:f.getObjectScreenCoord(h),size:f.getObjSize(h)};g.hasNoCoord=!g.objCoord;if(!g.hasNoCoord){g.screenCoordOffset=Kekule.CoordUtils.substract(g.screenCoord,e)}return g},notifyCoordChangeOfObjects:function(m){var h=[];var g=this.getEditor();for(var f=0,e=m.length;f<e;++f){var j=m[f];Kekule.ArrayUtils.pushUnique(h,j);var k=j.getCoordDeterminateObjects?j.getCoordDeterminateObjects():[j];Kekule.ArrayUtils.pushUnique(h,k)}g.objectsChanged(h)},canInteractWithObj:function(e){return(this.getState()===Kekule.Editor.BasicManipulationIaController.State.NORMAL)&&e},doTestMouseCursor:function(l,i){var f="";var k=this._getEventMouseCoord(i,this.getEditor().getEditClientElem());if(this.getState()===Kekule.Editor.BasicManipulationIaController.State.NORMAL){if(this.getEnableResize()){var g=Kekule.Editor.BoxRegion;var h=this.getEditor().getCoordRegionInSelectionMarker(k);var f=(h===g.INSIDE)?"move":(h===g.CORNER_TL)?"nwse-resize":(h===g.CORNER_TR)?"nesw-resize":(h===g.CORNER_BL)?"nesw-resize":(h===g.CORNER_BR)?"nwse-resize":(h===g.EDGE_TOP)||(h===g.EDGE_BOTTOM)?"ns-resize":(h===g.EDGE_LEFT)||(h===g.EDGE_RIGHT)?"ew-resize":""}if(!f){if(this.getEnableRotate()){var h=this.getCoordOnSelectionRotationRegion(k);if(!!h){var j=Kekule.Widget.StyleResourceNames;f=(h===g.CORNER_TL)?j.CURSOR_ROTATE_NW:(h===g.CORNER_TR)?j.CURSOR_ROTATE_NE:(h===g.CORNER_BL)?j.CURSOR_ROTATE_SW:(h===g.CORNER_BR)?j.CURSOR_ROTATE_SE:j.CURSOR_ROTATE}}}}return f},react_mousemove:function($super,j){$super(j);if(this._isBusy){return true}var l=this._getEventMouseCoord(j);if(this._lastMouseMoveCoord){var f=Kekule.CoordUtils.getDistance(l,this._lastMouseMoveCoord);if(f<2){return true}}this._lastMouseMoveCoord=l;var h=Kekule.Editor.BasicManipulationIaController.State;var g=Kekule.Editor.BasicManipulationIaController.ManipulationType;var i=this.getState();if(i===h.SELECTING){if(this.getEnableSelect()){this.getEditor().dragSelectingBoxToCoord(l)}}else{if(i===h.MANIPULATING){var k=this.getManipulationType();try{this._isBusy=true;if(k===g.MOVE){this.moveManipulatedObjs(l)}else{if(k===g.RESIZE){this._suppressConstrainedResize=j.getAltKey();this.resizeManipulatedObjs(l)}else{if(k===g.ROTATE){this.rotateManipulatedObjs(l)}}}}finally{this._isBusy=false}}}return true},react_mousedown:function(n){var j=Kekule.Editor.BasicManipulationIaController.State;var h=Kekule.Editor.BasicManipulationIaController.ManipulationType;if(n.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){this._lastMouseMoveCoord=null;var m=this._getEventMouseCoord(n);if((this.getState()===j.NORMAL)){this.setStartCoord(m);var i=this.getEditor().getCoordRegionInSelectionMarker(m);var l=Kekule.Editor.BoxRegion;var o=this.getEnableResize()&&(i!==l.INSIDE)&&(i!==l.OUTSIDE);var p=!o&&this.getEnableMove()&&(i!==l.OUTSIDE);var g=this.getCoordOnSelectionRotationRegion(m);var q=!o&&!p&&this.getEnableRotate()&&!!g;if(o){this.setState(j.MANIPULATING);this.setIsManipulatingSelection(true);this.setResizeStartingRegion(i);this.prepareManipulating(h.RESIZE,this.getEditor().getSelection(),m,this.getEditor().getSelectionContainerBox())}else{if(p){this.setState(j.MANIPULATING);this.setIsManipulatingSelection(true);this.prepareManipulating(h.MOVE,this.getEditor().getSelection(),m)}else{if(q){this.setState(j.MANIPULATING);this.setIsManipulatingSelection(true);this.setRotateStartingRegion(g);this.prepareManipulating(h.ROTATE,this.getEditor().getSelection(),m,this.getEditor().getSelectionContainerBox())}else{var k=this.getEditor().getTopmostBasicObjectAtCoord(m);if(k){k=k.getNearestSelectableObject();if(this.getEnableMove()){this.startDirectManipulate(null,k,m)}}else{if(this.getEnableSelect()){var f=n.getShiftKey();this.getEditor().startSelectingBoxDrag(m,f);this.setState(j.SELECTING)}}}}}}}else{if(n.getButton()===Kekule.X.Event.MOUSE_BTN_RIGHT){if(this.getState()===j.MANIPULATING){this.cancelManipulatingObjs();this.setState(j.NORMAL);n.stopPropagation()}}}return true},react_mouseup:function(k){if(k.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){var l=this._getEventMouseCoord(k);this.setEndCoord(l);var h=this.getStartCoord();var f=l;var j=k.getShiftKey();var i=this.getState();var g=Kekule.Editor.BasicManipulationIaController.State;if(i===g.SELECTING){this.getEditor().endSelectingBoxDrag(l,j);this.setState(g.NORMAL)}else{if(i===g.MANIPULATING){if(Kekule.CoordUtils.isEqual(h,f)){if(this.getEnableSelect()){this.getEditor().selectOnCoord(h,j)}}else{if(this.getEnableMove()){this.addOperationToEditor()}}this.stopManipulate();this.setState(g.NORMAL)}}}return true}});Kekule.Editor.BasicManipulationIaController.State={NORMAL:0,SELECTING:1,MANIPULATING:2};Kekule.Editor.BasicManipulationIaController.ManipulationType={MOVE:0,ROTATE:1,RESIZE:2};Kekule.Editor.IaControllerManager.register(Kekule.Editor.BasicManipulationIaController,Kekule.Editor.BaseEditor)})();(function(){Kekule.ChemObjOperation={};Kekule.ChemObjOperation.Base=Class.create(Kekule.Operation,{CLASS_NAME:"Kekule.ChemObjOperation.Base",initialize:function($super,a){$super();this.setTarget(a)},initProperties:function(){this.defineProp("target",{dataType:"Kekule.ChemObject",serializable:false});this.defineProp("allowCoordBorrow",{dataType:DataType.BOOL})}});Kekule.ChemObjOperation.Modify=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemObjOperation.Modify",initialize:function($super,b,a){$super(b);if(a){this.setNewPropValues(a)}},initProperties:function(){this.defineProp("newPropValues",{dataType:DataType.HASH});this.defineProp("oldPropValues",{dataType:DataType.HASH})},doExecute:function(){var a={};var d=this.getNewPropValues();var c=this.getTarget();for(var e in d){var b=d[e];a[e]=c.getPropValue(e);c.setPropValue(e,b)}this.setOldPropValues(a)},doReverse:function(){var c=this.getOldPropValues();var b=this.getTarget();for(var d in c){var a=c[d];b.setPropValue(d,a)}}});Kekule.ChemObjOperation.MoveTo=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemObjOperation.MoveTo",initialize:function($super,d,a,b,c){$super(d);if(a){this.setNewCoord(a)}this.setCoordMode(b||Kekule.CoordMode.COORD2D);this.setUseAbsCoord(!!c)},initProperties:function(){this.defineProp("newCoord",{dataType:DataType.HASH});this.defineProp("oldCoord",{dataType:DataType.HASH});this.defineProp("coordMode",{dataType:DataType.INT});this.defineProp("useAbsCoord",{dataType:DataType.BOOL})},setObjCoord:function(c,e,b){if(c&&e&&b){var d=false;if(this.getUseAbsCoord()){if(c.setAbsCoordOfMode){c.setAbsCoordOfMode(e,b);d=true}}else{if(c.setCoordOfMode){c.setCoordOfMode(e,b);d=true}}if(!d){var a=c.getClassName?c.getClassName():(typeof c);Kekule.warn(Kekule.ErrorMsg.CAN_NOT_SET_COORD_OF_CLASS.format(a))}}},getObjCoord:function(b,a){if(this.getUseAbsCoord()){if(b.getAbsCoordOfMode){return b.getAbsCoordOfMode(a,this.getAllowCoordBorrow())}}else{if(b.getCoordOfMode){return b.getCoordOfMode(a,this.getAllowCoordBorrow())}}return null},doExecute:function(){var a=this.getTarget();if(!this.getOldCoord()){this.setOldCoord(this.getObjCoord(a,this.getCoordMode()))}if(this.getNewCoord()){this.setObjCoord(this.getTarget(),this.getNewCoord(),this.getCoordMode())}},doReverse:function(){if(this.getOldCoord()){this.setObjCoord(this.getTarget(),this.getOldCoord(),this.getCoordMode())}}});Kekule.ChemObjOperation.MoveAndResize=Class.create(Kekule.ChemObjOperation.MoveTo,{CLASS_NAME:"Kekule.ChemObjOperation.MoveAndResize",initialize:function($super,e,b,a,c,d){$super(e,a,c,d)},initProperties:function(){this.defineProp("newDimension",{dataType:DataType.HASH});this.defineProp("oldDimension",{dataType:DataType.HASH})},setObjSize:function(d,c,b){if(d&&c){if(d.setSizeOfMode){d.setSizeOfMode(c,b)}else{var a=d.getClassName?d.getClassName():(typeof d);Kekule.warn(Kekule.ErrorMsg.CAN_NOT_SET_DIMENSION_OF_CLASS.format(a))}}},getObjSize:function(b,a){if(b.getSizeOfMode){return b.getSizeOfMode(a,this.getAllowCoordBorrow())}else{return null}},doExecute:function($super){$super();var a=this.getTarget();if(!this.getOldDimension()){this.setOldDimension(this.getObjSize(a,this.getCoordMode()))}if(this.getNewDimension()){this.setObjSize(this.getTarget(),this.getNewDimension(),this.getCoordMode())}},doReverse:function($super){if(this.getOldDimension()){this.setObjSize(this.getTarget(),this.getOldDimension(),this.getCoordMode())}$super()}});Kekule.ChemObjOperation.Add=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemObjOperation.Add",initialize:function($super,c,b,a){$super(c);this.setParentObj(b);this.setRefSibling(a)},initProperties:function(){this.defineProp("parentObj",{dataType:"Kekule.ChemObject",serializable:false});this.defineProp("refSibling",{dataType:"Kekule.ChemObject",serializable:false})},doExecute:function(){var b=this.getParentObj();var c=this.getTarget();if(b&&c){var a=this.getRefSibling()||null;b.insertBefore(c,a)}},doReverse:function(){var c=this.getTarget();var b=this.getParentObj();if(b&&c){var a=this.getRefSibling();if(!a){a=c.getNextSibling();this.setRefSibling(a)}b.removeChild(c)}}});Kekule.ChemObjOperation.Remove=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemObjOperation.Remove",initialize:function($super,c,b,a){$super(c);this.setParentObj(b);this.setRefSibling(a)},initProperties:function(){this.defineProp("parentObj",{dataType:"Kekule.ChemObject",serializable:false});this.defineProp("refSibling",{dataType:"Kekule.ChemObject",serializable:false})},doExecute:function(){var c=this.getTarget();var b=this.getParentObj();if(!b&&c.getParent){b=c.getParent();this.setParentObj(b)}if(b&&c){if(!this.getRefSibling()){var a=c.getNextSibling?c.getNextSibling():null;this.setRefSibling(a)}b.removeChild(c)}},doReverse:function(){var b=this.getParentObj();var c=this.getTarget();if(b&&c){var a=this.getRefSibling();b.insertBefore(c,a)}}});Kekule.ChemStructOperation={};Kekule.ChemStructOperation.AddNode=Class.create(Kekule.ChemObjOperation.Add,{CLASS_NAME:"Kekule.ChemStructOperation.AddNode"});Kekule.ChemStructOperation.RemoveNode=Class.create(Kekule.ChemObjOperation.Remove,{CLASS_NAME:"Kekule.ChemStructOperation.RemoveNode",initProperties:function(){this.defineProp("linkedConnectors",{dataType:DataType.ARRAY,serializable:false})},doExecute:function($super){if(!this.getLinkedConnectors()){this.setLinkedConnectors(Kekule.ArrayUtils.clone(this.getTarget().getLinkedConnectors()))}$super()},doReverse:function($super){$super();var d=this.getLinkedConnectors();if(d&&d.length){var c=this.getTarget();for(var b=0,a=d.length;b<a;++b){c.appendLinkedConnector(d[b])}}}});Kekule.ChemStructOperation.ReplaceNode=Class.create(Kekule.Operation,{CLASS_NAME:"Kekule.ChemStructOperation.ReplaceNode",initialize:function($super,c,a,b){$super();this.setOldNode(c);this.setNewNode(a);this.setParentObj(b)},initProperties:function(){this.defineProp("oldNode",{dataType:"Kekule.ChemStructureNode",serializable:false});this.defineProp("newNode",{dataType:"Kekule.ChemStructureNode",serializable:false});this.defineProp("parentObj",{dataType:"Kekule.ChemStructureFragment",serializable:false})},doExecute:function(){var c=this.getOldNode();var a=this.getNewNode();if(c&&a){var b=this.getParentObj();if(!b){b=c.getParent();this.setParentObj(b)}if(b.replaceNode){b.replaceNode(c,a)}}},doReverse:function(){var c=this.getOldNode();var a=this.getNewNode();if(c&&a){var b=this.getParentObj()||a.getParent();if(b.replaceNode){b.replaceNode(a,c)}}}});Kekule.ChemStructOperation.AddConnector=Class.create(Kekule.ChemObjOperation.Add,{CLASS_NAME:"Kekule.ChemStructOperation.AddConnector",initialize:function($super,d,b,a,c){$super(d);this.setParentObj(b);this.setRefSibling(a);this.setConnectedObjs(c)},initProperties:function(){this.defineProp("connectedObjs",{dataType:DataType.ARRAY,serializable:false})},doExecute:function($super){$super();var a=Kekule.ArrayUtils.clone(this.getConnectedObjs());if(a&&a.length){this.getTarget().setConnectedObjs(a)}},doReverse:function($super){$super()}});Kekule.ChemStructOperation.RemoveConnector=Class.create(Kekule.ChemObjOperation.Remove,{CLASS_NAME:"Kekule.ChemStructOperation.RemoveConnector",initProperties:function(){this.defineProp("connectedObjs",{dataType:DataType.ARRAY,serializable:false})},doExecute:function($super){if(!this.getConnectedObjs()){this.setConnectedObjs(Kekule.ArrayUtils.clone(this.getTarget().getConnectedObjs()))}$super()},doReverse:function($super){$super();var a=this.getConnectedObjs();if(a&&a.length){this.getTarget().setConnectedObjs(a)}}});Kekule.ChemStructOperation.MergeNodes=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemStructOperation.MergeNodes",initialize:function($super,c,b,a){$super(c);this.setDest(b);this.setEnableStructFragmentMerge(a||false);this._refSibling=null;this._nodeParent=null;this._structFragmentMergeOperation=null;this._removeConnectorOperations=[]},initProperties:function(){this.defineProp("dest",{dataType:"Kekule.ChemStructureNode",serializable:false});this.defineProp("changedConnectors",{dataType:DataType.ARRAY,serializable:false});this.defineProp("removedConnectors",{dataType:DataType.ARRAY,serializable:false});this.defineProp("enableStructFragmentMerge",{dataType:DataType.BOOL})},getCommonSiblings:function(c,b){var a=c.getLinkedObjs();var d=b.getLinkedObjs();return Kekule.ArrayUtils.intersect(a,d)},doExecute:function(){var n=this.getTarget();var h=this.getDest();var m=n.getParent();var o=h.getParent();if(m!==o){if(this.getEnableStructFragmentMerge()){this._structFragmentMergeOperation=new Kekule.ChemStructOperation.MergeStructFragment(m,o);this._structFragmentMergeOperation.execute();m=o}else{return null}}this._nodeParent=m;var e=this.getRemovedConnectors();if(!e){var b=this.getCommonSiblings(n,h);var e=[];if(b.length){for(var g=0,f=b.length;g<f;++g){var p=b[g];var d=n.getConnectorTo(p);if(d&&(d.getConnectedObjCount()==2)){e.push(d)}}}var k=n.getConnectorTo(h);if(k){e.push(k)}this.setRemovedConnectors(e)}var a=this.getChangedConnectors();if(!a){var a=Kekule.ArrayUtils.clone(n.getLinkedConnectors())||[];a=Kekule.ArrayUtils.exclude(a,e);this.setChangedConnectors(a)}this._refSibling=n.getNextSibling();for(var g=0,f=a.length;g<f;++g){var d=a[g];var j=d.indexOfConnectedObj(n);d.removeConnectedObj(n);d.insertConnectedObjAt(h,j)}this._removeConnectorOperations=[];for(var g=0,f=e.length;g<f;++g){var d=e[g];var c=new Kekule.ChemStructOperation.RemoveConnector(d);c.execute();this._removeConnectorOperations.push(c)}m.removeNode(n)},doReverse:function(){var j=this.getTarget();var f=this.getDest();var h=this._nodeParent;h.insertBefore(j,this._refSibling);if(this._removeConnectorOperations.length){for(var e=this._removeConnectorOperations.length-1;e>=0;--e){var b=this._removeConnectorOperations[e];b.reverse()}}this._removeConnectorOperations=[];var a=this.getChangedConnectors();for(var e=0,c=a.length;e<c;++e){var d=a[e];var g=d.indexOfConnectedObj(f);d.removeConnectedObj(f);d.insertConnectedObjAt(j,g)}if(this._structFragmentMergeOperation){this._structFragmentMergeOperation.reverse()}}});Kekule.ChemStructOperation.MergeNodes.canMerge=function(e,b,g,d){var f=e.getParent();var c=b.getParent();var a=(f===c)||g;if(!d){a=a&&(!e.getConnectorTo(b))}return a};Kekule.ChemStructOperation.MergeConnectors=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemStructOperation.MergeConnectors",initialize:function($super,d,b,c,a){$super(d);this.setDest(b);this.setCoordMode(c||Kekule.CoordMode.COORD2D);this.setEnableStructFragmentMerge(a||false);this._refSibling=null;this._nodeParent=null;this._nodeMergeOperations=[]},initProperties:function(){this.defineProp("dest",{dataType:"Kekule.ChemStructureConnector",serializable:false});this.defineProp("enableStructFragmentMerge",{dataType:DataType.BOOL});this.defineProp("coordMode",{dataType:DataType.INT})},doExecute:function(){var s=Kekule.ChemStructOperation.MergeConnectors.canMerge(this.getTarget(),this.getDest(),this.getEnableStructFragmentMerge());if(!s){Kekule.error(Kekule.ErrorMsg.CAN_NOT_MERGE_CONNECTORS)}var j=this.getCoordMode();var c=[this.getTarget(),this.getDest()];var p=Kekule.ArrayUtils;var o=p.clone(this.getTarget().getConnectedObjs());var q=p.clone(this.getDest().getConnectedObjs());var e=this.getAllowCoordBorrow();for(var k=0,h=c.length;k<h;++k){var g=c[k];var n=g.getConnectedObjAt(0).getAbsCoordOfMode(j,e);var m=g.getConnectedObjAt(1).getAbsCoordOfMode(j,e);var a=Kekule.CoordUtils.substract(n,m);var r=Math.abs(a.x)>Math.abs(a.y)?"x":"y";if(Kekule.ObjUtils.notUnset(n.z)){if(Math.abs(a.z)>Math.abs(a.x)){r="z"}}var b=(k===0)?o:q;b.sort(function(l,i){var u=l.getAbsCoordOfMode(j,e);var t=i.getAbsCoordOfMode(j,e);return(u[r]-t[r])||0})}var d=p.intersect(o,q);o=p.exclude(o,d);q=p.exclude(q,d);this._nodeMergeOperations=[];for(var k=0,h=o.length;k<h;++k){if(o[k]!==q[k]){var f=new Kekule.ChemStructOperation.MergeNodes(o[k],q[k],this.getEnableStructFragmentMerge());f.execute()}this._nodeMergeOperations.push(f)}},doReverse:function(){for(var a=this._nodeMergeOperations.length-1;a>=0;--a){var b=this._nodeMergeOperations[a];b.reverse()}this._nodeMergeOperations=[]}});Kekule.ChemStructOperation.MergeConnectors.canMerge=function(d,c,e){if(!e&&(d.getParent()!==c.getParent())){return false}if(d.isConnectingConnector()||c.isConnectingConnector()){return false}var a=d.getConnectedExposedObjs();var b=c.getConnectedObjs();if(a.length!==b.length){return false}if(a.length!==2){return false}if(Kekule.ArrayUtils.intersect(a,b).length>=1){return false}return true};Kekule.ChemStructOperation.MergeStructFragment=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemStructOperation.MergeStructFragment",initialize:function($super,b,a){$super(b);this.setDest(a);this._removeOperation=null},initProperties:function(){this.defineProp("dest",{dataType:"Kekule.StructureFragment",serializable:false});this.defineProp("mergedNodes",{dataType:DataType.ARRAY,serializable:false});this.defineProp("mergedConnectors",{dataType:DataType.ARRAY,serializable:false})},moveChildBetweenStructFragment:function(d,c,b,a){Kekule.ChemStructureUtils.moveChildBetweenStructFragment(d,c,b,a)},doExecute:function(){var e=this.getTarget();var c=this.getDest();if(e&&c){var b=Kekule.ArrayUtils.clone(e.getNodes());this.setMergedNodes(b);var a=Kekule.ArrayUtils.clone(e.getConnectors());this.setMergedConnectors(a);this.moveChildBetweenStructFragment(e,c,b,a);var d=e.getParent();if(d){this._removeOperation=new Kekule.ChemObjOperation.Remove(e,d);this._removeOperation.execute()}}},doReverse:function(){var d=this.getTarget();var c=this.getDest();if(d&&c){if(this._removeOperation){this._removeOperation.reverse();this._removeOperation=null}var b=this.getMergedNodes();var a=this.getMergedConnectors();this.moveChildBetweenStructFragment(c,d,b,a)}}});Kekule.ChemStructOperation.SplitStructFragment=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemStructOperation.SplitStructFragment",initialize:function($super,a){$super(a)},initProperties:function(){this.defineProp("splittedFragments",{dataType:DataType.ARRAY,serializable:false,setter:null})},doExecute:function(){var f=Kekule.ChemStructureUtils.splitStructFragment(this.getTarget());if(f.length>1){this.setPropStoreFieldValue("splittedFragments",f);var c=this.getTarget().getParent();var d=this.getTarget().getNextSibling();c.beginUpdate();try{if(c){for(var b=1,a=f.length;b<a;++b){var e=f[b];c.insertBefore(e,d)}}}finally{c.endUpdate()}}else{this.setPropStoreFieldValue("splittedFragments",null)}},doReverse:function(){var a=this.getSplittedFragments();if(a&&a.length){var e=this.getTarget();for(var c=0,b=a.length;c<b;++c){var f=a[c];if(f!==e){Kekule.ChemStructureUtils.moveChildBetweenStructFragment(f,e,Kekule.ArrayUtils.clone(f.getNodes()),Kekule.ArrayUtils.clone(f.getConnectors()));var d=f.getParent();if(d){d.removeChild(f)}f.finalize()}}}}});Kekule.ChemStructOperation.StandardizeStructFragment=Class.create(Kekule.ChemObjOperation.Base,{CLASS_NAME:"Kekule.ChemStructOperation.StandardizeStructFragment",initialize:function($super,a){$super(a);this.setEnableSplit(true);this.setEnableRemove(true);this._concreteOper=null},initProperties:function(){this.defineProp("enableRemove",{dataType:DataType.BOOL});this.defineProp("enableSplit",{dataType:DataType.BOOL})},doExecute:function(){var b=this.getTarget();var a=b.getNodeCount();this._concreteOper=null;if(a<=0){if(this.getEnableRemove()){this._concreteOper=new Kekule.ChemObjOperation.Remove(b)}}else{if(this.getEnableSplit()){this._concreteOper=new Kekule.ChemStructOperation.SplitStructFragment(b)}}if(this._concreteOper){return this._concreteOper.execute()}else{return null}},doReverse:function(){return this._concreteOper?this._concreteOper.reverse():null}})})();(function(){Kekule.Editor.StructureUtils={getCascadeDeleteObjs:function(a){return Kekule.ChemStructureUtils.getCascadeDeleteObjs(a)},getSurroundingObjs:function(c){var b=c.getLinkedObjs();if(c instanceof Kekule.ChemStructureConnector){var a=c.getConnectedObjs();Kekule.ArrayUtils.pushUnique(b,a)}return b},calcMostEmptyDirectionAngleOfChemObj:function(h,d,e){var n=[];if(!d){d=h.getLinkedObjs()}var p=h.getAbsBaseCoord2D(e);for(var j=0,g=d.length;j<g;++j){var m=d[j].getAbsBaseCoord2D(e);m=Kekule.CoordUtils.substract(m,p);var f=Math.atan2(m.y,m.x);if(f<0){f=Math.PI*2+f}n.push(f)}n.sort();var g=n.length;if(g===0){return 0}else{if(g===1){return -n[0]}else{var o=0;var k=0;for(var j=0;j<g;++j){var b=n[j];var a=n[(j+1)%g];var q=a-b;if(q<0){q+=Math.PI*2}if(q>o){o=q;k=j}}var r=n[k]+o/2;return r}}},calcPreferred2DBondGrowingDirection:function(e,b,d){var c=e.getAbsBaseCoord2D(d);var f=Kekule.Editor.StructureUtils.getSurroundingObjs(e);var m=f?f.length:0;switch(m){case 0:return b;case 1:var a=f[0];var n=a.getAbsBaseCoord2D(d);var o=Kekule.CoordUtils.substract(n,c);var l=Math.atan2(o.y,o.x);var i=l-b;var h=l+b;if(i<0){i+=Math.PI*2}if(h<0){h+=Math.PI*2}var g;if(i!==h){var k=Math.min((i>Math.PI)?Math.abs(i-Math.PI*2):i,Math.abs(i-Math.PI));var j=Math.min((h>Math.PI)?Math.abs(h-Math.PI*2):h,Math.abs(h-Math.PI));g=(k<=j)?i:h}else{g=i}return g;default:var g=Kekule.Editor.StructureUtils.calcMostEmptyDirectionAngleOfChemObj(e,f,d);return g}},calcPreferred2DBondGrowingLocation:function(a,e,f,b){var c=a.getAbsBaseCoord2D(b);var d=Kekule.Editor.StructureUtils.calcPreferred2DBondGrowingDirection(a,f,b);return Kekule.CoordUtils.add(c,{x:e*Math.cos(d),y:e*Math.sin(d)})}}})();(function(){var a=Class.PropertyScope;Kekule.Editor.BaseEditorConfigs=Class.create(Kekule.ChemWidget.ChemObjDisplayerConfigs,{CLASS_NAME:"Kekule.Editor.BaseEditorConfigs",initProperties:function(){this.addConfigProp("uiMarkerConfigs","Kekule.EditorConfigs.UiMarkerConfigs");this.addConfigProp("interactionConfigs","Kekule.EditorConfigs.InteractionConfigs");this.addConfigProp("structureConfigs","Kekule.Editor.StructureConfigs")},initPropValues:function($super){$super();this.setPropStoreFieldValue("uiMarkerConfigs",new Kekule.Editor.UiMarkerConfigs());this.setPropStoreFieldValue("interactionConfigs",new Kekule.Editor.InteractionConfigs());this.setPropStoreFieldValue("structureConfigs",new Kekule.Editor.StructureConfigs())}});Kekule.Editor.ChemSpaceEditorConfigs=Class.create(Kekule.Editor.BaseEditorConfigs,{CLASS_NAME:"Kekule.Editor.ChemSpaceEditorConfigs",initProperties:function(){this.addConfigProp("chemSpaceConfigs","Kekule.Editor.ChemSpaceConfigs");this.addConfigProp("styleSetterConfigs","Kekule.Editor.StyleSetterConfigs",undefined,{scope:a.PUBLIC})},initPropValues:function($super){$super();this.setPropStoreFieldValue("chemSpaceConfigs",new Kekule.Editor.ChemSpaceConfigs());this.setPropStoreFieldValue("styleSetterConfigs",new Kekule.Editor.StyleSetterConfigs())}});Kekule.Editor.InteractionConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Editor.InteractionConfigs",initProperties:function(){this.addBoolConfigProp("enableHotTrack",true);this.addIntConfigProp("objBoundTrackInflation",5);this.addBoolConfigProp("enablePartialAreaSelecting",false);this.addIntConfigProp("selectionMarkerInflation",5,{scope:a.PUBLIC});this.addIntConfigProp("selectionMarkerEdgeInflation",5,{scope:a.PUBLIC});this.addIntConfigProp("rotationRegionInflation",10,{scope:a.PUBLIC});this.addFloatConfigProp("constrainedRotateStep",Math.PI/18*1.5,{scope:a.PUBLIC});this.addIntConfigProp("rotationLocationPointDistanceThreshold",10);this.addIntConfigProp("directedMoveDistanceThreshold",10);this.addIntConfigProp("clonedObjectScreenOffset",10);this.addIntConfigProp("atomSetterFontSize",14)}});Kekule.Editor.UiMarkerConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Editor.UiMarkerConfigs",initProperties:function(){this.addStrConfigProp("hotTrackerColor","#0000FF");this.addFloatConfigProp("hotTrackerOpacity",0.5);this.addStrConfigProp("selectionMarkerStrokeColor","#0000FF");this.addFloatConfigProp("selectionMarkerStrokeWidth",2);this.addStrConfigProp("selectionMarkerFillColor","#0000FF");this.addFloatConfigProp("selectionMarkerOpacity",0.2);this.addFloatConfigProp("selectionTransformMarkerSize",8,{scope:a.PUBLIC});this.addFloatConfigProp("selectionTransformMarkerOpacity",0.4,{scope:a.PUBLIC});this.addStrConfigProp("selectingMarkerStrokeColor","#000000");this.addFloatConfigProp("selectingMarkerStrokeWidth",1);this.addStrConfigProp("selectingMarkerStrokeDash",true);this.addStrConfigProp("selectingMarkerFillColor",null);this.addFloatConfigProp("selectingMarkerOpacity",0.7)}});Kekule.Editor.StructureConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Editor.StructureConfigs",initProperties:function(){this.addStrConfigProp("defBondType",Kekule.BondType.DEFAULT,{enumSource:Kekule.BondType});this.addIntConfigProp("defBondOrder",Kekule.BondOrder.SINGLE,{enumSource:Kekule.BondOrder});this.addFloatConfigProp("defBondLength",0.8);this.addConfigProp("defBondAngles",DataType.ARRAY,undefined,{scope:a.PUBLIC});this.addFloatConfigProp("bondConstrainedDirectionDelta",undefined,{scope:a.PUBLIC});this.addFloatConfigProp("initialBondDirection",undefined,{scope:a.PUBLIC});this.addStrConfigProp("defIsotopeId","C");this.addConfigProp("primaryOrgChemAtoms",DataType.ARRAY,undefined,{scope:a.PUBLIC})},initPropValues:function($super){$super();var c=[];var b=Kekule.BondOrder;var d=Math.PI*2/3;c[0]=d;c[b.EXPLICIT_AROMATIC]=[d];c[b.TRIPLE]=[Math.PI];c[b.DOUBLE]=[d];c[b.DOUBLE][b.DOUBLE]=Math.PI;c[b.SINGLE]=[d];this.setDefBondAngles(c);this.setBondConstrainedDirectionDelta(10*Math.PI/180);this.setInitialBondDirection(30*Math.PI/180);this.setPrimaryOrgChemAtoms(["C","H","O","N","P","S","F","Cl","Br","I"])},getDefAngleOfBonds:function(f,d){var c=f||0;var b=d||0;if(c>b){c=d||0;b=f||0}var h=this.getDefBondAngles();var g=h[b];if(!g){return h[0]}else{var e=g[c];return e||g[0]}},getNewBondDefAngle:function(d,e){if(Kekule.ObjUtils.isUnset(e)){e=this.getDefBondOrder()}var c;var f=Kekule.Editor.StructureUtils.getSurroundingObjs(d);if(f.length===1){var b=d.getLinkedConnectorAt(0);if(b&&(b.getConnectedObjs().indexOf(f[0])>=0)){var g=b.getBondOrder?b.getBondOrder():null;if(Kekule.ObjUtils.notUnset(g)){c=this.getDefAngleOfBonds(e,g)}}}else{if(f.length===0){c=this.getInitialBondDirection()}else{c=this.getDefAngleOfBonds(e,0)}}return c}});Kekule.Editor.ChemSpaceConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Editor.ChemSpaceConfigs",initProperties:function(){this.addHashConfigProp("defScreenSize2D");this.addHashConfigProp("defScreenSize3D");this.addNumConfigProp("defPadding",50)},initPropValues:function($super){$super();this.setDefScreenSize2D({x:900,y:1500});this.setDefScreenSize3D({x:600,y:600,z:600})}});Kekule.Editor.StyleSetterConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Editor.StyleSetterConfigs",initProperties:function(){this.defineProp("listedFontSizes",{dataType:DataType.ARRAY});this.defineProp("listedFontNames",{dataType:DataType.ARRAY})},initPropValues:function($super){$super();this.setListedFontSizes([8,9,10,11,12,14,16,18,20,24,28,32,36,40,44,48,54,60,66,72,80,88,96]);this.setListedFontNames(Kekule.Widget.FontEnumerator.getAvailableFontFamilies())}})})();(function(){Kekule.Editor.AbstractRepositoryItem=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Editor.AbstractRepositoryItem",initialize:function($super){$super()},initProperties:function(){},getAvailableCoordModes:function(){return[]},createObjects:function(a){},getRefLength:function(){},isOneStructureFragmentObj:function(){return false}});Kekule.Editor.MolRingRepositoryItem2D=Class.create(Kekule.Editor.AbstractRepositoryItem,{CLASS_NAME:"Kekule.Editor.MolRingRepositoryItem2D",initialize:function($super,b,a){$super();this.setRingAtomCount(b);this.setBondLength(a||1)},initProperties:function(){this.defineProp("ringAtomCount",{dataType:DataType.INT});this.defineProp("bondLength",{dataType:DataType.FLOAT});this.defineProp("isAromatic",{dataType:DataType.BOOL})},getAvailableCoordModes:function(){return Kekule.CoordMode.COORD2D},getRefLength:function(){return this.getBondLength()},isOneStructureFragmentObj:function(){return true},createObjects:function(c){var b=this.generateRing();var a=null;var e=null;var d={x:0,y:0};if(c){a=(c instanceof Kekule.ChemStructureNode)?b.getNodeAt(0):(c instanceof Kekule.ChemStructureConnector)?b.getConnectorAt(0):null;if(a){e=c}d=a.getAbsBaseCoord2D()}return{objects:[b],mergeObj:a,mergeDest:e,baseObjCoord:d,centerCoord:{x:0,y:0}}},generateRing:function(l,m){if(!m){m=Kekule.Molecule}var q;if(l){q=l}else{q=new m()}var t=this.getRingAtomCount();var k=this.getBondLength();var e=Math.PI/t;var d=Math.sin(e);var s=2*e;var j=k/2/d;var g=((t===4)||(t===8))?-Math.PI/2-s/2:-Math.PI/2;var n;var p;var b;for(var o=0;o<t;++o){var a=this._generateAtom(o);var r=g+s*o;var h=j*Math.cos(r);var f=j*Math.sin(r);a.setCoord2D({x:h,y:f});q.appendNode(a);if(o===0){b=a}if(n){var c=this._generateBond(p,o);q.appendConnector(c);c.appendConnectedObj(n);c.appendConnectedObj(a)}n=a;p=o}var c=this._generateBond(t-1,0);q.appendConnector(c);c.appendConnectedObj(n);c.appendConnectedObj(b);return q},_generateAtom:function(a){return new Kekule.Atom(null,"C")},_generateBond:function(c,b){var a=Kekule.BondOrder.SINGLE;if(this.getIsAromatic()){if(c%2){a=Kekule.BondOrder.DOUBLE}}return new Kekule.Bond(null,null,a)}});Kekule.Editor.PathGlyphRepositoryItem2D=Class.create(Kekule.Editor.AbstractRepositoryItem,{CLASS_NAME:"Kekule.Editor.PathGlyphRepositoryItem2D",initialize:function($super,b,c,a){$super();this.setGlyphClass(b);this.setGlyphRefLength(c||1);this.setGlyphInitialParams(a)},initProperties:function(){this.defineProp("glyphRefLength",{dataType:DataType.FLOAT});this.defineProp("glyphClass",{dataType:DataType.CLASS,serializable:false});this.defineProp("glyphInitialParams",{dataType:DataType.HASH})},getAvailableCoordModes:function(){return Kekule.CoordMode.COORD2D},getRefLength:function(){return this.getGlyphRefLength()},createObjects:function(a){var b=this.generateGlyph();var c={x:0,y:0};return{objects:[b],mergeObj:null,mergeDest:null,baseObjCoord:c,centerCoord:c}},generateGlyph:function(){var a=this.getGlyphClass();var b=new a(null,this.getGlyphRefLength(),this.getGlyphInitialParams());return b}})})();(function(){var a=Kekule.ArrayUtils;var d=Kekule.ChemWidget.HtmlClassNames;var b=Kekule.ChemWidgetTexts;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{CHEMSPACE_EDITOR:"K-Chem-Space-Editor",CHEMSPACE_EDITOR2D:"K-Chem-Space-Editor2D",CHEMSPACE_EDITOR3D:"K-Chem-Space-Editor3D",CHEMEDITOR_TEXT_SETTER:"K-ChemEditor-Text-Setter"});Kekule.Editor.ChemSpaceEditor=Class.create(Kekule.Editor.BaseEditor,{CLASS_NAME:"Kekule.Editor.ChemSpaceEditor",initialize:function($super,e,h,g,f){this.setPropStoreFieldValue("allowCreateNewChild",true);this.setPropStoreFieldValue("autoCreateNewStructFragment",true);$super(e,h,g,f);this._containerChemSpace=null},initProperties:function(){this.defineProp("chemSpace",{dataType:"Kekule.ChemSpace",serializable:false,getter:function(){return this.getChemObj()},setter:function(e){this.setChemObj(e)}});this.defineProp("defBondLength",{dataType:DataType.FLOAT,serializable:false,getter:function(){var e=this.getPropStoreFieldValue("defBondLength");if(!e){e=this.getEditorConfigs().getStructureConfigs().getDefBondLength()}return e}});this.defineProp("autoCreateNewStructFragment",{dataType:DataType.BOOL,getter:function(){return this.getPropStoreFieldValue("autoCreateNewStructFragment")&&this.canCreateNewChild()}});this.defineProp("allowCreateNewChild",{dataType:DataType.BOOL})},canCreateNewChild:function(){return this.getChemSpace()&&(this.getAllowCreateNewChild()||(this.getChemSpace().getChildCount()<=0))},getActualDrawOptions:function($super){var e=$super();e.useExplicitSpaceSize=true;return e},doSetChemObj:function($super,g){var e=this.getChemObj();if(e&&this._containerChemSpace){e.finalize();this._containerChemSpace=null}if(g){if(g instanceof Kekule.ChemSpace){this._initChemSpaceDefProps(g);return $super(g)}else{var f=this.createContainerChemSpace(null,g);this._containerChemSpace=f;$super(f)}}else{$super(g)}},getExportableClasses:function($super){var e=$super();var h=this.getChemSpace();if(h){for(var g=0,f=h.getChildCount();g<f;++g){var j=h.getChildAt(g);if(j&&j.getClass){Kekule.ArrayUtils.pushUnique(e,j.getClass())}}}return e},exportObj:function($super,g){var e=$super(g);if(!e&&g){var j=this.getChemSpace();if(j){for(var h=0,f=j.getChildCount();h<f;++h){var k=j.getChildAt(h);if(k&&(k instanceof g)){return k}}}}return e},createDefaultConfigs:function(){return new Kekule.Editor.ChemSpaceEditorConfigs()},doCreateNewDocObj:function(){return this.createContainerChemSpace()},doLoadEnd:function($super,j){var m=$super(j);var l=null;if(j){var g=j.getAllContainingConnectors();if(g&&g.length){var i=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;l=Kekule.ChemStructureUtils.getConnectorLengthMedian(g,i,this.getAllowCoordBorrow())}}this.setDefBondLength(l);var e=this.getChemObj();if(e){var f=e.getScreenSize();this.changeClientSize(f.x,f.y,this.getCurrZoom());var h=this.getEditClientElem().parentNode;var k=Kekule.HtmlElementUtils.getElemClientDimension(h);this.scrollClientTo(0,(f.x-k.width)/2)}return m},zoomChanged:function($super,g){$super();var f=this.getChemObj();var e=f.getScreenSize();this.changeClientSize(e.x,e.y,g)},createNewBoundInfoRecorder:function($super,f){$super(f);var e=this.getBoundInfoRecorder();if(e){e.addEventListener("updateBasicDrawObject",this.reactUpdateBasicDrawObject,this)}},reactUpdateBasicDrawObject:function(h){var g=h.obj;if(g&&(g instanceof Kekule.TextBlock)){var f=h.boundInfo;this.updateTextBlockSize(g,f)}},objectChanged:function($super,f,e){if(this.getCoordMode()===Kekule.CoordMode.COORD2D){if(f instanceof Kekule.TextBlock){f.setPropStoreFieldValue("size2D",{x:null,y:null})}}return $super(f,e)},updateTextBlockSize:function(f,i){if(this.getCoordMode()!==Kekule.CoordMode.COORD2D){return}var j=f.getSize2D();if(Kekule.ObjUtils.notUnset(j.x)||Kekule.ObjUtils.notUnset(j.y)){return}var e=i.shapeType;if(e===Kekule.Render.BoundShapeType.RECT){var k=i.coords;var h=this.contextCoordToObj(k[0]);var g=this.contextCoordToObj(k[1]);var l=Kekule.CoordUtils.substract(g,h);f.setPropStoreFieldValue("size2D",{x:Math.abs(l.x),y:Math.abs(l.y)})}},createContainerChemSpace:function(e,g){var m=new Kekule.ChemDocument(e);this._initChemSpaceDefProps(m,g);if(g){m.appendChild(g);var f=m.getSizeOfMode(this.getCoordMode(),this.getAllowCoordBorrow());var j,k;if(this.getCoordMode()===Kekule.CoordMode.COORD2D){var l=this.getEditorConfigs().getChemSpaceConfigs().getDefPadding();var k=m.getObjScreenLengthRatio();var h=Kekule.Render.ObjUtils.getContainerBox(g,this.getCoordMode(),this.getAllowCoordBorrow())}if(k&&h){var i=g.getCoordOfMode(this.getCoordMode())||{};j=Kekule.CoordUtils.divide(f,2);j.y=(i.y||0)+f.y-l*k-h.y2;j.x+=(i.x||0)-(h.x2+h.x1)/2}else{var i=g.getCoordOfMode(this.getCoordMode())||{};j=Kekule.CoordUtils.divide(f,2);j.x-=(h.x2+h.x1)/2;j.y-=(h.y2+h.y1)/2;if(this.getCoordMode()===Kekule.CoordMode.COORD3D){j.z-=(h.z2+h.z1)/2}j=Kekule.CoordUtils.add(j,i)}g.setCoordOfMode(j,this.getCoordMode())}return m},_initChemSpaceDefProps:function(h,i){var j=this.getEditorConfigs();var e=j.getChemSpaceConfigs();if(this.getCoordMode()===Kekule.CoordMode.COORD2D){var f=h.getScreenSize();if(!f.x&&!f.y){f=e.getDefScreenSize2D();h.setScreenSize(f)}if(!h.getDefAutoScaleRefLength()){var m;if(i&&i.getAllAutoScaleRefLengths){var g=i.getAllAutoScaleRefLengths(this.getCoordMode(),this.getAllowCoordBorrow());m=g&&g.length?Kekule.ArrayUtils.getMedian(g):null}else{var g=h.getAllAutoScaleRefLengths(this.getCoordMode(),this.getAllowCoordBorrow());m=g.length?Kekule.ArrayUtils.getMedian(g):null}if(!m){m=j.getStructureConfigs().getDefBondLength()}h.setDefAutoScaleRefLength(m)}if(!h.getSize2D()){var l=this.getRenderConfigs().getLengthConfigs().getDefBondLength();var k=h.getDefAutoScaleRefLength()/l;h.setObjScreenLengthRatio(k);h.setSize2D({x:f.x*k,y:f.y*k})}}},createNewStructFragmentAnchor:function(f){if(this.getAutoCreateNewStructFragment()){var e=new Kekule.Molecule(f);this.getChemSpace().appendChild(e);return e}else{return null}},createStructStartingAtom:function(g,i,e,f){this.beginUpdateObject();try{if(g){if(!f){f=this.getEditorConfigs().getStructureConfigs().getDefIsotopeId()}var h=new Kekule.Atom(null,f);g.appendNode(h);h.setAbsCoordOfMode(e,this.getCoordMode());return h}else{return null}}finally{this.endUpdateObject()}},createNewStructFragmentAndStartingAtom:function(h,e,f){this.beginUpdateObject();try{var g;g=this.createNewStructFragmentAnchor(h);if(g){return this.createStructStartingAtom(g,h,e,f)}else{return null}}finally{this.endUpdateObject()}},hasOnlyOneBlankStructFragment:function(){var e=false;if(this.getChemSpace().getChildCount()===1){var f=this.getChemSpace().getChildAt(0);if(f instanceof Kekule.StructureFragment){if(f.getNodeCount()<=0&&f.getConnectorCount()<=0&&!f.hasFormula()){e=true}}}return e},getOnlyOneBlankStructFragment:function(){if(this.hasOnlyOneBlankStructFragment()){return this.getChemSpace().getChildAt(0)}},canAddNewStandaloneObject:function(){return this.getAllowCreateNewChild()||(this.getChemSpace().getChildCount()<=0)},canAddUnconnectedStructFragment:function(){return this.canAddNewStandaloneObject()||this.hasOnlyOneBlankStructFragment()},canCloneObjects:function(){return this.getAllowCreateNewChild()},cloneObjects:function(e,f,m){if(!this.getChemSpace()){return null}var u=this.getAllowCreateNewChild();var q=function(F,E){for(var D=0,C=E.length;D<C;++D){var G=E[D];if((G.isChildOf(F))){return true}}return false};var p=function(F,E,C){if(C.indexOf(E)>=0){a.remove(C,E);return}if(F.getChildAt&&E.getChildAt){var l=E.getChildCount();for(var D=l-1;D>=0;--D){var H=F.getChildAt(D);if(!C.length){F.removeChild(H);continue}var G=E.getChildAt(D);if(C.indexOf(G)>=0){a.remove(C,G)}else{if(q(G,C)){if(G.getChildObjs){p(H,G,C)}}else{F.removeChild(H)}}}}};var z=Kekule.ArrayUtils.toArray(e);var A=[];var r=new Kekule.MapEx();for(var v=0,t=z.length;v<t;++v){var o=z[v];var B=o.getStandaloneAncestor?o.getStandaloneAncestor():o;if(B.clone){Kekule.ArrayUtils.pushUnique(A,B);var n=r.get(B);if(!n){n=[];r.set(B,n)}n.push(o)}}var x=this.getChemSpace();var j=[];var w=this.getCoordMode();var y=this.getAllowCoordBorrow();var g=A.length;for(var v=0;v<g;++v){var o=A[v];var h=o.clone();if(h.clearIds){h.clearIds()}p(h,o,r.get(o));if(m&&u){x.appendChild(h);if(f){var s=this.getObjectScreenCoord(h);var k=Kekule.CoordUtils.add(s,f);this.setObjectScreenCoord(h,k)}}j.push(h)}r.finalize();return j},cloneSelection:function(g,f){if(g===undefined){g=this.getDefaultCloneScreenCoordOffset()}var h=this.getSelection();var e=this.cloneObjects(h,g,f);if(f){this.setSelection(e)}return e},getDefaultCloneScreenCoordOffset:function(){var g=this.getEditorConfigs().getInteractionConfigs().getClonedObjectScreenOffset()||0;var e=this.getCoordMode();var f={x:g,y:g};if(e===Kekule.CoordMode.COORD3D){f.z=g}return f}});Kekule.Editor.ChemSpaceEditor.Settings=Class.create(Kekule.Editor.BaseEditor.Settings,{CLASS_NAME:"Kekule.Editor.ChemSpaceEditor.Settings",initProperties:function(){this.defineProp("allowCreateNewChild",{dataType:DataType.BOOL,serializable:false,getter:function(){return this.getEditor().getAllowCreateNewChild()},setter:function(e){this.getEditor().setAllowCreateNewChild(e)}})}});Kekule.Editor.BasicMolEraserIaController=Class.create(Kekule.Editor.BasicEraserIaController,{CLASS_NAME:"Kekule.Editor.BasicMolEraserIaController",initialize:function($super,e){$super(e)},doGetActualRemovedObjs:function(j){var e=[];Kekule.ArrayUtils.pushUnique(e,j);for(var h=0,g=j.length;h<g;++h){var f=j[h].getCascadeDeleteObjs?j[h].getCascadeDeleteObjs():[];Kekule.Editor.StructureUtils.getCascadeDeleteObjs(j[h]);if(f){Kekule.ArrayUtils.pushUnique(e,f)}}return e},doRemoveObjs:function(n){if(!n.length){return}var e=new Kekule.MacroOperation();var p=[];for(var m=0,g=n.length;m<g;++m){var k=n[m];var q=k.getParent();var o=this.getEditor();var f;if(k instanceof Kekule.BaseStructureNode){f=new Kekule.ChemStructOperation.RemoveNode(k);Kekule.ArrayUtils.pushUnique(p,k.getParent())}else{if(k instanceof Kekule.BaseStructureConnector){f=new Kekule.ChemStructOperation.RemoveConnector(k);Kekule.ArrayUtils.pushUnique(p,k.getParent())}else{f=new Kekule.ChemObjOperation.Remove(k)}}if(f){e.add(f)}}for(var m=0,g=p.length;m<g;++m){var j=p[m];if(j&&(j instanceof Kekule.StructureFragment)){var h=new Kekule.ChemStructOperation.StandardizeStructFragment(j);h.setEnableSplit(this.getEditor().canCreateNewChild());e.add(h)}}e.execute();if(o&&o.getEnableOperHistory()){o.pushOperation(e)}}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.BasicMolEraserIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.BasicMolManipulationIaController=Class.create(Kekule.Editor.BasicManipulationIaController,{CLASS_NAME:"Kekule.Editor.BasicMolManipulationIaController",initialize:function($super,e){$super(e);this.setEnableMagneticMerge(true);this.setEnableNodeMerge(true);this.setEnableNeighborNodeMerge(true);this.setEnableConnectorMerge(true);this.setEnableStructFragmentMerge(true);this.setEnableConstrainedMove(true);this.setEnableConstrainedRotate(true);this.setEnableDirectedMove(true);this._suppressConstrainedMoving=false;this._suppressConstrainedRotating=false;this._isInDirectedMoving=false;this._directedMovingDirection=null},initProperties:function(){this.defineProp("enableMagneticMerge",{dataType:DataType.BOOL});this.defineProp("enableNodeMerge",{dataType:DataType.BOOL});this.defineProp("enableNeighborNodeMerge",{dataType:DataType.BOOL});this.defineProp("enableConnectorMerge",{dataType:DataType.BOOL});this.defineProp("enableStructFragmentMerge",{dataType:DataType.BOOL});this.defineProp("allManipulateObjsMerged",{dataType:DataType.BOOL,serializable:false});this.defineProp("isMergeDone",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableConstrainedMove",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableConstrainedRotate",{dataType:DataType.BOOL,serializable:false});this.defineProp("enableDirectedMove",{dataType:DataType.BOOL,serializable:false});this.defineProp("mergeOperations",{dataType:DataType.ARRAY,serializable:false})},canInteractWithObj:function($super,e){return $super(e)||(this._isMerging&&e)},isConstrainedMove:function(){if(!this.getEnableConstrainedMove()){return false}var g=this.getManipulateObjs();if(g.length===1){var f=g[0];var e=this.getEditor().getSelection();if(e&&(e.indexOf(f)<0)){if(f instanceof Kekule.ChemStructureNode){return(f.getLinkedObjs().length===1)}}}return false},isConstrainedRotate:function(){return this.getEnableConstrainedMove()},isDirectedMove:function(){return(this.getEnableDirectedMove()&&(!this.isConstrainedMove())&&this._isInDirectedMoving)},createManipulateObjInfo:function($super,h,i){var j=this.getEditor();var f=$super(h,i);var k=this.isConstrainedMove();if(k){var g=h.getLinkedConnectors()[0];var e=h.getLinkedObjs()[0];if(g&&e){f.isConstrained=true;if(!f.hasNoCoord){f.originScreenCoord=j.getObjectScreenCoord(h);f.refScreenCoord=j.getObjectScreenCoord(e);f.connectorScreenLength=Kekule.CoordUtils.getDistance(f.screenCoord,f.refScreenCoord);f.connectorObjLength=g.getLength(this.getEditor().getCoordMode(),this.getEditor().getAllowCoordBorrow());var l=Kekule.CoordUtils.substract(f.originScreenCoord,f.refScreenCoord);f.originBondDirectionAngle=Math.atan2(l.y,l.x);f.constrainedBondDirectionDelta=this.getEditorConfigs().getStructureConfigs().getBondConstrainedDirectionDelta()}}}return f},_calcActualMovedScreenCoord:function($super,l,j,m){var e=Kekule.CoordUtils;var o;var n=m;if(j.isConstrained&&(!this._suppressConstrainedMoving)){var h=j.constrainedBondDirectionDelta||null;var g;var f=e.substract(m,j.refScreenCoord);var k=Math.atan2(f.y,f.x);if(h){var i=Math.round((k-j.originBondDirectionAngle)/h);g=j.originBondDirectionAngle+i*h}else{g=k}o=e.add(j.refScreenCoord,{x:j.connectorScreenLength*Math.cos(g),y:j.connectorScreenLength*Math.sin(g)})}else{o=n}return o},_calcActualRotateAngle:function($super,g,h){var e=(this.isConstrainedRotate()&&(!this._suppressConstrainedRotating))?this.getEditorConfigs().getInteractionConfigs().getConstrainedRotateStep():null;if(e){var f=Math.floor(h/e);return f*e}else{return $super(g,h)}},prepareManipulating:function($super,h,f,e,i,g){this.setMergeOperations([]);$super(h,f,e,i,g);this._directedMovingDirection=null},stopManipulate:function($super){$super()},createManipulateOperation:function($super){$super();this.setMergeOperations([])},getAllObjOperations:function($super){var e=$super()||[];var f=this.getMergeOperations();if(f&&f.length){Kekule.ArrayUtils.pushUnique(e,f)}return e},_canMergeNodes:function(g,h){var f=this.getEnableStructFragmentMerge();var e=this.getEnableNeighborNodeMerge();if(this.getEnableNodeMerge()){return Kekule.ChemStructOperation.MergeNodes.canMerge(g,h,f,e)}else{return false}},_canMergeConnectors:function(f,g){var e=this.getEnableStructFragmentMerge();if(this.getEnableConnectorMerge()){return Kekule.ChemStructOperation.MergeConnectors.canMerge(f,g,e)}else{return false}},_findSuitableMergeTargetBoundInfo:function(f,j,h,e){for(var g=f.length-1;g>=0;--g){var l=f[g];var k=l.obj;if(j.indexOf(k)>=0){continue}if(!(k instanceof h)){continue}if(e&&!e(k)){continue}return l}return null},_getMagneticNodeMergeDest:function(j,k,i){var h=this.getEditor();var f=this;if(k){var e=h.getBoundInfosAtCoord(k);var g=this._findSuitableMergeTargetBoundInfo(e,i,Kekule.ChemStructureNode,function(l){return f._canMergeNodes(j,l)});return g?g.obj:null}else{return null}},moveManipulatedObjs:function($super,i){var e;if(this.isDirectedMove()){var h=Kekule.CoordUtils;var g=this.getStartCoord();var k=h.getDistance(g,i);var j=h.substract(i,g);var f=this._directedMovingDirection;if(this._directedMovingDirection){}else{f=(Math.abs(j.x)>=Math.abs(j.y))?"x":"y";if(k<this.getEditor().getEditorConfigs().getInteractionConfigs().getDirectedMoveDistanceThreshold()){}else{this._directedMovingDirection=f}}e=Object.extend({},g);e[f]=i[f]}else{e=i}return $super(e)},applyManipulatingObjsInfo:function($super,k){this.setAllManipulateObjsMerged(false);var ad=Kekule.Editor.BasicManipulationIaController.ManipulationType;var B=this.getManipulationType();var t=this.getManipulateOriginObjs();var q=this.getManipulateObjs();var f=this.getEditor();var U=[].concat(t);Kekule.ArrayUtils.pushUnique(U,q);var s=this.getMergeOperations();var p=this;var Q=(t.length===1)&&(t[0] instanceof Kekule.ChemStructureConnector);var aa=(q.length===1)&&(q[0] instanceof Kekule.ChemStructureNode);if(!Q&&this.getEnableMagneticMerge()){var e=this.getManipulateObjCurrInfoMap();var g=this.getManipulateObjInfoMap();var p=this;var v=[];var V=[];var h=[];for(var X=0,W=q.length;X<W;++X){var j=q[X];var z=e.get(j);var E=z.screenCoord;if(E){var O=f.getBoundInfosAtCoord(E);var K=this._getMagneticNodeMergeDest(j,E,U);if(K){v.push(X);V.push(j);h.push(K)}else{}}}if(V.length){var ab=V.length;this.setAllManipulateObjsMerged(ab===q.length);var ac=(ab<=1);if(!ac){for(var X=0,W=V.length;X<W;++X){var j=V[X];var L=h[X];var N=v[X];var C=s[N];if(!C||!this.isSameNodeMerge(C,j,L)){ac=true;break}}}if(ac){this.reverseMergeOpers();var r=Kekule.CoordUtils;if((ab===1)||(f.getCoordMode()===Kekule.CoordMode.COORD3D)){var z=e.get(V[0]);var E=z.screenCoord;var R=f.getObjectScreenCoord(h[0]);var T=r.substract(R,E);var Y=false;for(var X=0,W=q.length;X<W;++X){var j=q[X];if(j!==V[0]){var Z=e.get(j);if(Z.screenCoord){var x=r.add(Z.screenCoord,T);Z.screenCoord=x;if(this._getMagneticNodeMergeDest(j,x,U)){Y=true}}}}if(Y){return this.applyManipulatingObjsInfo(k)}else{for(var X=0,W=q.length;X<W;++X){var j=q[X];if(j!==V[0]){var Z=e.get(j);this.applySingleManipulatingObjInfo(X,j,Z,k)}}}}else{if((ab>1)&&(f.getCoordMode()!==Kekule.CoordMode.COORD3D)){var n=V[0];var m=V[1];var J=g.get(n).screenCoord;var H=g.get(m).screenCoord;var M=f.getObjectScreenCoord(h[0]);var I=f.getObjectScreenCoord(h[1]);var S=r.calcCoordGroup2DTransformParams(J,H,M,I);var G=r.calcTransform2DMatrix(S);var Y=false;for(var X=0,W=q.length;X<W;++X){var j=q[X];if(V.indexOf(j)<0){var Z=g.get(j);var z=e.get(j);if(Z.screenCoord){var x=r.transform2DByMatrix(Z.screenCoord,G);z.screenCoord=x;if(this._getMagneticNodeMergeDest(j,x,U)){Y=true}}if(Z.size){z.size=r.multiply(Z.size,S.scale)}}}if(Y){return this.applyManipulatingObjsInfo(k)}else{for(var X=0,W=q.length;X<W;++X){var j=q[X];if(V.indexOf(j)<0){var z=e.get(j);this.applySingleManipulatingObjInfo(X,j,z,k)}}}}}for(var X=0,W=ab;X<W;++X){var j=V[X];var L=h[X];var N=v[X];var y=this.createNodeMergeOperation(j,L);this.getMergeOperations()[N]=y}this.executeMergeOpers()}f.hotTrackOnObj(h);return}}if(B===ad.MOVE){var w=false;if((Q&&this.getEnableConnectorMerge())||(aa&&this.getEnableNodeMerge())){var D;var O=f.getBoundInfosAtCoord(k);var F=Q?Kekule.ChemStructureConnector:Kekule.ChemStructureNode;var o=Q?t[0]:q[0];var P=Q?function(i){return p._canMergeConnectors(o,i)}:function(i){return p._canMergeNodes(o,i)};var A=this._findSuitableMergeTargetBoundInfo(O,U,F,P);if(A){var u=A.obj;if(u){this.setAllManipulateObjsMerged(true);f.hotTrackOnObj(u);var C=s[0];if((Q&&this.isSameConnectorMerge(C,o,u))||(aa&&this.isSameNodeMerge(C,o,u))){return}else{if(C){this.reverseMergeOpers()}var y=Q?this.createConnectorMergeOperation(o,u):this.createNodeMergeOperation(o,u);this.getMergeOperations()[0]=y;y.execute();return}}}}}this.reverseMergeOpers();$super(k)},doMoveManipulatedObj_old:function($super,p,m,j,h){var f=this.getEditor();var y=this.getManipulateObjInfoMap().get(m);var u=j;var e=this.getManipulateOriginObjs();var t=this.getManipulationType();var q=(t===Kekule.Editor.BasicManipulationIaController.ManipulationType.MOVE)&&(e.length===1)&&(e[0] instanceof Kekule.ChemStructureConnector);var s=u;var o=null;var A=this.getMergeOperations();var k=A[p];var B=this.getManipulateObjs();if(!q&&this.getEnableMagneticMerge()&&(m instanceof Kekule.ChemStructureNode)){var g=f.getBoundInfosAtCoord(s);if(g&&g.length){for(var v=g.length-1;v>=0;--v){var y=g[v];var r=y.obj;if(r===m){continue}if(B.indexOf(r)>=0){continue}if(r instanceof Kekule.ChemStructureNode){if(this._canMergeNodes(m,r)){f.addHotTrackedObj(r);if(this.isSameNodeMerge(k,m,r)){return}o=this.createNodeMergeOperation(m,r);break}}}if(!o){f.hotTrackOnObj(null)}else{if(k){this.reverseMergeOpers(p)}this.getMergeOperations()[p]=o;o.execute()}}}var s=h;var z=false;if((t===Kekule.Editor.BasicManipulationIaController.ManipulationType.MOVE)){var n=e[0];if(e&&(e.length===1)){var x=f.getTopmostBoundInfoAtCoord(s,[n]);if(x){var l=x.obj;if(l&&(B.indexOf(l)<0)){if(q&&(n instanceof Kekule.ChemStructureConnector)&&(l instanceof Kekule.ChemStructureConnector)){if(this.getEnableConnectorMerge()){f.hotTrackOnObj(l);if(this.getEnableStructFragmentMerge()){z=true}else{z=(n.getParent()===l.getParent())}if(z){o=this.createConnectorMergeOperation(n,l)}}}else{if((n instanceof Kekule.ChemStructureNode)&&(l instanceof Kekule.ChemStructureNode)){if(this._canMergeNodes(n,l)){f.hotTrackOnObj(l);if(this.isSameNodeMerge(k,n,l)){return}else{}o=this.createNodeMergeOperation(n,l)}}}if(o){var k=A[p];if(k){this.reverseMergeOpers(p)}this.getMergeOperations()[p]=o;o.execute();return}}}}}if(!o){f.hideHotTrack();var w=!!this.getMergeOperations().length;if(w){this.reverseMergeOpers(p)}$super(p,m,j,h)}},_maniplateObjsFrameEnd:function($super,e){$super(e)},createNodeMergeOperation:function(g,f){var e=this.getEnableStructFragmentMerge();if(!Kekule.ChemStructOperation.MergeNodes.canMerge(g,f,e,this.getEnableNeighborNodeMerge())){return null}else{var h=new Kekule.ChemStructOperation.MergeNodes(g,f,e);return h}},createConnectorMergeOperation:function(g,f){var e=this.getEnableStructFragmentMerge();if(!Kekule.ChemStructOperation.MergeConnectors.canMerge(g,f,e)){return null}else{var h=new Kekule.ChemStructOperation.MergeConnectors(g,f,this.getEditor().getCoordMode(),e);return h}},isSameConnectorMerge:function(f,g,e){return f&&(f instanceof Kekule.ChemStructOperation.MergeConnectors)&&(g===f.getTarget())&&(e===f.getDest())},isSameNodeMerge:function(f,g,e){return f&&(f instanceof Kekule.ChemStructOperation.MergeNodes)&&(g===f.getTarget())&&(e===f.getDest())},executeMergeOpers:function(){var g=Kekule.ArrayUtils.toUnique(this.getMergeOperations());for(var f=0,e=g.length;f<e;++f){if(g[f]){g[f].execute()}}},reverseMergeOpers:function(g){var f=Kekule.ArrayUtils.toUnique(this.getMergeOperations());if(!g){g=0}for(var e=f.length-1;e>=g;--e){if(f[e]){f[e].reverse()}}this.getMergeOperations().length=g},react_mousemove:function($super,f){this._suppressConstrainedMoving=f.getAltKey();this._suppressConstrainedRotating=f.getAltKey();this._isInDirectedMoving=f.getShiftKey();return $super(f)}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.BasicMolManipulationIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.MolBondIaController=Class.create(Kekule.Editor.BasicMolManipulationIaController,{CLASS_NAME:"Kekule.Editor.MolBondIaController",initialize:function($super,e){$super(e);this.setState(c.State.INITIAL);this.setBondOrder(Kekule.BondOrder.SINGLE);this.setAllowBondingToBond(false);this.setEnableBondModification(true);this.setEnableSelect(false);this.setEnableMove(true);this.setAutoSwitchBondOrder(false);this.setEnableNeighborNodeMerge(false)},initProperties:function(){this.defineProp("allowBondingToBond",{dataType:DataType.BOOL,serializable:false});this.defineProp("state",{dataType:DataType.INT,serializable:false});this.defineProp("enableBondModification",{dataType:DataType.BOOL,serializable:false});this.defineProp("autoSwitchBondOrder",{dataType:DataType.BOOL,serializable:false});this.defineProp("startingObj",{dataType:"Kekule.ChemStructureObject",serializable:false});this.defineProp("endingObj",{dataType:"Kekule.ChemStructureObject",serializable:false});this.defineProp("structFragment",{dataType:"Kekule.ChemStructureFragment",serializable:false});this.defineProp("autoCreatedStructFragment",{dataType:"Kekule.StructureFragment",serializable:false});this.defineProp("autoCreatedStartingObj",{dataType:"Kekule.ChemStructureObject",serializable:false});this.defineProp("bond",{dataType:"Kekule.Bond",serializable:false});this.defineProp("bondType",{dataType:DataType.STRING,serializable:false});this.defineProp("bondOrder",{dataType:DataType.INT,serializable:false});this.defineProp("bondStereo",{dataType:DataType.INT,serializable:false});this.defineProp("initialBondDirection",{dataType:DataType.FLOAT})},_isBondDifferent:function(g){var e=this.getBondStereo();var f=Kekule.BondStereo;if(e===f.UP||e===f.UP_INVERTED||e===f.DOWN||e===f.DOWN_INVERTED){return true}else{return(g.getBondType()!==this.getBondType())||(g.getBondOrder()!==this.getBondOrder())||(g.getStereo()!==this.getBondStereo())}},canInteractWithObj:function($super,f){var e=this.getState();if(e===c.State.INITIAL){if(f instanceof Kekule.ChemStructureNode){return true}else{if(f instanceof Kekule.ChemStructureConnector){if(this.getAllowBondingToBond()){return true}else{if(this.getEnableBondModification()){if(f instanceof Kekule.Bond){return this._isBondDifferent(f)}}else{return false}}}}}else{return $super(f)}},doTestMouseCursor:function(g,f){return""},isObjValidBondTerminator:function(e){if(!e){return false}if(!this.getAllowBondingToBond()){return(e instanceof Kekule.ChemStructureNode)}else{return((e instanceof Kekule.ChemStructureNode)||(e instanceof Kekule.ChemStructureConnector))}},isBond:function(e){return(e instanceof Kekule.Bond)},getNewBondDefAngle:function(e,f){var g=this.getEditorConfigs().getStructureConfigs();return g.getNewBondDefAngle(e,f)},addDefBond:function(r,i,j){var u;var l=this.getEditor();l.beginUpdateObject();try{if(!i){if(!this.getEditor().canAddUnconnectedStructFragment()){return null}var g=this.getEditor().screenCoordToObj(r);var s=this.getEditor().getOnlyOneBlankStructFragment();if(!s){i=this.getEditor().createNewStructFragmentAndStartingAtom(null,g);this.setAutoCreatedStartingObj(null);this.setAutoCreatedStructFragment(i?i.getParent():null)}else{i=this.getEditor().createStructStartingAtom(s,null,g);this.setAutoCreatedStructFragment(null);this.setAutoCreatedStartingObj(i)}}else{this.setAutoCreatedStartingObj(null);this.setAutoCreatedStructFragment(null)}if(this.isObjValidBondTerminator(i)){var l=this.getEditor();this.setStartingObj(i);var o=i.getParent();this.setStructFragment(o);var e=this.getEditorConfigs().getStructureConfigs();var m=Kekule.oneOf(this.getBondType(),e.getDefBondType());var q=Kekule.oneOf(this.getBondOrder(),e.getDefBondOrder());var n=Kekule.oneOf(this.getBondStereo(),Kekule.BondStereo.NONE);var f=l.getDefBondLength?l.getDefBondLength():e.getDefBondLength();var p=this.getNewBondDefAngle(i,q);var k=Kekule.Editor.StructureUtils.calcPreferred2DBondGrowingLocation(i,f,p,this.getEditor().getAllowCoordBorrow());var h=this.getEditor().createDefaultNode(k,Kekule.Editor.CoordSys.OBJ,o);this.setEndingObj(h);var t=new Kekule.Bond();t.setBondType(m);t.setBondOrder(q);t.setStereo(n);o.appendConnector(t);t.appendConnectedObj(i);t.appendConnectedObj(h);this.setBond(t);if(j){this.getEditor().objectsChanged([t,h])}u=k}else{u=null}}finally{l.endUpdateObject()}return u},addOperationToEditor:function($super){return $super()},getAllObjOperations:function($super){var e=$super()||[];var f=this.getAddBondOperation();if(f){e.unshift(f)}return e},getAddBondOperation:function(){var n=new Kekule.MacroOperation();var j=this.getEditor();var i=this.getAutoCreatedStructFragment();if(i){var e=new Kekule.ChemObjOperation.Add(i,this.getEditor().getChemObj(),null);n.add(e)}var h=this.getStartingObj();var m=this.getEndingObj();var o=this.getBond();var l=this.getStructFragment();var g=this.getAutoCreatedStartingObj();if(g){var f=new Kekule.ChemStructOperation.AddNode(g,l);n.add(f)}var f=new Kekule.ChemStructOperation.AddNode(m,l);n.add(f);var k=new Kekule.ChemStructOperation.AddConnector(o,l,null,[h,m]);n.add(k);return n},modifyBond:function(s){var n=this.getBondType();var p;var m=Kekule.BondOrder;var h=[m.SINGLE,m.DOUBLE,m.TRIPLE];if(this.getAutoSwitchBondOrder()&&(n===Kekule.BondType.COVALENT)&&(s.getBondType===Kekule.BondType.COVALENT)){var j=s.getBondOrder();var l=h.indexOf(j);if(l>=0){l=(++l)%h.length}else{l=0}p=h[l]}else{p=this.getBondOrder()}var q=s.getStereo();var o=this.getBondStereo();if(q===o){o=Kekule.BondStereo.getInvertedDirection(o)}var r={bondType:n,bondOrder:p,stereo:o};var t=false;for(var g in r){var e=s.getPropValue(g);if(e!==r[g]){t=true;break}}if(t){var k=this.getEditor();k.beginUpdateObject();try{var i=new Kekule.ChemObjOperation.Modify(s,r);i.execute();k.pushOperation(i);var f=[s].concat(s.getConnectedObjs());this.getEditor().objectsChanged(f)}finally{k.endUpdateObject()}}},react_mousedown:function(k){if(k.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){var h=c.State;var l=this._getEventMouseCoord(k);var i=this.getState();if(i===h.INITIAL){var f=this.getEditor().getTopmostBoundInfoAtCoord(l);if(f){var j=f.obj;if(this.isObjValidBondTerminator(j)){var g=this.addDefBond(l,j,true);if(g){this.startDirectManipulate(null,this.getEndingObj(),l)}return true}else{if(this.isBond(j)&&this.getEnableBondModification()){this.modifyBond(j);return true}}}else{if(this.getEditor().canAddUnconnectedStructFragment()){var g=this.addDefBond(l,null,true);if(g){this.startDirectManipulate(null,this.getEndingObj(),l)}return true}}}}},react_mouseup:function($super,j){var i=this.getState();var h=this.getStartCoord();var f=this._getEventMouseCoord(j);var g=Kekule.Editor.BasicManipulationIaController.State;if((i===g.MANIPULATING)&&(j.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT)){if(Kekule.CoordUtils.isEqual(h,f)){this.addOperationToEditor();this.stopManipulate();this.setState(g.NORMAL);return true}}return $super(j)}});Kekule.Editor.MolBondIaController.State={INITIAL:0,START_NODE_SET:21,ADJUSTING:22};var c=Kekule.Editor.MolBondIaController;Kekule.Editor.IaControllerManager.register(Kekule.Editor.MolBondIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.MolAtomIaController=Class.create(Kekule.Editor.BaseEditorIaController,{CLASS_NAME:"Kekule.Editor.MolAtomIaController",initialize:function($super,e){$super(e);this._createNonAtomLabelInfos()},finalize:function($super){if(this.getAtomSetter()){this.getAtomSetter().finalize()}$super()},initProperties:function(){this.defineProp("currAtom",{dataType:DataType.OBJECT,serializable:false});this.defineProp("atomSetter",{dataType:DataType.OBJECT,serializable:false});this.defineProp("periodicTable",{dataType:DataType.OBJECT,serializable:false});this.defineProp("periodicTableDialog",{dataType:DataType.OBJECT,serializable:false});this.defineProp("nonAtomLabelInfos",{dataType:DataType.ARRAY,serializable:false})},canInteractWithObj:function($super,e){if(this.isValidNode(e)){return true}else{return false}},isValidNode:function(e){return e instanceof Kekule.ChemStructureNode},getNodeLabel:function(f){var g=this.getEditor().getRenderConfigs().getDisplayLabelConfigs();if(f.getIsotopeId){return f.getIsotopeId()}else{if(f instanceof Kekule.SubGroup){return g.getRgroup()}else{var e=f.getCoreDisplayRichTextItem(g);return Kekule.Render.RichTextUtils.toText(e)}}},_getVarAtomListLabel:function(){var e=this.getEditor().getRenderConfigs().getDisplayLabelConfigs();return e.getVariableAtom()},_getVarAtomNotListLabel:function(){var e=this.getEditor().getRenderConfigs().getDisplayLabelConfigs();return"~"+e.getVariableAtom()},_createNonAtomLabelInfos:function(){var e=[];var f=this.getEditor().getRenderConfigs().getDisplayLabelConfigs();e.push({nodeLabel:f.getRgroup(),nodeClass:Kekule.RGroup,description:Kekule.ChemWidgetTexts.CAPTION_RGROUP});e.push({nodeLabel:f.getDummyAtom(),nodeClass:Kekule.Pseudoatom,props:{atomType:Kekule.PseudoatomType.DUMMY},description:Kekule.ChemWidgetTexts.CAPTION_DUMMY_ATOM});e.push({nodeLabel:f.getHeteroAtom(),nodeClass:Kekule.Pseudoatom,props:{atomType:Kekule.PseudoatomType.HETERO},description:Kekule.ChemWidgetTexts.CAPTION_HETERO_ATOM});e.push({nodeLabel:f.getAnyAtom(),nodeClass:Kekule.Pseudoatom,props:{atomType:Kekule.PseudoatomType.ANY},description:Kekule.ChemWidgetTexts.CAPTION_ANY_ATOM});e.push({nodeLabel:this._getVarAtomListLabel(),nodeClass:Kekule.VariableAtom,description:Kekule.ChemWidgetTexts.CAPTION_VARIABLE_ATOM});e.push({nodeLabel:this._getVarAtomNotListLabel(),nodeClass:Kekule.VariableAtom,description:Kekule.ChemWidgetTexts.CAPTION_VARIABLE_NOT_ATOM});this.setNonAtomLabelInfos(e);return e},_indexOfNonAtomLabel:function(j){var h=this.getNonAtomLabelInfos();for(var f=0,e=h.length;f<e;++f){var g=h[f];if(g.nodeLabel===j){return f}}return -1},_getNonAtomInfo:function(f){var e=this._indexOfNonAtomLabel(f);return(e<0)?null:this.getNonAtomLabelInfos()[e]},getAtomSetterWidget:function(h){var f=this.getAtomSetter();if(!f&&h){var e=this.getEditor().getCoreElement();var g=e.ownerDocument;f=this._createAtomSetterWidget(g,e);this.setAtomSetter(f)}return f},_createAtomSetterWidget:function(o,n){var q=new Kekule.Widget.ComboBox(o);var g=this.getEditor().getEditorConfigs().getStructureConfigs().getPrimaryOrgChemAtoms();var j=[];for(var m=0,k=g.length;m<k;++m){j.push({value:g[m],data:{props:{isotopeId:g[m]}}})}j.push({value:b.CAPTION_ATOMLIST_PERIODIC_TABLE});var f=this.getNonAtomLabelInfos();for(var m=0,k=f.length;m<k;++m){var h=f[m];var e={value:h.nodeLabel,data:{props:h.props}};if(h.description){e.text=h.nodeLabel+" - "+h.description}j.push(e)}q.setItems(j);q.appendToElem(n);var p=this;q.addEventListener("keyup",function(l){var i=l.htmlEvent;if(i.getKeyCode()===Kekule.X.Event.KeyCode.ENTER){p.applySetter(q);q.dismiss()}});q.addEventListener("valueSelect",function(i){p.applySetter(q);q.dismiss()});q.addEventListener("showStateChange",function(i){if(!i.isShown&&!i.isDismissed){p.applySetter(q)}});return q},getPeriodicTableDialogWidget:function(h){var f=this.getPeriodicTableDialog();if(!f&&h){var e=this.getEditor().getCoreElement();var g=e.ownerDocument;f=this._createPeriodicTableDialogWidget(g,e);this.setPeriodicTableDialog(f)}console.log(f);return f},_createPeriodicTableDialogWidget:function(h,e){var f=new Kekule.Widget.Dialog(h,b.CAPTION_PERIODIC_TABLE_DIALOG,[Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL]);var g=new Kekule.ChemWidget.PeriodicTable(h);g.setUseMiniMode(true);g.setEnableSelect(true);g.appendToElem(f.getClientElem());this.setPeriodicTable(g);return f},openSetterUi:function(l,i){var j=this.getAtomSetter();if(j&&j.isShown()){this.applySetter(j,this.getCurrAtom())}if(!this.isValidNode(i)){return}this.setCurrAtom(i);var h=this.getEditor().getEditorConfigs().getInteractionConfigs().getAtomSetterFontSize()||0;var f=h/1.5;var e=this.getNodeLabel(i);var k=this.getAtomSetterWidget(true);k.setValue(e);var g=k.getElement().style;g.position="absolute";g.fontSize=h;g.left=(l.x-f)+"px";g.top=(l.y-f)+"px";k.show(null,null,Kekule.Widget.ShowHideType.POPUP);k.selectAll();k.focus()},applySetter:function(h,k){if(!k){k=this.getCurrAtom()}var e;var l=null;var o=h.getValue();var i;if(o===b.CAPTION_ATOMLIST_PERIODIC_TABLE){var i=this.getPeriodicTableDialogWidget(true);i.setCaption(b.CAPTION_PERIODIC_TABLE_DIALOG_SEL_ELEM);var g=k.getSymbol?k.getSymbol():null;this.getPeriodicTable().setEnableSelect(true).setEnableMultiSelect(false).setSelectedSymbol(g)}else{if(o===this._getVarAtomListLabel()||o===this._getVarAtomNotListLabel()){var j=o===this._getVarAtomNotListLabel();var i=this.getPeriodicTableDialogWidget(true);i.setCaption(b.CAPTION_PERIODIC_TABLE_DIALOG_SEL_ELEMS);var m=k.getAllowedIsotopeIds?k.getAllowedIsotopeIds():null;var f=k.getDisallowedIsotopeIds?k.getDisallowedIsotopeIds():null;this.getPeriodicTable().setEnableSelect(true).setEnableMultiSelect(true).setSelectedSymbols(j?f:m)}}if(i){var p=this;i.openModal(function(q){if(q===Kekule.Widget.DialogButtons.OK){var t;var s;if(o===b.CAPTION_ATOMLIST_PERIODIC_TABLE){var u=p.getPeriodicTable().getSelectedSymbol();t=Kekule.Atom;s={isotopeId:u}}if(o===p._getVarAtomListLabel()){var r=p.getPeriodicTable().getSelectedSymbols();t=Kekule.VariableAtom;s={allowedIsotopeIds:r,disallowedIsotopeIds:null}}if(o===p._getVarAtomNotListLabel()){var r=p.getPeriodicTable().getSelectedSymbols();t=Kekule.VariableAtom;s={allowedIsotopeIds:null,disallowedIsotopeIds:r}}p.applyModification(k,t,s)}},this);return}var n=this._getNonAtomInfo(o);if(n){e=n.nodeClass;l=n.props}else{e=Kekule.Atom;l={isotopeId:o}}this.applyModification(k,e,l)},applyModification:function(g,p,l){var n;var h,i;var f=g.getClass();if(p!==f){h=new Kekule.MacroOperation();n=new p();n.assign(g);var o=new Kekule.ChemStructOperation.ReplaceNode(g,n);h.add(o)}else{n=g}if(l){i=new Kekule.ChemObjOperation.Modify(n,l);if(h){h.add(i)}}var k=this.getEditor();k.beginUpdateObject();try{var j=h||i;j.execute()}catch(m){Kekule.error(Kekule.ErrorMsg.NOT_A_VALID_ATOM);throw (m)}finally{k.endUpdateObject()}if(k&&k.getEnableOperHistory()&&j){k.pushOperation(j)}},react_mouseup:function(i){if(i.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){this.getEditor().setSelection(null);var j=this._getEventMouseCoord(i);var f=this.getEditor().getTopmostBoundInfoAtCoord(j);if(f){var h=f.obj;if(this.isValidNode(h)){var g=this.getEditor().getObjectScreenCoord(h);i.preventDefault();i.stopPropagation();this.openSetterUi(g,h);this.getEditor().setSelection([h])}return true}}}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.MolAtomIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.MolNodeChargeIaController=Class.create(Kekule.Editor.BaseEditorIaController,{CLASS_NAME:"Kekule.Editor.MolNodeChargeIaController",initialize:function($super,e){$super(e);this.setChargeInc(1)},initProperties:function(){this.defineProp("chargeInc",{dataType:DataType.NUMBER,serializable:false});this.defineProp("charge",{dataType:DataType.NUMBER,serializable:false});this.defineProp("radical",{dataType:DataType.INT,serializable:false});this.defineProp("currNode",{dataType:DataType.OBJECT,serializable:false})},canInteractWithObj:function($super,e){if(this.isValidNode(e)){return true}else{return false}},isValidNode:function(e){return e instanceof Kekule.ChemStructureNode},apply:function(i){var f=false;var j={};var h=i.getCharge();if(Kekule.ObjUtils.notUnset(this.getCharge())){if(h!==this.getCharge()){j.charge=this.getCharge();f=true}}else{if(this.getChargeInc()){h+=this.getChargeInc();j.charge=h;f=true}}var e=i.getRadical();if(this.getRadical()!==e){j.radical=this.getRadical();f=true}if(f){var k=new Kekule.ChemObjOperation.Modify(i,j);k.execute();var g=this.getEditor();if(g&&g.getEnableOperHistory()){g.pushOperation(k)}}},react_mouseup:function(h){if(h.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){var i=this._getEventMouseCoord(h);var f=this.getEditor().getTopmostBoundInfoAtCoord(i);if(f){var g=f.obj;if(this.isValidNode(g)){this.apply(g);h.preventDefault();h.stopPropagation()}return true}}}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.MolNodeChargeIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.RepositoryIaController=Class.create(Kekule.Editor.BasicMolManipulationIaController,{CLASS_NAME:"Kekule.Editor.RepositoryIaController",initialize:function($super,e){$super(e)},initProperties:function(){this.defineProp("repositoryItem",{dataType:"Kekule.AbstractRepositoryItem",serializable:false});this.defineProp("addRepObjsOper",{dataType:"Kekule.MacroOperation",serializable:false})},_calcNodeMergeAdjustRotateAngle:function(x,n){var m=0;var w=this.getEditor().getCoordMode();if(w!==Kekule.CoordMode.COORD3D){var y=this.getEditor().getAllowCoordBorrow();var o=this.getEditorConfigs().getStructureConfigs();var j=Kekule.Editor.StructureUtils.getSurroundingObjs(x);var h=Kekule.Editor.StructureUtils.getSurroundingObjs(n);if(j.length===1){var e=x.getLinkedConnectorAt(0);var r=e.getBondOrder?e.getBondOrder():0;var t=o.getNewBondDefAngle(n,r);z=Kekule.Editor.StructureUtils.calcPreferred2DBondGrowingDirection(n,t,y);var f=Kekule.ChemStructureUtils.getAbsCoordVectorBetweenObjs(x,j[0],w,y);var g=Math.atan2(f.y,f.x);m=z-g}else{if(h.length===1){var e=n.getLinkedConnectorAt(0);var r=e.getBondOrder?e.getBondOrder():0;var t=o.getNewBondDefAngle(x,r);var z=Kekule.Editor.StructureUtils.calcPreferred2DBondGrowingDirection(x,t,y);var f=Kekule.ChemStructureUtils.getAbsCoordVectorBetweenObjs(n,h[0],w,y);var q=Math.atan2(f.y,f.x);m=q-z}else{var t=o.getNewBondDefAngle(n,null);var z=Kekule.Editor.StructureUtils.calcPreferred2DBondGrowingDirection(n,t,y);var p={};for(var u=0,s=j.length;u<s;++u){var f=Kekule.ChemStructureUtils.getAbsCoordVectorBetweenObjs(x,j[u],w,y);var v=Math.atan2(f.y,f.x);if(Kekule.ObjUtils.isUnset(p.min)||(v<p.min)){p.min=v}if(Kekule.ObjUtils.isUnset(p.max)||(v>p.max)){p.max=v}}var k=(p.max+p.min)/2;m=z-k}}}return m},_calcConnectorMergeTransformParams:function(f,m){var j=f.getConnectedObjAt(0);var i=f.getConnectedObjAt(1);var l=m.getConnectedObjAt(0);var k=m.getConnectedObjAt(1);var h=this.getEditor();var g=h.getObjCoord(j);var e=h.getObjCoord(i);var p=h.getObjCoord(l);var n=h.getObjCoord(k);var o=Kekule.CoordUtils.calcCoordGroup2DTransformParams(g,e,n,p);return o},calcInitialTransformParams:function(j,g,k,h){var o=this.getEditor();var m=g.baseObjCoord;var f=o.getDefBondLength();var n=f/j.getRefLength();var l;var e=m;if(g.mergeObj){var k=g.mergeDest||k;if(k){h=o.getObjectScreenCoord(k);if((g.mergeObj instanceof Kekule.ChemStructureNode)&&(k instanceof Kekule.ChemStructureNode)){l=this._calcNodeMergeAdjustRotateAngle(g.mergeObj,k)}else{if((g.mergeObj instanceof Kekule.ChemStructureConnector)&&(k instanceof Kekule.ChemStructureConnector)){return this._calcConnectorMergeTransformParams(g.mergeObj,k)}}}}var i=o.translateCoord(h,Kekule.Editor.CoordSys.SCREEN,Kekule.Editor.CoordSys.OBJ);if(m){i=Kekule.CoordUtils.substract(i,m)}var p={scale:n,translateX:i.x,translateY:i.y,translateZ:i.z,rotateAngle:l,center:e};return p},addRepositoryObj:function(t,r){var s=this.getEditor();this.setAddRepObjsOper(null);var f=null;s.beginUpdateObject();try{var h=s.getChemSpace();var m=this.getRepositoryItem();f=m.createObjects(t);var w=f.objects;var e=m.isOneStructureFragmentObj();var g=false;var u=this.getEditor().getOnlyOneBlankStructFragment();if(!this.getEditor().canCreateNewChild()&&!f.mergeObj){if(!e||!this.getEditor().canAddUnconnectedStructFragment()){return null}else{g=true}}var q=new Kekule.MacroOperation();for(var p=0,k=w.length;p<k;++p){var o=w[p];var j;if(g){j=new Kekule.ChemStructOperation.MergeStructFragment(o,u)}else{j=new Kekule.ChemObjOperation.Add(o,h)}q.add(j)}q.execute();this.setAddRepObjsOper(q);var n=g?[u]:w;var v=this.calcInitialTransformParams(m,f,t,r);this._transformObjectsCoordAndSize(n,v);f.objects=n}finally{s.endUpdateObject()}return f},_transformObjectsCoordAndSize:function(p,o){var j=this.getEditor().getCoordMode();var g=this.getEditor().getAllowCoordBorrow();var n=(j===Kekule.CoordMode.COORD3D)?Kekule.CoordUtils.calcTransform3DMatrix(o):Kekule.CoordUtils.calcTransform2DMatrix(o);var e=Object.extend({},o);e=Object.extend(e,{translateX:0,translateY:0,translateZ:0,center:{x:0,y:0,z:0}});var f=(j===Kekule.CoordMode.COORD3D)?Kekule.CoordUtils.calcTransform3DMatrix(e):Kekule.CoordUtils.calcTransform2DMatrix(e);for(var m=0,h=p.length;m<h;++m){var k=p[m];k.transformAbsCoordByMatrix(n,f,j,true,g);k.scaleSize(o.scale,j,true,g)}},getAllObjOperations:function($super){var f=$super()||[];var e=this.getAddRepObjsOper();if(e){f.unshift(e)}return f},addOperationToEditor:function($super){if(this.getAllManipulateObjsMerged()){return null}else{return $super()}},getInitManipulationType:function(){return Kekule.Editor.BasicManipulationIaController.ManipulationType.ROTATE},react_mousedown:function(p){if(p.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){var k=c.State;var n=this._getEventMouseCoord(p);var f=this.getState();if(f===k.INITIAL){var i=this.getEditor().getTopmostBoundInfoAtCoord(n);var m=i?i.obj:null;var h=this.addRepositoryObj(m,n);if(h){var g=h.objects;var o=null;var j=this.getInitManipulationType();if(h.mergeObj){o=this.getEditor().getObjectScreenCoord(h.mergeObj);j=Kekule.Editor.BasicManipulationIaController.ManipulationType.ROTATE}var l=this.getEditor().getObjectsContainerBox(g);this.startDirectManipulate(j,g,n,l,o);this.moveManipulatedObjs(n)}else{}return true}}},react_mouseup:function($super,j){var i=this.getState();var h=this.getStartCoord();var f=this._getEventMouseCoord(j);var g=Kekule.Editor.BasicManipulationIaController.State;if((i===g.MANIPULATING)&&(j.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT)){if(Kekule.CoordUtils.isEqual(h,f)){this.addOperationToEditor();this.stopManipulate();this.setState(g.NORMAL);return true}}return $super(j)}});Kekule.Editor.MolRingIaController=Class.create(Kekule.Editor.RepositoryIaController,{CLASS_NAME:"Kekule.Editor.MolRingIaController",initialize:function($super,e){$super(e);this.setRepositoryItem(new Kekule.Editor.MolRingRepositoryItem2D())},initProperties:function(){this.defineProp("ringAtomCount",{dataType:DataType.INT,getter:function(){return this.getRepositoryItem().getRingAtomCount()},setter:function(e){this.getRepositoryItem().setRingAtomCount(e)}});this.defineProp("isAromatic",{dataType:DataType.INT,getter:function(){return this.getRepositoryItem().getIsAromatic()},setter:function(e){this.getRepositoryItem().setIsAromatic(e)}})}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.MolRingIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.ArrowLineIaController=Class.create(Kekule.Editor.RepositoryIaController,{CLASS_NAME:"Kekule.Editor.ArrowLineIaController",initialize:function($super,e){$super(e);this.setRepositoryItem(new Kekule.Editor.PathGlyphRepositoryItem2D())},initProperties:function(){this.defineProp("glyphRefLength",{dataType:DataType.FLOAT,getter:function(){return this.getRepositoryItem().getGlyphRefLength()},setter:function(e){this.getRepositoryItem().setGlyphRefLength(e)}});this.defineProp("glyphClass",{dataType:DataType.CLASS,serializable:false,getter:function(){return this.getRepositoryItem().getGlyphClass()},setter:function(e){this.getRepositoryItem().setGlyphClass(e)}});this.defineProp("glyphInitialParams",{dataType:DataType.HASH,getter:function(){return this.getRepositoryItem().getGlyphInitialParams()},setter:function(e){this.getRepositoryItem().setGlyphInitialParams(e)}})},getInitManipulationType:function(){return Kekule.Editor.BasicManipulationIaController.ManipulationType.MOVE},addRepositoryObj:function($super,f,e){this.getRepositoryItem().setGlyphRefLength(this.getEditor().getChemSpace().getDefAutoScaleRefLength());return $super(f,e)}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.ArrowLineIaController,Kekule.Editor.ChemSpaceEditor);Kekule.Editor.TextBlockIaController=Class.create(Kekule.Editor.BaseEditorIaController,{CLASS_NAME:"Kekule.Editor.TextBlockIaController",initialize:function($super,e){$super(e);this._operAddBlock=null},initProperties:function(){this.defineProp("currBlock",{dataType:DataType.OBJECT,serializable:false});this.defineProp("textSetter",{dataType:DataType.OBJECT,serializable:false})},canInteractWithObj:function($super,e){if(e&&this.isValidBlock(e)){return true}else{return false}},isValidBlock:function(e){return e instanceof Kekule.TextBlock},getBlockText:function(e){return e.getText()},createNewBlock:function(g,i){var f=this.getEditor();if(!f.canCreateNewChild()){return null}f.beginUpdateObject();try{var h=new Kekule.TextBlock();g.appendChild(h);f.setObjectScreenCoord(h,i);var e=new Kekule.ChemObjOperation.Add(h,g,null);this._operAddBlock=e}finally{f.endUpdateObject()}return h},getTextSetterWidget:function(h){var f=this.getTextSetter();if(!f&&h){var e=this.getEditor().getCoreElement();var g=e.ownerDocument;f=this._createTextSetterWidget(g,e);this.setTextSetter(f)}return f},_createTextSetterWidget:function(h,f){var e=new Kekule.Widget.TextArea(h);e.setAutoSizeX(true);e.setAutoSizeY(true);e.addClassName(d.CHEMEDITOR_TEXT_SETTER);e.appendToElem(f);var g=this;e.addEventListener("keyup",function(k){var i=k.htmlEvent;var j=i.getKeyCode();if((j===Kekule.X.Event.KeyCode.ENTER)&&(i.getCtrlKey())){g.applySetter(e);e.dismiss()}else{if(j===Kekule.X.Event.KeyCode.ESC){e.dismiss();if(g._operAddBlock){g._operAddBlock.reverse();g._operAddBlock=null}}}});e.addEventListener("showStateChange",function(i){if(!i.isShown&&!i.isDismissed){g.applySetter(e)}});return e},applySetter:function(j,h){if(j._applied){return}if(!h){h=this.getCurrBlock()}var g=j.getText();var i=new Kekule.ChemObjOperation.Modify(h,{text:g});i.execute();var e=this.getEditor();if(e&&e.getEnableOperHistory()){if(this._operAddBlock){var f=new Kekule.MacroOperation();f.add(this._operAddBlock);f.add(i);e.pushOperation(f);this._operAddBlock=null}else{e.pushOperation(i)}}j._applied=true},openSetterUi:function(l,j){var i=this.getTextSetter();if(i&&i.isShown()){this.applySetter(i,this.getCurrBlock())}if(!j){j=this.createNewBlock(this.getEditor().getChemObj(),l)}if(!this.isValidBlock(j)){return}this.setCurrBlock(j);this.getEditor().setSelection([j]);var g=j.getCascadedRenderOption("fontSize")||this.getEditor().getEditorConfigs().getInteractionConfigs().getAtomSetterFontSize();var h=this.getBlockText(j);var k=this.getTextSetterWidget(true);k._applied=false;var e=h||Kekule.ChemWidgetTexts.CAPTION_TEXTBLOCK_INIT;k.setValue(e);var f=k.getElement().style;f.position="absolute";f.fontSize=g+"px";f.left=l.x+"px";f.top=l.y+"px";k.show(null,null,Kekule.Widget.ShowHideType.POPUP);k.selectAll();k.focus()},react_mouseup:function(i){if(i.getButton()===Kekule.X.Event.MOUSE_BTN_LEFT){this.getEditor().setSelection(null);var k=this._getEventMouseCoord(i);var j;var f=this.getEditor().getTopmostBoundInfoAtCoord(k);if(f){var h=f.obj;if(this.isValidBlock(h)){j=h}}var g=j?this.getEditor().getObjectScreenCoord(j):k;i.preventDefault();i.stopPropagation();this.openSetterUi(g,j);return true}}});Kekule.Editor.IaControllerManager.register(Kekule.Editor.TextBlockIaController,Kekule.Editor.ChemSpaceEditor)})();(function(){Kekule.Editor.EditorNexus=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemWidget.StructureTreeView",initialize:function($super,a){$super();this._currInvoker=null;if(a){if(a.editor){this.setEditor(a.editor)}if(a.structureTreeView){this.setStructureTreeView(a.structureTreeView)}if(a.objectInspector){this.setObjectInspector(a.objectInspector)}}},initProperties:function(){this.defineProp("editor",{dataType:"Kekule.Editor.BaseEditor",serializable:false,setter:function(b){var a=this.getPropStoreFieldValue("editor");this.setPropStoreFieldValue("editor",b);this.editorChanged(b,a)}});this.defineProp("structureTreeView",{dataType:"Kekule.ChemWidget.StructureTreeView",serializable:false,setter:function(b){var a=this.getPropStoreFieldValue("structureTreeView");this.setPropStoreFieldValue("structureTreeView",b);this.structureTreeViewChanged(b,a)}});this.defineProp("objectInspector",{dataType:"Kekule.Widget.ObjectInspector",serializable:false,setter:function(b){var a=this.getPropStoreFieldValue("objectInspector");this.setPropStoreFieldValue("objectInspector",b);this.objectInspectorChanged(b,a)}})},editorChanged:function(b,a){if(a){this._uninstallEditorEventHandler(a)}if(b){this._installEditorEventHandler(b)}},structureTreeViewChanged:function(b,a){if(a){this._uninstallStructureTreeViewEventHandler(a)}if(b){this._installStructureTreeViewEventHandler(b);this._updateByEditor()}},objectInspectorChanged:function(c,a){var b=this.getEditor();if(b){if(a){if(a.getOperHistory()===b.getOperHistory()){a.setOperHistory(null)}}if(c){c.setOperHistory(b.getOperHistory());c.setEnableOperHistory(b.getEnableOperHistory());this._updateByEditor()}}},_installEditorEventHandler:function(a){a.addEventListener("change",this._reactEditorChanged,this)},_uninstallEditorEventHandler:function(a){a.removeEventListener("change",this._reactEditorChanged,this)},_installStructureTreeViewEventHandler:function(a){a.addEventListener("change",this._reactStructureTreeViewChanged,this)},_uninstallStructureTreeViewEventHandler:function(a){a.removeEventListener("change",this._reactStructureTreeViewChanged,this)},_reactEditorChanged:function(b){if(this._currInvoker){return}var a=b.target;if(a!==this.getEditor()){return}var d=b.changedPropNames;if(d.indexOf("chemObj")>=0){this.changeRootObj(a.getChemObj(),a)}if(d.indexOf("selection")>=0){this.changeSelection(a.getSelection(),a)}if((d.indexOf("operHistory")>=0)||(d.indexOf("enableOperHistory")>=0)){var c=this.getObjectInspector();if(c){c.setOperHistory(a.getOperHistory());c.setEnableOperHistory(a.getEnableOperHistory())}}},_updateByEditor:function(){this._reactEditorChanged({target:this.getEditor(),changedPropNames:["chemObj","selection","operHistory"]})},_reactStructureTreeViewChanged:function(b){if(this._currInvoker){return}var a=b.target;if(a!==this.getStructureTreeView()){return}var d=b.changedPropNames;if(d.indexOf("selection")>=0){var c=a.getSelectedChemObjs();this.changeSelection(c,a)}},changeSelection:function(d,b){this._currInvoker=b;try{var c=this.getEditor();if(c){if(this._currInvoker!==c){c.setSelection(d)}}var a=this.getStructureTreeView();if(a){if(this._currInvoker!==a){a.selectChemObjs(d)}}var e=this.getObjectInspector();if(e){if(this._currInvoker!==e){e.setObjects(d)}}}finally{this._currInvoker=null}},changeRootObj:function(a,c){this._currInvoker=c;try{var d=this.getEditor();if(d&&this._currInvoker!==d){d.setChemObj(a)}var b=this.getStructureTreeView();if(b&&this._currInvoker!==b){b.setRootObj(a)}}finally{this._currInvoker=null}}})})();(function(){var h=Class.PropertyScope;var c=Kekule.ChemWidget;var f=Kekule.Editor;var b=Kekule.Widget.HtmlClassNames;var g=Kekule.ChemWidget.HtmlClassNames;var d=Kekule.ChemWidget.ComponentWidgetNames;var e=Kekule.ChemWidgetTexts;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{COMPOSER:"K-Chem-Composer",COMPOSER_EDITOR_STAGE:"K-Chem-Composer-Editor-Stage",COMPOSER_ADV_PANEL:"K-Chem-Composer-Adv-Panel",COMPOSER_TOOLBAR:"K-Chem-Composer-Toolbar",COMPOSER_COMMON_TOOLBAR:"K-Chem-Composer-Common-Toolbar",COMPOSER_CHEM_TOOLBAR:"K-Chem-Composer-Chem-Toolbar",COMPOSER_ASSOC_TOOLBAR:"K-Chem-Composer-Assoc-Toolbar",COMPOSER_STYLE_TOOLBAR:"K-Chem-Composer-Style-Toolbar",COMPOSER_FONTNAME_BOX:"K-Chem-Composer-FontName-Box",COMPOSER_FONTSIZE_BOX:"K-Chem-Composer-FontSize-Box",COMPOSER_COLOR_BOX:"K-Chem-Composer-Color-Box",COMPOSER_TEXTDIRECTION_BUTTON:"K-Chem-Composer-TextDirection-Button",COMPOSER_TEXTDIRECTION_BUTTON_DEFAULT:"K-Chem-Composer-TextDirection-Button-Default",COMPOSER_TEXTDIRECTION_BUTTON_LTR:"K-Chem-Composer-TextDirection-Button-LTR",COMPOSER_TEXTDIRECTION_BUTTON_RTL:"K-Chem-Composer-TextDirection-Button-RTL",COMPOSER_TEXTDIRECTION_BUTTON_TTB:"K-Chem-Composer-TextDirection-Button-TTB",COMPOSER_TEXTDIRECTION_BUTTON_BTT:"K-Chem-Composer-TextDirection-Button-BTT",COMPOSER_TEXTALIGN_BUTTON:"K-Chem-Composer-TextAlign-Button",COMPOSER_TEXTALIGN_BUTTON_HORIZONTAL:"K-Chem-Composer-TextAlign-Button-Horizontal",COMPOSER_TEXTALIGN_BUTTON_VERTICAL:"K-Chem-Composer-TextAlign-Button-Vertical",COMPOSER_TEXTALIGN_BUTTON_DEFAULT:"K-Chem-Composer-TextAlign-Button",COMPOSER_TEXTALIGN_BUTTON_LEADING:"K-Chem-Composer-TextAlign-Button-Leading",COMPOSER_TEXTALIGN_BUTTON_TRAILING:"K-Chem-Composer-TextAlign-Button-Trailing",COMPOSER_TEXTALIGN_BUTTON_CENTER:"K-Chem-Composer-TextAlign-Button-Center",COMPOSER_TEXTALIGN_BUTTON_LEFT:"K-Chem-Composer-TextAlign-Button-Left",COMPOSER_TEXTALIGN_BUTTON_RIGHT:"K-Chem-Composer-TextAlign-Right",COMPOSER_TEXTALIGN_BUTTON_TOP:"K-Chem-Composer-TextAlign-Top",COMPOSER_TEXTALIGN_BUTTON_BOTTOM:"K-Chem-Composer-TextAlign-Bottom",COMPOSER_DIALOG:"K-Chem-ComposerDialog"});Kekule.Editor.ComposerStyleToolbar=Class.create(Kekule.Widget.Toolbar,{CLASS_NAME:"Kekule.Editor.ComposerStyleToolbar",ATOM_COLOR_SPECIAL_VALUE_INFO:{value:"(use atom custom color)",text:"Atom",className:b.COLORPICKER_SPEC_COLOR_MIXED},LINKED_VALUE_FIELD:"__$value__",initialize:function($super,i){$super(i);this.setPropStoreFieldValue("composer",i);this.createChildWidgets();this.appendToWidget(i);this._relatedPropNames=(i.getCoordMode()===Kekule.CoordMode.COORD3D)?["renderOptions","render3DOptions"]:["renderOptions"];this.getEditor().addEventListener("selectionChange",function(j){if(!this._isApplying){this.updateStyleValues()}},this);this.getEditor().addEventListener("editObjChanged",function(j){var k=j.propNames;if(!k||!k.length||!Kekule.ArrayUtils.intersect(this._relatedPropNames,k).length){return}if(!this._isApplying){this.updateStyleValues()}},this);this._isApplying=false},doFinalize:function($super){this.clearWidgets();$super()},initProperties:function(){this.defineProp("composer",{dataType:"Kekule.Editor.Composer",serializable:false,setter:null});this.defineProp("fontNameBox",{dataType:"Kekule.Widget.ComboBox",serializable:false,setter:null});this.defineProp("fontSizeBox",{dataType:"Kekule.Widget.ComboBox",serializable:false,setter:null});this.defineProp("colorBox",{dataType:"Kekule.Widget.ColorDropButton",serializable:false,setter:null});this.defineProp("textDirectionButtonSet",{dataType:"Kekule.Widget.CompactButtonSet",serializable:false,setter:null});this.defineProp("textHorizontalAlignButtonSet",{dataType:"Kekule.Widget.CompactButtonSet",serializable:false,setter:null});this.defineProp("textVerticalAlignButtonSet",{dataType:"Kekule.Widget.CompactButtonSet",serializable:false,setter:null});this.defineProp("fontName",{dataType:DataType.STRING,serializable:false,getter:function(){return this.getFontNameBox()?this.getFontNameBox().getValue():null},setter:function(i){if(this.getFontNameBox()){this.getFontNameBox().setValue(i)}}});this.defineProp("fontSize",{dataType:DataType.NUMBER,serializable:false,getter:function(){return this.getFontSizeBox()?parseFloat(this.getFontSizeBox().getValue()):null},setter:function(i){if(this.getFontSizeBox()){this.getFontSizeBox().setValue(i)}}});this.defineProp("color",{dataType:DataType.STRING,serializable:false,getter:function(){return this.getColorBox()?this.getColorBox().getValue():undefined},setter:function(i){if(this.getColorBox()){this.getColorBox().setValue(i)}}});this.defineProp("textDirection",{dataType:DataType.INT,serializable:false,getter:function(){return this._getButtonSetLinkedValue(this.getTextDirectionButtonSet())},setter:function(i){this._setButtonSetLinkedValue(this.getTextDirectionButtonSet(),i)}});this.defineProp("textHorizontalAlign",{dataType:DataType.INT,serializable:false,getter:function(){return this._getButtonSetLinkedValue(this.getTextHorizontalAlignButtonSet())},setter:function(i){this._setButtonSetLinkedValue(this.getTextHorizontalAlignButtonSet(),i)}});this.defineProp("textVerticalAlign",{dataType:DataType.INT,serializable:false,getter:function(){return this._getButtonSetLinkedValue(this.getTextVerticalAlignButtonSet())},setter:function(i){this._setButtonSetLinkedValue(this.getTextVerticalAlignButtonSet(),i)}});this.defineProp("componentNames",{dataType:DataType.ARRAY,serializable:false,getter:function(){var i=this.getPropStoreFieldValue("componentNames");if(!i){i=this.getDefaultComponentNames();this.setPropStoreFieldValue("componentNames",i)}return i},setter:function(i){this.setPropStoreFieldValue("componentNames",i);this.recreateComponents()}})},initPropValues:function($super){$super();this.setShowGlyph(true)},removeWidget:function($super,j,i){if(j===this.getFontNameBox()){this.setPropStoreFieldValue("fontNameBox",null)}if(j===this.getFontSizeBox()){this.setPropStoreFieldValue("fontSizeBox",null)}$super(j,i)},doGetWidgetClassName:function($super){var i=$super()+" "+g.COMPOSER_TOOLBAR+" "+g.COMPOSER_STYLE_TOOLBAR;return i},getEditor:function(){return this.getComposer().getEditor()},getEditorConfigs:function(){return this.getEditor().getEditorConfigs()},createChildWidgets:function(o){if(!o){o=this.getComponentNames()}for(var n=0,m=o.length;n<m;++n){var j=o[n];if(j===d.fontName){var s=new Kekule.Widget.ComboBox(this);this.fillFontNameBox(s);s.addClassName(g.COMPOSER_FONTNAME_BOX);s.setHint(e.HINT_FONTNAME);s.addEventListener("valueChange",function(i){this.applyFontName()},this);this.setPropStoreFieldValue("fontNameBox",s)}else{if(j===d.fontSize){s=new Kekule.Widget.ComboBox(this);this.fillFontSizeBox(s);s.addClassName(g.COMPOSER_FONTSIZE_BOX);s.setHint(e.HINT_FONTSIZE);s.addEventListener("valueChange",function(i){this.applyFontSize()},this);this.setPropStoreFieldValue("fontSizeBox",s)}else{if(j===d.color){var q=new Kekule.Widget.ColorDropButton(this);q.setHint(e.HINT_PICK_COLOR);q.setShowText(false);q.setSpecialColors([Kekule.Widget.ColorPicker.SpecialColors.UNSET,this.ATOM_COLOR_SPECIAL_VALUE_INFO]);q.addClassName(g.COMPOSER_COLOR_BOX);q.addEventListener("valueChange",function(i){this.applyColor()},this);this.setPropStoreFieldValue("colorBox",q)}else{if(j===d.textDirection){var r=Kekule.Render.TextDirection;var p=[{value:r.DEFAULT,text:e.CAPTION_TEXT_DIRECTION_DEFAULT,className:g.COMPOSER_TEXTDIRECTION_BUTTON_DEFAULT},{value:r.LTR,text:e.CAPTION_TEXT_DIRECTION_LTR,className:g.COMPOSER_TEXTDIRECTION_BUTTON_LTR},{value:r.RTL,text:e.CAPTION_TEXT_DIRECTION_RTL,className:g.COMPOSER_TEXTDIRECTION_BUTTON_RTL},{value:r.TTB,text:e.CAPTION_TEXT_DIRECTION_TTB,className:g.COMPOSER_TEXTDIRECTION_BUTTON_TTB},{value:r.BTT,text:e.CAPTION_TEXT_DIRECTION_BTT,className:g.COMPOSER_TEXTDIRECTION_BUTTON_BTT}];var k=this._createStyleButtonSet(e.CAPTION_TEXT_DIRECTION,e.HINT_TEXT_DIRECTION,g.COMPOSER_TEXTDIRECTION_BUTTON,p);k.addEventListener("select",function(i){this.applyTextDirection()},this);this.setPropStoreFieldValue("textDirectionButtonSet",k)}else{if(j===d.textAlign){var t=Kekule.Render.TextAlign;var p=[{value:t.DEFAULT,text:e.CAPTION_TEXT_ALIGN_DEFAULT,className:g.COMPOSER_TEXTALIGN_BUTTON_DEFAULT},{value:t.LEADING,text:e.CAPTION_TEXT_ALIGN_LEADING,className:g.COMPOSER_TEXTALIGN_BUTTON_LEADING},{value:t.TRAILING,text:e.CAPTION_TEXT_ALIGN_TRAILING,className:g.COMPOSER_TEXTALIGN_BUTTON_TRAILING},{value:t.CENTER,text:e.CAPTION_TEXT_ALIGN_CENTER,className:g.COMPOSER_TEXTALIGN_BUTTON_CENTER},{value:t.LEFT,text:e.CAPTION_TEXT_ALIGN_LEFT,className:g.COMPOSER_TEXTALIGN_BUTTON_LEFT},{value:t.RIGHT,text:e.CAPTION_TEXT_ALIGN_RIGHT,className:g.COMPOSER_TEXTALIGN_BUTTON_RIGHT}];var k=this._createStyleButtonSet(e.CAPTION_TEXT_HORIZONTAL_ALIGN,e.HINT_TEXT_HORIZONTAL_ALIGN,g.COMPOSER_TEXTALIGN_BUTTON_HORIZONTAL,p);k.addEventListener("select",function(i){this.applyTextHorizontalAlign()},this);this.setPropStoreFieldValue("textHorizontalAlignButtonSet",k);var t=Kekule.Render.TextAlign;var p=[{value:t.DEFAULT,text:e.CAPTION_TEXT_ALIGN_DEFAULT,className:g.COMPOSER_TEXTALIGN_BUTTON_DEFAULT},{value:t.LEADING,text:e.CAPTION_TEXT_ALIGN_LEADING,className:g.COMPOSER_TEXTALIGN_BUTTON_LEADING},{value:t.TRAILING,text:e.CAPTION_TEXT_ALIGN_TRAILING,className:g.COMPOSER_TEXTALIGN_BUTTON_TRAILING},{value:t.CENTER,text:e.CAPTION_TEXT_ALIGN_CENTER,className:g.COMPOSER_TEXTALIGN_BUTTON_CENTER},{value:t.TOP,text:e.CAPTION_TEXT_ALIGN_TOP,className:g.COMPOSER_TEXTALIGN_BUTTON_TOP},{value:t.BOTTOM,text:e.CAPTION_TEXT_ALIGN_BOTTOM,className:g.COMPOSER_TEXTALIGN_BUTTON_BOTTOM}];var k=this._createStyleButtonSet(e.CAPTION_TEXT_ALIGN,e.HINT_TEXT_VERTICAL_ALIGN,g.COMPOSER_TEXTALIGN_BUTTON_VERTICAL,p);k.addEventListener("select",function(i){this.applyTextVerticalAlign()},this);this.setPropStoreFieldValue("textVerticalAlignButtonSet",k)}}}}}}this.updateStyleValues()},_createStyleButtonSet:function(s,o,q,r){var k=new Kekule.Widget.CompactButtonSet(this);k.setText(s);k.setHint(o);k.addClassName(q);k.setShowText(false);k.setShowCompactMark(false);k.setButtonKind(Kekule.Widget.Button.Kinds.DROPDOWN);k.getButtonSet().addClassName(g.COMPOSER_STYLE_TOOLBAR);k.getButtonSet().setShowText(true);if(r){for(var p=0,n=r.length;p<n;++p){var m=r[p];var j=new Kekule.Widget.RadioButton(k,m.text||"");j.setHint(m.hint||"");j.addClassName(m.className);j[this.LINKED_VALUE_FIELD]=m.value;k.append(j,m.selected)}}return k},_getButtonSetLinkedValue:function(i){var j=i?i.getSelected():null;return j?j[this.LINKED_VALUE_FIELD]:undefined},_setButtonSetLinkedValue:function(k,o){if(k){var p=k.getButtonSet();var n=p.getChildWidgets();k.setSelected(null);for(var m=0,j=n.length;m<j;++m){var q=n[m];if(q.hasOwnProperty(this.LINKED_VALUE_FIELD)){if(q[this.LINKED_VALUE_FIELD]==o){k.setSelected(q);break}}}}},getDefaultComponentNames:function(){return[d.fontName,d.fontSize,d.color,d.textDirection,d.textAlign]},recreateComponents:function(){var i=this.getComponentNames();this.clearWidgets();this.createChildWidgets(i)},fillFontSizeBox:function(o){var n=this.getEditorConfigs().getStyleSetterConfigs().getListedFontSizes();var k=[{text:Kekule.ChemWidgetTexts.S_VALUE_DEFAULT,value:undefined}];for(var m=0,j=n.length;m<j;++m){k.push({text:n[m]+" px",value:n[m]})}o.setItems(k)},fillFontNameBox:function(o){var n=this.getEditorConfigs().getStyleSetterConfigs().getListedFontNames();var k=[{text:Kekule.ChemWidgetTexts.S_VALUE_DEFAULT,value:""}];for(var m=0,j=n.length;m<j;++m){k.push({text:n[m],value:n[m]})}o.setItems(k)},applyStyle:function(i,k,l){this._isApplying=true;try{var j=this.getEditor();j.modifyObjectsRenderOptions(i,k,l,true)}finally{this._isApplying=false}},getStyleValue:function(i,k,j){return Kekule.Render.RenderOptionUtils.getCascadeRenderOptionValueOfObjs(i,k,j)},applyStyleToEditorSelection:function(i,j){var k=this.getEditor().getSelection();if(k&&k.length){return this.applyStyle(k,i,j)}},applyFontName:function(j){if(!j){j=this.getEditor().getSelection()}if(j&&j.length){var i=this.getFontName();this.applyStyle(j,{fontFamily:i})}},applyFontSize:function(j){if(!j){j=this.getEditor().getSelection()}if(j&&j.length){var i=this.getFontSize();this.applyStyle(j,{fontSize:i})}},applyColor:function(j){if(!j){j=this.getEditor().getSelection()}if(j&&j.length){var i=this.getColor();if(i===this.ATOM_COLOR_SPECIAL_VALUE_INFO.value){this.applyStyle(j,{useAtomSpecifiedColor:true,color:undefined})}else{if(i==Kekule.Widget.ColorPicker.SpecialColors.UNSET){i=undefined}this.applyStyle(j,{useAtomSpecifiedColor:false,color:i})}}},applyTextDirection:function(j){if(!j){j=this.getEditor().getSelection()}if(j&&j.length){var i=this.getTextDirection();this.applyStyle(j,{charDirection:i})}},applyTextHorizontalAlign:function(j){if(!j){j=this.getEditor().getSelection()}if(j&&j.length){var i=this.getTextHorizontalAlign();this.applyStyle(j,{horizontalAlign:i})}},applyTextVerticalAlign:function(j){if(!j){j=this.getEditor().getSelection()}if(j&&j.length){var i=this.getTextVerticalAlign();this.applyStyle(j,{verticalAlign:i})}},updateStyleValues:function(i){if(!i){i=this.getEditor().getSelection()}if(i&&i.length){this.updateFontName(i);this.updateFontSize(i);this.updateColor(i);this.updateTextDirection(i);this.updateTextHorizontalAlign(i);this.updateTextVerticalAlign(i)}},updateFontName:function(j){if(j&&j.length&&this.getFontNameBox()){var i=this.getStyleValue(j,"fontFamily");this.setFontName(i||"")}},updateFontSize:function(j){if(j&&j.length&&this.getFontSizeBox()){var i=this.getStyleValue(j,"fontSize");this.setFontSize(i||undefined)}},updateColor:function(k){if(k&&k.length&&this.getColorBox()){var i;var j=this.getStyleValue(k,"useAtomSpecifiedColor");var i=this.getStyleValue(k,"color");this.getColorBox().setColorClassName(null);if(i){this.getColorBox().setColorClassName(null)}else{if(j){i=this.ATOM_COLOR_SPECIAL_VALUE_INFO.value;this.getColorBox().setColorClassName(this.ATOM_COLOR_SPECIAL_VALUE_INFO.className)}}this.setColor(i||undefined)}},updateTextDirection:function(j){if(j&&j.length&&this.getTextDirectionButtonSet()){var i=this.getStyleValue(j,"charDirection");this.setTextDirection(i)}},updateTextHorizontalAlign:function(j){if(j&&j.length&&this.getTextHorizontalAlignButtonSet()){var i=this.getStyleValue(j,"horizontalAlign");this.setTextHorizontalAlign(i)}},updateTextVerticalAlign:function(j){if(j&&j.length&&this.getTextVerticalAlignButtonSet()){var i=this.getStyleValue(j,"verticalAlign");this.setTextVerticalAlign(i)}},updateState:function(){var j=this.getEditor();var i=(j&&j.hasSelection());if(this.getFontNameBox()){this.getFontNameBox().setEnabled(i)}if(this.getFontSizeBox()){this.getFontSizeBox().setEnabled(i)}if(this.getColorBox()){this.getColorBox().setEnabled(i)}if(this.getTextDirectionButtonSet()){this.getTextDirectionButtonSet().setEnabled(i)}if(this.getTextHorizontalAlignButtonSet()){this.getTextHorizontalAlignButtonSet().setEnabled(i)}if(this.getTextVerticalAlignButtonSet()){this.getTextVerticalAlignButtonSet().setEnabled(i)}}});Kekule.Editor.Composer=Class.create(Kekule.ChemWidget.AbstractWidget,{CLASS_NAME:"Kekule.Editor.Composer",BINDABLE_TAG_NAMES:["div"],initialize:function($super,i,j){this.updateStyleToolbarStateBind=this.updateStyleToolbarState.bind(this);this.setPropStoreFieldValue("enableStyleToolbar",true);this.setPropStoreFieldValue("editor",j);$super(i);this.setPropStoreFieldValue("editorNexus",new Kekule.Editor.EditorNexus());this.bindEditor();this.createCommonToolbar();this.createChemToolbar();this.uiLayoutChanged()},doFinalize:function($super){var i=this.getCommonBtnGroup();if(i){i.finalize()}var i=this.getChemBtnGroup();if(i){i.finalize()}var j=this.getPropStoreFieldValue("editor");if(j){j.finalize()}this.getEditorNexus().finalize();$super()},initProperties:function(){this.defineProp("editor",{dataType:"Kekule.Editor.BaseEditor",serializable:false,setter:null,getter:function(){var i=this.getPropStoreFieldValue("editor");if(!i){i=this.createDefaultEditor();this.setPropStoreFieldValue("editor",i)}return i}});this.defineProp("showInspector",{dataType:DataType.BOOL,setter:function(i){if(this.getShowInspector()!==i){this.setPropStoreFieldValue("showInspector",i);this.showInspectorChanged()}}});this.defineProp("editorStageElem",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("advPanelElem",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("editorNexus",{dataType:"Kekule.Editor.EditorNexus",serializable:false,setter:null});this.defineProp("objInspector",{dataType:"Kekule.Widget.ObjectInspector",serializable:false,setter:null});this.defineProp("structureTreeView",{dataType:"Kekule.ChemWidget.StructureTreeView",serializable:false,setter:null});this.defineProp("commonBtnGroup",{dataType:"Kekule.Widget.ButtonGroup",serializable:false});this.defineProp("chemBtnGroup",{dataType:"Kekule.Widget.ButtonGroup",serializable:false});this.defineProp("assocBtnGroup",{dataType:"Kekule.Widget.ButtonGroup",serializable:false});this.defineProp("styleToolbar",{dataType:"Kekule.Widget.ButtonGroup",serializable:false,getter:function(){var i=this.getPropStoreFieldValue("styleToolbar");if(!i){if(this.getEnableStyleToolbar()){i=this.createStyleToolbar();this.setPropStoreFieldValue("styleToolbar",i)}}return i}});this.defineProp("styleToolComponentNames",{dataType:DataType.ARRAY,serializable:false,getter:function(){var i=this.getStyleToolbar();return i?i.getComponentNames():null},setter:function(j){var i=this.getStyleToolbar();if(i){i.setComponentNames(j)}return this}});this.defineProp("enableStyleToolbar",{dataType:DataType.BOOL,setter:function(i){this.setPropStoreFieldValue("enableStyleToolbar",i);this.updateStyleToolbarState()}});this.defineProp("commonToolButtons",{dataType:DataType.HASH,serializable:false,getter:function(){var i=this.getPropStoreFieldValue("commonToolButtons");if(!i){i=this.getDefaultCommonToolBarButtons();this.setPropStoreFieldValue("commonToolButtons",i)}return i},setter:function(i){this.setPropStoreFieldValue("commonToolButtons",i);this.updateCommonToolbar()}});this.defineProp("chemToolButtons",{dataType:DataType.HASH,serializable:false,getter:function(){var i=this.getPropStoreFieldValue("chemToolButtons");if(!i){i=this.getDefaultChemToolBarButtons();this.setPropStoreFieldValue("chemToolButtons",i)}return i},setter:function(i){this.setPropStoreFieldValue("chemToolButtons",i);this.updateChemToolbar()}});this.defineProp("styleBarComponents",{dataType:DataType.ARRAY,serializable:false,getter:function(){var i=this.getPropStoreFieldValue("styleBarComponents");if(!i){i=null;this.setPropStoreFieldValue("styleBarComponents",i)}return i},setter:function(i){this.setPropStoreFieldValue("styleBarComponents",i);if(this.getStyleToolbar()){this.getStyleToolbar().setComponentNames(i)}}});this.defineProp("toolButtonNameMapping",{dataType:DataType.HASH,serializable:false,setter:null,getter:function(){var i=this.getPropStoreFieldValue("toolButtonNameMapping");if(!i){i=this._createDefaultToolButtonNameMapping();this.setPropStoreFieldValue("toolButtonNameMapping",i)}return i}});this.defineProp("commonActions",{dataType:"Kekule.ActionList",serializable:false,setter:null,getter:function(){var i=this.getPropStoreFieldValue("commonActions");if(!i){i=new Kekule.ActionList();this.setPropStoreFieldValue("commonActions",i)}return i}});this.defineProp("chemActions",{dataType:"Kekule.ActionList",serializable:false,setter:null,getter:function(){var i=this.getPropStoreFieldValue("chemActions");if(!i){i=new Kekule.ActionList();this.setPropStoreFieldValue("chemActions",i)}return i}});this.defineProp("allowCreateNewChild",{dataType:DataType.BOOL,getter:function(){var i=this.getEditor();return(i&&i.getAllowCreateNewChild)?i.getAllowCreateNewChild():null},setter:function(j){var i=this.getEditor();if(i.setAllowCreateNewChild){i.setAllowCreateNewChild(j)}return this}});this._defineEditorDelegatedProp("chemObj");this._defineEditorDelegatedProp("chemObjLoaded");this._defineEditorDelegatedProp("renderType");this._defineEditorDelegatedProp("renderConfigs");this._defineEditorDelegatedProp("drawOptions");this._defineEditorDelegatedProp("allowCoordBorrow");this._defineEditorDelegatedProp("editorConfigs");this._defineEditorDelegatedProp("operHistory");this._defineEditorDelegatedProp("enableOperHistory");this._defineEditorDelegatedProp("selection");this._defineEditorDelegatedProp("hotTrackedObjs");this._defineEditorDelegatedProp("enableOperContext");this._defineEditorDelegatedProp("enableCreateNewDoc");this._defineEditorDelegatedProp("enableLoadNewFile");this._defineEditorDelegatedProp("initOnNewDoc")},_defineEditorDelegatedProp:function(l,i){if(!i){i=l}var k=ClassEx.getPropInfo(Kekule.Editor.BaseEditor,i);var j=Object.create(k);j.getter=null;j.setter=null;if(k.getter){j.getter=function(){return this.getEditor().getPropValue(i)}}if(k.setter){j.setter=function(m){this.getEditor().setPropValue(i,m)}}return this.defineProp(l,j)},loadPredefinedResDataToProp:function(j,i,l){if(j==="chemObj"){if(l){try{var m=Kekule.IO.loadTypedData(i.data,i.resType,i.resUri);this.setChemObj(m)}catch(k){this.reportException(k)}}else{Kekule.throwException(Kekule.ErrorMsg.CANNOT_LOAD_RES_OF_URI+i.resUri||"")}}},doCreateRootElement:function(j){var i=j.createElement("div");return i},doCreateSubElements:function(l,j){var i=[];var k=l.createElement("div");k.className=g.COMPOSER_EDITOR_STAGE;j.appendChild(k);this.setPropStoreFieldValue("editorStageElem",k);i.push(k);var k=l.createElement("div");k.className=g.COMPOSER_ADV_PANEL;j.appendChild(k);this.setPropStoreFieldValue("advPanelElem",k);i.push(k);return i},doGetWidgetClassName:function($super){var i=$super()+" "+g.COMPOSER;return i},doWidgetShowStateChanged:function($super,i){$super(i);if(i){this.adjustComponentPositions()}},getCoordMode:function(){return this.getEditor().getCoordMode()},isDirty:function(){return this.getEditor().isDirty()},load:function(i){return this.getEditor().load(i)},getExportableClasses:function(){return this.getEditor().getExportableClasses()},exportObj:function(i){return this.getEditor().exportObj(i)},uiLayoutChanged:function(){this.adjustComponentPositions()},adjustComponentPositions:function(){var n=this.getCommonBtnGroup()?this.getCommonBtnGroup().getElement():null;var o=this.getChemBtnGroup()?this.getChemBtnGroup().getElement():null;if(!n||!o){return}if(n){var r=Kekule.HtmlElementUtils.getElemBoundingClientRect(n)}if(o){var k=Kekule.HtmlElementUtils.getElemBoundingClientRect(o)}var j=n.style;j.top="0px";j.left=k.width+"px";j=o.style;j.top=r.height+"px";j.left="0px";var q,m,t,i;var l=this.getCommonBtnGroup().getElement();var p=Kekule.HtmlElementUtils.getElemBoundingClientRect(l);q=p.height;var l=this.getChemBtnGroup().getElement();var p=Kekule.HtmlElementUtils.getElemBoundingClientRect(l);m=p.width;var i=0;if(!this.getShowInspector()){t=0}else{var l=this.getAdvPanelElem();var p=Kekule.HtmlElementUtils.getElemBoundingClientRect(l);t=p.width}var s=this.getEditorStageElem();var j=s.style;j.position="absolute";j.top=q+"px";j.left=m+"px";j.bottom=i+"px";j.right=t+"px";l=this.getAdvPanelElem();j=l.style;j.position="absolute";j.top=q+"px";j.bottom=i+"px"},adjustAssocToolbarPositions:function(){var k=this.getChemBtnGroup().getElement();var i=Kekule.HtmlElementUtils.getElemBoundingClientRect(k);if(this.isAssocToolbarShown()){var j=this.getAssocBtnGroup().getElement();j.style.left=i.width+"px"}if(this.isStyleToolbarShown()){var j=this.getStyleToolbar().getElement();j.style.left=i.width+"px"}},bindEditor:function(l){if(!l){l=this.getEditor()}var j=this;var i=this.getCommonActions();var k=this.getChemActions();this.createIaControllers(l);l.addEventListener("load",function(n){this.updateAllActions();this.updateUiWidgets();var o=this.getChemActions();var m=o.getActionAt(0);if(m){m.execute()}},this);l.addEventListener("operChange",function(m){i.updateAll();this.updateUiWidgets()},this);l.addEventListener("selectionChange",function(m){i.updateAll();this.updateUiWidgets()},this);l.appendToElem(this.getEditorStageElem());this.getEditorNexus().setEditor(l)},createDefaultEditor:function(){var i=new Kekule.Editor.ChemSpaceEditor(this,null,Kekule.Render.RendererType.R2D);i.addClassName(b.DYN_CREATED);return i},createIaControllers:function(o){var n=Kekule.Editor.IaControllerManager.getAvailableControllerClasses(o.getClass());for(var m=0,k=n.length;m<k;++m){var p=n[m];var j=new p(o);o.addIaController(j.getDefId(),j)}},showInspectorChanged:function(){var i=this.getShowInspector();if(i){if(!this.getObjInspector()){this.createAdvControls()}this.showAdvPanel()}else{this.hideAdvPanel()}this.uiLayoutChanged()},createAdvControls:function(i){if(!i){i=this.getAdvPanelElem()}var l=this.getDocument();var j=new Kekule.ChemWidget.StructureTreeView(l);j.setItemInitialExpanded(true);j.appendToElem(i);this.setPropStoreFieldValue("structureTreeView",j);var m=new Kekule.Widget.ObjectInspector(l);m.setShowPropInfoPanel(false);m.appendToElem(i);this.setPropStoreFieldValue("objInspector",m);var k=this.getEditorNexus();k.setObjectInspector(m);k.setStructureTreeView(j)},showAdvPanel:function(){this.getAdvPanelElem().style.display="block"},hideAdvPanel:function(){this.getAdvPanelElem().style.display="none"},_createDefaultToolButtonNameMapping:function(){var i={};i[d.newDoc]=f.ActionEditorNewDoc;i[d.loadFile]=c.ActionDisplayerLoadFile;i[d.loadData]=c.ActionDisplayerLoadData;i[d.saveFile]=c.ActionDisplayerSaveFile;i[d.zoomIn]=c.ActionDisplayerZoomIn;i[d.zoomOut]=c.ActionDisplayerZoomOut;i[d.reset]=c.ActionDisplayerReset;i[d.config]=Kekule.Widget.ActionOpenConfigWidget;i[d.undo]=f.ActionEditorUndo;i[d.redo]=f.ActionEditorRedo;i[d.cloneSelection]=f.ActionCloneSelection;i[d.copy]=f.ActionCopySelection;i[d.cut]=f.ActionCutSelection;i[d.paste]=f.ActionPaste;i[d.manipulate]=f.ActionComposerSetManipulateController;i[d.erase]=f.ActionComposerSetEraserController;i[d.molAtom]=f.ActionComposerSetAtomController;i[d.molBond]=f.ActionComposerSetBondController;i[d.molCharge]=f.ActionComposerSetNodeChargeController;i[d.textBlock]=f.ActionComposerSetTextBlockController;i[d.molRing]=f.ActionComposerSetRepositoryRingController;i[d.glyph]=f.ActionComposerSetRepositoryGlyphController;i[d.objInspector]=f.ActionComposerToggleInspector;return i},getDefaultCommonToolBarButtons:function(){var i=[d.newDoc,d.loadData,d.saveFile,d.undo,d.redo,d.copy,d.cut,d.paste,d.zoomIn,d.zoomOut,d.reset,d.config,d.objInspector];return i},getDefaultChemToolBarButtons:function(){var i=[d.manipulate,d.erase,d.molBond,d.molAtom,d.molRing,d.molCharge,d.glyph,d.textBlock];return i},getToolButtonActionClass:function(i){return this.getToolButtonNameMapping()[i]},_getActionTargetWidget:function(i){if(ClassEx.isOrIsDescendantOf(i,Kekule.Editor.ActionOnComposer)||ClassEx.isOrIsDescendantOf(i,Kekule.Widget.ActionOpenConfigWidget)){return this}else{return this.getEditor()}},createToolButton:function(p,n,l,o){var q=null;var m=this.getToolButtonActionClass(p);if(m){var i=(p===d.objInspector)?Kekule.Widget.CheckButton:(!!o)?Kekule.Widget.RadioButton:Kekule.Widget.Button;q=new i(n);var j=this._getActionTargetWidget(m);var k=new m(j);if(o){k.setCheckGroup(o)}l.add(k);q.setAction(k)}return q},createInnerToolbar:function(){var i=new Kekule.Widget.ButtonGroup(this);i.addClassName(g.COMPOSER_TOOLBAR);i.addClassName(g.INNER_TOOLBAR);i.addClassName(b.DYN_CREATED);i.setShowText(false);i.doSetShowGlyph(true);i.appendToElem(this.getElement());return i},createCommonToolbar:function(){var q=this.createInnerToolbar();q.addClassName(g.COMPOSER_COMMON_TOOLBAR);var p=this.getCommonToolButtons();var r=this.getCommonActions();var o=this.getEditor();r.clear();for(var n=0,j=p.length;n<j;++n){var k=p[n];var m=this.createToolButton(k,q,r)}this.setCommonBtnGroup(q);q.addClassName(b.DYN_CREATED);this.adjustComponentPositions();return q},updateCommonToolbar:function(){var i=this.getCommonBtnGroup();if(i){i.finalize()}this.createCommonToolbar()},createChemToolbar:function(){var q=this.createInnerToolbar();q.addClassName(g.COMPOSER_CHEM_TOOLBAR);q.setLayout(Kekule.Widget.Layout.VERTICAL);var p=this.getChemToolButtons();var r=this.getChemActions();r.clear();var o="chemTools";for(var n=0,j=p.length;n<j;++n){var k=p[n];var m=this.createToolButton(k,q,r,o)}this.setChemBtnGroup(q);q.addClassName(b.DYN_CREATED);this.adjustComponentPositions();return q},updateChemToolbar:function(){var i=this.getChemBtnGroup();if(i){i.finalize()}this.createChemToolbar()},createAssocToolbar:function(){var i=this.createInnerToolbar();i.addClassName(g.COMPOSER_ASSOC_TOOLBAR);this.setAssocBtnGroup(i);this.adjustAssocToolbarPositions();i.addClassName(b.DYN_CREATED);return i},showAssocToolbar:function(){var j=this.getAssocBtnGroup();if(!j){j=this.createAssocToolbar()}var i=this;j.show(null,function(){i.uiLayoutChanged();setTimeout(i.updateStyleToolbarStateBind,0)});return this},hideAssocToolbar:function(){var j=this.getAssocBtnGroup();if(j){var i=this;j.hide(null,function(){i.uiLayoutChanged();setTimeout(i.updateStyleToolbarStateBind,0)})}return this},isAssocToolbarShown:function(){var i=this.getAssocBtnGroup();return i&&i.isShown()},bindAssocActions:function(r){var o=this.getAssocBtnGroup();if(!o){o=this.createAssocToolbar()}o.clearWidgets();for(var m=0,j=r.getActionCount();m<j;++m){var p=r.getActionAt(m);var n=p.getCheckGroup();var q=(!!n)?Kekule.Widget.RadioButton:Kekule.Widget.Button;var k=new q(o);k.setAction(p)}},createStyleToolbar:function(){if(this.getEnableStyleToolbar()){var i=new Kekule.Editor.ComposerStyleToolbar(this);i.setComponentNames(this.getStyleBarComponents());this.setStyleToolbar(i);this.adjustAssocToolbarPositions();this.updateStyleToolbarState();return i}else{return null}},showStyleToolbar:function(){if(this.getEnableStyleToolbar()){var j=this.getStyleToolbar();if(!j.isShown()){var i=this;j.show(null,function(){i.uiLayoutChanged()})}}return this},hideStyleToolbar:function(){var j=this.getPropStoreFieldValue("styleToolbar");if(j){if(j.isShown()){var i=this;j.hide(null,function(){i.uiLayoutChanged()})}}return this},isStyleToolbarShown:function(){var i=this.getPropStoreFieldValue("styleToolbar");return(i&&i.isShown())},needShowStyleToolbar:function(){var i=this.getEditor();return i&&i.hasSelection()&&(!this.isAssocToolbarShown())},updateStyleToolbarState:function(){if(this.getEnableStyleToolbar()&&this.needShowStyleToolbar()){this.showStyleToolbar();this.getStyleToolbar().updateState()}else{this.hideStyleToolbar()}},updateAllActions:function(){this.getCommonActions().updateAll();this.getChemActions().updateAll()},updateUiWidgets:function(){this.updateStyleToolbarState()},createConfigurator:function($super){var i=$super();i.addEventListener("configChange",function(j){this.getEditor().repaint()},this);return i}});Kekule.Editor.Composer.Settings=Class.create(Kekule.Widget.BaseWidget.Settings,{CLASS_NAME:"Kekule.Editor.Composer.Settings",initialize:function($super,i){$super(i)},initProperties:function(){this.defineDelegatedProps(["enableCreateNewDoc","enableLoadNewFile","initOnNewDoc","enableOperHistory","allowCreateNewChild","enableStyleToolbar"])}});Kekule.Editor.Composer.Configurator=Class.create(Kekule.Widget.Configurator,{CLASS_NAME:"Kekule.Editor.Composer.Configurator",TAB_BTN_DATA_FIELD:"__$data__",initialize:function($super,i){$super(i)},initPropValues:function($super){$super();this.setLayout(Kekule.Widget.Layout.HORIZONTAL)},getCategoryInfos:function($super){var x=$super();var m=this.getComposer();var u=m.getEditor();var q=[u.getDisplayerConfigs(),u.getRenderConfigs()];for(var r=0,p=q.length;r<p;++r){var n=q[r];var w=n.getPropListOfScopes([Class.PropertyScope.PUBLISHED]);for(var t=0,o=w.getLength();t<o;++t){var v=w.getPropInfoAt(t);var s=n.getPropValue(v.name);if(s){x.push({obj:s,name:v.name,title:v.title,description:v.description})}}}return x},getComposer:function(){return this.getWidget()},getEditor:function(){return this.getComposer().getEditor()}});var a=Kekule.ObjPropSettingManager;a.register("Kekule.Editor.Composer.fullFunc",{enableStyleToolbar:true,enableOperHistor:true,enableLoadNewFile:true,enableCreateNewDoc:true,allowCreateNewChild:true,commonToolButtons:null,chemToolButtons:null,styleToolComponentNames:null});a.register("Kekule.Editor.Composer.molOnly",{enableStyleToolbar:true,enableOperHistor:true,enableLoadNewFile:true,enableCreateNewDoc:true,allowCreateNewChild:true,commonToolButtons:null,chemToolButtons:[d.manipulate,d.erase,d.molBond,d.molAtom,d.molRing,d.molCharge],styleToolComponentNames:null});a.register("Kekule.Editor.Composer.compact",{enableStyleToolbar:false,commonToolButtons:[d.newDoc,d.loadData,d.saveFile,d.undo,d.redo]});a.register("Kekule.Editor.Composer.singleObj",{allowCreateNewChild:false});Kekule.Editor.ComposerDialog=Class.create(Kekule.Widget.Dialog,{CLASS_NAME:"Kekule.Editor.ComposerDialog",initialize:function($super,i,j,k){$super(i,j,k||[Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL])},initProperties:function(){this.defineProp("composer",{dataType:"Kekule.Editor.Composer",serializable:false,setter:null});this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:false,getter:function(){var i=this.getComposer();return i&&i.getChemObj()},setter:function(i){var j=this.getComposer();if(j){j.setChemObj(i)}}})},initPropValues:function($super){$super()},doGetWidgetClassName:function($super){return $super()+" "+g.COMPOSER_DIALOG},doCreateClientContents:function($super,j){$super();var i=this.doCreateComposerWidget();this.setPropStoreFieldValue("composer",i);i.appendToElem(j)},doCreateComposerWidget:function(){var i=new Kekule.Editor.Composer(this);i.addClassName(b.DYN_CREATED);var j=i.getEditor();j.addClassName(b.DYN_CREATED);return i}})})();(function(){var a=Kekule.ArrayUtils;var c=Kekule.ChemWidget.HtmlClassNames;var b=Kekule.ChemWidgetTexts;Kekule.ChemWidget.HtmlClassNames=Object.extend(Kekule.ChemWidget.HtmlClassNames,{ACTION_UNDO:"K-Chem-Undo",ACTION_REDO:"K-Chem-Redo",ACTION_NEWDOC:"K-Chem-NewDoc",ACTION_CLONE_SELECTION:"K-Chem-Clone-Selection",ACTION_COPY:"K-Chem-Copy",ACTION_CUT:"K-Chem-Cut",ACTION_PASTE:"K-Chem-Paste",ACTION_TOGGLE_INSPECTOR:"K-Chem-Toggle-Inspector"});Kekule.Editor.ActionOperUtils={addObjectsToChemSpaceEditor:function(n,k,d){var e=n.getChemSpace&&n.getChemSpace();if(n&&e&&n.canAddNewStandaloneObject&&n.canAddNewStandaloneObject()){n.beginUpdateObject();try{var p=new Kekule.MacroOperation();for(var j=0,g=k.length;j<g;++j){var h=k[j];var f=new Kekule.ChemObjOperation.Add(k[j],e);p.add(f)}p.execute();if(d){for(var j=0,g=k.length;j<g;++j){var h=k[j];var m=n.getObjectScreenCoord(h);var o=Kekule.CoordUtils.add(m,d);n.setObjectScreenCoord(h,o)}}n.pushOperation(p);n.select(k)}finally{n.endUpdateObject()}}}};Kekule.Editor.ActionOnEditor=Class.create(Kekule.ChemWidget.ActionOnDisplayer,{CLASS_NAME:"Kekule.Editor.ActionOnEditor",initialize:function($super,e,d,f){$super(e,d,f)},doUpdate:function(){var d=this.getDisplayer();this.setEnabled(d&&d.getChemObj()&&d.getChemObjLoaded()&&d.getEnabled())},getEditor:function(){var d=this.getDisplayer();return(d instanceof Kekule.Editor.BaseEditor)?d:null}});Kekule.Editor.ActionEditorUndo=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionEditorUndo",HTML_CLASSNAME:c.ACTION_UNDO,initialize:function($super,d){$super(d,b.CAPTION_UNDO,b.HINT_UNDO)},doUpdate:function($super){$super();if(this.getEnabled()){this.setEnabled(this.getEditor().canUndo())}},doExecute:function(){var d=this.getEditor();if(d){d.undo()}}});Kekule.Editor.ActionEditorRedo=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionEditorRedo",HTML_CLASSNAME:c.ACTION_REDO,initialize:function($super,d){$super(d,b.CAPTION_REDO,b.HINT_REDO)},doUpdate:function($super){$super();if(this.getEnabled()){this.setEnabled(this.getEditor().canRedo())}},doExecute:function(){var d=this.getEditor();if(d){d.redo()}}});Kekule.Editor.ActionEditorNewDoc=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionEditorNewDoc",HTML_CLASSNAME:c.ACTION_NEWDOC,initialize:function($super,d){$super(d,b.CAPTION_NEWDOC,b.HINT_NEWDOC)},doUpdate:function(){var d=this.getDisplayer();this.setEnabled(d&&d.getEnabled()&&d.getEnableCreateNewDoc())},doExecute:function(){var d=this.getEditor();if(d){d.newDoc()}}});Kekule.Editor.ActionCloneSelection=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionCloneSelection",HTML_CLASSNAME:c.ACTION_CLONE_SELECTION,initialize:function($super,d){$super(d,b.CAPTION_CLONE_SELECTION,b.HINT_CLONE_SELECTION)},_hasCloneMethod:function(){var d=this.getEditor();return d&&d.cloneSelection},doUpdate:function($super){$super();if(this.getEnabled()){this.setEnabled(this._hasCloneMethod()&&this.getEditor().hasSelection())}this.setDisplayed(this._hasCloneMethod()&&this.getEditor().canCloneObjects())},doExecute:function(){var d=this.getEditor();if(d&&d.getChemSpace){var e=d.getDefaultCloneScreenCoordOffset&&d.getDefaultCloneScreenCoordOffset();var f=d.cloneSelection();Kekule.Editor.ActionOperUtils.addObjectsToChemSpaceEditor(d,f,e)}}});Kekule.Editor.ActionCopySelection=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionCopySelection",HTML_CLASSNAME:c.ACTION_COPY,initialize:function($super,d){$super(d,b.CAPTION_COPY,b.HINT_COPY)},doUpdate:function($super){$super();if(this.getEnabled()){this.setEnabled(this.getEditor().hasSelection())}},doExecute:function(){var d=this.getEditor();var e=d.getChemSpace&&d.getChemSpace();if(d&&e){var f=d.cloneSelection();Kekule.Widget.clipboard.setObjects(Kekule.IO.MimeType.JSON,f)}}});Kekule.Editor.ActionCutSelection=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionCutSelection",HTML_CLASSNAME:c.ACTION_CUT,initialize:function($super,d){$super(d,b.CAPTION_CUT,b.HINT_CUT)},doUpdate:function($super){$super();if(this.getEnabled()){this.setEnabled(this.getEditor().hasSelection())}},doExecute:function(){var e=this.getEditor();var f=e.getChemSpace&&e.getChemSpace();if(e&&f){var g=e.cloneSelection();Kekule.Widget.clipboard.setObjects(Kekule.IO.MimeType.JSON,g);var d=e.getIaController("BasicMolEraserIaController");if(d){d.removeSelection()}}}});Kekule.Editor.ActionPaste=Class.create(Kekule.Editor.ActionOnEditor,{CLASS_NAME:"Kekule.Editor.ActionPaste",HTML_CLASSNAME:c.ACTION_PASTE,initialize:function($super,d){$super(d,b.CAPTION_PASTE,b.HINT_PASTE);Kekule.Widget.clipboard.addEventListener("setData",this._reactClipboardChange,this)},finalize:function($super){Kekule.Widget.clipboard.removeEventListener("setData",this._reactClipboardChange,this);$super()},_reactClipboardChange:function(){this.update()},doUpdate:function($super){$super();if(this.getEnabled()){this.setEnabled(Kekule.Widget.clipboard.hasData(Kekule.IO.MimeType.JSON)&&this.getEditor().canAddNewStandaloneObject())}},getObjsCenterScreenCoord:function(j,m){var f=Kekule.BoxUtils;var p=Kekule.CoordUtils;var d=null;for(var g=0,e=m.length;g<e;++g){var h=Kekule.Render.ObjUtils.getContainerBox(m[g],j.getCoordMode(),j.getAllowCoordBorrow());if(!d){d=h}else{d=f.getContainerBox(h,d)}}var k=f.getMinMaxCoords(d);var o={min:j.objCoordToScreen(k.min),max:j.objCoordToScreen(k.max)};var n=p.add(o.min,o.max);var n=p.divide(n,2);return n},doExecute:function(){var g=this.getEditor();if(g&&g.getChemSpace){var j=Kekule.Widget.clipboard.getObjects(Kekule.IO.MimeType.JSON);var i=null;var k=g.getSelection();if(k&&k.length){i=g.getDefaultCloneScreenCoordOffset?g.getDefaultCloneScreenCoordOffset():null;var h=a.clone(k);if(h&&h.length&&i){var e=this.getObjsCenterScreenCoord(g,h);var f=this.getObjsCenterScreenCoord(g,j);var d=Kekule.CoordUtils.substract(e,f);i=Kekule.CoordUtils.add(i,d)}}Kekule.Editor.ActionOperUtils.addObjectsToChemSpaceEditor(g,j,i)}}});Kekule.Editor.ActionOnComposer=Class.create(Kekule.Action,{CLASS_NAME:"Kekule.Editor.ActionOnComposer",initialize:function($super,e,d,f){$super();this.setText(d);this.setHint(f);this.setComposer(e)},initProperties:function(){this.defineProp("composer",{dataType:"Kekule.Editor.Composer",serializable:false})},doUpdate:function(){var d=this.getComposer();var e=this.getEditor();this.setEnabled(d&&d.getEnabled()&&e&&e.getChemObj()&&e.getChemObjLoaded()&&e.getEnabled())},getEditor:function(){var d=this.getComposer();return d?d.getEditor():null}});Kekule.Editor.ActionOnComposerAdv=Class.create(Kekule.Editor.ActionOnComposer,{CLASS_NAME:"Kekule.Editor.ActionOnComposerAdv",initialize:function($super,e,d,g){var f=new Kekule.ActionList();f.setOwnActions(true);this.setPropStoreFieldValue("attachedActions",f);$super(e,d,g)},finalize:function($super){this.getAttachedActions().finalize();$super()},initProperties:function(){this.defineProp("attachedActions",{dataType:"Kekule.ActionList",serializable:false,setter:null});this.defineProp("defaultAttachedAction",{dataType:"Kekule.Action",serializable:false})},checkedChanged:function($super){$super();var e=this.getChecked();if(this.hasAttachedActions()){var d=this.getComposer();if(d){if(e){d.bindAssocActions(this.getAttachedActions());d.showAssocToolbar();var f=this.getDefaultAttachedAction();if(f){if(f.getCheckGroup()&&!this.getAttachedActions().hasActionChecked(f.getCheckGroup())){f.execute()}}}else{d.hideAssocToolbar()}}}},hasAttachedActions:function(){return !!this.getAttachedActions().getActionCount()},addAttachedActions:function(e,d){this.getAttachedActions().add(e);if(d){this.setDefaultAttachedAction(e)}return this},removeAttachedActions:function(d){if(this.getDefaultAttachedAction()===d){this.setDefaultAttachedAction(null)}this.getAttachedActions().remove(d);return this},clearAttachedActions:function(){this.setDefaultAttachedAction(null);var d=this.getAttachedActions();d.clear()},doExecute:function(){},update:function($super){$super();this.getAttachedActions().updateAll()}});Kekule.Editor.ActionComposerToggleInspector=Class.create(Kekule.Editor.ActionOnComposer,{CLASS_NAME:"Kekule.Editor.ActionComposerToggleInspector",HTML_CLASSNAME:c.ACTION_TOGGLE_INSPECTOR,initialize:function($super,d){$super(d,b.CAPTION_TOGGLE_INSPECTOR,b.HINT_TOGGLE_INSPECTOR)},doUpdate:function(){var d=this.getComposer();if(d){this.setChecked(d.getShowInspector())}},doExecute:function(){var d=this.getComposer();if(d){this.setChecked(!this.getChecked());d.setShowInspector(this.getChecked())}}});Kekule.Editor.ActionComposerSetIaController=Class.create(Kekule.Editor.ActionOnComposerAdv,{CLASS_NAME:"Kekule.Editor.ActionComposerSetIaController",initialize:function($super,e,d,g,f){$super(e,d,g);this.setPropStoreFieldValue("iaControllerId",f)},initProperties:function(){this.defineProp("iaControllerId",{dataType:DataType.STRING,serializable:false,setter:null})},doExecute:function(){this.getEditor().setActiveIaControllerId(this.getIaControllerId())}});Kekule.Editor.createComposerIaControllerActionClass=function(k,l,g,j,i,f,d,e){if(!i){i=j}if(!i.startsWith(Kekule.ChemWidget.HtmlClassNames.PREFIX)){i=Kekule.ChemWidget.HtmlClassNames.PREFIX+i}var h={CLASS_NAME:k,HTML_CLASSNAME:i,initialize:function($super,m){$super(m,l,g,j);if(this.initAttachedActions){this.initAttachedActions()}}};if(f){h.doExecute=function($super){var n=this.getEditor();var m=n.getIaController(j);if(m){m.setPropValues(f)}}}if(d){h.initAttachedActions=function(){var n=this.getComposer();var p=this.getClassName();for(var o=0,m=d.length;o<m;++o){var q=new d[o](n);q.setCheckGroup(p);this.addAttachedActions(q,o===0)}}}if(e){h=Object.extend(h,e)}return Class.create(Kekule.Editor.ActionComposerSetIaController,h)};Kekule.Editor.ActionComposerSetManipulateController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetManipulateController",Kekule.ChemWidgetTexts.CAPTION_MANIPULATE,Kekule.ChemWidgetTexts.HINT_MANIPULATE,"BasicMolManipulationIaController",null,null);Kekule.Editor.ActionComposerSetEraserController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetEraserController",Kekule.ChemWidgetTexts.CAPTION_ERASE,Kekule.ChemWidgetTexts.HINT_ERASE,"BasicMolEraserIaController",null,null,null,{doExecute:function($super){$super();var d=this.getEditor();if(d.hasSelection()){d.getActiveIaController().removeSelection()}}});Kekule.Editor.ActionComposerSetBondControllerSingle=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondControllerSingle",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND_SINGLE,Kekule.ChemWidgetTexts.HINT_MOL_BOND_SINGLE,"MolBondIaController","MolBondIaController-Single",{bondType:Kekule.BondType.COVALENT,bondOrder:Kekule.BondOrder.SINGLE,bondStereo:Kekule.BondStereo.NONE});Kekule.Editor.ActionComposerSetBondControllerDouble=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondControllerDouble",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND_DOUBLE,Kekule.ChemWidgetTexts.HINT_MOL_BOND_DOUBLE,"MolBondIaController","MolBondIaController-Double",{bondType:Kekule.BondType.COVALENT,bondOrder:Kekule.BondOrder.DOUBLE,bondStereo:Kekule.BondStereo.NONE});Kekule.Editor.ActionComposerSetBondControllerTriple=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondControllerTriple",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND_TRIPLE,Kekule.ChemWidgetTexts.HINT_MOL_BOND_TRIPLE,"MolBondIaController","MolBondIaController-Triple",{bondType:Kekule.BondType.COVALENT,bondOrder:Kekule.BondOrder.TRIPLE,bondStereo:Kekule.BondStereo.NONE});Kekule.Editor.ActionComposerSetBondControllerWedgeUp=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondControllerWedgeUp",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND_WEDGEUP,Kekule.ChemWidgetTexts.HINT_MOL_BOND_WEDGEUP,"MolBondIaController","MolBondIaController-WedgeUp",{bondType:Kekule.BondType.COVALENT,bondOrder:Kekule.BondOrder.SINGLE,bondStereo:Kekule.BondStereo.UP});Kekule.Editor.ActionComposerSetBondControllerWedgeDown=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondControllerWedgeDown",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND_WEDGEDOWN,Kekule.ChemWidgetTexts.HINT_MOL_BOND_WEDGEDOWN,"MolBondIaController","MolBondIaController-WedgeDown",{bondType:Kekule.BondType.COVALENT,bondOrder:Kekule.BondOrder.SINGLE,bondStereo:Kekule.BondStereo.DOWN});Kekule.Editor.ActionComposerSetBondControllerWedgeUpOrDown=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondControllerWedgeUpOrDown",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND_WAVY,Kekule.ChemWidgetTexts.HINT_MOL_BOND_WAVY,"MolBondIaController","MolBondIaController-WedgeUpOrDown",{bondType:Kekule.BondType.COVALENT,bondOrder:Kekule.BondOrder.SINGLE,bondStereo:Kekule.BondStereo.UP_OR_DOWN});Kekule.Editor.ActionComposerSetBondController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetBondController",Kekule.ChemWidgetTexts.CAPTION_MOL_BOND,Kekule.ChemWidgetTexts.HINT_MOL_BOND,"MolBondIaController",null,null,[Kekule.Editor.ActionComposerSetBondControllerSingle,Kekule.Editor.ActionComposerSetBondControllerDouble,Kekule.Editor.ActionComposerSetBondControllerTriple,Kekule.Editor.ActionComposerSetBondControllerWedgeUp,Kekule.Editor.ActionComposerSetBondControllerWedgeDown,Kekule.Editor.ActionComposerSetBondControllerWedgeUpOrDown]);Kekule.Editor.ActionComposerSetAtomController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetAtomController",Kekule.ChemWidgetTexts.CAPTION_MOL_ATOM,Kekule.ChemWidgetTexts.HINT_MOL_ATOM,"MolAtomIaController",null,null);Kekule.Editor.ActionComposerSetNodeChargeControllerClear=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeControllerClear",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE_CLEAR,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE_CLEAR,"MolNodeChargeIaController","MolNodeChargeIaController-Clear",{charge:0,chargeInc:0,radical:Kekule.RadicalOrder.NONE});Kekule.Editor.ActionComposerSetNodeChargeControllerPositive=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeControllerPositive",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE_POSITIVE,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE_POSITIVE,"MolNodeChargeIaController","MolNodeChargeIaController-Positive",{charge:null,chargeInc:1});Kekule.Editor.ActionComposerSetNodeChargeControllerNegative=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeControllerNegative",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE_NEGATIVE,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE_NEGATIVE,"MolNodeChargeIaController","MolNodeChargeIaController-Negative",{charge:null,chargeInc:-1});Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalSinglet=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalSinglet",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE_SINGLET,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE_SINGLET,"MolNodeChargeIaController","MolNodeChargeIaController-Singlet",{charge:null,chargeInc:0,radical:Kekule.RadicalOrder.SINGLET});Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalTriplet=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalTriplet",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE_TRIPLET,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE_TRIPLET,"MolNodeChargeIaController","MolNodeChargeIaController-Triplet",{charge:null,chargeInc:0,radical:Kekule.RadicalOrder.TRIPLET});Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalDoublet=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalDoublet",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE_DOUBLET,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE_DOUBLET,"MolNodeChargeIaController","MolNodeChargeIaController-Doublet",{charge:null,chargeInc:0,radical:Kekule.RadicalOrder.DOUBLET});Kekule.Editor.ActionComposerSetNodeChargeController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetNodeChargeController",Kekule.ChemWidgetTexts.CAPTION_MOL_CHARGE,Kekule.ChemWidgetTexts.HINT_MOL_CHARGE,"MolNodeChargeIaController",null,null,[Kekule.Editor.ActionComposerSetNodeChargeControllerClear,Kekule.Editor.ActionComposerSetNodeChargeControllerPositive,Kekule.Editor.ActionComposerSetNodeChargeControllerNegative,Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalSinglet,Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalTriplet,Kekule.Editor.ActionComposerSetNodeChargeControllerRadicalDoublet]);Kekule.Editor.ActionComposerSetTextBlockController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetTextBlockController",Kekule.ChemWidgetTexts.CAPTION_TEXT_BLOCK,Kekule.ChemWidgetTexts.HINT_TEXT_BLOCK,"TextBlockIaController",null,null);Kekule.Editor.ActionComposerSetRepositoryRing3Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRing3Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_3,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_3,"MolRingIaController","MolRingIaController-3",{ringAtomCount:3,isAromatic:false});Kekule.Editor.ActionComposerSetRepositoryRing4Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRing4Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_4,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_4,"MolRingIaController","MolRingIaController-4",{ringAtomCount:4,isAromatic:false});Kekule.Editor.ActionComposerSetRepositoryRing5Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRing5Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_5,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_5,"MolRingIaController","MolRingIaController-5",{ringAtomCount:5,isAromatic:false});Kekule.Editor.ActionComposerSetRepositoryRing6Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRing6Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_6,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_6,"MolRingIaController","MolRingIaController-6",{ringAtomCount:6,isAromatic:false});Kekule.Editor.ActionComposerSetRepositoryRing7Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRing7Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_7,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_7,"MolRingIaController","MolRingIaController-7",{ringAtomCount:7,isAromatic:false});Kekule.Editor.ActionComposerSetRepositoryRing8Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRing8Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_8,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_8,"MolRingIaController","MolRingIaController-8",{ringAtomCount:8,isAromatic:false});Kekule.Editor.ActionComposerSetRepositoryRingAr6Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRingAr6Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_AR_6,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_AR_6,"MolRingIaController","MolRingIaController-Ar-6",{ringAtomCount:6,isAromatic:true});Kekule.Editor.ActionComposerSetRepositoryRingAr5Controller=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRingAr5Controller",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING_AR_5,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING_AR_5,"MolRingIaController","MolRingIaController-Ar-5",{ringAtomCount:5,isAromatic:true});Kekule.Editor.ActionComposerSetRepositoryRingController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryRingController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_RING,Kekule.ChemWidgetTexts.HINT_REPOSITORY_RING,"MolRingIaController",null,null,[Kekule.Editor.ActionComposerSetRepositoryRing3Controller,Kekule.Editor.ActionComposerSetRepositoryRing4Controller,Kekule.Editor.ActionComposerSetRepositoryRing5Controller,Kekule.Editor.ActionComposerSetRepositoryRing6Controller,Kekule.Editor.ActionComposerSetRepositoryRing7Controller,Kekule.Editor.ActionComposerSetRepositoryRing8Controller,Kekule.Editor.ActionComposerSetRepositoryRingAr6Controller,Kekule.Editor.ActionComposerSetRepositoryRingAr5Controller]);Kekule.Editor.ActionComposerSetRepositoryPathLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathGlyphLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_LINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_LINE,"ArrowLineIaController","ArrowLineIaController-Line",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:null,lineLength:1.5});Kekule.Editor.ActionComposerSetRepositoryPathOpenArrowLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathOpenArrowLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_OPEN_ARROW_LINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_OPEN_ARROW_LINE,"ArrowLineIaController","ArrowLineIaController-OpenArrowLine",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:{endArrowType:Kekule.Glyph.ArrowType.OPEN,endArrowWidth:0.25,endArrowLength:0.25,lineLength:1.5}});Kekule.Editor.ActionComposerSetRepositoryPathTriangleArrowLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathTriangleArrowLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_TRIANGLE_ARROW_LINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_TRIANGLE_ARROW_LINE,"ArrowLineIaController","ArrowLineIaController-TriangleArrowLine",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:{endArrowType:Kekule.Glyph.ArrowType.TRIANGLE,endArrowWidth:0.25,endArrowLength:0.25,lineLength:1.5}});Kekule.Editor.ActionComposerSetRepositoryPathDiOpenArrowLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathDiOpenArrowLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_DI_OPEN_ARROW_LINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_DI_OPEN_ARROW_LINE,"ArrowLineIaController","ArrowLineIaController-DiOpenArrowLine",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:{startArrowType:Kekule.Glyph.ArrowType.OPEN,startArrowWidth:0.25,startArrowLength:0.25,endArrowType:Kekule.Glyph.ArrowType.OPEN,endArrowWidth:0.25,endArrowLength:0.25,lineLength:1.5}});Kekule.Editor.ActionComposerSetRepositoryPathDiTriangleArrowLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathDiTriangleArrowLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_DI_TRIANGLE_ARROW_LINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_DI_TRIANGLE_ARROW_LINE,"ArrowLineIaController","ArrowLineIaController-DiTriangleArrowLine",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:{startArrowType:Kekule.Glyph.ArrowType.TRIANGLE,startArrowWidth:0.25,startArrowLength:0.25,endArrowType:Kekule.Glyph.ArrowType.TRIANGLE,endArrowWidth:0.25,endArrowLength:0.25,lineLength:1.5}});Kekule.Editor.ActionComposerSetRepositoryPathReversibleArrowLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathReversibleArrowLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_REV_ARROW_LINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_REV_ARROW_LINE,"ArrowLineIaController","ArrowLineIaController-ReversibleArrowLine",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:{startArrowType:Kekule.Glyph.ArrowType.OPEN,startArrowSide:Kekule.Glyph.ArrowSide.REVERSED,startArrowWidth:0.25,startArrowLength:0.25,endArrowType:Kekule.Glyph.ArrowType.OPEN,endArrowSide:Kekule.Glyph.ArrowSide.SINGLE,endArrowWidth:0.25,endArrowLength:0.25,lineLength:1.5,lineGap:0.1,lineCount:2}});Kekule.Editor.ActionComposerSetRepositoryPathOpenArrowDblLineController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryPathOpenArrowDblLineController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_GLYPH_OPEN_ARROW_DILINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_GLYPH_OPEN_ARROW_DILINE,"ArrowLineIaController","ArrowLineIaController-OpenArrowDiLine",{glyphClass:Kekule.Glyph.StraightLine,glyphInitialParams:{endArrowType:Kekule.Glyph.ArrowType.OPEN,endArrowWidth:0.25,endArrowLength:0.25,lineLength:1.5,lineGap:0.1,lineCount:2}});Kekule.Editor.ActionComposerSetRepositoryHeatSymbolController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryHeatSymbolController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_HEAT_SYMBOL,Kekule.ChemWidgetTexts.HINT_REPOSITORY_HEAT_SYMBOL,"ArrowLineIaController","ArrowLineIaController-HeatSymbol",{glyphClass:Kekule.Glyph.HeatSymbol,glyphInitialParams:{lineLength:1}});Kekule.Editor.ActionComposerSetRepositoryAddSymbolController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryAddSymbolController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_ADD_SYMBOL,Kekule.ChemWidgetTexts.HINT_REPOSITORY_ADD_SYMBOL,"ArrowLineIaController","ArrowLineIaController-AddSymbol",{glyphClass:Kekule.Glyph.AddSymbol,glyphInitialParams:{lineLength:1}});Kekule.Editor.ActionComposerSetRepositoryGlyphController=Kekule.Editor.createComposerIaControllerActionClass("Kekule.Editor.ActionComposerSetRepositoryGlyphController",Kekule.ChemWidgetTexts.CAPTION_REPOSITORY_ARROWLINE,Kekule.ChemWidgetTexts.HINT_REPOSITORY_ARROWLINE,"ArrowLineIaController",null,null,[Kekule.Editor.ActionComposerSetRepositoryPathOpenArrowLineController,Kekule.Editor.ActionComposerSetRepositoryPathTriangleArrowLineController,Kekule.Editor.ActionComposerSetRepositoryPathDiOpenArrowLineController,Kekule.Editor.ActionComposerSetRepositoryPathDiTriangleArrowLineController,Kekule.Editor.ActionComposerSetRepositoryPathReversibleArrowLineController,Kekule.Editor.ActionComposerSetRepositoryPathOpenArrowDblLineController,Kekule.Editor.ActionComposerSetRepositoryPathLineController,Kekule.Editor.ActionComposerSetRepositoryHeatSymbolController,Kekule.Editor.ActionComposerSetRepositoryAddSymbolController])})();(function(){var a=Kekule.PropertyEditor.EditorAttributes;Kekule.PropertyEditor.ChemIdEditor=Class.create(Kekule.PropertyEditor.SimpleEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemIdEditor",getAttributes:function($super){var b=$super();if(b&a.MULTIOBJS){b=b^a.MULTIOBJS}return b}});Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemIdEditor,null,Kekule.ChemObject,"id");Kekule.PropertyEditor.ChemCoordSizeFieldEditor=Class.create(Kekule.PropertyEditor.SimpleEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemCoordSizeFieldEditor",initProperties:function(){this.defineProp("parentObjects",{dataType:DataType.Object,serializable:false});this.defineProp("parentPropName",{dataType:DataType.STRING,serializable:false})},getCoordFieldValue:function(j,g,h){if(!j.length){return undefined}var e=j[0].getPropValue(g);if(!e){return undefined}var b=e[h];for(var f=1,c=j.length;f<c;++f){var d=j[f].getPropValue(g)[h];if(d!==b){return undefined}}return b},getValue:function($super){var b=this.getParentObjects();var c=this.getParentPropName();if(b&&c){return this.getCoordFieldValue(b,c,this.getPropertyName())}else{return $super()}}});Kekule.PropertyEditor.ChemCoordEditor=Class.create(Kekule.PropertyEditor.ObjectEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemCoordEditor",is3DCoord:function(){var b=this.getPropertyName();return(b.indexOf("3")>=0)},getFieldEditorClass:function(b,c){return Kekule.PropertyEditor.ChemCoordSizeFieldEditor},createFieldEditor:function($super,d,c){var b=$super(d,c);if(b.setParentObjects){b.setParentObjects(this.getObjects())}if(b.setParentPropName){b.setParentPropName(this.getPropertyName())}return b},getFieldValueType:function(b,c){return DataType.FLOAT},getObjFields:function(b){return this.is3DCoord()?["x","y","z"]:["x","y"]},getValueText:function($super){var f=Kekule.Widget.ValueListEditor.ValueDisplayMode;var d=this.getValueTextMode();if(d===f.JSON){return $super()}var g=this.getValue();if(g){var e=this.getObjFields();var j="";for(var c=0,b=e.length;c<b;++c){var h=g[e[c]];if(Kekule.ObjUtils.notUnset(h)){if(!!j){j+=", "}j+=e[c]+": "+h}}return"{"+j+"}"}else{return""}}});Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemCoordEditor,null,Kekule.ChemObject,"coord2D");Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemCoordEditor,null,Kekule.ChemObject,"coord3D");Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemCoordEditor,null,Kekule.ChemObject,"absCoord2D");Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemCoordEditor,null,Kekule.ChemObject,"absCoord3D");Kekule.PropertyEditor.ChemSizeEditor=Class.create(Kekule.PropertyEditor.ObjectEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemSizeEditor",is3DSize:function(){var b=this.getPropertyName();return(b.indexOf("3")>=0)},getFieldEditorClass:function(b,c){return Kekule.PropertyEditor.ChemCoordSizeFieldEditor},createFieldEditor:function($super,d,c){var b=$super(d,c);if(b.setParentObjects){b.setParentObjects(this.getObjects())}if(b.setParentPropName){b.setParentPropName(this.getPropertyName())}return b},getFieldValueType:function(b,c){return DataType.FLOAT},getObjFields:function(b){return this.is3DSize()?["x","y","z"]:["x","y"]},getValueText:function($super){var f=Kekule.Widget.ValueListEditor.ValueDisplayMode;var d=this.getValueTextMode();if(d===f.JSON){return $super()}var g=this.getValue();if(g){var e=this.getObjFields();var j="";for(var c=0,b=e.length;c<b;++c){var h=g[e[c]];if(Kekule.ObjUtils.notUnset(h)){if(!!j){j+=", "}j+=e[c]+": "+h}}return"{"+j+"}"}else{return""}}});Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemSizeEditor,null,Kekule.ChemObject,"size2D");Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemSizeEditor,null,Kekule.ChemObject,"size3D");Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemSizeEditor,null,Kekule.ChemObject,"screenSize");Kekule.PropertyEditor.ChemOptionObjectEditor=Class.create(Kekule.PropertyEditor.ObjectEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemOptionObjectEditor",CHILD_FIELD_INFOS:null,initialize:function($super){$super();this.setAllowEmpty(true)},getObjFieldInfos:function(g){var e=ClassEx.getCommonSuperClass(this.getObjects());var b=[];var h=this.CHILD_FIELD_INFOS;for(var d=0,c=h.length;d<c;++d){var f=h[d];if(!f.targetClass||!e||ClassEx.isOrIsDescendantOf(e,f.targetClass)){b.push(f)}}b.sort(function(j,i){return(j.name>i.name)?1:(j.name<i.name)?-1:0});return b},notifyChildEditorValueChange:function($super,d,c){var b=this.getValue()||this._initialObjValue;b=Object.extend({},b);if(Kekule.ObjUtils.notUnset(c)){b[d]=c}else{delete b[d]}this.setValue(b)}});Kekule.PropertyEditor.ChemRender2DOptionsEditor=Class.create(Kekule.PropertyEditor.ChemOptionObjectEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemRender2DOptionsEditor",CHILD_FIELD_INFOS:[{name:"expanded",dataType:DataType.BOOL,targetClass:Kekule.StructureFragment},{name:"moleculeDisplayType",dataType:DataType.INT,enumSource:Kekule.Render.MoleculeDisplayType,targetClass:Kekule.StructureFragment},{name:"renderType",dataType:DataType.INT,enumSource:Kekule.Render.BondRenderType,targetClass:Kekule.ChemStructureConnector},{name:"nodeDisplayMode",dataType:DataType.INT,enumSource:Kekule.Render.NodeLabelDisplayMode,targetClass:Kekule.ChemStructureNode},{name:"hydrogenDisplayLevel",dataType:DataType.INT,enumSource:Kekule.Render.HydrogenDisplayLevel,targetClass:Kekule.ChemStructureNode},{name:"showCharge",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkType",dataType:DataType.INT,enumSource:Kekule.Render.ChargeMarkRenderType,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkFontSize",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkMargin",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkCircleWidth",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"fontSize",dataType:DataType.NUMBER},{name:"fontFamily",dataType:DataType.STRING},{name:"supFontSizeRatio",dataType:DataType.FLOAT},{name:"subFontSizeRatio",dataType:DataType.FLOAT},{name:"superscriptOverhang",dataType:DataType.FLOAT},{name:"subscriptOversink",dataType:DataType.FLOAT},{name:"textBoxXAlignment",dataType:DataType.INT,enumSource:Kekule.Render.BoxXAlignment},{name:"textBoxYAlignment",dataType:DataType.INT,enumSource:Kekule.Render.BoxYAlignment},{name:"horizontalAlign",dataType:DataType.INT,enumSource:Kekule.Render.TextAlign},{name:"verticalAlign",dataType:DataType.INT,enumSource:Kekule.Render.TextAlign},{name:"charDirection",dataType:DataType.INT,enumSource:Kekule.Render.TextDirection},{name:"customLabel",dataType:DataType.STRING,targetClass:Kekule.ChemStructureNode},{name:"bondLineWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"boldBondLineWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"hashSpacing",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"multipleBondSpacingRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"multipleBondSpacingAbs",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"multipleBondMaxAbsSpacing",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondArrowLength",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondArrowWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondWedgeWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondWedgeHashMinWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"color",dataType:DataType.STRING},{name:"atomColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureNode},{name:"bondColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureObject},{name:"useAtomSpecifiedColor",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureObject},{name:"opacity",dataType:DataType.FLOAT,targetClass:Kekule.ChemObject},{name:"fillColor",dataType:DataType.STRING},{name:"strokeColor",dataType:DataType.STRING},{name:"strokeWidth",dataType:DataType.NUMBER},{name:"atomRadius",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject}]});Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemRender2DOptionsEditor,null,Kekule.ChemObject,"renderOptions");Kekule.PropertyEditor.ChemRender3DOptionsEditor=Class.create(Kekule.PropertyEditor.ChemOptionObjectEditor,{CLASS_NAME:"Kekule.PropertyEditor.ChemRender3DOptionsEditor",CHILD_FIELD_INFOS:[{name:"displayMultipleBond",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"useVdWRadius",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"nodeRadius",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureNode},{name:"connectorRadius",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"nodeRadiusRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureNode},{name:"connectorRadiusRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"connectorLineWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"color",dataType:DataType.STRING},{name:"atomColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureObject},{name:"bondColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureObject},{name:"useAtomSpecifiedColor",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureObject},{name:"hideHydrogens",dataType:DataType.BOOL,targetClass:Kekule.StructureFragment},{name:"bondSpliceMode",dataType:DataType.INT,enumSource:Kekule.Render.Bond3DSpliceMode,targetClass:Kekule.ChemStructureObject}]});Kekule.PropertyEditor.register(Kekule.PropertyEditor.ChemRender3DOptionsEditor,null,Kekule.ChemObject,"render3DOptions");Kekule.PropertyEditor.GlyphPathParamsEditor=Class.create(Kekule.PropertyEditor.ChemOptionObjectEditor,{CLASS_NAME:"Kekule.PropertyEditor.GlyphPathParamsEditor",CHILD_FIELD_INFOS:[{name:"lineCount",dataType:DataType.INT,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"lineGap",dataType:DataType.FLOAT,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"startArrowType",dataType:DataType.STRING,enumSource:Kekule.Glyph.ArrowType,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"startArrowSide",dataType:DataType.INT,enumSource:Kekule.Glyph.ArrowSide,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"startArrowLength",dataType:DataType.FLOAT,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"startArrowWidth",dataType:DataType.FLOAT,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"endArrowType",dataType:DataType.INT,enumSource:Kekule.Glyph.ArrowType,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"endArrowSide",dataType:DataType.INT,enumSource:Kekule.Glyph.ArrowSide,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"endArrowLength",dataType:DataType.FLOAT,targetClass:Kekule.Glyph.PathGlyphConnector},{name:"endArrowWidth",dataType:DataType.FLOAT,targetClass:Kekule.Glyph.PathGlyphConnector}]});Kekule.PropertyEditor.register(Kekule.PropertyEditor.GlyphPathParamsEditor,null,Kekule.Glyph.PathGlyphConnector,"pathParams")})();